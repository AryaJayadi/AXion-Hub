---
phase: 10-settings-public-pages-developer-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/auth/lib/auth.ts
  - src/features/auth/lib/auth-client.ts
  - src/entities/user/model/auth-schema.ts
  - src/features/settings/model/settings-types.ts
  - src/features/settings/schemas/settings-schemas.ts
  - src/features/settings/components/settings-sidebar.tsx
  - src/features/settings/components/general-settings-form.tsx
  - src/features/settings/components/theme-settings-form.tsx
  - src/features/settings/components/profile-settings-form.tsx
  - src/features/settings/api/use-settings.ts
  - src/views/settings/settings-general-view.tsx
  - src/views/settings/settings-profile-view.tsx
  - app/(dashboard)/settings/layout.tsx
  - app/(dashboard)/settings/page.tsx
  - app/(dashboard)/settings/profile/page.tsx
  - src/shared/lib/query-keys.ts
autonomous: true
requirements:
  - SETT-01
  - SETT-02

must_haves:
  truths:
    - "User can navigate to /settings and see a sidebar with all settings categories"
    - "User can configure app name, timezone, and language at /settings in a save-per-section form"
    - "User can toggle between dark/light theme at /settings"
    - "User can update display name and avatar at /settings/profile"
  artifacts:
    - path: "src/features/settings/components/settings-sidebar.tsx"
      provides: "Left navigation with 9 categories using usePathname active state"
      min_lines: 40
    - path: "src/features/settings/components/general-settings-form.tsx"
      provides: "General settings form with app name, timezone, language fields and Save button"
      min_lines: 40
    - path: "src/features/settings/components/profile-settings-form.tsx"
      provides: "Profile form with display name, avatar, and Save button using authClient.updateUser"
      min_lines: 40
    - path: "app/(dashboard)/settings/layout.tsx"
      provides: "Settings layout with sidebar + content area"
      min_lines: 10
  key_links:
    - from: "app/(dashboard)/settings/layout.tsx"
      to: "src/features/settings/components/settings-sidebar.tsx"
      via: "imports and renders SettingsSidebar"
      pattern: "import.*SettingsSidebar"
    - from: "src/features/settings/components/profile-settings-form.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "authClient.updateUser for profile save"
      pattern: "authClient.*updateUser"
---

<objective>
Create the settings infrastructure and first two settings pages (General and Profile).

Purpose: Establish the settings layout pattern (sidebar + separate pages, save-per-section) that all subsequent settings plans build on. Extend better-auth with twoFactor and apiKey plugins for downstream plans. Build general workspace settings (app name, timezone, theme, language) and profile settings (display name, avatar).

Output: Settings layout with sidebar navigation, /settings page with general settings forms, /settings/profile page with profile management. Auth plugins extended for Phase 10 use.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-public-pages-developer-tools/10-RESEARCH.md
@src/features/auth/lib/auth.ts
@src/features/auth/lib/auth-client.ts
@src/entities/user/model/auth-schema.ts
@src/shared/lib/query-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings foundation — auth plugins, types, schemas, query keys, layout, and sidebar</name>
  <files>
    src/features/auth/lib/auth.ts
    src/features/auth/lib/auth-client.ts
    src/features/settings/model/settings-types.ts
    src/features/settings/schemas/settings-schemas.ts
    src/features/settings/api/use-settings.ts
    src/features/settings/components/settings-sidebar.tsx
    app/(dashboard)/settings/layout.tsx
    src/shared/lib/query-keys.ts
  </files>
  <action>
    1. **Extend better-auth server** (`src/features/auth/lib/auth.ts`):
       - Import `twoFactor` and `apiKey` from `better-auth/plugins`
       - Add `twoFactor({ issuer: "AXion Hub" })` to plugins array
       - Add `apiKey({ defaultPrefix: "axion_", startingCharactersConfig: { shouldStore: true, charactersLength: 4 } })` to plugins array
       - Note: The auth-schema.ts may need new tables for twoFactor and apiKey. Check if better-auth auto-creates or if manual schema is needed. If manual, add `twoFactorTable` and `apiKeyTable` to auth-schema.ts matching better-auth's expected schema.

    2. **Extend better-auth client** (`src/features/auth/lib/auth-client.ts`):
       - Import `twoFactorClient` from `better-auth/client/plugins`
       - Import `apiKeyClient` from `better-auth/client/plugins`
       - Add both to plugins array
       - Export new methods: `twoFactor`, `apiKey` from authClient destructure (alongside existing signIn, signUp, etc.)

    3. **Create settings types** (`src/features/settings/model/settings-types.ts`):
       - `GeneralSettings`: { appName: string, timezone: string, language: string }
       - `ProfileSettings`: { displayName: string, avatar: string | null }
       - `SettingsNavItem`: { label: string, href: string, icon: LucideIcon }

    4. **Create settings schemas** (`src/features/settings/schemas/settings-schemas.ts`):
       - `generalSettingsSchema`: Zod v4 schema for GeneralSettings (appName min 1 max 100, timezone non-empty, language non-empty)
       - `profileSettingsSchema`: Zod v4 schema for ProfileSettings (displayName min 1 max 100, avatar optional url)

    5. **Create settings TanStack Query hooks** (`src/features/settings/api/use-settings.ts`):
       - `useGeneralSettings()`: returns mock general settings data (app name, timezone, language)
       - `useSaveGeneralSettings()`: mutation hook for saving general settings (mock API call)
       - `useProfileSettings()`: derives from authClient.useSession() for display name and image
       - Query keys: add `settings` domain to `src/shared/lib/query-keys.ts` with `all`, `general()`, `profile()`, `security()`, `team()`, `apiKeys()`, `notifications()`, `integrations()` sub-keys

    6. **Create SettingsSidebar** (`src/features/settings/components/settings-sidebar.tsx`):
       - "use client" component
       - Use usePathname for active state detection
       - 9 nav items in order: General (/settings, Settings icon), Profile (/settings/profile, User), Security (/settings/security, Shield), Team (/settings/team, Users), API Keys (/settings/api, Key), Notifications (/settings/notifications, Bell), Integrations (/settings/integrations, Plug), Backup & Export (/settings/backup, Download), Danger Zone (/settings/danger, AlertTriangle)
       - Active state: exact match for /settings, startsWith for sub-pages (matching agent-detail-shell pattern)
       - Use cn() for conditional classes: bg-accent text-accent-foreground font-medium when active, text-muted-foreground hover:bg-accent/50 when inactive
       - Simple `<nav>` element (NOT shadcn Sidebar component per research Pitfall 5)
       - Width: w-full md:w-56 shrink-0

    7. **Create settings layout** (`app/(dashboard)/settings/layout.tsx`):
       - Server component
       - PageHeader with title "Settings" and description
       - Flex layout: `<div className="flex flex-col md:flex-row gap-6">` with SettingsSidebar + `<main className="flex-1 min-w-0">{children}</main>`
  </action>
  <verify>
    - `find app/(dashboard)/settings -name "*.tsx" | head -5` shows layout.tsx exists
    - `grep -r "twoFactor" src/features/auth/lib/auth.ts` finds plugin registration
    - `grep -r "apiKey" src/features/auth/lib/auth.ts` finds plugin registration
    - `grep "settings" src/shared/lib/query-keys.ts` finds settings domain
  </verify>
  <done>Settings sidebar renders 9 navigation items with active state highlighting. Settings layout wraps all /settings/* routes. better-auth extended with twoFactor and apiKey plugins. Query keys extended with settings domain.</done>
</task>

<task type="auto">
  <name>Task 2: General settings page and profile settings page</name>
  <files>
    src/features/settings/components/general-settings-form.tsx
    src/features/settings/components/theme-settings-form.tsx
    src/features/settings/components/profile-settings-form.tsx
    src/views/settings/settings-general-view.tsx
    src/views/settings/settings-profile-view.tsx
    app/(dashboard)/settings/page.tsx
    app/(dashboard)/settings/profile/page.tsx
  </files>
  <action>
    1. **GeneralSettingsForm** (`src/features/settings/components/general-settings-form.tsx`):
       - "use client" component accepting `defaults: GeneralSettings` prop
       - react-hook-form with zodResolver (as-never cast for Zod v4 + exactOptionalPropertyTypes)
       - Fields: App Name (Input), Timezone (Select with common timezones like UTC, America/New_York, Europe/London, Asia/Tokyo, etc.), Language (Select with English, Spanish, French, German, Japanese)
       - Save button per section pattern: `<Button type="submit" disabled={form.formState.isSubmitting}>` with Loader2 spinner
       - Wrap in Card with CardHeader (title "General", description "Configure your workspace basics") and CardContent
       - On submit: call useSaveGeneralSettings mutation, toast.success on success, toast.error on failure

    2. **ThemeSettingsForm** (`src/features/settings/components/theme-settings-form.tsx`):
       - "use client" component
       - Use `useTheme()` from next-themes to get/set theme
       - Three toggle options: Light, Dark, System — using a ToggleGroup or radio-button-style Cards
       - Each option shows a small preview icon (Sun, Moon, Monitor from lucide-react)
       - No Save button needed — theme changes are instant via next-themes
       - Wrap in Card with CardHeader (title "Appearance", description "Choose your preferred theme")

    3. **ProfileSettingsForm** (`src/features/settings/components/profile-settings-form.tsx`):
       - "use client" component
       - react-hook-form with zodResolver for profileSettingsSchema
       - Fields: Display Name (Input), Avatar URL (Input with preview — show current avatar as a small image next to input; for MVP, URL input is fine, file upload can come later)
       - On submit: call `authClient.updateUser({ name: values.displayName, image: values.avatar })` directly
       - Toast success/error feedback
       - Wrap in Card with CardHeader (title "Profile", description "Manage your personal information")

    4. **SettingsGeneralView** (`src/views/settings/settings-general-view.tsx`):
       - "use client" component
       - Calls useGeneralSettings() for data
       - Renders GeneralSettingsForm (with defaults) and ThemeSettingsForm stacked vertically with gap-6
       - Loading: show Skeleton cards
       - Error: show toast error

    5. **SettingsProfileView** (`src/views/settings/settings-profile-view.tsx`):
       - "use client" component
       - Uses authClient.useSession() to get current user data for form defaults
       - Renders ProfileSettingsForm
       - Loading: show Skeleton

    6. **Route pages**:
       - `app/(dashboard)/settings/page.tsx`: server component rendering SettingsGeneralView
       - `app/(dashboard)/settings/profile/page.tsx`: server component rendering SettingsProfileView
       - Both with generateMetadata returning appropriate titles
  </action>
  <verify>
    - Navigate to /settings in the browser (or check file existence with `ls app/(dashboard)/settings/page.tsx`)
    - `grep -r "GeneralSettingsForm" src/views/settings/settings-general-view.tsx` confirms composition
    - `grep -r "useTheme" src/features/settings/components/theme-settings-form.tsx` confirms theme integration
    - `grep -r "authClient.updateUser" src/features/settings/components/profile-settings-form.tsx` confirms profile wiring
  </verify>
  <done>User sees general settings page at /settings with App Name, Timezone, Language fields each in a Card with Save button. Theme toggle shows Light/Dark/System with instant switching. Profile page at /settings/profile shows Display Name and Avatar URL with Save button that calls better-auth updateUser.</done>
</task>

</tasks>

<verification>
1. /settings renders with left sidebar showing 9 navigation categories
2. Clicking sidebar items navigates to respective routes
3. General settings page shows App Name, Timezone, Language in a Card with Save
4. Theme card shows Light/Dark/System toggle with instant theme switching
5. Profile page shows Display Name and Avatar URL with Save
6. better-auth config includes twoFactor and apiKey plugins
7. Auth client includes twoFactorClient and apiKeyClient plugins
</verification>

<success_criteria>
- Settings sidebar with 9 items renders correctly with active state
- Settings layout provides consistent sidebar + content area for all /settings/* routes
- General settings form validates and saves with toast feedback
- Theme toggle works instantly via next-themes
- Profile form saves via authClient.updateUser with toast feedback
- better-auth plugins (twoFactor, apiKey) registered on both server and client
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-public-pages-developer-tools/10-01-SUMMARY.md`
</output>
