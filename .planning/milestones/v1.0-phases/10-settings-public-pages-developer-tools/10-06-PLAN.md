---
phase: 10-settings-public-pages-developer-tools
plan: 06
type: execute
wave: 2
depends_on:
  - 10-05
files_modified:
  - src/features/developer-tools/model/playground-store.ts
  - src/features/developer-tools/model/event-templates.ts
  - src/features/developer-tools/lib/playground-ws-manager.ts
  - src/features/developer-tools/components/connection-panel.tsx
  - src/features/developer-tools/components/event-template-picker.tsx
  - src/features/developer-tools/components/event-log.tsx
  - src/features/developer-tools/components/ws-playground.tsx
  - src/views/developer-tools/ws-playground-view.tsx
  - app/(dashboard)/api-docs/ws/page.tsx
autonomous: true
requirements:
  - ADEV-02

must_haves:
  truths:
    - "User can connect to a gateway WebSocket at /api-docs/ws with URL and token inputs"
    - "User can select pre-built event templates from a dropdown and customize the JSON payload"
    - "User can send WebSocket messages and see sent/received events in a timestamped log"
    - "User can export the session event log as JSON"
  artifacts:
    - path: "src/features/developer-tools/model/playground-store.ts"
      provides: "Zustand store for playground connection state, event log, and payload editor"
      min_lines: 50
    - path: "src/features/developer-tools/model/event-templates.ts"
      provides: "Pre-built event template catalog based on OpenClaw gateway methods"
      min_lines: 40
    - path: "src/features/developer-tools/components/ws-playground.tsx"
      provides: "Full interactive WebSocket console with connection, editor, and event log"
      min_lines: 80
    - path: "src/features/developer-tools/components/event-log.tsx"
      provides: "Timestamped event log with direction indicators and JSON display"
      min_lines: 50
  key_links:
    - from: "src/features/developer-tools/components/ws-playground.tsx"
      to: "src/features/developer-tools/model/playground-store.ts"
      via: "usePlaygroundStore for state management"
      pattern: "usePlaygroundStore"
    - from: "src/features/developer-tools/lib/playground-ws-manager.ts"
      to: "src/features/gateway-connection/lib/ws-manager.ts"
      via: "Creates standalone WebSocketManager instance (not reusing app singleton)"
      pattern: "WebSocketManager"
---

<objective>
Build the interactive WebSocket playground for testing gateway commands.

Purpose: Developers need a full interactive console to connect to the OpenClaw Gateway, send events using pre-built templates or custom JSON, and view the event log with timestamps. This is a debugging and exploration tool.

Output: /api-docs/ws with connection panel, event template picker, JSON editor, send button, and timestamped event log with JSON export.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-public-pages-developer-tools/10-RESEARCH.md
@.planning/phases/10-settings-public-pages-developer-tools/10-05-SUMMARY.md
@src/features/gateway-connection/lib/ws-manager.ts
@src/features/gateway-connection/lib/event-bus.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Playground store, event templates, and WebSocket manager wrapper</name>
  <files>
    src/features/developer-tools/model/playground-store.ts
    src/features/developer-tools/model/event-templates.ts
    src/features/developer-tools/lib/playground-ws-manager.ts
  </files>
  <action>
    1. **Create event template catalog** (`src/features/developer-tools/model/event-templates.ts`):
       - Define `EventTemplate` type: { id: string, label: string, description: string, method: string, params: Record<string, unknown> }
       - Create EVENT_TEMPLATES array with 8-10 templates based on OpenClaw gateway methods:
         - "Health Check" — method: "health", params: {}
         - "List Agents" — method: "agent.list", params: {}
         - "Get Agent" — method: "agent.get", params: { agentId: "<agent-id>" }
         - "Send Message" — method: "agent.send", params: { agentId: "<agent-id>", message: "Hello from playground", sessionId: "<session-id>" }
         - "Get Config" — method: "config.get", params: {}
         - "List Sessions" — method: "sessions.list", params: {}
         - "Get Session" — method: "sessions.get", params: { sessionId: "<session-id>" }
         - "Subscribe Events" — method: "events.subscribe", params: { patterns: ["agent.*", "session.*"] }
         - "Compact Session" — method: "session.compact", params: { sessionId: "<session-id>" }
         - "Custom" — method: "", params: {} (blank template for free-form)
       - Export helper: `getTemplateById(id: string)`, `templateToJson(template: EventTemplate): string` (returns formatted JSON string)

    2. **Create playground Zustand store** (`src/features/developer-tools/model/playground-store.ts`):
       - Plain Zustand (no persist — playground sessions are ephemeral)
       - State shape:
         ```
         url: string (default: "ws://127.0.0.1:18789")
         token: string (default: "")
         connectionState: "disconnected" | "connecting" | "connected" | "error"
         events: PlaygroundEvent[]
         selectedTemplateId: string | null
         jsonPayload: string (default: "{}")
         error: string | null
         ```
       - `PlaygroundEvent` type: { id: string, timestamp: Date, direction: "sent" | "received", type: "req" | "res" | "event", raw: string }
       - Actions:
         - `setUrl(url: string)`
         - `setToken(token: string)`
         - `setConnectionState(state)`
         - `addEvent(event: PlaygroundEvent)` — prepends to events array
         - `clearEvents()`
         - `selectTemplate(id: string)` — sets selectedTemplateId and jsonPayload from template
         - `setJsonPayload(json: string)`
         - `setError(error: string | null)`
       - Export `usePlaygroundStore` hook

    3. **Create playground WebSocket manager** (`src/features/developer-tools/lib/playground-ws-manager.ts`):
       - Creates a STANDALONE WebSocketManager instance (NOT reusing the app's singleton from GatewayProvider per research Pitfall 4)
       - `createPlaygroundConnection(url: string, token: string, onMessage: (data: string) => void, onStateChange: (state) => void): { send: (data: string) => void, disconnect: () => void }`
       - Uses raw WebSocket (or thin wrapper over WebSocketManager) for simplicity
       - On open: call onStateChange("connected")
       - On message: call onMessage with raw data string
       - On close: call onStateChange("disconnected")
       - On error: call onStateChange("error")
       - send() writes raw string to WebSocket
       - disconnect() closes the WebSocket
       - Includes connect handshake: sends `{ type: "req", id: nanoid(), method: "connect", params: { token } }` on open if token provided
  </action>
  <verify>
    - `grep -r "EVENT_TEMPLATES" src/features/developer-tools/model/event-templates.ts` confirms template array
    - `grep -r "usePlaygroundStore" src/features/developer-tools/model/playground-store.ts` confirms store export
    - `grep -r "WebSocket\|new WebSocket" src/features/developer-tools/lib/playground-ws-manager.ts` confirms standalone connection
  </verify>
  <done>Playground store manages connection state, event log, and payload editor. 10 event templates cover common gateway operations. Standalone WebSocket manager creates independent connections separate from the app's gateway client.</done>
</task>

<task type="auto">
  <name>Task 2: WebSocket playground UI — connection panel, editor, event log, and route page</name>
  <files>
    src/features/developer-tools/components/connection-panel.tsx
    src/features/developer-tools/components/event-template-picker.tsx
    src/features/developer-tools/components/event-log.tsx
    src/features/developer-tools/components/ws-playground.tsx
    src/views/developer-tools/ws-playground-view.tsx
    app/(dashboard)/api-docs/ws/page.tsx
  </files>
  <action>
    1. **ConnectionPanel** (`src/features/developer-tools/components/connection-panel.tsx`):
       - "use client" component
       - Two inputs: Gateway URL (Input, default ws://127.0.0.1:18789) and Auth Token (Input type="password", optional)
       - Connect/Disconnect button with dynamic label based on connectionState
       - StatusBadge showing connection state (connected green, connecting yellow, disconnected gray, error red)
       - On Connect: creates playground connection, wires onMessage/onStateChange to store actions
       - On Disconnect: calls disconnect, updates store
       - Compact horizontal layout: URL input (flex-1) + Token input (w-48) + Button

    2. **EventTemplatePicker** (`src/features/developer-tools/components/event-template-picker.tsx`):
       - "use client" component
       - Select dropdown populated from EVENT_TEMPLATES array
       - On select: calls store.selectTemplate(id) which fills jsonPayload
       - Shows template description below the dropdown as muted text
       - "Custom" option at the end for free-form JSON

    3. **JSON Editor area** (part of WsPlayground):
       - Use CodeMirror with @codemirror/lang-json for JSON editing (already in project)
       - Load via next/dynamic with ssr:false (matching workspace code-editor pattern)
       - Value controlled by store.jsonPayload, onChange updates store.setJsonPayload
       - Validate JSON on change (try JSON.parse), show error indicator if invalid
       - Height: ~200px
       - "Send" button below editor. Disabled when disconnected or JSON invalid.
       - On Send: parse JSON, wrap in gateway frame format `{ type: "req", id: nanoid(), method, params }`, send via playground WS manager, add to event log as "sent" event

    4. **EventLog** (`src/features/developer-tools/components/event-log.tsx`):
       - "use client" component
       - Renders store.events as a scrollable list (max-h-[400px] overflow-y-auto)
       - Each event shows:
         - Direction arrow: sent (arrow right, blue) / received (arrow left, green)
         - Timestamp (HH:mm:ss.SSS format)
         - Type badge (req/res/event)
         - Collapsible JSON body — shows first line by default, expands on click to show full formatted JSON
       - Header area: "Event Log" title + event count badge + "Clear" button + "Export" button
       - Export button: generates JSON file with all events using the Blob download pattern from research (exportedAt, gatewayUrl, eventCount, events array). Filename: `ws-playground-{timestamp}.json`
       - Empty state: "No events yet. Connect to a gateway and send a request."

    5. **WsPlayground** (`src/features/developer-tools/components/ws-playground.tsx`):
       - "use client" component
       - Composes: ConnectionPanel (top), then split layout below:
         - Left column (md:w-1/2): EventTemplatePicker + CodeMirror JSON editor + Send button
         - Right column (md:w-1/2): EventLog
       - On mobile: stacked vertically
       - Manages the playground connection lifecycle: store ref for disconnect on unmount (useEffect cleanup)
       - useRef for WS connection to persist across renders

    6. **WsPlaygroundView** (`src/views/developer-tools/ws-playground-view.tsx`):
       - "use client" component
       - PageHeader: title "WebSocket Playground", description "Test Gateway WebSocket commands live"
       - Link back to /api-docs for API reference
       - Renders WsPlayground

    7. **Route page** (`app/(dashboard)/api-docs/ws/page.tsx`):
       - Server component
       - generateMetadata: title "WebSocket Playground"
       - Renders WsPlaygroundView
  </action>
  <verify>
    - `ls app/(dashboard)/api-docs/ws/page.tsx` exists
    - `grep -r "CodeMirror\|codemirror" src/features/developer-tools/components/ws-playground.tsx` confirms JSON editor
    - `grep -r "export.*JSON\|Blob\|createObjectURL" src/features/developer-tools/components/event-log.tsx` confirms export functionality
    - `grep -r "EventTemplatePicker.*EventLog" src/features/developer-tools/components/ws-playground.tsx` or verify both are imported
    - `grep -r "usePlaygroundStore" src/features/developer-tools/components/ws-playground.tsx` confirms store usage
  </verify>
  <done>WebSocket playground at /api-docs/ws shows connection panel, event template picker, CodeMirror JSON editor with Send button, and timestamped event log with collapse/expand and JSON export. Standalone WebSocket connection separate from app gateway.</done>
</task>

</tasks>

<verification>
1. /api-docs/ws renders the full playground UI
2. Connection panel shows URL and token inputs with connect/disconnect button
3. Template picker populates JSON editor with template content
4. CodeMirror editor validates JSON and shows error for invalid JSON
5. Sending a message adds it to the event log as "sent"
6. Receiving a response shows it in the event log as "received"
7. Export button downloads JSON file with all events
8. Clear button empties the event log
</verification>

<success_criteria>
- Playground creates standalone WebSocket connection (not reusing app singleton)
- Event templates cover common gateway operations
- JSON editor uses CodeMirror with syntax highlighting and validation
- Event log shows direction, timestamp, type badge, and collapsible JSON
- Export generates downloadable JSON with event history
- Connection cleanup on unmount prevents memory leaks
- All within authenticated app shell at /api-docs/ws
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-public-pages-developer-tools/10-06-SUMMARY.md`
</output>
