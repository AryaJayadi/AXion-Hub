---
phase: 10-settings-public-pages-developer-tools
plan: 03
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - src/features/settings/components/team-members-table.tsx
  - src/features/settings/components/invite-manager.tsx
  - src/features/settings/components/api-key-manager.tsx
  - src/features/settings/components/api-key-create-dialog.tsx
  - src/features/settings/api/use-team.ts
  - src/features/settings/api/use-api-keys.ts
  - src/views/settings/settings-team-view.tsx
  - src/views/settings/settings-invites-view.tsx
  - src/views/settings/settings-api-view.tsx
  - app/(dashboard)/settings/team/page.tsx
  - app/(dashboard)/settings/team/invites/page.tsx
  - app/(dashboard)/settings/api/page.tsx
autonomous: true
requirements:
  - SETT-04
  - SETT-05
  - SETT-06

must_haves:
  truths:
    - "User can view organization members with roles at /settings/team"
    - "User can update member roles and remove members from the organization"
    - "User can invite users by email and see pending invitations at /settings/team/invites"
    - "User can create API keys at /settings/api and see the full key exactly once"
    - "User can view existing API keys showing only prefix + masked + last 4 chars"
    - "User can delete API keys"
  artifacts:
    - path: "src/features/settings/components/team-members-table.tsx"
      provides: "Organization member table with role dropdown and remove button"
      min_lines: 60
    - path: "src/features/settings/components/invite-manager.tsx"
      provides: "Invite form + pending invitations list with cancel"
      min_lines: 60
    - path: "src/features/settings/components/api-key-manager.tsx"
      provides: "API key list with masked display and delete, plus create button"
      min_lines: 60
    - path: "src/features/settings/components/api-key-create-dialog.tsx"
      provides: "Dialog showing full API key once after creation with copy button and warning"
      min_lines: 40
  key_links:
    - from: "src/features/settings/components/team-members-table.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "authClient.organization methods"
      pattern: "authClient.*organization"
    - from: "src/features/settings/components/api-key-manager.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "authClient.apiKey.create/list/delete"
      pattern: "authClient.*apiKey"
---

<objective>
Build team management, invitation management, and API key management settings pages.

Purpose: Organization owners/admins need to manage team members and roles, send invitations, and create API keys for external integrations. API keys follow the Stripe show-once pattern per user decision.

Output: /settings/team with member table, /settings/team/invites with invite form and pending list, /settings/api with API key CRUD and show-once creation dialog.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-public-pages-developer-tools/10-RESEARCH.md
@.planning/phases/10-settings-public-pages-developer-tools/10-01-SUMMARY.md
@src/features/auth/lib/auth-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Team members table, invite manager, and route pages</name>
  <files>
    src/features/settings/components/team-members-table.tsx
    src/features/settings/components/invite-manager.tsx
    src/features/settings/api/use-team.ts
    src/views/settings/settings-team-view.tsx
    src/views/settings/settings-invites-view.tsx
    app/(dashboard)/settings/team/page.tsx
    app/(dashboard)/settings/team/invites/page.tsx
  </files>
  <action>
    1. **Create team API hooks** (`src/features/settings/api/use-team.ts`):
       - `useTeamMembers()`: TanStack Query hook wrapping `authClient.organization.getFullOrganization()`. Returns members array with id, name, email, role, joinedAt. Use queryKeys.settings.team() key.
       - `useUpdateMemberRole()`: mutation wrapping `authClient.organization.updateMemberRole({ memberId, role })` with cache invalidation.
       - `useRemoveMember()`: mutation wrapping `authClient.organization.removeMember({ memberIdOrEmail })` with optimistic removal from cache.
       - `useInviteMember()`: mutation wrapping `authClient.organization.inviteMember({ email, role })` with cache invalidation.
       - `usePendingInvitations()`: derives pending invitations from getFullOrganization() data (invitation table). Falls back to mock data if API not available yet.
       - `useCancelInvitation()`: mutation for canceling a pending invitation (revoke by ID).

    2. **TeamMembersTable** (`src/features/settings/components/team-members-table.tsx`):
       - "use client" component
       - Uses useTeamMembers() hook
       - DataTable or manual table showing columns: Avatar + Name, Email, Role (Select dropdown: owner/admin/member), Actions (Remove button)
       - Role dropdown calls useUpdateMemberRole on change (with toast feedback)
       - Remove button shows confirmation Dialog before calling useRemoveMember
       - Current user's row shows their role but cannot remove self
       - Owner cannot be removed or demoted (disable controls)
       - Wrap in Card (title "Team Members", description "Manage your organization's members and their roles")
       - Loading: SkeletonTable

    3. **InviteManager** (`src/features/settings/components/invite-manager.tsx`):
       - "use client" component
       - Top section: Invite form with Email input + Role select (admin/member) + "Send Invite" button
       - Zod schema: email (z.email()), role (z.enum(["admin", "member"]))
       - react-hook-form with zodResolver
       - Bottom section: Pending Invitations table showing Email, Role, Sent date, Actions (Cancel button)
       - Cancel calls useCancelInvitation with optimistic removal
       - Wrap in Card (title "Invitations", description "Invite new members and manage pending invitations")

    4. **SettingsTeamView** (`src/views/settings/settings-team-view.tsx`):
       - "use client" component
       - Renders TeamMembersTable
       - Link to "Manage Invitations" at /settings/team/invites

    5. **SettingsInvitesView** (`src/views/settings/settings-invites-view.tsx`):
       - "use client" component
       - Renders InviteManager
       - Breadcrumb-style link back to /settings/team

    6. **Route pages**:
       - `app/(dashboard)/settings/team/page.tsx`: server component, generateMetadata "Team - Settings", renders SettingsTeamView
       - `app/(dashboard)/settings/team/invites/page.tsx`: server component, generateMetadata "Invitations - Settings", renders SettingsInvitesView
  </action>
  <verify>
    - `ls app/(dashboard)/settings/team/page.tsx app/(dashboard)/settings/team/invites/page.tsx` both exist
    - `grep -r "organization\." src/features/settings/api/use-team.ts` confirms better-auth org API usage
    - `grep -r "updateMemberRole\|removeMember" src/features/settings/components/team-members-table.tsx` confirms member management
  </verify>
  <done>Team settings page shows member table with role editing and removal. Invites page has invite form and pending invitations list with cancel. All wired to better-auth organization APIs.</done>
</task>

<task type="auto">
  <name>Task 2: API key management with show-once creation pattern</name>
  <files>
    src/features/settings/components/api-key-manager.tsx
    src/features/settings/components/api-key-create-dialog.tsx
    src/features/settings/api/use-api-keys.ts
    src/views/settings/settings-api-view.tsx
    app/(dashboard)/settings/api/page.tsx
  </files>
  <action>
    1. **Create API key hooks** (`src/features/settings/api/use-api-keys.ts`):
       - `useApiKeys()`: TanStack Query hook wrapping `authClient.apiKey.list()`. Returns array of keys with id, name, prefix, start (first 4 chars), createdAt, expiresAt. Use queryKeys.settings.apiKeys() key.
       - `useCreateApiKey()`: mutation wrapping `authClient.apiKey.create({ name, expiresIn? })`. Returns the full raw key in the response (this is the ONLY time the full key is available). Cache invalidation on success.
       - `useDeleteApiKey()`: mutation wrapping `authClient.apiKey.delete({ keyId })`. Optimistic removal from cache with toast feedback.

    2. **ApiKeyCreateDialog** (`src/features/settings/components/api-key-create-dialog.tsx`):
       - "use client" component
       - Two-phase dialog pattern (matching Phase 9 webhook create dialog):
         - **Phase 1 (form)**: Dialog with name Input + optional expiration Select (Never, 30 days, 60 days, 90 days, 1 year). Create button.
         - **Phase 2 (reveal)**: Shows the full raw API key in a monospace code block with a Copy button. Warning Alert: "This key won't be shown again. Copy it now and store it securely." Close button dismisses and clears the key from state.
       - Props: `open`, `onOpenChange` for controlled Dialog
       - On create success: transition to phase 2 with full key from response
       - Copy uses navigator.clipboard.writeText with sonner toast "Copied to clipboard"
       - On close: clear justCreatedKey state, call onOpenChange(false)

    3. **ApiKeyManager** (`src/features/settings/components/api-key-manager.tsx`):
       - "use client" component
       - Uses useApiKeys() hook
       - Header area: "Create API Key" button opening ApiKeyCreateDialog
       - Table showing columns: Name, Key (display as `{prefix}****{start}` — e.g., "axion_****a1b2"), Created (formatted date), Expires (formatted date or "Never"), Actions (Delete button with confirmation)
       - Delete button shows confirmation Dialog ("Are you sure? This action cannot be undone.")
       - Per user locked decision: keys shown once on creation, masked forever after — only last 4 chars visible post-creation (Stripe pattern)
       - Wrap in Card (title "API Keys", description "Manage API keys for external integrations. Keys are shown once at creation.")
       - Empty state: "No API keys yet. Create one to integrate with external services."

    4. **SettingsApiView** (`src/views/settings/settings-api-view.tsx`):
       - "use client" component
       - Renders ApiKeyManager

    5. **API route page** (`app/(dashboard)/settings/api/page.tsx`):
       - Server component
       - generateMetadata: title "API Keys - Settings"
       - Renders SettingsApiView
  </action>
  <verify>
    - `ls app/(dashboard)/settings/api/page.tsx` exists
    - `grep -r "apiKey" src/features/settings/api/use-api-keys.ts` confirms better-auth API key plugin usage
    - `grep -r "clipboard" src/features/settings/components/api-key-create-dialog.tsx` confirms copy functionality
    - `grep -r "won't be shown again" src/features/settings/components/api-key-create-dialog.tsx` confirms show-once warning
  </verify>
  <done>API keys page at /settings/api shows masked key list with delete capability. Create dialog reveals full key exactly once with copy button and "won't be shown again" warning. Keys displayed as prefix + masked + last 4 chars in the list.</done>
</task>

</tasks>

<verification>
1. /settings/team shows member table with role dropdowns and remove buttons
2. /settings/team/invites shows invite form and pending invitations with cancel
3. /settings/api shows API key list with masked display
4. Creating a new API key shows the full key in a dialog with copy button
5. Closing the creation dialog hides the key permanently
6. Deleting an API key shows confirmation then removes it
</verification>

<success_criteria>
- Team member roles can be changed via dropdown (owner excluded from demotion)
- Members can be removed with confirmation dialog
- Invitations sent via email with role selection
- Pending invitations visible with cancel capability
- API key creation shows full key exactly once (Stripe pattern)
- API key list shows only prefix + masked + last 4 chars
- API key deletion with confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-public-pages-developer-tools/10-03-SUMMARY.md`
</output>
