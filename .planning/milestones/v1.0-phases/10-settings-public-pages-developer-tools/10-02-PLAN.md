---
phase: 10-settings-public-pages-developer-tools
plan: 02
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - src/features/settings/components/password-change-form.tsx
  - src/features/settings/components/totp-setup-card.tsx
  - src/features/settings/components/active-sessions-card.tsx
  - src/features/settings/api/use-security.ts
  - src/views/settings/settings-security-view.tsx
  - app/(dashboard)/settings/security/page.tsx
autonomous: true
requirements:
  - SETT-03

must_haves:
  truths:
    - "User can change their password at /settings/security with current + new password fields"
    - "User can enable 2FA via TOTP with QR code scan and backup codes at /settings/security"
    - "User can view and revoke active sessions at /settings/security"
    - "User can disable 2FA after verifying their current TOTP code"
  artifacts:
    - path: "src/features/settings/components/totp-setup-card.tsx"
      provides: "TOTP 2FA setup with QR code display, verification, backup codes, and disable flow"
      min_lines: 80
    - path: "src/features/settings/components/password-change-form.tsx"
      provides: "Password change form using authClient.changePassword"
      min_lines: 40
    - path: "src/features/settings/components/active-sessions-card.tsx"
      provides: "Active sessions table with revoke buttons"
      min_lines: 50
  key_links:
    - from: "src/features/settings/components/totp-setup-card.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "authClient.twoFactor.enable/verifyTOTP/disable"
      pattern: "authClient.*twoFactor"
    - from: "src/features/settings/components/password-change-form.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "authClient.changePassword"
      pattern: "authClient.*changePassword"
    - from: "src/features/settings/components/active-sessions-card.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "authClient.listSessions/revokeSession"
      pattern: "authClient\\.(?:listSessions|revokeSession)"
---

<objective>
Build the security settings page with password change, TOTP two-factor authentication, and active session management.

Purpose: Users need to manage their account security: change password, enable/disable 2FA with QR-code-based TOTP (Google Authenticator / Authy style), view backup codes, and monitor/revoke active sessions.

Output: /settings/security page with three cards: password change form, 2FA setup/management, and active sessions table.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-public-pages-developer-tools/10-RESEARCH.md
@.planning/phases/10-settings-public-pages-developer-tools/10-01-SUMMARY.md
@src/features/auth/lib/auth.ts
@src/features/auth/lib/auth-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Password change form and active sessions card</name>
  <files>
    src/features/settings/components/password-change-form.tsx
    src/features/settings/components/active-sessions-card.tsx
    src/features/settings/api/use-security.ts
  </files>
  <action>
    1. **Create security API hooks** (`src/features/settings/api/use-security.ts`):
       - `useActiveSessions()`: TanStack Query hook wrapping `authClient.listSessions()`. Returns array of sessions with id, ipAddress, userAgent, createdAt, current flag. Use queryKeys.settings.security() key. staleTime 30s (sessions change frequently, matching approval pattern).
       - `useRevokeSession()`: mutation wrapping `authClient.revokeSession({ token })` with optimistic removal from cache and toast feedback.
       - `useRevokeOtherSessions()`: mutation wrapping `authClient.revokeOtherSessions()` with cache invalidation.
       - `useChangePassword()`: mutation wrapping `authClient.changePassword({ currentPassword, newPassword })` with toast success/error.

    2. **PasswordChangeForm** (`src/features/settings/components/password-change-form.tsx`):
       - "use client" component
       - Zod v4 schema: currentPassword (min 8), newPassword (min 8), confirmPassword; refine confirmPassword === newPassword
       - react-hook-form with zodResolver (as-never cast)
       - Three Input fields with type="password": Current Password, New Password, Confirm New Password
       - Save button with loading state
       - On submit: call useChangePassword mutation, reset form on success
       - Wrap in Card (title "Password", description "Change your password")
       - toast.success("Password changed successfully") on success
       - Toast error on failure (wrong current password, etc.)

    3. **ActiveSessionsCard** (`src/features/settings/components/active-sessions-card.tsx`):
       - "use client" component
       - Uses useActiveSessions() hook
       - Shows sessions in a simple table or list: Browser/Device (parsed from userAgent), IP Address, Created date (formatted with date-fns), Status (current session badge)
       - Each non-current session has a "Revoke" button calling useRevokeSession
       - "Revoke All Other Sessions" button at top using useRevokeOtherSessions
       - Current session row highlighted with a "Current" StatusBadge (no revoke button)
       - Wrap in Card (title "Active Sessions", description "Manage your active sessions across devices")
       - Loading: SkeletonTable
  </action>
  <verify>
    - `grep -r "changePassword" src/features/settings/components/password-change-form.tsx` confirms password API usage
    - `grep -r "listSessions\|revokeSession" src/features/settings/api/use-security.ts` confirms session hooks
    - `ls src/features/settings/components/active-sessions-card.tsx` file exists
  </verify>
  <done>Password change form validates current + new + confirm passwords and calls better-auth changePassword. Sessions card shows active sessions with revoke buttons and "Current" badge for the active session.</done>
</task>

<task type="auto">
  <name>Task 2: TOTP 2FA setup card and security view page</name>
  <files>
    src/features/settings/components/totp-setup-card.tsx
    src/views/settings/settings-security-view.tsx
    app/(dashboard)/settings/security/page.tsx
  </files>
  <action>
    1. **Install react-qr-code** if not already installed:
       - `bun add react-qr-code`

    2. **TotpSetupCard** (`src/features/settings/components/totp-setup-card.tsx`):
       - "use client" component
       - Multi-step flow managed by local state: `step: "idle" | "password" | "scan" | "verify" | "enabled"`
       - **idle state**: Shows 2FA status. If not enabled, show "Enable Two-Factor Authentication" button. If enabled, show "Enabled" badge and "Disable" button.
       - **password state**: Ask for current password to initiate 2FA setup. Input + Continue button. On submit: call `authClient.twoFactor.enable({ password })`. On success, receive `totpURI` and `backupCodes`, transition to "scan".
       - **scan state**: Display QR code using `react-qr-code` (`<QRCode value={totpURI} size={200} />`). Show the QR code on a white background container (for contrast). Below QR code, show a "Can't scan? Enter this code manually" collapsible with the TOTP secret extracted from the URI. Show backup codes in a bordered box with a "Copy All" button using navigator.clipboard. Warning text: "Save these backup codes. They won't be shown again." Continue button to move to "verify".
       - **verify state**: Input field for 6-digit TOTP code from authenticator app. Verify button calls `authClient.twoFactor.verifyTOTP({ code })`. On success: toast.success("Two-factor authentication enabled"), transition to "enabled".
       - **enabled state (or idle with 2FA enabled)**: Show green checkmark, "Two-factor authentication is enabled" message. "Disable" button triggers password confirmation, then calls `authClient.twoFactor.disable({ password })`.
       - **Disable flow**: Dialog/inline asking for password, then calls disable API. On success: toast, transition back to idle.
       - Use sonner toast for all feedback. Wrap in Card (title "Two-Factor Authentication", description "Add an extra layer of security using TOTP").
       - Per CONTEXT.md locked decision: TOTP only, no WebAuthn.
       - Per research Pitfall 6: Use the totpURI directly from better-auth (already properly formatted).

    3. **SettingsSecurityView** (`src/views/settings/settings-security-view.tsx`):
       - "use client" component
       - Stacks three cards vertically with gap-6: PasswordChangeForm, TotpSetupCard, ActiveSessionsCard
       - No loading gate needed â€” each card manages its own loading state

    4. **Security route page** (`app/(dashboard)/settings/security/page.tsx`):
       - Server component
       - generateMetadata: title "Security - Settings"
       - Renders SettingsSecurityView
  </action>
  <verify>
    - `grep -r "react-qr-code\|QRCode" src/features/settings/components/totp-setup-card.tsx` confirms QR integration
    - `grep -r "twoFactor" src/features/settings/components/totp-setup-card.tsx` confirms auth API usage
    - `ls app/(dashboard)/settings/security/page.tsx` exists
    - `grep -r "PasswordChangeForm.*TotpSetupCard.*ActiveSessionsCard" src/views/settings/settings-security-view.tsx` or check all three are imported
  </verify>
  <done>Security settings page at /settings/security shows password change form, TOTP 2FA setup with QR code + backup codes + verify flow, and active sessions table with revoke capabilities. 2FA uses TOTP only (no WebAuthn) per user decision.</done>
</task>

</tasks>

<verification>
1. /settings/security renders three cards stacked vertically
2. Password change form validates and submits via better-auth
3. TOTP setup shows QR code after password confirmation
4. Backup codes are displayed and copyable
5. TOTP verification input accepts 6-digit code
6. Session table shows current session with badge, others with revoke buttons
7. "Revoke All Other Sessions" button works
</verification>

<success_criteria>
- Password change validates current password, new password, and confirm match
- 2FA enable flow: password -> QR code -> backup codes -> verify code -> enabled
- 2FA disable flow: password confirmation -> disabled
- QR code uses react-qr-code with totpURI from better-auth
- Active sessions display IP, user agent, date with current session highlighted
- Session revocation with optimistic UI update
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-public-pages-developer-tools/10-02-SUMMARY.md`
</output>
