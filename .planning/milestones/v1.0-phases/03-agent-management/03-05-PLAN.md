---
phase: 03-agent-management
plan: 05
type: execute
wave: 3
depends_on:
  - "03-02"
files_modified:
  - src/features/agents/api/use-agent-sessions.ts
  - src/features/agents/api/use-agent-memory.ts
  - src/features/agents/components/agent-sessions-table.tsx
  - src/features/agents/components/agent-memory-browser.tsx
  - src/features/agents/components/agent-memory-search.tsx
  - src/views/agents/agent-sessions-view.tsx
  - src/views/agents/agent-memory-view.tsx
  - app/(dashboard)/agents/[agentId]/sessions/page.tsx
  - app/(dashboard)/agents/[agentId]/memory/page.tsx
autonomous: true
requirements:
  - AGNT-06
  - AGNT-07

must_haves:
  truths:
    - "User can view agent sessions with token counts and compaction history at /agents/[agentId]/sessions"
    - "Sessions are displayed in a sortable/filterable data table"
    - "User can view/edit agent MEMORY.md and daily memory files at /agents/[agentId]/memory"
    - "Memory page has a categorized file browser with MEMORY.md and daily files"
    - "User can search memory contents via a search input"
    - "MEMORY.md is editable; daily files are read-only"
  artifacts:
    - path: "src/features/agents/components/agent-sessions-table.tsx"
      provides: "Sessions data table with token counts and compaction info"
      exports: ["AgentSessionsTable"]
    - path: "src/features/agents/components/agent-memory-browser.tsx"
      provides: "Categorized memory file browser with tree view"
      exports: ["AgentMemoryBrowser"]
    - path: "app/(dashboard)/agents/[agentId]/sessions/page.tsx"
      provides: "Next.js route for /agents/[agentId]/sessions"
    - path: "app/(dashboard)/agents/[agentId]/memory/page.tsx"
      provides: "Next.js route for /agents/[agentId]/memory"
  key_links:
    - from: "src/views/agents/agent-sessions-view.tsx"
      to: "src/features/agents/api/use-agent-sessions.ts"
      via: "useAgentSessions hook"
      pattern: "useAgentSessions"
    - from: "src/views/agents/agent-memory-view.tsx"
      to: "src/features/agents/api/use-agent-memory.ts"
      via: "useAgentMemory hook"
      pattern: "useAgentMemory"
---

<objective>
Agent sessions table at /agents/[agentId]/sessions and memory browser/editor at /agents/[agentId]/memory.

Purpose: Users can inspect agent session history with token usage data and browse/edit agent memory files.
Output: Sessions data table, memory file browser with tree view and search, MEMORY.md editor.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-management/03-RESEARCH.md
@.planning/phases/03-agent-management/03-CONTEXT.md
@.planning/phases/03-agent-management/03-02-SUMMARY.md
@src/entities/agent/model/types.ts
@src/widgets/agent-detail-layout/components/agent-detail-shell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent sessions data table</name>
  <files>
    src/features/agents/api/use-agent-sessions.ts
    src/features/agents/components/agent-sessions-table.tsx
    src/views/agents/agent-sessions-view.tsx
    app/(dashboard)/agents/[agentId]/sessions/page.tsx
  </files>
  <action>
    **Step 1: Create useAgentSessions hook at `src/features/agents/api/use-agent-sessions.ts`.**

    - TanStack Query fetches sessions for a given agentId
    - Returns `{ sessions: AgentSession[], isLoading, error }`
    - Mock data: 8-10 sessions with varied statuses (active, compacted, ended), token counts (ranging from 500 to 50,000), compaction counts (0-5), and realistic timestamps spanning the past 7 days
    - Add `// TODO: Replace with gatewayClient.agent.sessions(agentId)`

    **Step 2: Create AgentSessionsTable at `src/features/agents/components/agent-sessions-table.tsx`.**

    "use client" component using @tanstack/react-table (already installed from Phase 1).

    Columns:
    - **Session ID**: Truncated ID with copy-to-clipboard
    - **Status**: Badge component (active = green, compacted = yellow, ended = muted)
    - **Started**: Formatted date+time (date-fns format)
    - **Duration**: Calculated from startedAt/endedAt (or "Active" if no endedAt)
    - **Tokens**: Formatted number (e.g., "12,450")
    - **Compactions**: Count number

    Features:
    - Sortable by started date, token count, duration
    - Filterable by status (dropdown)
    - Pagination (10 per page)

    Use shadcn Table component for rendering. Include Skeleton loading state matching the table shape (header + 5 rows).

    **Step 3: Create AgentSessionsView at `src/views/agents/agent-sessions-view.tsx`.**

    "use client" component. Takes agentId prop.
    - Page header: "Sessions" with session count badge
    - Calls `useAgentSessions(agentId)`
    - Renders AgentSessionsTable with session data
    - Loading/error states handled

    **Step 4: Create page route at `app/(dashboard)/agents/[agentId]/sessions/page.tsx`.**

    Async server component, awaits params, renders AgentSessionsView.
  </action>
  <verify>
    `bun run build` succeeds. Navigate to /agents/[id]/sessions -- see data table with mock sessions showing token counts, statuses, and durations. Sorting and filtering work.
  </verify>
  <done>
    Sessions page at /agents/[agentId]/sessions shows a sortable, filterable data table with session ID, status, start time, duration, token count, and compaction count.
  </done>
</task>

<task type="auto">
  <name>Task 2: Agent memory browser with tree view, search, and MEMORY.md editor</name>
  <files>
    src/features/agents/api/use-agent-memory.ts
    src/features/agents/components/agent-memory-browser.tsx
    src/features/agents/components/agent-memory-search.tsx
    src/views/agents/agent-memory-view.tsx
    app/(dashboard)/agents/[agentId]/memory/page.tsx
  </files>
  <action>
    **Step 1: Create useAgentMemory hook at `src/features/agents/api/use-agent-memory.ts`.**

    - TanStack Query fetches memory files for agent
    - Returns `{ memoryFiles: AgentMemoryFile[], isLoading, error, saveMemoryFile, searchMemory }`
    - Mock data: MEMORY.md (persistent memory, ~30 lines of realistic content) + 5 daily files (2026-02-17.md through 2026-02-13.md with realistic daily summaries)
    - `saveMemoryFile(path, content)` mutation for MEMORY.md editing
    - `searchMemory(query)` returns filtered files where content matches query string
    - Add `// TODO: Replace with gatewayClient.agent.memory.list(agentId)`

    **Step 2: Create AgentMemorySearch at `src/features/agents/components/agent-memory-search.tsx`.**

    - Search input with Search icon (lucide-react)
    - Debounced search (300ms) using use-debounce
    - When search query is non-empty, highlights which files contain matches
    - Props: onSearch(query: string), placeholder text

    **Step 3: Create AgentMemoryBrowser at `src/features/agents/components/agent-memory-browser.tsx`.**

    Claude's discretion recommendation from research: categorized file browser with tree view.

    Layout: left sidebar (w-56) with file tree + right content area with viewer/editor.

    File tree:
    - "Persistent Memory" section header
      - MEMORY.md (always first, with edit icon indicating it's editable)
    - "Daily Memory" section header
      - Daily files sorted newest first (2026-02-17.md, 2026-02-16.md, etc.)
    - Active file highlighted
    - Search result files get a subtle highlight/badge when search matches

    Content area:
    - For MEMORY.md: Use @uiw/react-md-editor (dynamic import, ssr: false) in "live" mode for editing. Auto-save via useDebouncedCallback (500ms), same pattern as identity editor.
    - For daily files: Use @uiw/react-md-editor in "preview" mode (read-only). Show a "Read only" badge at the top.
    - Wrap editor in `data-color-mode="dark"` for theme consistency.

    **Step 4: Create AgentMemoryView at `src/views/agents/agent-memory-view.tsx`.**

    "use client" component. Takes agentId prop.
    - Page header: "Memory" with file count
    - AgentMemorySearch at top
    - AgentMemoryBrowser below with file list and viewer/editor
    - Loading skeleton: file tree skeleton + content area skeleton

    **Step 5: Create page route at `app/(dashboard)/agents/[agentId]/memory/page.tsx`.**

    Async server component, awaits params, renders AgentMemoryView.
  </action>
  <verify>
    `bun run build` succeeds. Navigate to /agents/[id]/memory -- see file tree on left (MEMORY.md + daily files), content area on right. Click MEMORY.md -- shows editable markdown editor. Click a daily file -- shows read-only preview. Search filters/highlights matching files.
  </verify>
  <done>
    Memory page at /agents/[agentId]/memory shows categorized file browser with MEMORY.md (editable with auto-save) and daily files (read-only preview). Search finds content across all memory files.
  </done>
</task>

</tasks>

<verification>
- `bun run lint` passes
- `bun run build` succeeds
- /agents/[agentId]/sessions shows data table with mock session data
- Sessions table supports sorting by date and token count
- Sessions table supports filtering by status
- /agents/[agentId]/memory shows file tree + content viewer
- MEMORY.md is editable with auto-save
- Daily files are read-only
- Memory search filters files by content
- Both pages render inside the agent detail layout with sidebar
</verification>

<success_criteria>
- Sessions table displays all required fields (ID, status, tokens, compactions, duration)
- Memory browser shows categorized file tree with persistent and daily memory
- MEMORY.md editable, daily files read-only
- Search functional across memory contents
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-management/03-05-SUMMARY.md`
</output>
