---
phase: 03-agent-management
plan: 06
type: execute
wave: 3
depends_on:
  - "03-02"
files_modified:
  - src/features/agents/api/use-agent-skills.ts
  - src/features/agents/api/use-agent-logs.ts
  - src/features/agents/api/use-agent-metrics.ts
  - src/features/agents/components/agent-skills-grid.tsx
  - src/features/agents/components/agent-tools-config.tsx
  - src/features/agents/components/agent-sandbox-form.tsx
  - src/features/agents/components/agent-channels-table.tsx
  - src/features/agents/components/agent-logs-table.tsx
  - src/features/agents/components/agent-metrics-charts.tsx
  - src/features/agents/schemas/config-schemas.ts
  - src/views/agents/agent-skills-view.tsx
  - src/views/agents/agent-tools-view.tsx
  - src/views/agents/agent-sandbox-view.tsx
  - src/views/agents/agent-channels-view.tsx
  - src/views/agents/agent-logs-view.tsx
  - src/views/agents/agent-metrics-view.tsx
  - app/(dashboard)/agents/[agentId]/skills/page.tsx
  - app/(dashboard)/agents/[agentId]/tools/page.tsx
  - app/(dashboard)/agents/[agentId]/sandbox/page.tsx
  - app/(dashboard)/agents/[agentId]/channels/page.tsx
  - app/(dashboard)/agents/[agentId]/logs/page.tsx
  - app/(dashboard)/agents/[agentId]/metrics/page.tsx
autonomous: true
requirements:
  - AGNT-08
  - AGNT-09
  - AGNT-10
  - AGNT-11
  - AGNT-12
  - AGNT-13

must_haves:
  truths:
    - "User can manage agent skills (view installed, enable/disable) at /agents/[agentId]/skills"
    - "User can configure agent tool allow/deny lists at /agents/[agentId]/tools"
    - "User can configure agent sandbox mode and Docker settings at /agents/[agentId]/sandbox"
    - "User can view channel routing at /agents/[agentId]/channels"
    - "User can view agent activity log with tool calls and errors at /agents/[agentId]/logs"
    - "User can view agent metrics (tokens, cost, tasks, response times) at /agents/[agentId]/metrics"
  artifacts:
    - path: "src/features/agents/components/agent-skills-grid.tsx"
      provides: "Skills card grid with enable/disable toggles"
      exports: ["AgentSkillsGrid"]
    - path: "src/features/agents/components/agent-tools-config.tsx"
      provides: "Tool allow/deny list configuration"
      exports: ["AgentToolsConfig"]
    - path: "src/features/agents/components/agent-sandbox-form.tsx"
      provides: "Sandbox configuration form"
      exports: ["AgentSandboxForm"]
    - path: "src/features/agents/components/agent-channels-table.tsx"
      provides: "Read-only channel routing table"
      exports: ["AgentChannelsTable"]
    - path: "src/features/agents/components/agent-logs-table.tsx"
      provides: "Activity log table with virtual scrolling"
      exports: ["AgentLogsTable"]
    - path: "src/features/agents/components/agent-metrics-charts.tsx"
      provides: "Metrics charts (tokens, cost, tasks, response times)"
      exports: ["AgentMetricsCharts"]
    - path: "app/(dashboard)/agents/[agentId]/skills/page.tsx"
      provides: "Route for /agents/[agentId]/skills"
    - path: "app/(dashboard)/agents/[agentId]/tools/page.tsx"
      provides: "Route for /agents/[agentId]/tools"
    - path: "app/(dashboard)/agents/[agentId]/sandbox/page.tsx"
      provides: "Route for /agents/[agentId]/sandbox"
    - path: "app/(dashboard)/agents/[agentId]/channels/page.tsx"
      provides: "Route for /agents/[agentId]/channels"
    - path: "app/(dashboard)/agents/[agentId]/logs/page.tsx"
      provides: "Route for /agents/[agentId]/logs"
    - path: "app/(dashboard)/agents/[agentId]/metrics/page.tsx"
      provides: "Route for /agents/[agentId]/metrics"
  key_links:
    - from: "src/features/agents/components/agent-metrics-charts.tsx"
      to: "recharts"
      via: "AreaChart, BarChart via shadcn Chart wrapper"
      pattern: "ChartContainer"
    - from: "src/features/agents/components/agent-logs-table.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer for virtual scrolling"
      pattern: "useVirtualizer"
---

<objective>
Six remaining agent sub-pages: skills, tools, sandbox, channels, logs, and metrics.

Purpose: Completes all agent detail sub-pages so users can manage every aspect of their agents from the sidebar navigation.
Output: Skills grid with toggles, tool allow/deny config, sandbox form, channel routing table, activity log with virtual scrolling, and metrics charts.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-management/03-RESEARCH.md
@.planning/phases/03-agent-management/03-CONTEXT.md
@.planning/phases/03-agent-management/03-02-SUMMARY.md
@src/entities/agent/model/types.ts
@src/widgets/agent-detail-layout/components/agent-detail-shell.tsx
@src/features/agents/model/agent-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Skills, tools, and sandbox sub-pages</name>
  <files>
    src/features/agents/api/use-agent-skills.ts
    src/features/agents/components/agent-skills-grid.tsx
    src/features/agents/components/agent-tools-config.tsx
    src/features/agents/components/agent-sandbox-form.tsx
    src/features/agents/schemas/config-schemas.ts
    src/views/agents/agent-skills-view.tsx
    src/views/agents/agent-tools-view.tsx
    src/views/agents/agent-sandbox-view.tsx
    app/(dashboard)/agents/[agentId]/skills/page.tsx
    app/(dashboard)/agents/[agentId]/tools/page.tsx
    app/(dashboard)/agents/[agentId]/sandbox/page.tsx
  </files>
  <action>
    **Step 1: Create config schemas at `src/features/agents/schemas/config-schemas.ts`.**

    Use `import { z } from "zod/v4"`. Define:
    - `sandboxConfigSchema`: enabled (boolean), image (string), workspacePath (string)
    - `toolConfigSchema`: name (string), allowed (boolean), elevated (boolean)

    **Step 2: Create useAgentSkills hook at `src/features/agents/api/use-agent-skills.ts`.**

    - Fetches skills for agentId via TanStack Query
    - Returns `{ skills: AgentSkill[], isLoading, toggleSkill(skillId, enabled) }`
    - Mock data: 8 skills (code-analysis, web-search, git-operations, summarization, data-processing, file-management, image-generation, task-planning) with mixed enabled states and sources (built-in, clawhub, custom)
    - `toggleSkill` mutation updates local state + shows toast

    **Step 3: Create AgentSkillsGrid at `src/features/agents/components/agent-skills-grid.tsx`.**

    Per research discretion: inline toggle switches for skills.
    - Card grid: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4`
    - Each card: skill name, description, source badge (built-in/clawhub/custom), Switch toggle for enable/disable
    - Toggle calls `toggleSkill(skillId, newState)`
    - "Install from ClawHub" button at the bottom (links to /skills/clawhub -- future page, show as disabled with tooltip)

    **Step 4: Create AgentToolsConfig at `src/features/agents/components/agent-tools-config.tsx`.**

    Per research discretion: inline editing with expandable sections.
    - Two sections: "Allowed Tools" and "Denied Tools"
    - Each tool: name, description, Switch toggle (moves between allowed/denied)
    - Expandable section per tool for "elevated" configuration (checkbox for elevated access)
    - Mock data: 10 tools (Read, Write, Bash, Grep, Glob, WebFetch, WebSearch, Edit, Task, TodoWrite) with mixed allowed/denied states
    - Changes saved via mutation with toast feedback

    **Step 5: Create AgentSandboxForm at `src/features/agents/components/agent-sandbox-form.tsx`.**

    Per research discretion: inline form (few fields, all visible at once).
    - react-hook-form with zodResolver(sandboxConfigSchema)
    - Fields: Sandbox mode (Switch), Docker image (Input, text), Workspace path (Input, text)
    - Smart defaults shown as placeholder text
    - Submit button "Save Configuration" with loading state
    - Mock save via mutation + toast

    **Step 6: Create view components and page routes for each sub-page.**

    Each view follows the same pattern:
    - "use client" component taking agentId prop
    - Page header with title
    - Data hook for loading
    - Loading/error states
    - Renders the feature component

    Each page route:
    - Async server component, awaits params, renders view
    - Metadata with appropriate title

    `agent-skills-view.tsx` / `skills/page.tsx`
    `agent-tools-view.tsx` / `tools/page.tsx`
    `agent-sandbox-view.tsx` / `sandbox/page.tsx`
  </action>
  <verify>
    `bun run build` succeeds. Navigate to /agents/[id]/skills -- see skill cards with toggles. Navigate to /agents/[id]/tools -- see allow/deny tool lists. Navigate to /agents/[id]/sandbox -- see config form.
  </verify>
  <done>
    Skills page shows card grid with enable/disable toggles. Tools page shows allow/deny lists with expandable elevated config. Sandbox page shows inline configuration form.
  </done>
</task>

<task type="auto">
  <name>Task 2: Channels, logs, and metrics sub-pages</name>
  <files>
    src/features/agents/api/use-agent-logs.ts
    src/features/agents/api/use-agent-metrics.ts
    src/features/agents/components/agent-channels-table.tsx
    src/features/agents/components/agent-logs-table.tsx
    src/features/agents/components/agent-metrics-charts.tsx
    src/views/agents/agent-channels-view.tsx
    src/views/agents/agent-logs-view.tsx
    src/views/agents/agent-metrics-view.tsx
    app/(dashboard)/agents/[agentId]/channels/page.tsx
    app/(dashboard)/agents/[agentId]/logs/page.tsx
    app/(dashboard)/agents/[agentId]/metrics/page.tsx
  </files>
  <action>
    **Step 1: Create AgentChannelsTable at `src/features/agents/components/agent-channels-table.tsx`.**

    Per research discretion: read-only table (editing is in Phase 7).
    - Simple table with columns: Channel Name, Channel Type (badge: whatsapp, telegram, discord, slack), Routing Rule, Status (badge: connected, disconnected)
    - Mock data: 3-4 channel bindings
    - No edit actions -- "Channel configuration is managed in the Channels section" note at bottom
    - Link to /channels (future, disabled) for full channel management

    **Step 2: Create useAgentLogs hook at `src/features/agents/api/use-agent-logs.ts`.**

    - TanStack Query fetches log entries for agentId
    - Returns `{ logs: AgentLogEntry[], isLoading, error }`
    - Mock data: 50 log entries with varied event types (tool_call, message, error, status_change, compaction), realistic timestamps, summaries, and statuses
    - Add `// TODO: Wire to WebSocket Event Bus for real-time log streaming`

    **Step 3: Create AgentLogsTable at `src/features/agents/components/agent-logs-table.tsx`.**

    "use client" component with virtual scrolling for performance.
    - Uses @tanstack/react-virtual's `useVirtualizer` for the row container
    - Columns: Timestamp (formatted relative time), Event Type (color-coded badge), Summary (truncated, expandable on click), Status (success/error/pending badge)
    - Filter dropdown by event type (all, tool_call, message, error, status_change, compaction)
    - Estimated row height: 40px
    - Container height: `h-[calc(100vh-16rem)]` for full page scrolling
    - Expand row on click to show `details` JSON (if present)

    **Step 4: Create useAgentMetrics hook at `src/features/agents/api/use-agent-metrics.ts`.**

    - TanStack Query fetches metrics for agentId
    - Returns `{ metrics: AgentMetrics, isLoading, error }`
    - Mock data: 14 days of token usage (increasing trend), cost breakdown, tasks completed (varying), response times (stable ~2-5s range)
    - Add `// TODO: Replace with gatewayClient.agent.metrics(agentId)`

    **Step 5: Create AgentMetricsCharts at `src/features/agents/components/agent-metrics-charts.tsx`.**

    Follow RESEARCH.md Code Example for Metrics Charts. Use shadcn Chart component (ChartContainer, ChartTooltip, ChartTooltipContent) wrapping Recharts.

    Layout: 2x2 grid on lg, 1 column on mobile.

    Four charts:
    1. **Token Usage** (AreaChart): area chart with primary color fill, date on X axis, tokens on Y axis
    2. **Cost Breakdown** (AreaChart): area chart with warning color, date vs cost
    3. **Tasks Completed** (BarChart): bar chart with success color, date vs count
    4. **Response Times** (AreaChart): area chart with secondary color, date vs avgMs

    Each chart:
    - Title label above
    - CartesianGrid with strokeDasharray
    - XAxis (date), YAxis
    - ChartTooltip with ChartTooltipContent
    - Min height 200px
    - Import specific Recharts components (NOT `import *`) per Pitfall 6

    Include a time range selector at the top: "7 days", "14 days", "30 days" as Button group (only visual for now, defaults to 14 days).

    **Step 6: Create view components and page routes.**

    Same pattern as Task 1:

    `agent-channels-view.tsx` / `channels/page.tsx`:
    - Mock channel data inline (no separate hook needed, small dataset)

    `agent-logs-view.tsx` / `logs/page.tsx`:
    - Uses useAgentLogs, renders AgentLogsTable
    - Page header "Activity Logs" with log count

    `agent-metrics-view.tsx` / `metrics/page.tsx`:
    - Uses useAgentMetrics, renders AgentMetricsCharts
    - Page header "Metrics" with time range selector
  </action>
  <verify>
    `bun run build` succeeds. Navigate to /agents/[id]/channels -- see read-only channel table. Navigate to /agents/[id]/logs -- see log table with virtual scrolling, event type filter, and expandable rows. Navigate to /agents/[id]/metrics -- see 4 charts (token usage, cost, tasks, response times) with mock data.
  </verify>
  <done>
    Channels page shows read-only routing table. Logs page shows virtually-scrolled activity log with event type filtering and expandable details. Metrics page shows 4 Recharts charts for token usage, cost, tasks completed, and response times.
  </done>
</task>

</tasks>

<verification>
- `bun run lint` passes
- `bun run build` succeeds
- All 6 sub-pages render inside the agent detail layout with sidebar
- /agents/[agentId]/skills: card grid with enable/disable toggles
- /agents/[agentId]/tools: allow/deny tool lists with toggle switches
- /agents/[agentId]/sandbox: config form with sandbox mode switch, Docker image, workspace path
- /agents/[agentId]/channels: read-only routing table with channel names, types, and statuses
- /agents/[agentId]/logs: virtually-scrolled log table with event type filter and expandable rows
- /agents/[agentId]/metrics: 4 charts rendering with mock data
- All sidebar navigation links are now functional (every sub-page has content)
</verification>

<success_criteria>
- All 6 remaining sub-pages implemented and accessible from sidebar
- Skills toggle, tools config, and sandbox form are interactive
- Channels table is read-only with appropriate messaging
- Logs use virtual scrolling for performance
- Metrics charts render correctly with shadcn Chart + Recharts
- Every sub-page in the sidebar navigation now resolves to a working page
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-management/03-06-SUMMARY.md`
</output>
