---
phase: 03-agent-management
plan: 03
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/features/agents/model/wizard-store.ts
  - src/features/agents/schemas/wizard-schemas.ts
  - src/features/agents/wizard/wizard-shell.tsx
  - src/features/agents/wizard/step-basics.tsx
  - src/features/agents/wizard/step-model-config.tsx
  - src/features/agents/wizard/step-identity.tsx
  - src/features/agents/wizard/step-skills-tools.tsx
  - src/features/agents/wizard/step-sandbox.tsx
  - src/features/agents/wizard/step-channels.tsx
  - src/features/agents/wizard/step-review.tsx
  - src/features/agents/components/agent-template-card.tsx
  - src/views/agents/agent-creation-view.tsx
  - src/views/agents/agent-templates-view.tsx
  - app/(dashboard)/agents/new/page.tsx
  - app/(dashboard)/agents/templates/page.tsx
autonomous: true
requirements:
  - AGNT-03
  - AGNT-04

must_haves:
  truths:
    - "User can create a new agent at /agents/new via a multi-step wizard"
    - "Wizard covers 7 steps: basics, model config, identity files, skills & tools, sandbox config, channel routing, and review"
    - "Each wizard step has smart defaults pre-filled"
    - "Name + model are the minimum required; all other steps can be skipped"
    - "User can browse pre-built templates at /agents/templates in a visual gallery"
    - "Selecting a template pre-populates wizard steps with that template's config"
    - "User can clone an existing agent by loading its config into the wizard"
    - "Completing the wizard adds the new agent to the roster"
  artifacts:
    - path: "src/features/agents/model/wizard-store.ts"
      provides: "Zustand store for wizard cross-step state with sessionStorage persist"
      exports: ["useWizardStore"]
    - path: "src/features/agents/schemas/wizard-schemas.ts"
      provides: "Per-step Zod validation schemas"
      exports: ["basicsSchema", "modelConfigSchema"]
    - path: "src/features/agents/wizard/wizard-shell.tsx"
      provides: "Wizard layout with step navigation and progress"
      exports: ["WizardShell"]
    - path: "src/views/agents/agent-creation-view.tsx"
      provides: "Creation wizard page composition"
      exports: ["AgentCreationView"]
    - path: "src/views/agents/agent-templates-view.tsx"
      provides: "Template gallery page composition"
      exports: ["AgentTemplatesView"]
    - path: "app/(dashboard)/agents/new/page.tsx"
      provides: "Next.js route for /agents/new"
    - path: "app/(dashboard)/agents/templates/page.tsx"
      provides: "Next.js route for /agents/templates"
  key_links:
    - from: "src/features/agents/wizard/step-basics.tsx"
      to: "src/features/agents/model/wizard-store.ts"
      via: "reads/writes wizard state"
      pattern: "useWizardStore"
    - from: "src/features/agents/wizard/step-basics.tsx"
      to: "src/features/agents/schemas/wizard-schemas.ts"
      via: "zodResolver for per-step validation"
      pattern: "zodResolver.*basicsSchema"
    - from: "src/features/agents/wizard/step-review.tsx"
      to: "src/features/agents/api/use-agent-mutations.ts"
      via: "useCreateAgent mutation to submit"
      pattern: "useCreateAgent"
    - from: "src/views/agents/agent-templates-view.tsx"
      to: "src/entities/agent/model/templates.ts"
      via: "imports AGENT_TEMPLATES"
      pattern: "AGENT_TEMPLATES"
---

<objective>
Multi-step agent creation wizard at /agents/new and template gallery at /agents/templates.

Purpose: Users can create new agents from scratch or from templates, with a deep wizard that covers all configuration while remaining skippable via smart defaults.
Output: 7-step wizard with per-step validation, Zustand wizard store with sessionStorage persistence, template gallery, and both pages.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-management/03-RESEARCH.md
@.planning/phases/03-agent-management/03-CONTEXT.md
@.planning/phases/03-agent-management/03-01-SUMMARY.md
@src/entities/agent/model/types.ts
@src/entities/agent/model/templates.ts
@src/features/agents/model/agent-store.ts
@src/features/agents/api/use-agent-mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wizard store, schemas, and step components</name>
  <files>
    src/features/agents/model/wizard-store.ts
    src/features/agents/schemas/wizard-schemas.ts
    src/features/agents/wizard/wizard-shell.tsx
    src/features/agents/wizard/step-basics.tsx
    src/features/agents/wizard/step-model-config.tsx
    src/features/agents/wizard/step-identity.tsx
    src/features/agents/wizard/step-skills-tools.tsx
    src/features/agents/wizard/step-sandbox.tsx
    src/features/agents/wizard/step-channels.tsx
    src/features/agents/wizard/step-review.tsx
  </files>
  <action>
    **Step 1: Create wizard Zod schemas at `src/features/agents/schemas/wizard-schemas.ts`.**

    Use `import { z } from "zod/v4"` (project convention). Create per-step schemas as shown in RESEARCH.md Pattern 4:
    - `basicsSchema`: name (min 2, max 64), description (max 500, optional, default ""), avatar (url, optional)
    - `modelConfigSchema`: model (min 1, required), temperature (0-2, default 0.7), maxTokens (256-200000, default 4096)
    - `identitySchema`: soul, identity, user, agents (all string, default "")
    - `skillsToolsSchema`: skills (string[]), tools (string[]), deniedTools (string[])
    - `sandboxSchema`: enabled (boolean, default false), image (string, default "node:20-slim"), workspacePath (string, default "/workspace")
    - `channelsSchema`: bindings (array of {channelId, rule})

    **Step 2: Create wizard Zustand store at `src/features/agents/model/wizard-store.ts`.**

    Follow RESEARCH.md Pattern 4. Key addition: Use `persist` middleware with `sessionStorage` to survive browser back/forward navigation (per Pitfall 2 in research):
    ```ts
    import { create } from "zustand";
    import { persist, createJSONStorage } from "zustand/middleware";
    ```

    State shape: currentStep (number), basics, modelConfig, identity, skillsTools, sandbox, channels (all nullable objects matching their Zod schemas).

    Actions: setStep, setBasics, setModelConfig, setIdentity, setSkillsTools, setSandbox, setChannels, loadTemplate (takes AgentTemplate, populates all fields), loadAgent (takes Agent, populates for cloning), reset (clears all back to defaults).

    Smart defaults: modelConfig defaults to { model: "claude-sonnet-4-20250514", temperature: 0.7, maxTokens: 4096 }. Sandbox defaults to { enabled: false, image: "node:20-slim", workspacePath: "/workspace" }.

    **Step 3: Create WizardShell at `src/features/agents/wizard/wizard-shell.tsx`.**

    "use client" component. Renders the wizard layout:
    - Step progress indicator at the top: 7 numbered circles connected by lines, current step highlighted, completed steps shown with checkmark
    - Step labels: "Basics", "Model", "Identity", "Skills & Tools", "Sandbox", "Channels", "Review"
    - Content area renders the current step component
    - Navigation buttons: "Back" (disabled on step 0), "Skip" (advances without validating, except step 0 which requires name+model), "Next" (validates current step), "Create Agent" (on review step)
    - Uses useWizardStore for currentStep and setStep

    **Step 4: Create step components (one per wizard step).**

    Each step is a "use client" component following the pattern in RESEARCH.md:
    - Uses react-hook-form with zodResolver for the step's schema
    - Reads initial values from useWizardStore (pre-populated from template or previous visit)
    - On "Next", validates via form.handleSubmit, writes to wizard store, calls onNext()
    - On "Skip", writes current form values (even if incomplete) to store, calls onNext()

    **step-basics.tsx**: Name input (required), Description textarea, Avatar URL input. This step cannot be skipped -- name is required per user decision.

    **step-model-config.tsx**: Model select dropdown (hardcoded list of popular models: claude-sonnet-4-20250514, claude-haiku-4-20250414, gpt-4o, gemini-2.5-flash, etc.). Temperature slider (0-2, step 0.1). Max tokens input (numeric).

    **step-identity.tsx**: Four textarea fields for SOUL.md, IDENTITY.md, USER.md, AGENTS.md. If loaded from template, shows pre-filled content. If from scratch, shows template starter content with section headers and guidance comments. Each textarea has a label showing the file name.

    **step-skills-tools.tsx**: Skills section with checkboxes (mock list: code-analysis, web-search, git-operations, summarization, data-processing). Tools section with checkboxes (Read, Write, Bash, Grep, Glob, WebFetch, WebSearch). Denied tools section with checkboxes for the same tools list.

    **step-sandbox.tsx**: Sandbox mode Switch toggle. Docker image Input (text). Workspace path Input (text). All have smart defaults shown.

    **step-channels.tsx**: Simple repeatable fieldset: channelId select + rule input. "Add binding" button. "Remove" button per row. For now, channel list is empty with a note "Channels will be available after gateway connection."

    **step-review.tsx**: Read-only summary of all wizard data. Organized in sections matching the steps. Each section shows the data or "Skipped (using defaults)". "Create Agent" button at the bottom calls useCreateAgent mutation, shows success toast, resets wizard store, and redirects to /agents.
  </action>
  <verify>
    `bun run build` succeeds. All step components import and render without errors. Wizard store persists data in sessionStorage.
  </verify>
  <done>
    Seven wizard step components with per-step Zod validation, Zustand wizard store with sessionStorage persistence, and WizardShell layout are implemented. Smart defaults pre-fill all optional steps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Creation page, template gallery, and routing</name>
  <files>
    src/features/agents/components/agent-template-card.tsx
    src/views/agents/agent-creation-view.tsx
    src/views/agents/agent-templates-view.tsx
    app/(dashboard)/agents/new/page.tsx
    app/(dashboard)/agents/templates/page.tsx
  </files>
  <action>
    **Step 1: Create AgentTemplateCard at `src/features/agents/components/agent-template-card.tsx`.**

    Per user decision: visual gallery of pre-built templates.
    - Card with icon (from lucide-react, mapped from template.icon string), template name, description, and category badge
    - "Use Template" button that calls useWizardStore's loadTemplate, then navigates to /agents/new
    - Hover effect similar to agent cards but without status glow

    **Step 2: Create AgentTemplatesView at `src/views/agents/agent-templates-view.tsx`.**

    "use client" component.
    - Page header: "Agent Templates" title + "Choose a template to get started quickly" description
    - Renders AGENT_TEMPLATES from @/entities/agent in a grid: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4`
    - Each template renders AgentTemplateCard
    - Below the templates grid, a section "Clone an Existing Agent" with a Select dropdown listing agents from useAgentStore. Selecting an agent loads its config into the wizard store via loadAgent and navigates to /agents/new.
    - "Or start from scratch" link at bottom navigating to /agents/new (which clears the wizard store)

    **Step 3: Create AgentCreationView at `src/views/agents/agent-creation-view.tsx`.**

    "use client" component.
    - Page header: "Create Agent" title + breadcrumb-style link back to /agents
    - Renders WizardShell
    - On wizard complete (create mutation success), shows success toast and navigates to /agents

    **Step 4: Create page routes.**

    `app/(dashboard)/agents/new/page.tsx`:
    ```tsx
    import { AgentCreationView } from "@/views/agents/agent-creation-view";
    export const metadata = { title: "New Agent | AXion Hub" };
    export default function NewAgentPage() {
      return <AgentCreationView />;
    }
    ```

    `app/(dashboard)/agents/templates/page.tsx`:
    ```tsx
    import { AgentTemplatesView } from "@/views/agents/agent-templates-view";
    export const metadata = { title: "Agent Templates | AXion Hub" };
    export default function AgentTemplatesPage() {
      return <AgentTemplatesView />;
    }
    ```
  </action>
  <verify>
    `bun run build` succeeds. Navigate to /agents/templates -- see template gallery with 5 cards. Click "Use Template" -- navigates to /agents/new with wizard pre-populated. Navigate to /agents/new directly -- wizard starts empty with smart defaults. Complete wizard -- agent appears in roster at /agents.
  </verify>
  <done>
    /agents/new renders the 7-step creation wizard. /agents/templates shows a visual gallery of pre-built templates. Selecting a template pre-populates the wizard. Completing the wizard creates an agent and navigates to the roster.
  </done>
</task>

</tasks>

<verification>
- `bun run lint` passes
- `bun run build` succeeds
- /agents/new renders wizard with 7 steps and step progress indicator
- Name + model are required; skipping step 1 without name shows validation error
- Other steps can be skipped (smart defaults used)
- Review step shows all accumulated data
- "Create Agent" adds agent to roster and redirects to /agents
- /agents/templates shows 5 template cards in a grid
- Clicking "Use Template" loads template config into wizard
- Wizard state persists through browser back/forward (sessionStorage)
</verification>

<success_criteria>
- Multi-step wizard functional with per-step validation
- Template gallery functional with pre-population
- New agents appear in roster after creation
- Wizard state survives browser navigation via sessionStorage
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-management/03-03-SUMMARY.md`
</output>
