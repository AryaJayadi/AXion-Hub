---
phase: 02-authentication-app-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/auth/lib/auth.ts
  - src/features/auth/lib/auth-client.ts
  - src/features/auth/lib/email.ts
  - src/features/auth/schemas/auth-schemas.ts
  - src/entities/user/model/auth-schema.ts
  - app/api/auth/[...all]/route.ts
  - app/proxy.ts
  - .env.example
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-06
user_setup:
  - service: google-oauth
    why: "Google OAuth login"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: http://localhost:3000/api/auth/callback/google"
        location: "OAuth 2.0 Client ID -> Authorized redirect URIs"
  - service: github-oauth
    why: "GitHub OAuth login"
    env_vars:
      - name: GITHUB_CLIENT_ID
        source: "GitHub Settings -> Developer settings -> OAuth Apps"
      - name: GITHUB_CLIENT_SECRET
        source: "GitHub Settings -> Developer settings -> OAuth Apps"
    dashboard_config:
      - task: "Create a new OAuth App"
        location: "GitHub Settings -> Developer settings -> OAuth Apps -> New OAuth App"
      - task: "Set callback URL to http://localhost:3000/api/auth/callback/github"
        location: "OAuth App settings -> Authorization callback URL"
  - service: smtp
    why: "Email verification and password reset emails"
    env_vars:
      - name: SMTP_HOST
        source: "Your SMTP provider (or localhost:1025 for Mailpit in dev)"
      - name: SMTP_PORT
        source: "Your SMTP provider (typically 587)"
      - name: SMTP_USER
        source: "Your SMTP provider credentials"
      - name: SMTP_PASS
        source: "Your SMTP provider credentials"
      - name: EMAIL_FROM
        source: "Desired sender address (e.g., noreply@yourdomain.com)"

must_haves:
  truths:
    - "better-auth server instance is configured with email/password, OAuth (Google, GitHub), email verification, password reset, organization plugin, and session management"
    - "Drizzle schema includes user, session, account, verification, organization, member, and invitation tables"
    - "API route at /api/auth/[...all] handles all auth requests"
    - "proxy.ts redirects unauthenticated users to /login and authenticated users away from auth pages"
    - "Auth client exports signIn, signUp, signOut, useSession, organization methods"
    - "Email utility sends verification and password reset emails via nodemailer"
    - "Zod schemas validate login, register, forgot-password, and reset-password forms"
  artifacts:
    - path: "src/features/auth/lib/auth.ts"
      provides: "better-auth server configuration"
      contains: "betterAuth"
    - path: "src/features/auth/lib/auth-client.ts"
      provides: "better-auth client instance with organization plugin"
      exports: ["authClient", "signIn", "signUp", "signOut", "useSession"]
    - path: "src/features/auth/lib/email.ts"
      provides: "Email sending utility via nodemailer"
      exports: ["sendEmail"]
    - path: "src/features/auth/schemas/auth-schemas.ts"
      provides: "Zod validation schemas for all auth forms"
      exports: ["loginSchema", "registerSchema", "forgotPasswordSchema", "resetPasswordSchema"]
    - path: "src/entities/user/model/auth-schema.ts"
      provides: "Drizzle schema for better-auth tables"
      contains: "pgTable"
    - path: "app/api/auth/[...all]/route.ts"
      provides: "better-auth API route handler"
      exports: ["GET", "POST"]
    - path: "app/proxy.ts"
      provides: "Route protection via cookie check"
      exports: ["proxy"]
  key_links:
    - from: "app/api/auth/[...all]/route.ts"
      to: "src/features/auth/lib/auth.ts"
      via: "import and toNextJsHandler"
      pattern: "toNextJsHandler\\(auth\\)"
    - from: "src/features/auth/lib/auth.ts"
      to: "src/entities/user/model/auth-schema.ts"
      via: "drizzleAdapter using db connection"
      pattern: "drizzleAdapter"
    - from: "src/features/auth/lib/auth.ts"
      to: "src/features/auth/lib/email.ts"
      via: "sendEmail in verification and reset callbacks"
      pattern: "sendEmail"
    - from: "app/proxy.ts"
      to: "better-auth/cookies"
      via: "getSessionCookie for cookie existence check"
      pattern: "getSessionCookie"
---

<objective>
Set up the better-auth server configuration, Drizzle auth schema, API route handler, email utility, auth client, validation schemas, and route protection proxy. This is the authentication foundation that all subsequent auth plans build on.

Purpose: Establish the complete auth backend so that auth pages (Plan 02), app shell (Plan 03), and org features (Plan 04) can build on working auth infrastructure.
Output: Working better-auth server with email/password + OAuth + organizations + email verification + password reset, plus route protection and form validation schemas.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-app-shell/02-RESEARCH.md
@.planning/phases/02-authentication-app-shell/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and generate better-auth Drizzle schema</name>
  <files>
    package.json
    src/entities/user/model/auth-schema.ts
  </files>
  <action>
    Install required dependencies:
    ```bash
    bun add better-auth@^1.4.18 react-hook-form@^7.71.1 @hookform/resolvers nodemailer
    bun add -D @types/nodemailer
    ```

    Create the better-auth server config file at `src/features/auth/lib/auth.ts` (temporary minimal version just for schema generation — will be replaced in Task 2):
    ```typescript
    import { betterAuth } from "better-auth";
    import { organization } from "better-auth/plugins";
    export const auth = betterAuth({
      database: { url: process.env.DATABASE_URL! },
      emailAndPassword: { enabled: true },
      plugins: [organization()],
    });
    ```

    Generate the Drizzle schema from better-auth config:
    ```bash
    bunx @better-auth/cli@latest generate --output src/entities/user/model/auth-schema.ts
    ```

    This generates tables: user, session, account, verification, organization, member, invitation.

    After generation, verify the schema file exists and contains all expected tables. The generated file should use `pgTable` from drizzle-orm/pg-core. Ensure all tables are exported.

    Register the auth schema in the Drizzle config so migrations pick it up. Check if there's an existing `drizzle.config.ts` or `src/shared/lib/db.ts` that references schemas — add the auth schema to it.

    Generate and apply the database migration:
    ```bash
    bunx drizzle-kit generate
    bunx drizzle-kit migrate
    ```

    Note: If the migration fails because the database isn't running, that's expected — Phase 1's Docker setup provides the database. The migration files should still be generated for later application.
  </action>
  <verify>
    - `src/entities/user/model/auth-schema.ts` exists and contains `user`, `session`, `account`, `verification`, `organization`, `member`, `invitation` table definitions
    - `bun run build` does not produce TypeScript errors related to auth schema
    - Migration SQL files exist in the drizzle migrations directory
  </verify>
  <done>
    Auth schema file exists with all 7 better-auth tables (user, session, account, verification, organization, member, invitation) as Drizzle pgTable definitions. Migration files generated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure better-auth server, email utility, auth client, validation schemas, API route, and proxy.ts</name>
  <files>
    src/features/auth/lib/auth.ts
    src/features/auth/lib/auth-client.ts
    src/features/auth/lib/email.ts
    src/features/auth/schemas/auth-schemas.ts
    app/api/auth/[...all]/route.ts
    app/proxy.ts
    .env.example
  </files>
  <action>
    **1. Email utility** (`src/features/auth/lib/email.ts`):
    Create nodemailer transporter using SMTP env vars. Export `sendEmail({ to, subject, html, text })`. In development (NODE_ENV=development), log email contents to console as fallback when SMTP is not configured. Wrap transporter.sendMail in try/catch — log errors but do not throw (fire-and-forget per research anti-patterns). Use `EMAIL_FROM` env var with default `"AXion Hub <noreply@axionhub.local>"`.

    **2. better-auth server config** (`src/features/auth/lib/auth.ts`):
    Replace the minimal temporary config from Task 1 with full configuration:
    - `baseURL`: from `BETTER_AUTH_URL` env var
    - `database`: Use `drizzleAdapter(db, { provider: "pg" })` — import db from `@/shared/lib/db` (Phase 1 provides this)
    - `emailAndPassword`: enabled, minPasswordLength: 8, maxPasswordLength: 128, requireEmailVerification: true, sendResetPassword callback using `sendEmail`
    - `emailVerification`: sendOnSignUp: true, sendVerificationEmail callback using `sendEmail`, autoSignInAfterVerification: true
    - `socialProviders.google`: clientId/clientSecret from env vars, prompt: "select_account"
    - `socialProviders.github`: clientId/clientSecret from env vars
    - `session`: expiresIn: 7 days (604800), updateAge: 1 day (86400), cookieCache enabled with maxAge 5 minutes (300)
    - `plugins`: [nextCookies(), organization({ allowUserToCreateOrganization: true, creatorRole: "owner", sendInvitationEmail callback using sendEmail })]
    - `databaseHooks.user.create.after`: Auto-create personal organization named "{user.name}'s Workspace" with slug `personal-{user.id}` (Claude's discretion: auto-create org per research recommendation)
    - Export `Session` type: `typeof auth.$Infer.Session`

    **3. Auth client** (`src/features/auth/lib/auth-client.ts`):
    Mark as `"use client"`. Create auth client with `createAuthClient({ plugins: [organizationClient()] })`. Export destructured: `authClient`, `signIn`, `signUp`, `signOut`, `useSession`, `useActiveOrganization`, `useListOrganizations`, `organization`.

    **4. Validation schemas** (`src/features/auth/schemas/auth-schemas.ts`):
    Create zod schemas exactly as shown in research Pattern 6:
    - `loginSchema`: email (string.email), password (string.min(1))
    - `registerSchema`: name (string.min(2)), email (string.email), password (string.min(8).max(128) + uppercase/lowercase/number regex), agreeToTerms (literal(true))
    - `forgotPasswordSchema`: email (string.email)
    - `resetPasswordSchema`: newPassword (string.min(8).max(128)), confirmPassword (string) + refine for match
    Export all schemas and their inferred types.

    **5. API route** (`app/api/auth/[...all]/route.ts`):
    Import auth from `@/features/auth/lib/auth`. Use `toNextJsHandler(auth)` to export `GET` and `POST`.

    **6. proxy.ts** (`app/proxy.ts`):
    Import `getSessionCookie` from `better-auth/cookies`. Check cookie existence only (NO database calls).
    - Auth pages (`/login`, `/register`, `/forgot-password`, `/reset-password`): redirect to `/` if session cookie exists
    - Public paths (`/login`, `/register`, `/forgot-password`, `/reset-password`, `/verify-email`, `/invite`, `/api/auth`): allow through
    - Everything else: redirect to `/login?callbackUrl={pathname}` if no session cookie
    - Matcher: exclude static files, images, favicon, sitemap, robots

    **7. .env.example**:
    Update .env.example (create if missing) with all required env vars:
    ```
    # Database (Phase 1)
    DATABASE_URL=postgresql://axion:axion@localhost:5432/axion_hub

    # better-auth
    BETTER_AUTH_URL=http://localhost:3000
    BETTER_AUTH_SECRET=change-me-to-a-random-string

    # OAuth - Google
    GOOGLE_CLIENT_ID=
    GOOGLE_CLIENT_SECRET=

    # OAuth - GitHub
    GITHUB_CLIENT_ID=
    GITHUB_CLIENT_SECRET=

    # Email (SMTP)
    SMTP_HOST=localhost
    SMTP_PORT=1025
    SMTP_SECURE=false
    SMTP_USER=
    SMTP_PASS=
    EMAIL_FROM=AXion Hub <noreply@axionhub.local>
    ```
  </action>
  <verify>
    - `bun run build` succeeds without TypeScript errors
    - `app/api/auth/[...all]/route.ts` exports GET and POST
    - `app/proxy.ts` exports proxy function and config
    - All 4 zod schemas parse valid input without errors: test by running a quick inline validation check
    - `src/features/auth/lib/auth.ts` imports drizzleAdapter, nextCookies, organization
    - `src/features/auth/lib/auth-client.ts` exports signIn, signUp, signOut, useSession
    - `.env.example` contains all required env vars
  </verify>
  <done>
    Complete auth backend infrastructure: better-auth server configured with email/password + OAuth + organizations + email verification + password reset + session management. Auth client ready for frontend use. Validation schemas ready for forms. API route mounted. Route protection via proxy.ts active. All env vars documented.
  </done>
</task>

</tasks>

<verification>
- `bun run build` passes without auth-related TypeScript errors
- Auth schema file contains all 7 better-auth tables
- better-auth server config includes all plugins and features
- proxy.ts uses cookie-only check (no database imports)
- API route correctly mounted at /api/auth/[...all]
</verification>

<success_criteria>
- better-auth server instance fully configured with email/password, OAuth (Google + GitHub), email verification, password reset, organization plugin, and cookie-cached sessions
- Drizzle schema generated with all auth tables (user, session, account, verification, organization, member, invitation)
- Auth client exports all needed methods for frontend (signIn, signUp, signOut, useSession, organization operations)
- Zod validation schemas ready for all auth forms (login, register, forgot-password, reset-password)
- API route handler at /api/auth/[...all] connects to better-auth server
- proxy.ts protects routes with fast cookie check (no DB calls)
- .env.example documents all required environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-app-shell/02-01-SUMMARY.md`
</output>
