---
phase: 02-authentication-app-shell
plan: 04
type: execute
wave: 3
depends_on:
  - "02-02"
  - "02-03"
files_modified:
  - app/(auth)/invite/[token]/page.tsx
  - src/features/auth/components/invite-acceptance.tsx
  - src/widgets/app-shell/components/org-switcher.tsx
  - src/widgets/app-shell/components/app-sidebar.tsx
autonomous: true
requirements:
  - AUTH-05

must_haves:
  truths:
    - "User clicking an invite link at /invite/[token] is redirected to login/register if unauthenticated, then auto-joins the organization after authenticating"
    - "Authenticated user clicking an invite link auto-accepts the invitation and redirects to the dashboard with the new org active"
    - "Org switcher in the sidebar header shows the current organization and lets the user switch between their organizations"
    - "Org switcher shows a 'Create organization' option"
    - "Invite token is preserved through the login/register flow via callbackUrl"
  artifacts:
    - path: "app/(auth)/invite/[token]/page.tsx"
      provides: "Invitation acceptance page"
      contains: "InviteAcceptance"
    - path: "src/features/auth/components/invite-acceptance.tsx"
      provides: "Client component handling invitation acceptance flow"
      contains: "acceptInvitation"
    - path: "src/widgets/app-shell/components/org-switcher.tsx"
      provides: "Organization switcher dropdown in sidebar header"
      contains: "useListOrganizations"
  key_links:
    - from: "src/features/auth/components/invite-acceptance.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "organization.acceptInvitation and organization.setActive"
      pattern: "acceptInvitation"
    - from: "src/widgets/app-shell/components/org-switcher.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "useListOrganizations and organization.setActive for switching"
      pattern: "useListOrganizations|setActive"
    - from: "app/(auth)/invite/[token]/page.tsx"
      to: "app/(auth)/login/page.tsx"
      via: "redirect to /login?callbackUrl=/invite/[token] when unauthenticated"
      pattern: "callbackUrl.*invite"
---

<objective>
Build the organization invitation acceptance flow and the org switcher component. Users can accept org invitations from email links (handling both authenticated and unauthenticated states), and switch between their organizations from the sidebar header.

Purpose: Enable multi-organization collaboration — users join orgs via invite links and switch between them. This completes the social/team dimension of auth.
Output: Working invitation acceptance page at /invite/[token] with auth redirect flow, and org switcher in the sidebar header.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-app-shell/02-RESEARCH.md
@.planning/phases/02-authentication-app-shell/02-CONTEXT.md
@.planning/phases/02-authentication-app-shell/02-01-SUMMARY.md
@.planning/phases/02-authentication-app-shell/02-02-SUMMARY.md
@.planning/phases/02-authentication-app-shell/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build invitation acceptance page and flow</name>
  <files>
    app/(auth)/invite/[token]/page.tsx
    src/features/auth/components/invite-acceptance.tsx
  </files>
  <action>
    Per locked decision: "Invitation flow: invite link leads to auth (register or login), then auto-joins the org -- no separate confirmation step."

    **1. Invite acceptance component** (`src/features/auth/components/invite-acceptance.tsx`):
    Mark as `"use client"`. This component handles the full invitation acceptance flow.

    Props: `token: string` (the invitation ID from the URL).

    States: `"checking" | "redirecting" | "accepting" | "success" | "error"`.

    Flow:
    1. On mount (`useEffect`), check if user is authenticated: `const { data: session } = await authClient.getSession()`
    2. **If NOT authenticated**: Set state to `"redirecting"`. Redirect to `/login?callbackUrl=/invite/${token}` using `router.push()`. The login page already preserves callbackUrl and will redirect back to `/invite/[token]` after auth. The register page links to login, so the flow works for new users too.
    3. **If authenticated**: Set state to `"accepting"`. Call `authClient.organization.acceptInvitation({ invitationId: token })`.
       - On success: Call `authClient.organization.setActive({ organizationId: data.member.organizationId })` to make the new org active. Set state to `"success"`. Redirect to `/` after a brief delay (1 second) so user sees the success message.
       - On error: Set state to `"error"`. Show error message. Common errors: invitation expired, already a member, invalid token. Show a "Go to dashboard" link.

    UI:
    - Centered card layout (NOT using auth-layout since this isn't a form page)
    - "checking": Spinner + "Checking invitation..."
    - "redirecting": Spinner + "Redirecting to sign in..."
    - "accepting": Spinner + "Joining organization..."
    - "success": Check icon + "You've joined {orgName}!" + "Redirecting to dashboard..."
    - "error": Alert icon + error message + "Go to dashboard" button

    **2. Invite page** (`app/(auth)/invite/[token]/page.tsx`):
    Renders the InviteAcceptance component with the token from params.

    ```tsx
    import { InviteAcceptance } from "@/features/auth/components/invite-acceptance";

    export default async function InvitePage({
      params,
    }: {
      params: Promise<{ token: string }>;
    }) {
      const { token } = await params;
      return (
        <div className="flex min-h-svh items-center justify-center">
          <InviteAcceptance token={token} />
        </div>
      );
    }
    ```

    Note: In Next.js 16, `params` is a Promise and must be awaited.
  </action>
  <verify>
    - `bun run build` passes
    - `app/(auth)/invite/[token]/page.tsx` exists and renders InviteAcceptance
    - `src/features/auth/components/invite-acceptance.tsx` calls `authClient.getSession`, `organization.acceptInvitation`, and `organization.setActive`
    - Component handles all states: checking, redirecting, accepting, success, error
    - Unauthenticated path redirects to `/login?callbackUrl=/invite/${token}`
  </verify>
  <done>
    Invitation acceptance page at /invite/[token] handles both authenticated (auto-accept + set active org + redirect) and unauthenticated (redirect to login with callbackUrl preserving invite token) flows. Shows loading/success/error states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build org switcher and integrate into sidebar</name>
  <files>
    src/widgets/app-shell/components/org-switcher.tsx
    src/widgets/app-shell/components/app-sidebar.tsx
  </files>
  <action>
    Per Claude's discretion recommendation from research: "Org switcher at top of sidebar (SidebarHeader). DropdownMenu showing current org name + chevron, with org list and 'Create organization' option."

    **1. Org switcher** (`src/widgets/app-shell/components/org-switcher.tsx`):
    Mark as `"use client"`. Uses better-auth client hooks for org data.

    Data:
    - `useActiveOrganization()` from auth-client — returns current active org
    - `useListOrganizations()` from auth-client — returns all user's orgs

    Structure:
    - Wrap in `<SidebarMenu><SidebarMenuItem>`:
    - Trigger: `<SidebarMenuButton size="lg">` containing:
      - Org avatar: colored circle with first letter of org name (use a deterministic color based on org id/name)
      - Org name (truncated if long)
      - `<ChevronsUpDown className="ml-auto" />` chevron icon
    - Content: `<DropdownMenuContent className="w-[--radix-dropdown-menu-trigger-width] min-w-56" align="start">`:
      - `<DropdownMenuLabel>`: "Organizations"
      - List of orgs from `useListOrganizations()`: each as `<DropdownMenuItem>` with org avatar + name. Active org has a check icon. On click: `authClient.organization.setActive({ organizationId: org.id })`.
      - `<DropdownMenuSeparator />`
      - `<DropdownMenuItem>`: `<Plus /> Create organization` — for now, this is a placeholder that logs a console message. Full org creation UI is out of scope for Phase 2.

    Handle loading state: Show skeleton while orgs load.
    Handle empty state: If no orgs (shouldn't happen due to auto-create), show "No organizations".

    When sidebar is collapsed to icon rail, the org switcher should show just the org avatar icon (the `SidebarMenuButton size="lg"` handles this automatically with the sidebar collapsible behavior — the text content is hidden in rail mode).

    **2. Update app-sidebar.tsx**:
    Import `OrgSwitcher` component. Replace the placeholder logo/name in `<SidebarHeader>` with `<OrgSwitcher />`.

    The sidebar structure should now be:
    ```
    <Sidebar collapsible="icon">
      <SidebarHeader>
        <OrgSwitcher />
      </SidebarHeader>
      <SidebarContent>
        {/* navigation groups */}
      </SidebarContent>
      <SidebarFooter>
        {/* empty or minimal app version label — do NOT place UserMenu here */}
      </SidebarFooter>
      <SidebarRail />
    </Sidebar>
    ```

    Per locked decision: "Header bar shows breadcrumbs (left), global search (center-right), user avatar/menu (right)". UserMenu stays in the header bar (placed there by Plan 03). SidebarFooter is NOT used for user menu — leave it empty or add a minimal app version label (e.g., `v0.1.0` in `text-xs text-muted-foreground`). Do NOT move UserMenu from the header bar to the sidebar footer.
  </action>
  <verify>
    - `bun run build` passes
    - `src/widgets/app-shell/components/org-switcher.tsx` uses `useActiveOrganization`, `useListOrganizations`, `organization.setActive`
    - `src/widgets/app-shell/components/app-sidebar.tsx` includes `<OrgSwitcher />` in `SidebarHeader`
    - Org switcher dropdown lists organizations and indicates the active one
    - Switching orgs calls `organization.setActive`
  </verify>
  <done>
    Org switcher renders in the sidebar header showing current active organization. Dropdown lists all user organizations with the active one indicated. Users can switch orgs by clicking. "Create organization" option present as placeholder. Sidebar header updated to use OrgSwitcher instead of static logo.
  </done>
</task>

</tasks>

<verification>
- /invite/[token] page loads and handles both authenticated and unauthenticated flows
- Unauthenticated invite visit redirects to /login with callbackUrl preserved
- After login, user returns to /invite/[token] and auto-joins the org
- Org switcher appears in sidebar header and lists user's organizations
- Switching orgs updates the active organization
- Sidebar collapses to icon rail and org switcher shows just the avatar
- `bun run build` passes
</verification>

<success_criteria>
- Invitation acceptance at /invite/[token]: unauthenticated users redirect to login (callbackUrl preserved), authenticated users auto-accept and set org as active
- Invitation success shows org name and redirects to dashboard
- Invitation errors (expired, invalid, already member) show appropriate messages
- Org switcher in sidebar header shows current org and dropdown of all orgs
- Clicking a different org switches the active organization
- "Create organization" option visible (placeholder for now)
- Sidebar header displays org switcher instead of static branding
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-app-shell/02-04-SUMMARY.md`
</output>
