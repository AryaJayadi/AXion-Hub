---
phase: 07-gateway-channels-models
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/features/channels/api/use-channels.ts
  - src/features/channels/api/use-channel-routing.ts
  - src/features/channels/components/channel-list-table.tsx
  - src/features/channels/components/channel-config-form.tsx
  - src/features/channels/components/channel-group-settings.tsx
  - src/features/channels/components/routing-table.tsx
  - src/features/channels/components/routing-graph.tsx
  - src/features/channels/schemas/channel-schemas.ts
  - src/features/gateway/api/use-gateway-channels.ts
  - src/features/gateway/components/gateway-channels-table.tsx
  - src/views/channels/channels-list-view.tsx
  - src/views/channels/channel-detail-view.tsx
  - src/views/channels/channel-routing-view.tsx
  - src/views/gateway/gateway-channels-view.tsx
  - app/(dashboard)/channels/page.tsx
  - app/(dashboard)/channels/[channel]/page.tsx
  - app/(dashboard)/channels/routing/page.tsx
  - app/(dashboard)/gateway/channels/page.tsx
autonomous: true
requirements:
  - GATE-04
  - CHAN-01
  - CHAN-02
  - CHAN-03
  - CHAN-05

must_haves:
  truths:
    - "User can view all connected channels with status at /channels in a data table"
    - "User can configure individual channels (settings, group allowlists, mention patterns) at /channels/[channel]"
    - "User can edit channel-to-agent routing at /channels/routing with a table view and toggle to visual graph"
    - "User can view connected channels from the gateway perspective at /gateway/channels"
    - "Group channel settings are managed per-channel within each channel's config page (not a dedicated groups page)"
  artifacts:
    - path: "src/features/channels/components/channel-list-table.tsx"
      provides: "DataTable listing all channels with platform badge, status, agent assignment"
      min_lines: 50
    - path: "src/features/channels/components/channel-config-form.tsx"
      provides: "Per-channel config form with platform-specific fields"
      min_lines: 60
    - path: "src/features/channels/components/routing-table.tsx"
      provides: "Editable routing table mapping channels to agents"
      min_lines: 50
    - path: "src/views/channels/channel-routing-view.tsx"
      provides: "Routing view with table/graph toggle"
      min_lines: 40
  key_links:
    - from: "src/views/channels/channels-list-view.tsx"
      to: "src/features/channels/api/use-channels.ts"
      via: "useChannels hook"
      pattern: "useChannels"
    - from: "src/views/channels/channel-routing-view.tsx"
      to: "src/features/channels/api/use-channel-routing.ts"
      via: "useChannelRouting hook"
      pattern: "useChannelRouting"
    - from: "src/features/channels/components/routing-graph.tsx"
      to: "@xyflow/react"
      via: "ReactFlow for visual routing view"
      pattern: "ReactFlow"
    - from: "app/(dashboard)/channels/page.tsx"
      to: "src/views/channels/channels-list-view.tsx"
      via: "view import"
      pattern: "ChannelsListView"
---

<objective>
Build the channel management pages: channel overview list, individual channel configuration with inline group settings, channel-to-agent routing editor (table + graph toggle), and gateway channels view.

Purpose: Let users see all connected messaging channels, configure each channel's settings and group behavior, and manage how channels route messages to specific agents.

Output: Channel list at /channels with DataTable. Channel detail at /channels/[channel] with config form and inline group settings. Routing editor at /channels/routing with default table view and toggle to visual connection graph. Gateway channels view at /gateway/channels.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gateway-channels-models/07-RESEARCH.md
@.planning/phases/07-gateway-channels-models/07-01-SUMMARY.md
@src/entities/channel/model/types.ts
@src/entities/channel/model/schemas.ts
@src/shared/lib/query-keys.ts
@src/features/dashboard/components/dependency-map.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Channel API hooks, schemas, list table, config form, and group settings</name>
  <files>
    src/features/channels/api/use-channels.ts
    src/features/channels/schemas/channel-schemas.ts
    src/features/channels/components/channel-list-table.tsx
    src/features/channels/components/channel-config-form.tsx
    src/features/channels/components/channel-group-settings.tsx
    src/features/gateway/api/use-gateway-channels.ts
    src/features/gateway/components/gateway-channels-table.tsx
    src/views/channels/channels-list-view.tsx
    src/views/channels/channel-detail-view.tsx
    src/views/gateway/gateway-channels-view.tsx
    app/(dashboard)/channels/page.tsx
    app/(dashboard)/channels/[channel]/page.tsx
    app/(dashboard)/gateway/channels/page.tsx
  </files>
  <action>
    **Channel schemas** (`channel-schemas.ts`):
    - Import from "zod/v4". Create Zod schemas for channel config form: `channelConfigSchema` with name (string min 1), platform (enum of ChannelPlatform), agentId (string nullable), and platform-specific optional fields (phoneNumber for whatsapp, botToken for telegram, webhookUrl for discord/slack).
    - `channelGroupSettingsSchema` with allowlist (array of strings), mentionPatterns (array of strings), broadcastEnabled (boolean).
    - `updateChannelSchema` for config updates.

    **API hooks** (`use-channels.ts`):
    - `useChannels()` — returns 5 mock channels covering all platforms: WhatsApp "Sales WhatsApp" (connected, agent "agent-001"), Telegram "Support Bot" (connected, agent "agent-002"), Discord "Dev Community" (connected, agent "agent-003"), Slack "Team Workspace" (disconnected, null agent), Web "Website Chat" (connected, agent "agent-001"). Uses queryKeys.channels.lists(), staleTime Infinity.
    - `useChannel(id)` — returns single channel from the list. Uses queryKeys.channels.detail(id).
    - `useUpdateChannel()` — mutation that simulates 500ms delay, invalidates channels queries, shows sonner toast.

    **Gateway channels hook** (`use-gateway-channels.ts`):
    - `useGatewayChannels()` — returns same mock data as useChannels (they're the gateway's channels). This is the gateway-perspective view. queryKeys.gateway.all with "channels" suffix.

    **Channel list table** (`channel-list-table.tsx`):
    - "use client" component using shared DataTable with columns: Platform (badge with platform icon from lucide — MessageSquare for whatsapp, Send for telegram, Hash for discord, Slack icon for slack, Globe for web), Name, Status (StatusBadge), Assigned Agent (agent name or "Unrouted" in muted text), Messages (number), Connected Since (relative time with date-fns formatDistanceToNow).
    - Row click navigates to `/channels/${channel.id}`.
    - Toolbar: SearchInput for name filtering, FilterBar with platform multi-select.

    **Channel config form** (`channel-config-form.tsx`):
    - "use client" component taking channel: Channel prop.
    - react-hook-form with zodResolver (as-any Zod v4 cast) and channelConfigSchema.
    - Fields: Name (Input), Platform (read-only badge), Agent Assignment (Select dropdown populated from mock agent list or text input), platform-specific fields shown conditionally based on channel.platform.
    - Save button calls useUpdateChannel mutation with toast feedback.

    **Channel group settings** (`channel-group-settings.tsx`):
    - "use client" component taking channelId prop. Inline within the channel detail page (per user decision: group settings per-channel, not a dedicated /channels/groups page).
    - react-hook-form with channelGroupSettingsSchema.
    - Allowlist: useFieldArray for managing string list. Each row is an Input with a remove button. "Add" button below.
    - Mention patterns: same useFieldArray pattern for regex patterns.
    - Broadcast enabled: Switch toggle.
    - Save button.

    **Gateway channels table** (`gateway-channels-table.tsx`):
    - Similar to channel-list-table but focused on gateway-connected channels with status and pairing info. Simpler columns: Name, Platform, Status, Last Active.
    - Links to full channel management at /channels/[id] via "Manage" button in actions column.

    **Views**:
    - `channels-list-view.tsx`: "use client". PageHeader ("Channels" with description "Manage messaging channel connections" and action button "Pair New Channel" linking to /channels/pairing). Renders ChannelListTable with data from useChannels. Loading: SkeletonTable. Empty: EmptyState "No channels connected" with CTA to /channels/pairing.
    - `channel-detail-view.tsx`: "use client". Takes channelId param. Uses useChannel(channelId). PageHeader with channel name and platform badge. Two sections: ChannelConfigForm at top, then a Separator, then ChannelGroupSettings below with its own section header "Group Settings". Loading skeleton and not-found state.
    - `gateway-channels-view.tsx`: "use client". PageHeader ("Connected Channels" with description "Channels connected to this gateway instance"). GatewayChannelsTable. Link button to "/channels" for full channel management.

    **Route pages** — Update placeholders from 07-01:
    - `app/(dashboard)/channels/page.tsx`: Render ChannelsListView in Suspense.
    - `app/(dashboard)/channels/[channel]/page.tsx`: Extract channel param, render ChannelDetailView with channelId prop.
    - `app/(dashboard)/gateway/channels/page.tsx`: Render GatewayChannelsView in Suspense.
  </action>
  <verify>
    Run `bunx tsc --noEmit`. Navigate to /channels — see 5 channels in DataTable with platform badges and status. Click a channel — see config form + group settings at /channels/[id]. Navigate to /gateway/channels — see gateway channel table with "Manage" links. Edit channel name and save — toast confirmation appears.
  </verify>
  <done>
    Channel list displays all channels with filtering. Channel detail shows config form with platform-specific fields and inline group settings. Gateway channels view links to full management. All channel pages have real content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Channel-to-agent routing editor with table and graph toggle</name>
  <files>
    src/features/channels/api/use-channel-routing.ts
    src/features/channels/components/routing-table.tsx
    src/features/channels/components/routing-graph.tsx
    src/views/channels/channel-routing-view.tsx
    app/(dashboard)/channels/routing/page.tsx
  </files>
  <action>
    **Routing API hook** (`use-channel-routing.ts`):
    - `useChannelRouting()` — returns mock ChannelRouting[] data: 5 routing rules matching the 5 channels from use-channels.ts. Each with channelId, agentId, rule description (e.g., "All messages", "Mentions only", "Direct messages"), priority (1-5). Uses queryKeys.channels.routing(), staleTime Infinity.
    - `useUpdateRouting()` — mutation for saving routing changes. Simulates 500ms delay, invalidates routing queries, sonner toast.

    **Routing table** (`routing-table.tsx`):
    - "use client" component using shared DataTable.
    - Columns: Channel (name + platform badge), Agent (name), Routing Rule (text), Priority (number badge), Actions (Edit button opening inline editing).
    - Inline editing: click Edit on a row, the Agent and Rule columns become editable (Select for agent, Input for rule). Save/Cancel buttons appear. Uses local state for edit mode, calls useUpdateRouting on save.
    - "Add Routing Rule" button at top for adding new channel-agent mappings.

    **Routing graph** (`routing-graph.tsx`):
    - "use client" component using @xyflow/react (following the dependency-map.tsx pattern from Phase 5).
    - Two node types: ChannelNode (left side, showing channel name + platform icon + status badge) and AgentNode (right side, showing agent name + status).
    - Edges connect channels to agents based on routing rules. Edge labels show the routing rule text.
    - Use dagre layout with rankdir LR (left-to-right) for channel->agent flow.
    - Custom node components with styled Card wrappers and appropriate icons.
    - ReactFlow with fitView, nodesDraggable=false (per Phase 5 pattern), background grid.
    - Read-only visualization — editing is done in the table view.

    **Routing view** (`channel-routing-view.tsx`):
    - "use client". PageHeader ("Channel Routing" with description "Configure how channels route messages to agents").
    - Toggle in the header actions: "Table" and "Graph" view buttons using nuqs useQueryState('view', { defaultValue: 'table' }) for URL persistence. Per user decision: table is the default, graph is toggle.
    - Conditionally render RoutingTable (default) or RoutingGraph based on toggle state.
    - Data from useChannelRouting passed to both views. Also needs useChannels and a mock agent list for display names.
    - Loading: SkeletonTable for table mode, centered Skeleton for graph mode.

    **Route page** — Update `app/(dashboard)/channels/routing/page.tsx`:
    - Render ChannelRoutingView in Suspense. generateMetadata: { title: "Channel Routing" }.
  </action>
  <verify>
    Run `bunx tsc --noEmit`. Navigate to /channels/routing — see routing table with 5 rules. Click "Graph" toggle — see visual graph with channels on left connected to agents on right. Switch back to "Table" — URL updates to ?view=table. Edit a routing rule inline — save shows toast. Add a new routing rule — row appears in table.
  </verify>
  <done>
    Channel routing at /channels/routing shows table by default with inline editing. Graph toggle displays visual channel-to-agent connection diagram using ReactFlow. Table/graph toggle persisted in URL.
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes with zero errors
- /channels shows DataTable with 5 mock channels, platform badges, and status
- /channels/[id] shows config form with platform-specific fields and inline group settings
- /channels/routing default table view with editable routing rules
- /channels/routing?view=graph shows ReactFlow channel-to-agent diagram
- /gateway/channels shows gateway channel table with links to /channels
- Group settings are inline per-channel (no separate /channels/groups page)
</verification>

<success_criteria>
Channel list at /channels displays all channels with filtering. Channel detail at /channels/[channel] provides config editing with inline group settings. Routing editor at /channels/routing works in both table mode (default, editable) and graph mode (visual ReactFlow diagram, read-only). Gateway channels at /gateway/channels shows connected channels with links to full management.
</success_criteria>

<output>
After completion, create `.planning/phases/07-gateway-channels-models/07-03-SUMMARY.md`
</output>
