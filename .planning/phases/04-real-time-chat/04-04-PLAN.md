---
phase: 04-real-time-chat
plan: 04
type: execute
wave: 4
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - src/features/chat/components/slash-command-popover.tsx
  - src/features/chat/components/command-palette.tsx
  - src/features/chat/components/agent-picker-dialog.tsx
  - src/features/chat/components/message-search.tsx
  - src/features/chat/components/chat-input.tsx
  - src/features/chat/components/chat-layout.tsx
  - src/features/chat/components/conversation-sidebar.tsx
  - src/features/chat/lib/commands.ts
  - src/features/chat/api/use-conversations.ts
  - src/features/chat/api/use-messages.ts
  - src/features/chat/api/use-message-search.ts
  - src/features/chat/index.ts
  - src/views/chat/team-chat-view.tsx
autonomous: true
requirements:
  - CHAT-03
  - CHAT-06
  - CHAT-07
  - CHAT-08
must_haves:
  truths:
    - "User can type '/' in chat input and see a filtered command autocomplete popover"
    - "User can press Cmd+K to open a command palette with the same commands"
    - "Quick commands /new, /compact, /status, /reset are available in both interfaces"
    - "User can switch between conversations and unsent draft text is preserved"
    - "User can search messages scoped to current chat or globally across all conversations"
    - "User can observe agent-to-agent conversations with streaming at /chat/team/[conversationId]"
    - "User can interject in agent-to-agent conversations as a full participant"
    - "User can create a new chat by picking agent(s) from a dialog"
  artifacts:
    - path: "src/features/chat/lib/commands.ts"
      provides: "Quick command definitions with action handlers"
      exports: ["quickCommands", "QuickCommand"]
    - path: "src/features/chat/components/slash-command-popover.tsx"
      provides: "Autocomplete popover triggered by '/' in chat input"
      min_lines: 40
    - path: "src/features/chat/components/command-palette.tsx"
      provides: "Cmd+K global command palette using shadcn Command"
      min_lines: 40
    - path: "src/features/chat/components/message-search.tsx"
      provides: "Search input with current/global scope toggle"
      min_lines: 30
    - path: "src/features/chat/components/agent-picker-dialog.tsx"
      provides: "Agent selection dialog for new conversations"
      min_lines: 40
  key_links:
    - from: "src/features/chat/components/slash-command-popover.tsx"
      to: "src/features/chat/lib/commands.ts"
      via: "imports quickCommands array"
      pattern: "quickCommands"
    - from: "src/features/chat/components/command-palette.tsx"
      to: "src/shared/ui/command.tsx"
      via: "shadcn Command component (cmdk)"
      pattern: "CommandDialog"
    - from: "src/features/chat/components/message-search.tsx"
      to: "src/features/chat/api/use-message-search.ts"
      via: "TanStack Query hook for search results"
      pattern: "useMessageSearch"
---

<objective>
Complete the chat feature set: quick commands (slash autocomplete + Cmd+K palette), session switching with draft preservation, message search with scope toggle, agent picker for new chats, team chat observer mode with interjection, and TanStack Query data hooks.

Purpose: Rounds out the chat experience with all interaction patterns that make it a power-user tool -- quick commands, searchable history, and multi-agent room observation with participation.
Output: Slash command popover, Cmd+K command palette, agent picker dialog, message search with scope toggle, team chat view with interjection, TanStack Query hooks for conversations/messages/search.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-chat/04-RESEARCH.md
@.planning/phases/04-real-time-chat/04-01-SUMMARY.md
@.planning/phases/04-real-time-chat/04-02-SUMMARY.md
@.planning/phases/04-real-time-chat/04-03-SUMMARY.md

# Existing code to integrate with
@src/features/chat/model/chat-store.ts
@src/features/chat/components/chat-view.tsx
@src/features/chat/components/chat-input.tsx
@src/features/gateway-connection/lib/gateway-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quick commands, slash popover, Cmd+K palette, and agent picker dialog</name>
  <files>
    src/features/chat/lib/commands.ts
    src/features/chat/components/slash-command-popover.tsx
    src/features/chat/components/command-palette.tsx
    src/features/chat/components/agent-picker-dialog.tsx
  </files>
  <action>
    **1. Create `src/features/chat/lib/commands.ts`:**
    Define quick commands exactly as in 04-RESEARCH.md:
    - Types: `QuickCommand` interface with id, label, description, icon (LucideIcon), keywords (string[]), shortcut (optional), action function
    - `CommandContext` interface with conversationId, agentId, gatewayClient (typed from gateway-client)
    - Four commands:
      - `/new` — Plus icon, "Start a new conversation", keywords: new/create/start/conversation/chat, shortcut: "Cmd+N", action: triggers agent picker dialog (via a callback or event)
      - `/compact` — Minimize2 icon, "Compact the current session", keywords: compact/compress/reduce/context, action: sends compact command via gatewayClient
      - `/status` — Activity icon, "Show agent status and session info", keywords: status/info/session/agent, action: inserts a system message with status info
      - `/reset` — RotateCcw icon, "Reset the current session", keywords: reset/clear/restart, action: sends reset command via gatewayClient (with confirmation)
    - Export `quickCommands` array and `QuickCommand`/`CommandContext` types

    **2. Create `src/features/chat/components/slash-command-popover.tsx`:**
    "use client" component for slash command autocomplete in the chat input:
    - Props: `isOpen: boolean`, `filter: string`, `onSelect: (command: QuickCommand) => void`, `onClose: () => void`, `inputRef: React.RefObject<HTMLTextAreaElement>`
    - Uses `Popover` from `@/shared/ui/popover` (PopoverContent positioned above the input)
    - Filters `quickCommands` by matching filter text against label and keywords (case-insensitive includes)
    - Renders matching commands as a list: icon + label + description + shortcut badge
    - Keyboard navigation: ArrowUp/ArrowDown moves selection, Enter selects, Escape closes
    - Track active index via useState, reset to 0 on filter change
    - The parent (ChatInput) detects '/' at the start of input to open this popover, and passes the text after '/' as filter
    - On select: clear the '/' text from input, execute command action, close popover

    **3. Create `src/features/chat/components/command-palette.tsx`:**
    "use client" component for Cmd+K global command palette:
    - Uses `CommandDialog`, `CommandInput`, `CommandList`, `CommandGroup`, `CommandItem`, `CommandEmpty` from `@/shared/ui/command` (shadcn Command wrapping cmdk)
    - Register Cmd+K keyboard shortcut via `useEffect` with `keydown` listener on document
    - State: `open` boolean via useState
    - Group: "Quick Commands" containing all `quickCommands` items
    - Each item: icon + label + description + shortcut badge on the right
    - On select: execute command action with current context (from useChatStore + useGateway), close dialog
    - CommandContext assembled from: `useChatStore.getState().activeConversationId`, derived agentId from active conversation, `useGateway().gatewayClient`
    - CommandEmpty: "No commands found" message
    - This component should be rendered once at the chat layout level (not per-conversation)

    **4. Create `src/features/chat/components/agent-picker-dialog.tsx`:**
    "use client" component for creating new conversations:
    - Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `onCreateConversation: (agentIds: string[], title?: string) => void`
    - Uses `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription`, `DialogFooter` from `@/shared/ui/dialog`
    - Content: search input (for filtering agents), scrollable list of agents with Checkbox + Avatar + name + status
    - Selected agents tracked via `useState<Set<string>>`
    - Agent list: initially placeholder data (Phase 3 provides the real agent store). For now, use `useGateway().gatewayClient` to call `getAgents()` wrapped in a TanStack Query hook, with fallback to empty array.
    - Title field: auto-generated from selected agent names (e.g., "Chat with Agent1, Agent2") but editable
    - "Create Chat" button: enabled when at least one agent selected. Calls `onCreateConversation(Array.from(selectedAgentIds), title)`.
    - Single agent selected: creates 'direct' type conversation. Multiple: creates 'room' type.
    - Close button and Escape to dismiss.
  </action>
  <verify>
    Run `bun run build` — no TypeScript errors. Verify all 4 files export their components/types. Verify command palette renders with shadcn Command component.
  </verify>
  <done>Four quick commands defined (/new, /compact, /status, /reset) with dual access: slash autocomplete popover in chat input AND Cmd+K global command palette. Agent picker dialog lets user select agent(s) to create new direct or room conversations.</done>
</task>

<task type="auto">
  <name>Task 2: Create message search, TanStack Query hooks, and finalize team chat view</name>
  <files>
    src/features/chat/components/message-search.tsx
    src/features/chat/api/use-conversations.ts
    src/features/chat/api/use-messages.ts
    src/features/chat/api/use-message-search.ts
    src/views/chat/team-chat-view.tsx
  </files>
  <action>
    **1. Create `src/features/chat/api/use-conversations.ts`:**
    TanStack Query hook for fetching conversation list:
    - `useConversations(filters?: Record<string, unknown>)` — uses `queryKeys.conversations.list(filters)` key
    - Query function: calls `gatewayClient.getSessions()` (sessions map to conversations) via `useGateway()`, transforms response to Conversation[] format
    - staleTime: 30 seconds (conversations update via WebSocket PUSH, REST is backup)
    - On success: seed Zustand chat store with fetched conversations via `useChatStore.getState().addConversation()`
    - Export the hook

    **2. Create `src/features/chat/api/use-messages.ts`:**
    TanStack Query hook for fetching message history for a conversation:
    - `useMessages(conversationId: string)` — uses `queryKeys.messages.byConversation(conversationId)` key
    - Query function: placeholder that returns empty array (message history fetching depends on gateway API that isn't fully defined yet; real-time messages come via WebSocket). Add TODO comment: "Replace with gateway session transcript fetch when API contract is finalized."
    - On success: seed Zustand store messages map
    - Enabled only when conversationId is truthy
    - Export the hook

    **3. Create `src/features/chat/api/use-message-search.ts`:**
    TanStack Query hook for searching messages:
    - `useMessageSearch(query: string, scope: 'current' | 'global', conversationId?: string)` — uses `queryKeys.messages.search(query, scope === 'current' ? conversationId : 'global')` key
    - Query function: placeholder that searches the Zustand store's messages in-memory (filtering message.content by query string). TODO: "Replace with server-side search endpoint when available."
    - Enabled only when query length >= 2
    - Uses `useDebouncedCallback` from `use-debounce` to debounce the query (300ms) — or use the `keepPreviousData` + manual debounce pattern
    - Returns `{ data: SearchResult[], isLoading }` where `SearchResult = { message: ChatMessage, conversationId: string, conversationTitle: string }`
    - Export the hook

    **4. Create `src/features/chat/components/message-search.tsx`:**
    "use client" component for searching messages:
    - Props: `conversationId?: string | undefined`
    - Search input using `Input` from `@/shared/ui/input` with Search icon
    - Scope toggle: "This Chat" / "All Chats" toggle buttons (using small Button variants or ToggleGroup if available). Default: "This Chat" when conversationId provided, "All Chats" otherwise.
    - Debounced input: use `useDebouncedCallback` from `use-debounce` (300ms) to update the search query state
    - Results dropdown/panel below the search input:
      - Each result: conversation title (if global scope), message preview (highlighted match), sender, timestamp
      - Click navigates to the conversation and scrolls to the message
    - Empty query: hide results
    - No results: "No messages found" text
    - Loading state: show skeleton items
    - Position: rendered in the conversation sidebar's top section or as a collapsible panel
    - Keyboard shortcut: Cmd+F or Ctrl+F could toggle the search (register in useEffect). Careful not to conflict with browser find.

    **5. Finalize `src/views/chat/team-chat-view.tsx`:**
    Update the team chat view (from 04-01) to be a full participant view (not read-only, per user decision):
    - Uses `<ChatLayout conversationId={conversationId} showParticipants={true}>`
    - Renders `<ChatView conversationId={conversationId} />` — same chat view as direct, allowing the user to type and send messages
    - Add a subtle banner at the top: "Agent-to-agent conversation — you can interject at any time" with an info icon, dismissible
    - The participant panel on the right shows all agents in the room with their status
    - Multi-agent streaming lanes are visible (from 04-02) since multiple agents may stream simultaneously
    - User messages appear with "You" label, distinct from agent messages

    **Integration updates:**
    - Update `src/features/chat/components/chat-layout.tsx` to include `<CommandPalette />` component (rendered once at layout level)
    - Update `src/features/chat/components/conversation-sidebar.tsx` to include `<MessageSearch />` component in the top section
    - Update `src/features/chat/components/chat-input.tsx` to integrate `<SlashCommandPopover />`: detect '/' at input start, show popover, handle selection
    - Update `src/features/chat/index.ts` barrel to export new APIs and components

    **TypeScript notes:** All optional props need `| undefined`. TanStack Query hooks should use proper generic typing.
  </action>
  <verify>
    Run `bun run build` — no TypeScript errors. Verify all 5 files exist. Verify message-search.tsx exports MessageSearch. Verify team-chat-view.tsx renders ChatView (not placeholder). Verify chat-input.tsx integrates slash command popover.
  </verify>
  <done>Message search works with current/global scope toggle and debounced input. TanStack Query hooks provide conversation list, message history, and search results. Team chat view enables full user participation in agent-to-agent conversations. Slash command popover and Cmd+K palette integrated into chat layout.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with no errors
2. Type '/' in chat input — slash command popover appears with filtered commands
3. Press Cmd+K — command palette opens with quick commands
4. Select /new — agent picker dialog opens
5. Search in sidebar — results show with scope toggle
6. Navigate to /chat/team/[id] — see team chat with interjection banner and participant panel
7. Switching conversations preserves unsent draft text
</verification>

<success_criteria>
- Slash command autocomplete works with keyboard navigation (up/down/enter/escape)
- Cmd+K command palette shows all quick commands with search
- Agent picker dialog allows selecting one or multiple agents for new conversations
- Message search scopes to current chat by default with global toggle
- Team chat view allows user interjection as full participant
- Session switching preserves draft text and scrolls to bottom on return
- TanStack Query hooks ready for real data (currently placeholder/gateway calls)
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-chat/04-04-SUMMARY.md`
</output>
