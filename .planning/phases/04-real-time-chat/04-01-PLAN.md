---
phase: 04-real-time-chat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/chat-message/model/types.ts
  - src/entities/chat-message/index.ts
  - src/features/chat/model/chat-store.ts
  - src/features/chat/model/hooks.ts
  - src/features/chat/components/chat-layout.tsx
  - src/features/chat/components/conversation-sidebar.tsx
  - src/features/chat/components/participant-panel.tsx
  - src/features/chat/index.ts
  - src/views/chat/chat-hub-view.tsx
  - src/views/chat/agent-chat-view.tsx
  - src/views/chat/team-chat-view.tsx
  - app/(dashboard)/chat/page.tsx
  - app/(dashboard)/chat/[agentId]/page.tsx
  - app/(dashboard)/chat/team/[conversationId]/page.tsx
  - src/shared/lib/query-keys.ts
autonomous: true
requirements:
  - CHAT-01
must_haves:
  truths:
    - "User can navigate to /chat and see a resizable sidebar with conversation list and a main chat area"
    - "User can see conversations organized by type (pinned, rooms, direct) in the sidebar"
    - "Route /chat/[agentId] renders the agent chat view shell"
    - "Route /chat/team/[conversationId] renders the team chat view shell"
    - "Participant panel is collapsible on the right side showing agent info"
  artifacts:
    - path: "src/entities/chat-message/model/types.ts"
      provides: "ChatMessage, Conversation, StreamingLane, ToolCallInfo, Attachment types"
      contains: "ChatMessage"
    - path: "src/features/chat/model/chat-store.ts"
      provides: "Zustand chat store with conversations, messages, streaming lanes, drafts"
      exports: ["useChatStore"]
    - path: "src/features/chat/components/chat-layout.tsx"
      provides: "Resizable three-panel layout (sidebar + main + participant panel)"
      min_lines: 30
    - path: "src/features/chat/components/conversation-sidebar.tsx"
      provides: "Conversation list with hybrid organization (pinned, rooms, direct)"
      min_lines: 40
    - path: "app/(dashboard)/chat/page.tsx"
      provides: "Chat hub page route"
  key_links:
    - from: "app/(dashboard)/chat/page.tsx"
      to: "src/views/chat/chat-hub-view.tsx"
      via: "import and render"
      pattern: "ChatHubView"
    - from: "src/views/chat/chat-hub-view.tsx"
      to: "src/features/chat/components/chat-layout.tsx"
      via: "composition"
      pattern: "ChatLayout"
    - from: "src/features/chat/components/conversation-sidebar.tsx"
      to: "src/features/chat/model/chat-store.ts"
      via: "Zustand selector"
      pattern: "useChatStore"
---

<objective>
Build the chat hub foundation: entity types, Zustand chat store, resizable three-panel layout, conversation sidebar with hybrid organization, participant panel, all three route pages (/chat, /chat/[agentId], /chat/team/[conversationId]), and view compositions.

Purpose: Establishes the structural skeleton that all subsequent chat plans build upon -- types, state management, layout, routing, and navigation.
Output: Chat entity types, Zustand store, resizable layout with conversation sidebar and participant panel, three route pages with view compositions.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-chat/04-RESEARCH.md

# Prior plan summaries needed for patterns
@.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-05-SUMMARY.md

# Existing code to reference/extend
@src/features/gateway-connection/lib/event-bus.ts
@src/features/gateway-connection/model/store.ts
@src/shared/lib/query-keys.ts
@app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat entity types, Zustand store, and query key extensions</name>
  <files>
    src/entities/chat-message/model/types.ts
    src/entities/chat-message/index.ts
    src/features/chat/model/chat-store.ts
    src/features/chat/model/hooks.ts
    src/features/chat/index.ts
    src/shared/lib/query-keys.ts
  </files>
  <action>
    **1. Install required shadcn/ui components:**
    ```bash
    bunx shadcn@latest add scroll-area collapsible command dialog resizable -y
    ```
    Also install new npm deps:
    ```bash
    bun add streamdown @streamdown/code use-debounce
    ```

    **2. Create `src/entities/chat-message/model/types.ts`:**
    Define all chat domain types following the patterns from 04-RESEARCH.md:
    - `ChatMessage` — id, conversationId, role ('user' | 'assistant' | 'system'), agentId (optional), content, timestamp (Date), toolCalls (ToolCallInfo[]), attachments (Attachment[])
    - `ToolCallInfo` — id, name, arguments (Record<string, unknown>), status ('pending' | 'running' | 'completed' | 'error'), output (optional string), error (optional string), startedAt (optional Date), completedAt (optional Date)
    - `Attachment` — id, type ('image' | 'document' | 'audio'), name, url, mimeType, size (number)
    - `StreamingLane` — agentId, agentName, messageId, accumulatedText, isActive (boolean), toolCalls (ToolCallInfo[])
    - `Conversation` — id, type ('direct' | 'room' | 'team'), agentIds (string[]), title, lastMessage (optional string), lastActivity (Date), unreadCount (number), isPinned (boolean)
    - `ConversationType` = Conversation['type']

    **3. Create barrel export `src/entities/chat-message/index.ts`:**
    Re-export all types from model/types.ts.

    **4. Create `src/features/chat/model/chat-store.ts`:**
    Zustand store following the PUSH state pattern from 01-05. Use `create<ChatStore>()`:
    - State: `conversations: Map<string, Conversation>`, `activeConversationId: string | null`, `messages: Map<string, ChatMessage[]>`, `streamingLanes: Map<string, StreamingLane>` (key: `${conversationId}:${agentId}`), `drafts: Map<string, string>` (conversationId -> text)
    - Actions: `setActiveConversation(id)`, `addConversation(conversation)`, `removeConversation(id)`, `updateConversation(id, partial)`, `addMessage(conversationId, message)`, `startStream(conversationId, agentId, agentName, messageId)`, `appendToStream(laneKey, token)`, `addToolCallToStream(laneKey, toolCall)`, `updateToolCallInStream(laneKey, toolCallId, partial)`, `finalizeStream(conversationId, agentId, fullText)`, `saveDraft(conversationId, text)`, `getDraft(conversationId) -> string`
    - Follow exact patterns from research: `finalizeStream` moves lane content to messages list and deletes the lane. `appendToStream` appends token to accumulatedText.
    - Export as `useChatStore`.

    **5. Create `src/features/chat/model/hooks.ts`:**
    Selector-based hooks (like connection store hooks from 01-05):
    - `useActiveConversation()` — returns active conversation object (or null)
    - `useConversationMessages(conversationId)` — returns messages array for a conversation
    - `useStreamingLanes(conversationId)` — returns active streaming lanes for a conversation (filter by key prefix)
    - `useDraft(conversationId)` — returns draft text
    - `useConversationList()` — returns sorted conversation list (pinned first, then by lastActivity desc)

    **6. Create barrel `src/features/chat/index.ts`:**
    Re-export store, hooks, and types.

    **7. Extend `src/shared/lib/query-keys.ts`:**
    Add `conversations` and `messages` domains following the existing hierarchical pattern:
    ```typescript
    conversations: {
      all: ["conversations"] as const,
      lists: () => [...queryKeys.conversations.all, "list"] as const,
      list: (filters?: Record<string, unknown>) => [...queryKeys.conversations.lists(), filters] as const,
      details: () => [...queryKeys.conversations.all, "detail"] as const,
      detail: (id: string) => [...queryKeys.conversations.details(), id] as const,
    },
    messages: {
      all: ["messages"] as const,
      byConversation: (conversationId: string) => [...queryKeys.messages.all, "conversation", conversationId] as const,
      search: (query: string, scope?: string) => [...queryKeys.messages.all, "search", { query, scope }] as const,
    },
    ```

    **TypeScript notes:** All optional props must include `| undefined` for `exactOptionalPropertyTypes: true`.
  </action>
  <verify>
    Run `bun run build` — expect no TypeScript errors in the new files.
    Verify `src/entities/chat-message/index.ts` exports all types.
    Verify `src/features/chat/index.ts` exports useChatStore and hooks.
    Verify shadcn/ui components installed: `ls src/shared/ui/scroll-area.tsx src/shared/ui/collapsible.tsx src/shared/ui/command.tsx src/shared/ui/dialog.tsx src/shared/ui/resizable.tsx`
  </verify>
  <done>Chat entity types defined, Zustand chat store with all actions working, selector hooks created, query key factory extended with conversations and messages domains, shadcn/ui components (scroll-area, collapsible, command, dialog, resizable) and npm packages (streamdown, @streamdown/code, use-debounce) installed.</done>
</task>

<task type="auto">
  <name>Task 2: Build chat layout, conversation sidebar, participant panel, route pages, and view compositions</name>
  <files>
    src/features/chat/components/chat-layout.tsx
    src/features/chat/components/conversation-sidebar.tsx
    src/features/chat/components/participant-panel.tsx
    src/views/chat/chat-hub-view.tsx
    src/views/chat/agent-chat-view.tsx
    src/views/chat/team-chat-view.tsx
    app/(dashboard)/chat/page.tsx
    app/(dashboard)/chat/[agentId]/page.tsx
    app/(dashboard)/chat/team/[conversationId]/page.tsx
  </files>
  <action>
    **1. Create `src/features/chat/components/chat-layout.tsx`:**
    A "use client" component using shadcn/ui Resizable (wraps react-resizable-panels):
    - `ResizablePanelGroup` direction="horizontal" with three panels:
      - Left panel (conversation sidebar): defaultSize={25}, minSize={15}, maxSize={35}, collapsible
      - Main panel (chat content): defaultSize={55}, minSize={40} — renders `{children}` (the active chat view)
      - Right panel (participant panel): defaultSize={20}, minSize={15}, maxSize={30}, collapsible, defaultCollapsed on direct chats
    - ResizableHandle between panels with `withHandle` prop
    - Props: `children: React.ReactNode`, `conversationId?: string | undefined`, `showParticipants?: boolean | undefined`
    - Import ResizablePanelGroup, ResizablePanel, ResizableHandle from `@/shared/ui/resizable`
    - Layout fills the available height: `className="h-full"`
    - Render `<ConversationSidebar />` in left panel, `{children}` in main, `<ParticipantPanel conversationId={conversationId} />` in right (only if showParticipants)

    **2. Create `src/features/chat/components/conversation-sidebar.tsx`:**
    A "use client" component for the conversation list:
    - Top section: Search input (using SearchInput from `@/shared/ui/search-input`) + "New Chat" button (Plus icon)
    - Hybrid organization per discretion recommendation:
      - **Pinned** section — conversations with `isPinned: true`, sorted by lastActivity
      - **Rooms** section — conversations with `type: 'room' | 'team'`, sorted by lastActivity
      - **Direct** section — conversations with `type: 'direct'`, sorted by lastActivity
    - Each section has a label (Separator + small caps heading)
    - Each conversation item: agent Avatar (from `@/shared/ui/avatar`) with fallback initials, conversation title, last message preview (truncated), relative time (use `formatDistanceToNow` from date-fns), unread count Badge
    - Active conversation highlighted with `bg-accent` class
    - Click sets `useChatStore.getState().setActiveConversation(id)` and navigates to the appropriate route
    - Wrap list in `ScrollArea` from `@/shared/ui/scroll-area` for custom scrollbars
    - When no conversations: render `EmptyState` with "No conversations yet" message and "Start Chat" CTA

    **3. Create `src/features/chat/components/participant-panel.tsx`:**
    A "use client" component showing agents in the current conversation:
    - Header: "Participants" title with agent count
    - Each agent: Avatar, name, StatusBadge (from `@/shared/ui/status-badge`), model info (small text below name), role in room (if applicable)
    - Wrap list in ScrollArea
    - When no conversationId or no agents: show empty state
    - Uses useChatStore to get active conversation's agentIds
    - Agent details are placeholder for now (will be populated from agent store in Phase 3) -- show agentId as name fallback

    **4. Create view compositions:**
    - `src/views/chat/chat-hub-view.tsx` — "use client", renders `<ChatLayout>` with an EmptyState in the main area saying "Select a conversation or start a new chat" with a "New Chat" CTA button. showParticipants={false}.
    - `src/views/chat/agent-chat-view.tsx` — "use client", accepts `agentId` prop, renders `<ChatLayout conversationId={agentId} showParticipants={false}>` with a placeholder div saying "Chat with agent {agentId}" (streaming UI added in 04-02). Sets active conversation on mount via useEffect.
    - `src/views/chat/team-chat-view.tsx` — "use client", accepts `conversationId` prop, renders `<ChatLayout conversationId={conversationId} showParticipants={true}>` with placeholder div saying "Team conversation {conversationId}" (streaming UI added in 04-02). Sets active conversation on mount via useEffect.

    **5. Create route pages:**
    - `app/(dashboard)/chat/page.tsx` — server component, renders `<ChatHubView />`
    - `app/(dashboard)/chat/[agentId]/page.tsx` — server component, extracts `params.agentId` (await params per Next.js 16), renders `<AgentChatView agentId={agentId} />`
    - `app/(dashboard)/chat/team/[conversationId]/page.tsx` — server component, extracts `params.conversationId` (await params), renders `<TeamChatView conversationId={conversationId} />`

    **TypeScript notes:** All optional props need `| undefined` for strictness. Use `React.ReactNode` for children type. Server component params are `Promise<{ param: string }>` in Next.js 16.
  </action>
  <verify>
    Run `bun run build` — expect no errors. Verify all three routes exist by checking file presence:
    `ls app/(dashboard)/chat/page.tsx app/(dashboard)/chat/\[agentId\]/page.tsx app/(dashboard)/chat/team/\[conversationId\]/page.tsx`
  </verify>
  <done>Three-panel resizable chat layout renders with conversation sidebar (hybrid organization: pinned/rooms/direct), collapsible participant panel, and all three route pages (/chat, /chat/[agentId], /chat/team/[conversationId]) wired to view compositions.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with no TypeScript errors
2. Navigate to /chat — see resizable sidebar + main area with empty state
3. Navigate to /chat/test-agent — see agent chat view shell
4. Navigate to /chat/team/test-conv — see team chat view shell with participant panel
5. Zustand store exports useChatStore with all actions
6. Query key factory includes conversations and messages domains
</verification>

<success_criteria>
- Chat layout renders with resizable three-panel structure
- Conversation sidebar shows hybrid organization (pinned, rooms, direct)
- All three route pages work and render their respective views
- Chat entity types are comprehensive and exported
- Zustand store manages conversations, messages, streaming lanes, and drafts
- shadcn/ui components (scroll-area, collapsible, command, dialog, resizable) installed
- streamdown, @streamdown/code, and use-debounce npm packages installed
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-chat/04-01-SUMMARY.md`
</output>
