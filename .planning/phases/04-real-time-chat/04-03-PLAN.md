---
phase: 04-real-time-chat
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/features/chat/components/tool-call-group.tsx
  - src/features/chat/components/tool-call-pipeline.tsx
  - src/features/chat/components/tool-call-node.tsx
  - src/features/chat/components/tool-output-panel.tsx
  - src/features/chat/components/media-preview.tsx
  - src/features/chat/components/media-upload-zone.tsx
  - src/features/chat/lib/media-upload.ts
autonomous: true
requirements:
  - CHAT-04
  - CHAT-05
must_haves:
  truths:
    - "Tool calls appear as a collapsible 'thinking step' group with a progress indicator"
    - "Expanding a step shows individual tool calls as an animated pipeline"
    - "In-progress tools show as nodes that light up as they execute"
    - "Clicking a tool call opens its output in a side panel (Sheet)"
    - "Tool errors display with a destructive badge and error details in the side panel"
    - "User can attach images, documents, and audio files via drag-and-drop, paste, or file picker"
    - "Image attachments preview inline in messages"
    - "Document and audio attachments display as downloadable cards"
  artifacts:
    - path: "src/features/chat/components/tool-call-group.tsx"
      provides: "Collapsible thinking step with progress indicator"
      min_lines: 40
    - path: "src/features/chat/components/tool-call-pipeline.tsx"
      provides: "Animated step-through pipeline visualization"
      min_lines: 30
    - path: "src/features/chat/components/tool-output-panel.tsx"
      provides: "Sheet side panel for tool call output details"
      min_lines: 30
    - path: "src/features/chat/components/media-preview.tsx"
      provides: "Inline image preview and document/audio card rendering"
      min_lines: 25
    - path: "src/features/chat/lib/media-upload.ts"
      provides: "File validation, upload utility, drag-and-drop helpers"
      exports: ["validateFile", "uploadFile", "ACCEPTED_TYPES"]
  key_links:
    - from: "src/features/chat/components/tool-call-group.tsx"
      to: "src/shared/ui/collapsible.tsx"
      via: "Collapsible wrapper"
      pattern: "Collapsible"
    - from: "src/features/chat/components/tool-output-panel.tsx"
      to: "src/shared/ui/sheet.tsx"
      via: "Sheet side panel"
      pattern: "Sheet"
    - from: "src/features/chat/components/tool-call-pipeline.tsx"
      to: "framer-motion"
      via: "Animated node transitions"
      pattern: "motion\\."
---

<objective>
Build tool call visualization (collapsible thinking steps with animated pipeline) and media support (drag-and-drop upload, paste-to-upload, inline previews for images/documents/audio).

Purpose: Makes agent reasoning transparent through visual tool call inspection, and enables rich media communication beyond text. Tool call visualization is a key differentiator -- it turns opaque agent reasoning into a visible mini-pipeline.
Output: Tool call group with collapsible pipeline, tool output side panel, media upload/preview components.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-chat/04-RESEARCH.md
@.planning/phases/04-real-time-chat/04-01-SUMMARY.md

# Entity types from 04-01
@src/entities/chat-message/model/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build tool call visualization — collapsible group, animated pipeline, output panel</name>
  <files>
    src/features/chat/components/tool-call-group.tsx
    src/features/chat/components/tool-call-pipeline.tsx
    src/features/chat/components/tool-call-node.tsx
    src/features/chat/components/tool-output-panel.tsx
  </files>
  <action>
    **1. Create `src/features/chat/components/tool-call-node.tsx`:**
    "use client" component rendering a single tool call in the pipeline:
    - Props: `tool: ToolCallInfo`, `index: number`, `onViewOutput: (tool: ToolCallInfo) => void`
    - Visual states using framer-motion `motion.div`:
      - **pending**: muted/gray node, dashed border
      - **running**: pulsing/glowing node with amber color, spinner icon (Loader2 from lucide-react with `animate-spin`)
      - **completed**: solid green node, CheckCircle icon, border-green
      - **error**: solid red node, XCircle icon, border-destructive
    - Node layout: small circle (status indicator) + tool name + chevron for expand
    - Click on the node calls `onViewOutput(tool)` to open the side panel
    - framer-motion `animate` for status transitions: `initial={{ opacity: 0, x: -10 }}`, `animate={{ opacity: 1, x: 0 }}` with `transition={{ delay: index * 0.1 }}` for stagger effect
    - Between nodes: a thin connecting line that "lights up" (changes from muted to primary color) when the preceding tool completes

    **2. Create `src/features/chat/components/tool-call-pipeline.tsx`:**
    "use client" component rendering the animated step-through pipeline:
    - Props: `tools: ToolCallInfo[]`, `onViewOutput: (tool: ToolCallInfo) => void`
    - Renders tool calls as a vertical pipeline with connecting lines between nodes
    - Each node is a `<ToolCallNode>` component
    - The pipeline is a `flex flex-col gap-1 pl-6 pt-2` container
    - framer-motion `AnimatePresence` wraps the list for smooth add/remove transitions
    - Connecting lines: thin vertical lines between nodes, color transitions from muted (not yet reached) to primary (completed/active) using framer-motion color animation

    **3. Create `src/features/chat/components/tool-call-group.tsx`:**
    "use client" component — the collapsible "thinking step" block:
    - Props: `tools: ToolCallInfo[]`, `isExecuting: boolean`
    - Uses `Collapsible` from `@/shared/ui/collapsible`
    - CollapsibleTrigger renders:
      - When `isExecuting`: spinner + "Running tools ({completedCount}/{tools.length})..." in muted text
      - When complete: green CheckCircle + "Used {tools.length} tool(s)" in muted text
      - When has error: red XCircle + "Tool error" in destructive text
    - CollapsibleContent renders `<ToolCallPipeline tools={tools} onViewOutput={setSelectedTool} />`
    - Manages selected tool state via `useState<ToolCallInfo | null>(null)` and renders `<ToolOutputPanel>` when a tool is selected
    - Visually: subtle background (bg-muted/30), rounded border, small padding, integrates inline with message content

    **4. Create `src/features/chat/components/tool-output-panel.tsx`:**
    "use client" component — Sheet side panel for tool call output:
    - Props: `tool: ToolCallInfo | null`, `open: boolean`, `onClose: () => void`
    - Uses `Sheet` from `@/shared/ui/sheet` (SheetContent, SheetHeader, SheetTitle, SheetDescription)
    - Sheet opens from the right side (side="right")
    - Header: tool name + status badge (StatusBadge from shared UI)
    - Body sections:
      - **Arguments**: `JSON.stringify(tool.arguments, null, 2)` in a `<pre>` block with monospace font and subtle background
      - **Output**: tool.output rendered as plain text or simple code block, scrollable
      - **Error** (if status='error'): destructive alert/banner with tool.error text and optional stack trace
      - **Timing**: "Started: {time}" and "Completed: {time}" if available
    - For error state per discretion: red destructive Banner at top of panel with error message, XCircle icon
  </action>
  <verify>
    Run `bun run build` — no TypeScript errors. Verify all 4 component files exist and export their components.
  </verify>
  <done>Tool call visualization renders as a collapsible "thinking step" group with animated pipeline nodes that light up during execution, status transitions, and a Sheet side panel showing full tool output/error details.</done>
</task>

<task type="auto">
  <name>Task 2: Build media upload utilities and preview components</name>
  <files>
    src/features/chat/lib/media-upload.ts
    src/features/chat/components/media-preview.tsx
    src/features/chat/components/media-upload-zone.tsx
  </files>
  <action>
    **1. Create `src/features/chat/lib/media-upload.ts`:**
    Media upload utility functions:
    - `ACCEPTED_TYPES` constant object: `{ image: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'], document: ['application/pdf', 'text/plain', 'text/markdown', 'application/json'], audio: ['audio/mpeg', 'audio/wav', 'audio/ogg'] }`
    - `ALL_ACCEPTED_MIME_TYPES`: flat array of all accepted types
    - `MAX_FILE_SIZE = 25 * 1024 * 1024` (25MB)
    - `getAttachmentType(mimeType: string): 'image' | 'document' | 'audio' | null` — returns the category or null if not accepted
    - `validateFile(file: File): { valid: boolean; error?: string | undefined }` — checks mime type against ACCEPTED_TYPES, checks size against MAX_FILE_SIZE
    - `createAttachmentFromFile(file: File): Attachment` — generates nanoid, extracts metadata, creates object URL for preview. Returns Attachment with type, name, url (object URL), mimeType, size.
    - `uploadFile(file: File): Promise<string>` — placeholder that returns the object URL for now. In production this would POST to an upload endpoint and return the permanent URL. Add a TODO comment noting the gateway upload protocol needs validation.
    - `revokeAttachmentUrl(url: string): void` — calls `URL.revokeObjectURL(url)` for cleanup

    **2. Create `src/features/chat/components/media-preview.tsx`:**
    "use client" component rendering attachment previews within messages:
    - Props: `attachments: Attachment[]`
    - For each attachment, render based on type:
      - **image**: `<img>` wrapped in a rounded container with max-width (300px) and max-height (200px), `object-contain`. Click opens full-size in a new tab or overlay.
      - **document**: Card with file icon (FileText from lucide-react), filename, file size (formatted to KB/MB), and a download link (`<a href={url} download={name}>`)
      - **audio**: Native `<audio controls>` element with source, wrapped in a styled card with Headphones icon and filename
    - Layout: attachments in a `flex flex-wrap gap-2` container
    - Handle empty attachments array gracefully (return null)

    **3. Create `src/features/chat/components/media-upload-zone.tsx`:**
    "use client" component providing drag-and-drop and paste-to-upload functionality:
    - Props: `onFilesAdded: (files: File[]) => void`, `children: React.ReactNode`, `disabled?: boolean | undefined`
    - Wraps children in a div that handles:
      - **onDragOver/onDragEnter**: prevent default, set visual hover state (dashed border, subtle bg change)
      - **onDragLeave**: reset hover state
      - **onDrop**: prevent default, extract files from `event.dataTransfer.files`, validate each with `validateFile()`, call `onFilesAdded` with valid files, show toast (from sonner) for rejected files with reason
      - **onPaste** (registered on window/document within useEffect): detect image paste from `event.clipboardData.files`, validate and call `onFilesAdded`
    - Visual overlay during drag: semi-transparent overlay with "Drop files here" text and Upload icon
    - Also exports a "hidden file input + trigger button" pattern: a hidden `<input type="file" multiple accept={...}>` with a ref, and the attachment button (Paperclip icon) clicks the hidden input via `ref.current?.click()`. onChange calls onFilesAdded.
    - Cleanup: paste event listener removed on unmount

    **Integration note for 04-02's ChatInput:** The MediaUploadZone wraps the chat input area. When files are added, they're stored in local state as pending attachments (displayed as preview chips above the textarea). On send, attachments are included in the message payload.
  </action>
  <verify>
    Run `bun run build` — no TypeScript errors. Verify all 3 files exist. Verify media-upload.ts exports validateFile, uploadFile, ACCEPTED_TYPES, createAttachmentFromFile.
  </verify>
  <done>Media upload supports drag-and-drop, paste-to-upload, and file picker with validation (type + size). Images render inline, documents and audio render as downloadable cards. Upload is placeholder pending gateway protocol validation.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with no errors
2. ToolCallGroup renders with collapsible header showing progress
3. Expanding shows animated pipeline with status-colored nodes
4. Clicking a tool node opens Sheet with output details
5. MediaPreview renders images inline, documents/audio as cards
6. MediaUploadZone accepts drag-and-drop, paste, and file picker
7. File validation rejects unsupported types and oversized files
</verification>

<success_criteria>
- Tool calls render as Claude.ai-style collapsible thinking steps
- Pipeline animation staggers node appearance with status color transitions
- Tool output opens in Sheet side panel keeping chat visible
- Error tools show destructive badge with error details in panel
- Drag-and-drop, paste-to-upload, and file picker all work for media
- Image, document, and audio attachments render with appropriate previews
- File validation enforces type whitelist and 25MB size limit
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-chat/04-03-SUMMARY.md`
</output>
