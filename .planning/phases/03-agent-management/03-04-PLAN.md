---
phase: 03-agent-management
plan: 04
type: execute
wave: 3
depends_on:
  - "03-02"
files_modified:
  - src/features/agents/components/agent-identity-editor.tsx
  - src/features/agents/components/agent-identity-sidebar.tsx
  - src/features/agents/api/use-agent-identity.ts
  - src/features/agents/lib/identity-templates.ts
  - src/views/agents/agent-identity-view.tsx
  - app/(dashboard)/agents/[agentId]/identity/page.tsx
autonomous: true
requirements:
  - AGNT-05

must_haves:
  truths:
    - "User can edit SOUL.md, IDENTITY.md, USER.md, and AGENTS.md with a Markdown editor at /agents/[agentId]/identity"
    - "Sidebar file list on the left shows all 4 identity files"
    - "Clicking a file in the sidebar loads it into the editor"
    - "Editor shows split-pane with raw markdown on left and live preview on right"
    - "Changes auto-save with debounce after user stops typing"
    - "Identity files have template starter content with section headers, placeholder text, and guidance comments"
  artifacts:
    - path: "src/features/agents/components/agent-identity-editor.tsx"
      provides: "Split-pane markdown editor with auto-save"
      exports: ["AgentIdentityEditor"]
    - path: "src/features/agents/components/agent-identity-sidebar.tsx"
      provides: "File list sidebar for identity files"
      exports: ["AgentIdentitySidebar"]
    - path: "src/features/agents/api/use-agent-identity.ts"
      provides: "TanStack Query hook for fetching/saving identity files"
      exports: ["useAgentIdentity"]
    - path: "src/features/agents/lib/identity-templates.ts"
      provides: "Default starter content for each identity file"
      exports: ["IDENTITY_FILE_DEFAULTS"]
    - path: "app/(dashboard)/agents/[agentId]/identity/page.tsx"
      provides: "Next.js route for /agents/[agentId]/identity"
  key_links:
    - from: "src/features/agents/components/agent-identity-editor.tsx"
      to: "@uiw/react-md-editor"
      via: "dynamic import with ssr: false"
      pattern: "dynamic.*import.*react-md-editor.*ssr.*false"
    - from: "src/features/agents/components/agent-identity-editor.tsx"
      to: "use-debounce"
      via: "useDebouncedCallback for auto-save"
      pattern: "useDebouncedCallback"
    - from: "src/views/agents/agent-identity-view.tsx"
      to: "src/features/agents/api/use-agent-identity.ts"
      via: "useAgentIdentity hook"
      pattern: "useAgentIdentity"
---

<objective>
Agent identity file editor at /agents/[agentId]/identity with split-pane Markdown editor, file sidebar, and auto-save.

Purpose: Users can edit their agents' core identity files (SOUL.md, IDENTITY.md, USER.md, AGENTS.md) with immediate visual feedback and automatic saving.
Output: Markdown editor page with file sidebar, split-pane preview, debounced auto-save, and template starter content.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-management/03-RESEARCH.md
@.planning/phases/03-agent-management/03-CONTEXT.md
@.planning/phases/03-agent-management/03-02-SUMMARY.md
@src/entities/agent/model/types.ts
@src/widgets/agent-detail-layout/components/agent-detail-shell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identity file editor with split-pane Markdown, file sidebar, and auto-save</name>
  <files>
    src/features/agents/components/agent-identity-editor.tsx
    src/features/agents/components/agent-identity-sidebar.tsx
    src/features/agents/api/use-agent-identity.ts
    src/features/agents/lib/identity-templates.ts
    src/views/agents/agent-identity-view.tsx
    app/(dashboard)/agents/[agentId]/identity/page.tsx
  </files>
  <action>
    **Step 1: Create identity file default templates at `src/features/agents/lib/identity-templates.ts`.**

    Per user decision: identity files always have template starter content with section headers, placeholder text, and guidance comments. These should "genuinely help users write good identity files, not just be empty boilerplate."

    Define `IDENTITY_FILE_DEFAULTS` as a Record<string, { name, description, defaultContent }>:

    - **SOUL.md**: Content with sections "## Core Personality", "## Values", "## Communication Style", "## Boundaries". Each section has a guidance comment (e.g., `<!-- Describe who this agent IS at its core -- personality traits, temperament, what drives them -->`) and placeholder text that reads as a genuine starting point.

    - **IDENTITY.md**: Sections "## Role", "## Capabilities", "## Expertise Areas", "## Working Style". Guidance comments explaining what each section means for the agent's behavior.

    - **USER.md**: Sections "## About the User", "## Preferences", "## Communication Preferences", "## Context". Guidance comments helping the user describe themselves to the agent.

    - **AGENTS.md**: Sections "## Known Agents", "## Collaboration Rules", "## Handoff Protocols". Guidance comments for multi-agent setups.

    Each file should be 20-40 lines of genuine, helpful content.

    **Step 2: Create useAgentIdentity hook at `src/features/agents/api/use-agent-identity.ts`.**

    - TanStack Query fetches all 4 identity files for an agent
    - Returns `{ files: Record<string, string>, isLoading, error, saveFile }`
    - `saveFile(fileKey: string, content: string)` is a mutation that saves a single file
    - For now, mock data: returns IDENTITY_FILE_DEFAULTS content. `saveFile` logs to console and shows success toast. Add `// TODO: Replace with gatewayClient.agent.saveIdentityFile()`.

    **Step 3: Create AgentIdentitySidebar at `src/features/agents/components/agent-identity-sidebar.tsx`.**

    Per user decision: sidebar file list on the left.
    - Lists all 4 identity files: SOUL.md, IDENTITY.md, USER.md, AGENTS.md
    - Each item shows file name in monospace + short description
    - Active file highlighted with `bg-accent text-accent-foreground`
    - onClick calls `onFileSelect(fileKey)`
    - Wrapped in ScrollArea

    **Step 4: Create AgentIdentityEditor at `src/features/agents/components/agent-identity-editor.tsx`.**

    Follow RESEARCH.md Pattern 5 closely. "use client" component.

    - Import @uiw/react-md-editor via `next/dynamic` with `{ ssr: false }` (Pitfall 1 -- CRITICAL)
    - Uses `useDebouncedCallback` from use-debounce (500ms) for auto-save
    - Wraps editor in `<div data-color-mode="dark">` for theme compatibility (Pitfall 4). If using next-themes, sync with `resolvedTheme`.
    - Editor in "live" preview mode (split-pane: editor left, preview right)
    - `visibleDragbar={false}` to hide the resize handle for a cleaner look
    - Height fills available space: `h-[calc(100vh-12rem)]`
    - Shows "Saving..." indicator when save is in progress (small text in bottom-right corner)
    - Shows "Saved" briefly after successful save (fade out after 2s)

    State management:
    - `activeFile` (string key) tracks which file is being edited
    - `files` (Record<string, string>) holds current file contents
    - When user types, update local state AND trigger debounced save
    - When switching files, flush any pending save before switching

    **Step 5: Create AgentIdentityView at `src/views/agents/agent-identity-view.tsx`.**

    "use client" component. Takes agentId prop.
    - Calls `useAgentIdentity(agentId)`
    - Layout: file sidebar (w-48) on left + editor area on right
    - Loading state: sidebar skeleton + editor area skeleton
    - Error state: error message with retry
    - Composes AgentIdentitySidebar + AgentIdentityEditor

    **Step 6: Create page route at `app/(dashboard)/agents/[agentId]/identity/page.tsx`.**

    Async server component. Awaits params, renders AgentIdentityView with agentId.
    ```tsx
    export const metadata = { title: "Identity Editor | AXion Hub" };
    ```
  </action>
  <verify>
    `bun run build` succeeds. Navigate to /agents/[id]/identity -- see file sidebar on left with 4 files, markdown editor on right with split-pane preview. Click different files to load them. Type in editor -- "Saving..." appears after a pause, then "Saved". Editor renders with dark theme matching the app.
  </verify>
  <done>
    Identity editor at /agents/[agentId]/identity renders with sidebar file list, split-pane Markdown editor (raw + preview), debounced auto-save, and template starter content. All 4 identity files (SOUL.md, IDENTITY.md, USER.md, AGENTS.md) are editable.
  </done>
</task>

</tasks>

<verification>
- `bun run lint` passes
- `bun run build` succeeds
- /agents/[agentId]/identity renders inside the agent detail layout (sidebar visible)
- File sidebar shows 4 identity files with names and descriptions
- Clicking a file loads its content into the editor
- Editor shows split-pane: raw markdown left, live preview right
- Typing triggers auto-save after 500ms debounce
- "Saving..." indicator appears during save
- Editor uses dark theme (data-color-mode="dark")
- Template starter content has genuine section headers and guidance
- No SSR errors from @uiw/react-md-editor (dynamic import with ssr: false)
</verification>

<success_criteria>
- All 4 identity files editable with split-pane Markdown editor
- Auto-save with debounce functional
- Template starter content is genuinely helpful (not empty boilerplate)
- No hydration/SSR errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-management/03-04-SUMMARY.md`
</output>
