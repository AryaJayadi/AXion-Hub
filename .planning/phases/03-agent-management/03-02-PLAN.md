---
phase: 03-agent-management
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - app/(dashboard)/agents/[agentId]/layout.tsx
  - app/(dashboard)/agents/[agentId]/page.tsx
  - src/widgets/agent-detail-layout/components/agent-detail-shell.tsx
  - src/features/agents/api/use-agent-detail.ts
  - src/features/agents/components/agent-overview-widgets.tsx
  - src/features/agents/components/agent-recent-activity.tsx
  - src/features/agents/components/agent-quick-actions.tsx
  - src/views/agents/agent-detail-view.tsx
autonomous: true
requirements:
  - AGNT-02

must_haves:
  truths:
    - "User can view agent overview at /agents/[agentId] showing status, model, context usage, uptime, and current task"
    - "Left sidebar navigation lists all sub-sections: overview, identity, sessions, memory, skills, tools, sandbox, channels, logs, metrics"
    - "Sidebar persists across sub-page transitions without re-rendering"
    - "Overview page has dashboard-style widget/card layout with status card, stats card, recent activity card, and quick actions card"
    - "Active sub-page is highlighted in the sidebar"
  artifacts:
    - path: "app/(dashboard)/agents/[agentId]/layout.tsx"
      provides: "Nested layout for agent detail with persistent sidebar"
      contains: "AgentDetailShell"
    - path: "app/(dashboard)/agents/[agentId]/page.tsx"
      provides: "Default overview page for agent detail"
      contains: "AgentDetailView"
    - path: "src/widgets/agent-detail-layout/components/agent-detail-shell.tsx"
      provides: "Agent detail layout with left sidebar navigation"
      exports: ["AgentDetailShell"]
    - path: "src/features/agents/components/agent-overview-widgets.tsx"
      provides: "Dashboard widget cards for agent overview"
      exports: ["AgentOverviewWidgets"]
  key_links:
    - from: "app/(dashboard)/agents/[agentId]/layout.tsx"
      to: "src/widgets/agent-detail-layout/components/agent-detail-shell.tsx"
      via: "imports AgentDetailShell"
      pattern: "AgentDetailShell"
    - from: "src/views/agents/agent-detail-view.tsx"
      to: "src/features/agents/api/use-agent-detail.ts"
      via: "useAgentDetail hook"
      pattern: "useAgentDetail"
    - from: "src/features/agents/api/use-agent-detail.ts"
      to: "src/features/agents/model/agent-store.ts"
      via: "syncs into Zustand agentDetail"
      pattern: "setAgentDetail"
---

<objective>
Agent detail layout with persistent sidebar navigation and overview dashboard page at /agents/[agentId].

Purpose: Establishes the nested layout structure that all 9 agent sub-pages (identity through metrics) will render inside, and delivers the overview page with status/model/context/uptime widgets.
Output: Agent detail layout with sidebar, overview page with widget cards, and TanStack Query hook for agent detail data.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-management/03-RESEARCH.md
@.planning/phases/03-agent-management/03-CONTEXT.md
@.planning/phases/03-agent-management/03-01-SUMMARY.md
@src/entities/agent/index.ts
@src/features/agents/model/agent-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent detail nested layout with persistent sidebar navigation</name>
  <files>
    app/(dashboard)/agents/[agentId]/layout.tsx
    src/widgets/agent-detail-layout/components/agent-detail-shell.tsx
  </files>
  <action>
    **Step 1: Create AgentDetailShell at `src/widgets/agent-detail-layout/components/agent-detail-shell.tsx`.**

    Follow RESEARCH.md Pattern 1 exactly. This is a "use client" component.

    Per user decision: left sidebar navigation listing all sub-sections.

    Sub-page navigation items (in order):
    1. Overview (href: "", icon: LayoutDashboard)
    2. Identity (href: "/identity", icon: FileText)
    3. Sessions (href: "/sessions", icon: MessageSquare)
    4. Memory (href: "/memory", icon: Brain)
    5. Skills (href: "/skills", icon: Wrench)
    6. Tools (href: "/tools", icon: Settings2)
    7. Sandbox (href: "/sandbox", icon: Shield)
    8. Channels (href: "/channels", icon: Radio)
    9. Logs (href: "/logs", icon: ScrollText)
    10. Metrics (href: "/metrics", icon: BarChart3)

    - Use `usePathname()` from next/navigation to determine active item
    - Overview is active when pathname exactly equals `/agents/${agentId}` (no trailing sub-path)
    - Other items are active when pathname starts with their full href
    - Active item: `bg-accent text-accent-foreground font-medium`
    - Inactive item: `text-muted-foreground hover:bg-accent/50 hover:text-foreground`
    - Each nav item renders as a `<Link>` with icon (size-4) + label text
    - Sidebar width: `w-56 shrink-0 border-r border-border`
    - Wrap nav in ScrollArea for overflow safety
    - At the top of the sidebar, show the agent name (passed via prop or fetched) in a small header area
    - Main content area: `flex-1 overflow-auto p-6`

    **Step 2: Create the nested layout at `app/(dashboard)/agents/[agentId]/layout.tsx`.**

    This is an async server component. Follows RESEARCH.md Pattern 1:
    ```tsx
    export default async function AgentDetailLayout({
      children,
      params,
    }: {
      children: React.ReactNode;
      params: Promise<{ agentId: string }>;
    }) {
      const { agentId } = await params;
      return (
        <AgentDetailShell agentId={agentId}>
          {children}
        </AgentDetailShell>
      );
    }
    ```

    Remember: Next.js 16 params are Promises that must be awaited (Pitfall 7 in research).
  </action>
  <verify>
    `bun run build` succeeds. Navigating to /agents/any-id shows the sidebar with all 10 sub-page links. Clicking links navigates to sub-paths while sidebar persists.
  </verify>
  <done>
    Agent detail layout renders with left sidebar navigation listing all sub-sections. Sidebar persists across sub-page transitions. Active page is highlighted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Agent overview page with dashboard-style widget cards</name>
  <files>
    src/features/agents/api/use-agent-detail.ts
    src/features/agents/components/agent-overview-widgets.tsx
    src/features/agents/components/agent-recent-activity.tsx
    src/features/agents/components/agent-quick-actions.tsx
    src/views/agents/agent-detail-view.tsx
    app/(dashboard)/agents/[agentId]/page.tsx
  </files>
  <action>
    **Step 1: Create useAgentDetail hook at `src/features/agents/api/use-agent-detail.ts`.**

    - TanStack Query fetches a single agent by ID
    - Syncs into Zustand `setAgentDetail`
    - `staleTime: Infinity`, `refetchOnWindowFocus: false` (WebSocket handles real-time)
    - For now, mock data: finds the agent from the mock roster by ID. Add `// TODO: Replace with gatewayClient.getAgent(agentId)`.
    - Returns { agent, isLoading, error } where agent is read from Zustand `agentDetail`

    **Step 2: Create AgentOverviewWidgets at `src/features/agents/components/agent-overview-widgets.tsx`.**

    Per user decision: dashboard-style widget/card layout. Follow the research Code Example for Overview Widgets.

    Layout: 4-column grid on xl, 2-column on md, 1-column on mobile.

    Row 1 (4 stat cards):
    - **Status Card**: Colored dot (matching status) + status text (capitalize) + current task if working
    - **Model Card**: Model name prominently displayed
    - **Context Usage Card**: Percentage number + Progress bar component
    - **Uptime Card**: Formatted uptime (use formatUptime from agent-utils) + "Last active X ago" relative time (use date-fns formatDistanceToNow)

    Each card uses shadcn Card with CardHeader (small label) and CardContent (value).

    **Step 3: Create AgentRecentActivity at `src/features/agents/components/agent-recent-activity.tsx`.**

    A Card spanning 2 columns (on lg+) showing the 5 most recent activity items.
    - Mock data: array of 5 recent activity entries with timestamp, event type, summary
    - Each entry: small colored dot (by event type), timestamp (relative), summary text
    - "View all" link at bottom pointing to `/agents/${agentId}/logs`

    **Step 4: Create AgentQuickActions at `src/features/agents/components/agent-quick-actions.tsx`.**

    A Card spanning 2 columns (on lg+) with action buttons:
    - "Send Message" (MessageSquare icon) -- links to `/chat/${agentId}` (future, disabled for now with tooltip "Available after Phase 4")
    - "View Sessions" (MessageSquare icon) -- links to `/agents/${agentId}/sessions`
    - "Edit Identity" (FileText icon) -- links to `/agents/${agentId}/identity`
    - "View Logs" (ScrollText icon) -- links to `/agents/${agentId}/logs`

    Buttons rendered as Link components styled as outline buttons with icon + label.

    **Step 5: Create AgentDetailView at `src/views/agents/agent-detail-view.tsx`.**

    "use client" component. Takes agentId prop.
    - Calls `useAgentDetail(agentId)`
    - Shows loading skeletons (4 card skeletons + 2 wide card skeletons) when loading
    - Shows error state with retry button on error
    - On success, renders:
      1. AgentOverviewWidgets (Row 1: 4 stat cards)
      2. AgentRecentActivity + AgentQuickActions (Row 2: 2 wide cards)

    **Step 6: Create the page at `app/(dashboard)/agents/[agentId]/page.tsx`.**

    Async server component. Awaits params to get agentId. Renders AgentDetailView with agentId prop. Sets metadata title dynamically.
  </action>
  <verify>
    `bun run build` succeeds. Navigate to /agents/[any-mock-agent-id] -- see the overview page with 4 stat cards (status, model, context usage, uptime) and 2 wide cards (recent activity, quick actions) inside the agent detail layout with sidebar.
  </verify>
  <done>
    Agent overview at /agents/[agentId] renders dashboard-style widget cards showing status, model, context usage, uptime, recent activity, and quick actions. Sidebar navigation is visible and functional.
  </done>
</task>

</tasks>

<verification>
- `bun run lint` passes
- `bun run build` succeeds
- /agents/[agentId] renders with left sidebar listing all 10 sub-sections
- Active sidebar item is visually highlighted
- Overview page shows 4 stat widget cards (status, model, context, uptime)
- Recent activity card shows 5 mock entries
- Quick actions card has navigation buttons to sessions, identity, logs
- Sidebar persists when clicking different sub-page links
- Loading skeletons show before data loads
</verification>

<success_criteria>
- Agent detail layout with persistent sidebar navigation is functional
- Overview page displays all required data: status, model, context usage, uptime, current task
- Layout is responsive (4 cols xl, 2 cols md, 1 col mobile)
- Sub-page navigation structure ready for all subsequent plans to add pages
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-management/03-02-SUMMARY.md`
</output>
