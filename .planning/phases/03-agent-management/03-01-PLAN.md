---
phase: 03-agent-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/agent/model/types.ts
  - src/entities/agent/model/schemas.ts
  - src/entities/agent/model/templates.ts
  - src/entities/agent/lib/agent-utils.ts
  - src/entities/agent/index.ts
  - src/features/agents/model/agent-store.ts
  - src/features/agents/api/use-agents.ts
  - src/features/agents/api/use-agent-mutations.ts
  - src/features/agents/components/agent-card.tsx
  - src/features/agents/components/agent-grid.tsx
  - src/features/agents/components/agent-search-bar.tsx
  - src/features/agents/index.ts
  - src/views/agents/agents-roster-view.tsx
  - app/(dashboard)/agents/page.tsx
autonomous: true
requirements:
  - AGNT-01

must_haves:
  truths:
    - "User can view all agents in a card grid at /agents"
    - "Agent cards look like employee badges with avatar, name, model, and one key stat"
    - "Agent status is communicated through subtle border/glow color (green=online, yellow=idle, blue=working, red=error)"
    - "No text status label appears on the cards -- the ambient glow IS the status indicator"
    - "User can search agents by name via a text search bar"
    - "User can filter agents by status via a dropdown (online, idle, working, error, all)"
    - "Search and filter state persists in the URL via query params"
  artifacts:
    - path: "src/entities/agent/model/types.ts"
      provides: "Agent, AgentStatus, AgentSession, AgentMemoryFile, AgentSkill, AgentTool, AgentLogEntry, AgentMetrics, AgentTemplate types"
      contains: "AgentStatus"
    - path: "src/entities/agent/model/schemas.ts"
      provides: "Zod schemas for agent entity validation"
      contains: "agentSchema"
    - path: "src/entities/agent/model/templates.ts"
      provides: "Pre-built agent template definitions"
      contains: "AGENT_TEMPLATES"
    - path: "src/features/agents/model/agent-store.ts"
      provides: "Zustand store for agent roster and detail state"
      exports: ["useAgentStore"]
    - path: "src/features/agents/components/agent-card.tsx"
      provides: "Employee badge-style card with status glow"
      exports: ["AgentCard"]
    - path: "src/views/agents/agents-roster-view.tsx"
      provides: "Roster page composition with search, filter, and grid"
      exports: ["AgentsRosterView"]
    - path: "app/(dashboard)/agents/page.tsx"
      provides: "Next.js route for /agents"
  key_links:
    - from: "app/(dashboard)/agents/page.tsx"
      to: "src/views/agents/agents-roster-view.tsx"
      via: "imports AgentsRosterView"
      pattern: "AgentsRosterView"
    - from: "src/views/agents/agents-roster-view.tsx"
      to: "src/features/agents/api/use-agents.ts"
      via: "useAgents hook"
      pattern: "useAgents"
    - from: "src/features/agents/api/use-agents.ts"
      to: "src/features/agents/model/agent-store.ts"
      via: "syncs TanStack Query data into Zustand"
      pattern: "useAgentStore"
    - from: "src/features/agents/components/agent-card.tsx"
      to: "src/entities/agent/model/types.ts"
      via: "imports Agent type"
      pattern: "import.*Agent.*from.*entities/agent"
---

<objective>
Agent entity foundation, Zustand agent store, and roster page at /agents with employee badge-style card grid, status glow borders, and URL-persisted search/filter.

Purpose: Establishes the shared agent entity model used by all 13 AGNT requirements and delivers the first user-visible feature -- the agent roster grid.
Output: Agent types, schemas, templates, Zustand store, TanStack Query hooks, and the /agents page with card grid.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-management/03-RESEARCH.md
@.planning/phases/03-agent-management/03-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
@src/shared/lib/cn.ts
@src/app/providers/app-providers.tsx
@src/app/styles/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent entity model, Zustand store, and TanStack Query hooks</name>
  <files>
    src/entities/agent/model/types.ts
    src/entities/agent/model/schemas.ts
    src/entities/agent/model/templates.ts
    src/entities/agent/lib/agent-utils.ts
    src/entities/agent/index.ts
    src/features/agents/model/agent-store.ts
    src/features/agents/api/use-agents.ts
    src/features/agents/api/use-agent-mutations.ts
    src/features/agents/index.ts
  </files>
  <action>
    **Step 1: Install new Phase 3 dependencies and shadcn components.**

    ```bash
    bun add @uiw/react-md-editor use-debounce
    bunx shadcn@latest add card avatar badge tabs dialog scroll-area select switch progress skeleton chart tooltip dropdown-menu command separator
    ```

    Note: recharts and react-hook-form are already installed from Phase 1/2.

    **Step 2: Create agent entity types at `src/entities/agent/model/types.ts`.**

    Define these types exactly as specified in the RESEARCH.md Code Examples section:
    - `AgentStatus = "online" | "idle" | "working" | "error" | "offline"`
    - `Agent` interface: id, name, description, avatar?, status, model, keyStat, contextUsage (0-100), uptime (seconds), currentTask?, createdAt, lastActive
    - `AgentSession` interface: id, agentId, startedAt, endedAt?, tokenCount, compactionCount, status
    - `AgentMemoryFile` interface: name, path, content, lastModified
    - `AgentSkill` interface: id, name, description, enabled, source
    - `AgentTool` interface: name, description, allowed, elevated
    - `AgentLogEntry` interface: id, timestamp, eventType, summary, details?, status
    - `AgentMetrics` interface: tokenUsage, costBreakdown, tasksCompleted, responseTimes (all as array of {date, value} objects)
    - `AgentTemplate` interface: id, name, description, icon, category, basics, modelConfig, identity, skillsTools, sandbox, channels (matching the wizard store shape)
    - `AgentIdentityFiles` type: Record with keys soul, identity, user, agents mapping to string content

    **Step 3: Create Zod schemas at `src/entities/agent/model/schemas.ts`.**

    Use `import { z } from "zod/v4"` (per project convention from 01-01). Create schemas for Agent, AgentSession, AgentSkill, AgentTool -- these validate data from the gateway.

    **Step 4: Create agent templates at `src/entities/agent/model/templates.ts`.**

    Define `AGENT_TEMPLATES` array with at least 5 templates as shown in RESEARCH.md:
    - "Code Assistant" (Development category, claude-sonnet-4, temp 0.3)
    - "Research Agent" (Research category, claude-sonnet-4, temp 0.5)
    - "Customer Support" (Support category, claude-sonnet-4, temp 0.4)
    - "Technical Writer" (Writing category, claude-sonnet-4, temp 0.6)
    - "Data Analyst" (Analysis category, claude-sonnet-4, temp 0.4)

    Each template has full pre-filled identity files (SOUL.md, IDENTITY.md, USER.md, AGENTS.md) with genuine, helpful starter content -- not empty boilerplate. Include section headers, guidance comments, and placeholder text per user decision.

    **Step 5: Create agent utility functions at `src/entities/agent/lib/agent-utils.ts`.**

    - `getStatusColor(status: AgentStatus): string` -- returns the CSS color for glow borders
    - `getStatusGlowClasses(status: AgentStatus): string` -- returns Tailwind classes for the card glow effect
    - `formatUptime(seconds: number): string` -- human-readable uptime ("2h 35m", "3d 12h")
    - `formatKeyStat(agent: Agent): string` -- derives a key stat string from agent data

    **Step 6: Create barrel export at `src/entities/agent/index.ts`.**

    Re-export all types, schemas, templates, and utils.

    **Step 7: Create Zustand agent store at `src/features/agents/model/agent-store.ts`.**

    Follow RESEARCH.md Pattern 3 exactly:
    - State: agents (Agent[]), isLoading, agentDetail (Agent | null)
    - Actions: setAgents, updateAgentStatus, setAgentDetail, addAgent, removeAgent
    - Export `initAgentStoreSubscriptions(eventBus)` for WebSocket integration
    - Use the `create` import from zustand (NOT zustand/react)

    **Step 8: Create TanStack Query hooks.**

    `src/features/agents/api/use-agents.ts`:
    - Follow RESEARCH.md Pattern 6: TanStack Query fetches initial data, syncs into Zustand, components read from Zustand
    - `staleTime: Infinity`, `refetchOnWindowFocus: false` to prevent TanStack/Zustand desync (per Pitfall 5 in research)
    - For now, the fetch function returns mock data (array of 6-8 agents with varied statuses) since the gateway client methods for agent CRUD are not yet wired. Add a `// TODO: Replace with gatewayClient.getAgents()` comment.

    `src/features/agents/api/use-agent-mutations.ts`:
    - `useCreateAgent` mutation (currently mocks the response, adds to store)
    - `useDeleteAgent` mutation (currently mocks, removes from store)
    - Both show toast via sonner on success/error

    **Step 9: Create barrel export at `src/features/agents/index.ts`.**
  </action>
  <verify>
    `bun run lint` passes. `bun run build` succeeds. Importing from `@/entities/agent` and `@/features/agents` resolves types correctly.
  </verify>
  <done>
    Agent entity types, Zod schemas, 5 template definitions, utility functions, Zustand store, and TanStack Query hooks all exist and export cleanly. Mock data provides realistic agent roster for development.
  </done>
</task>

<task type="auto">
  <name>Task 2: Agent roster page with card grid, status glow, and search/filter</name>
  <files>
    src/features/agents/components/agent-card.tsx
    src/features/agents/components/agent-grid.tsx
    src/features/agents/components/agent-search-bar.tsx
    src/views/agents/agents-roster-view.tsx
    app/(dashboard)/agents/page.tsx
  </files>
  <action>
    **Step 1: Create AgentCard at `src/features/agents/components/agent-card.tsx`.**

    Per user decision: cards styled like employee badges. Follow RESEARCH.md Pattern 2:
    - Card with subtle border/glow that changes color by status using `box-shadow` (NOT border-width changes -- prevents layout shift per Pitfall 3)
    - Status glow classes: online = green-500/40 shadow + green-500/30 border, idle = yellow-500/40 + yellow-500/30, working = blue-500/40 + blue-500/30, error = red-500/40 + red-500/30, offline = border-border only
    - Card content: Avatar (with initials fallback), agent name (font-semibold truncate), model name (text-xs muted), one key stat (text-xs muted)
    - NO text status label on the card -- per user decision, the ambient glow IS the status indicator
    - `transition-all duration-300 hover:scale-[1.02]` for smooth hover
    - onClick navigates to `/agents/${agent.id}` via `useRouter`
    - Three-dot dropdown menu (DropdownMenu) in top-right corner with: Edit, Clone, Delete options (delete shows AlertDialog confirmation)

    **Step 2: Create AgentGrid at `src/features/agents/components/agent-grid.tsx`.**

    Responsive CSS Grid: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4`. Maps over agent array rendering AgentCard for each. Shows loading skeletons (4 card-shaped Skeleton components matching AgentCard dimensions) when isLoading. Shows EmptyState when filtered results are empty ("No agents found" with appropriate messaging).

    **Step 3: Create AgentSearchBar at `src/features/agents/components/agent-search-bar.tsx`.**

    Per user decision: search bar with text search by name + status dropdown filter.
    - Input field for text search (with Search icon from lucide-react)
    - Select dropdown for status filter with options: All, Online, Idle, Working, Error
    - Both controlled by parent via props (value + onChange)
    - Laid out horizontally: search input takes flex-1, status select is fixed width
    - Include a "New Agent" button (Plus icon) on the right side that links to `/agents/new`

    **Step 4: Create AgentsRosterView at `src/views/agents/agents-roster-view.tsx`.**

    Follow RESEARCH.md Pattern 7:
    - "use client" component
    - Uses `useQueryState` from nuqs for URL-persisted search ("q") and status filter ("status")
    - Calls `useAgents()` hook for data
    - Filters agents in `useMemo` by search text (case-insensitive name match) and status
    - Renders PageHeader with title "Agents" at top (use a simple h1 + p description for now if shared PageHeader component doesn't exist yet)
    - Renders AgentSearchBar with search/status state
    - Renders AgentGrid with filtered agents and loading state

    **Step 5: Create Next.js route at `app/(dashboard)/agents/page.tsx`.**

    ```tsx
    import { AgentsRosterView } from "@/views/agents/agents-roster-view";

    export const metadata = {
      title: "Agents | AXion Hub",
    };

    export default function AgentsPage() {
      return <AgentsRosterView />;
    }
    ```

    Wrap with `<Suspense>` if needed for nuqs (nuqs with App Router may require a Suspense boundary for `useQueryState`).
  </action>
  <verify>
    `bun run build` succeeds. Navigate to `http://localhost:3000/agents` -- see card grid with mock agents, each card showing avatar/name/model/stat with colored glow borders. Search filters by name. Status dropdown filters by status. URL updates with ?q= and ?status= params.
  </verify>
  <done>
    /agents page renders a responsive card grid of employee badge-style agent cards with ambient status glow (no text labels), text search by name, and status dropdown filter. Search/filter state persists in URL query params.
  </done>
</task>

</tasks>

<verification>
- `bun run lint` passes with zero errors
- `bun run build` succeeds
- Navigating to /agents shows the agent card grid with mock data
- Cards display avatar, name, model, key stat, and colored border glow matching agent status
- No text status labels appear on cards
- Search by name works (case insensitive)
- Status dropdown filter works (online, idle, working, error, all)
- URL updates with ?q= and ?status= parameters
- Agent entity types import cleanly from @/entities/agent
- Zustand store imports cleanly from @/features/agents
</verification>

<success_criteria>
- Agent roster visible at /agents with card grid layout
- Status glow borders correctly map green/yellow/blue/red to online/idle/working/error
- Search and filter functional with URL persistence
- Agent entity model and Zustand store are established for use by all subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-management/03-01-SUMMARY.md`
</output>
