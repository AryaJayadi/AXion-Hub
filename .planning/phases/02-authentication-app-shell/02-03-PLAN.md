---
phase: 02-authentication-app-shell
plan: 03
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - app/(dashboard)/layout.tsx
  - app/(dashboard)/page.tsx
  - src/widgets/app-shell/components/app-sidebar.tsx
  - src/widgets/app-shell/components/header-bar.tsx
  - src/widgets/app-shell/components/user-menu.tsx
  - src/widgets/app-shell/components/mobile-nav.tsx
  - src/widgets/app-shell/config/navigation.ts
autonomous: true
requirements:
  - AUTH-06

must_haves:
  truths:
    - "Authenticated user sees the app shell with collapsible sidebar, header bar with breadcrumbs, and main content area"
    - "Sidebar shows navigation groups (Core, Operations, Automation, System) with section headers and visual dividers"
    - "Sidebar collapses from full labels to icon-only rail when user clicks the toggle"
    - "Header bar shows breadcrumbs on the left, global search placeholder center-right, and user avatar/menu on the right"
    - "User menu dropdown shows user name, email, and sign out option"
    - "On mobile, sidebar auto-hides and a hamburger button toggles it as an overlay"
    - "Unauthenticated users accessing dashboard routes are redirected to /login via server-side session validation in the layout"
    - "Dashboard home page shows a placeholder with welcome message"
  artifacts:
    - path: "app/(dashboard)/layout.tsx"
      provides: "Authenticated app shell with session validation"
      contains: "auth.api.getSession"
    - path: "app/(dashboard)/page.tsx"
      provides: "Dashboard home placeholder"
      min_lines: 5
    - path: "src/widgets/app-shell/components/app-sidebar.tsx"
      provides: "Collapsible sidebar with grouped navigation"
      contains: "Sidebar"
    - path: "src/widgets/app-shell/components/header-bar.tsx"
      provides: "Header with breadcrumbs and user menu"
      contains: "Breadcrumb"
    - path: "src/widgets/app-shell/components/user-menu.tsx"
      provides: "User avatar dropdown with sign out"
      contains: "signOut"
    - path: "src/widgets/app-shell/config/navigation.ts"
      provides: "Sidebar navigation configuration data"
      contains: "navigationConfig"
  key_links:
    - from: "app/(dashboard)/layout.tsx"
      to: "src/features/auth/lib/auth.ts"
      via: "auth.api.getSession for server-side session validation"
      pattern: "auth\\.api\\.getSession"
    - from: "src/widgets/app-shell/components/app-sidebar.tsx"
      to: "src/widgets/app-shell/config/navigation.ts"
      via: "import navigationConfig for sidebar items"
      pattern: "navigationConfig"
    - from: "src/widgets/app-shell/components/user-menu.tsx"
      to: "src/features/auth/lib/auth-client.ts"
      via: "signOut for logout functionality"
      pattern: "signOut"
---

<objective>
Build the authenticated application shell: collapsible sidebar with grouped navigation, header bar with breadcrumbs and user menu, and server-side session validation in the dashboard layout. This is the container for all authenticated pages in the app.

Purpose: Provide the persistent navigation frame that every authenticated page lives inside. Users see the sidebar, header, and content area after logging in.
Output: Working app shell with sidebar (full + icon rail), header (breadcrumbs + user menu), mobile responsive layout, and a dashboard placeholder page.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-app-shell/02-RESEARCH.md
@.planning/phases/02-authentication-app-shell/02-CONTEXT.md
@.planning/phases/02-authentication-app-shell/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sidebar/breadcrumb components and create navigation config + app sidebar</name>
  <files>
    src/widgets/app-shell/config/navigation.ts
    src/widgets/app-shell/components/app-sidebar.tsx
  </files>
  <action>
    **1. Install required shadcn/ui components** (if not already present):
    ```bash
    bunx shadcn@latest add sidebar breadcrumb dropdown-menu avatar sheet
    ```
    These install to `src/shared/ui/` per components.json.

    **2. Navigation configuration** (`src/widgets/app-shell/config/navigation.ts`):
    Data-driven navigation structure with grouped sections per locked decision ("Sidebar navigation grouped with section headers with visual dividers"):

    ```typescript
    import {
      LayoutDashboard, Bot, MessageSquare, Kanban,
      Radio, Globe, Activity, FolderOpen,
      Workflow, Plug, Shield, Settings,
    } from "lucide-react";
    import type { LucideIcon } from "lucide-react";

    export interface NavItem {
      title: string;
      url: string;
      icon: LucideIcon;
    }

    export interface NavGroup {
      label: string;
      items: NavItem[];
    }

    export const navigationConfig: NavGroup[] = [
      {
        label: "Core",
        items: [
          { title: "Dashboard", url: "/", icon: LayoutDashboard },
          { title: "Agents", url: "/agents", icon: Bot },
          { title: "Chat", url: "/chat", icon: MessageSquare },
          { title: "Missions", url: "/missions", icon: Kanban },
        ],
      },
      {
        label: "Operations",
        items: [
          { title: "Gateway", url: "/gateway", icon: Radio },
          { title: "Channels", url: "/channels", icon: Globe },
          { title: "Activity", url: "/activity", icon: Activity },
          { title: "Files", url: "/workspace", icon: FolderOpen },
        ],
      },
      {
        label: "Automation",
        items: [
          { title: "Workflows", url: "/workflows", icon: Workflow },
          { title: "Skills", url: "/skills", icon: Plug },
        ],
      },
      {
        label: "System",
        items: [
          { title: "Approvals", url: "/approvals", icon: Shield },
          { title: "Settings", url: "/settings", icon: Settings },
        ],
      },
    ];
    ```

    **3. App sidebar** (`src/widgets/app-shell/components/app-sidebar.tsx`):
    Mark as `"use client"`. Uses shadcn/ui Sidebar component with `collapsible="icon"` per locked decision ("Collapsible sidebar: full labels collapse to icon-only rail").

    Structure:
    - `<Sidebar collapsible="icon">` wrapping everything
    - `<SidebarHeader>`: Placeholder area for org switcher (Plan 04 adds it). For now, show AXion Hub logo + name. When collapsed, show just the logo icon.
    - `<SidebarContent>`: Map over `navigationConfig` groups, each wrapped in `<SidebarGroup>`:
      - `<SidebarGroupLabel>` for group label (e.g., "Core")
      - `<SidebarGroupContent>` containing `<SidebarMenu>` with items
      - Each item: `<SidebarMenuItem>` > `<SidebarMenuButton asChild tooltip={item.title}>` > `<Link href={item.url}>` with `<item.icon />` and `<span>{item.title}</span>`
    - Use Next.js `Link` component (not `<a>`) for client-side navigation
    - Highlight active item: use `usePathname()` from next/navigation, compare with item.url. Set `isActive` prop on `SidebarMenuButton`.
    - `<SidebarFooter>`: Will hold UserMenu (added in Task 2 of this plan)
    - `<SidebarRail />` at the end (enables the toggle handle between full and rail modes)

    Props: `user: { name: string; email: string; image?: string | null }` (passed from layout).
  </action>
  <verify>
    - `bun run build` passes
    - `src/widgets/app-shell/config/navigation.ts` exports `navigationConfig` with 4 groups and 12 items total
    - `src/widgets/app-shell/components/app-sidebar.tsx` uses `Sidebar`, `SidebarContent`, `SidebarGroup`, `SidebarGroupLabel`, `SidebarMenu`, `SidebarMenuButton`, `SidebarRail`
    - Sidebar uses `collapsible="icon"` prop
    - Active item detection uses `usePathname()`
  </verify>
  <done>
    Navigation config defines 4 groups (Core, Operations, Automation, System) with 12 nav items. App sidebar renders collapsible sidebar with icon rail mode, grouped navigation with labels, active item highlighting, and SidebarRail toggle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build header bar, user menu, and dashboard layout with session validation</name>
  <files>
    src/widgets/app-shell/components/header-bar.tsx
    src/widgets/app-shell/components/user-menu.tsx
    app/(dashboard)/layout.tsx
    app/(dashboard)/page.tsx
  </files>
  <action>
    **1. User menu** (`src/widgets/app-shell/components/user-menu.tsx`):
    Mark as `"use client"`. Dropdown menu triggered by user avatar.

    Structure:
    - Trigger: `<Avatar>` with user image or fallback initials (first letter of name). Wrap in `<DropdownMenuTrigger asChild><Button variant="ghost" size="icon">`.
    - Content (`<DropdownMenuContent align="end">`):
      - `<DropdownMenuLabel>`: User name + email (email in `text-muted-foreground text-xs`)
      - `<DropdownMenuSeparator />`
      - `<DropdownMenuItem>`: "Profile" (link to /settings/profile, placeholder for now)
      - `<DropdownMenuItem>`: "Settings" (link to /settings)
      - `<DropdownMenuSeparator />`
      - `<DropdownMenuItem>`: "Sign out" — calls `authClient.signOut()` then `router.push("/login")`. Show loading state.

    Props: `user: { name: string; email: string; image?: string | null }`.

    **2. Header bar** (`src/widgets/app-shell/components/header-bar.tsx`):
    Per locked decision: "Header bar shows breadcrumbs (left), global search (center-right), user avatar/menu (right)".

    Structure: `<header>` with `flex items-center gap-2 px-4 h-14 border-b` (or similar).
    - Left side: `<SidebarTrigger />` (hamburger/collapse button) + `<Separator orientation="vertical" className="h-4" />` + `<Breadcrumb>` component
      - Breadcrumbs: Use `usePathname()` to derive breadcrumb segments. Split pathname by `/`, capitalize each segment, create BreadcrumbItems. First item is always "Home" linking to `/`. Use `BreadcrumbList`, `BreadcrumbItem`, `BreadcrumbLink`, `BreadcrumbSeparator`, `BreadcrumbPage` (last segment).
    - Center-right: Global search placeholder — a styled div or button that looks like a search input (`flex items-center gap-2 text-muted-foreground bg-muted/50 rounded-md px-3 py-1.5 text-sm`) showing "Search..." with `Search` icon. Non-functional placeholder for now (future phases add search).
    - Right side: `<UserMenu user={user} />`

    Props: `user: { name: string; email: string; image?: string | null }`.

    **3. Dashboard layout** (`app/(dashboard)/layout.tsx`):
    Server component. Two-layer protection per research Pattern 5:
    - Call `auth.api.getSession({ headers: await headers() })` — full server-side session validation
    - If no session: `redirect("/login")`
    - If session exists: render app shell

    Structure:
    ```tsx
    <SidebarProvider>
      <AppSidebar user={session.user} />
      <SidebarInset>
        <HeaderBar user={session.user} />
        <main className="flex-1 overflow-auto p-4 md:p-6">
          {children}
        </main>
      </SidebarInset>
    </SidebarProvider>
    ```

    Import `SidebarProvider` and `SidebarInset` from `@/shared/ui/sidebar`.

    **4. Dashboard home page** (`app/(dashboard)/page.tsx`):
    Simple placeholder page showing:
    - "Welcome to AXion Hub" heading
    - "Your mission control dashboard will appear here." description
    - This is intentionally minimal — Phase 5 builds the real dashboard

    Per locked decision: "No onboarding wizard — each page uses contextual empty states to guide first actions."
  </action>
  <verify>
    - `bun run build` passes
    - `app/(dashboard)/layout.tsx` calls `auth.api.getSession` and redirects if no session
    - `app/(dashboard)/layout.tsx` renders `SidebarProvider` > `AppSidebar` + `SidebarInset` > `HeaderBar` + main
    - `src/widgets/app-shell/components/header-bar.tsx` contains Breadcrumb, SidebarTrigger, search placeholder, UserMenu
    - `src/widgets/app-shell/components/user-menu.tsx` contains signOut call, DropdownMenu, Avatar
    - `app/(dashboard)/page.tsx` exists with welcome message
  </verify>
  <done>
    App shell is complete: dashboard layout validates session server-side and redirects to /login if unauthenticated. Authenticated users see the sidebar (collapsible to icon rail), header bar (breadcrumbs + search placeholder + user avatar menu), and main content area. User menu provides sign out. Dashboard home shows welcome placeholder. Mobile sidebar works via SidebarTrigger.
  </done>
</task>

</tasks>

<verification>
- Authenticated users see the full app shell with sidebar and header
- Sidebar shows 4 navigation groups with labeled sections
- Sidebar collapses to icon rail and expands back
- Header shows breadcrumbs that update based on current route
- User menu shows name, email, and working sign out button
- Unauthenticated access to any dashboard route redirects to /login
- Mobile viewport shows hamburger button that toggles sidebar overlay
- `bun run build` passes
</verification>

<success_criteria>
- Dashboard layout at / (and all sub-routes) validates session server-side and redirects to /login if unauthenticated
- Sidebar renders 4 groups (Core, Operations, Automation, System) with 12 navigation items and active item highlighting
- Sidebar collapses from full labels to icon-only rail via SidebarRail toggle
- Header bar shows dynamic breadcrumbs (left), search placeholder (center-right), user avatar with dropdown menu (right)
- User menu shows user info and working sign out that redirects to /login
- Mobile responsive: sidebar hidden by default, hamburger button toggles overlay
- Dashboard home page shows contextual welcome/empty state
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-app-shell/02-03-SUMMARY.md`
</output>
