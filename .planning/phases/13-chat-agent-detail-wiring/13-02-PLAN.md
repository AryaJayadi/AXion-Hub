---
phase: 13-chat-agent-detail-wiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/agents/components/agent-sessions-table.tsx
  - src/widgets/agent-detail-layout/components/agent-detail-shell.tsx
autonomous: true
requirements:
  - SESS-01
  - AGNT-02

must_haves:
  truths:
    - "Per-agent sessions table at /agents/[agentId]/sessions row click opens SessionSlideOver"
    - "AgentDetailShell displays the agent's name in the sidebar header"
    - "Direct navigation to /agents/[agentId] shows the agent name (no prior /agents visit required)"
    - "Clicking copy button on session ID does not trigger row click (stopPropagation)"
  artifacts:
    - path: "src/features/agents/components/agent-sessions-table.tsx"
      provides: "Row-click session slide-over for per-agent sessions"
      contains: "SessionSlideOver"
    - path: "src/widgets/agent-detail-layout/components/agent-detail-shell.tsx"
      provides: "Agent name display from Zustand store"
      contains: "useAgents()"
  key_links:
    - from: "src/features/agents/components/agent-sessions-table.tsx"
      to: "src/features/sessions/components/session-slide-over.tsx"
      via: "SessionSlideOver rendered with mapped CrossAgentSession"
      pattern: "SessionSlideOver"
    - from: "src/features/agents/components/agent-sessions-table.tsx"
      to: "src/features/agents/model/agent-store.ts"
      via: "useAgentStore selector for agent name/model lookup"
      pattern: "useAgentStore"
    - from: "src/widgets/agent-detail-layout/components/agent-detail-shell.tsx"
      to: "src/features/agents/api/use-agents.ts"
      via: "useAgents() hook for store hydration on direct navigation"
      pattern: "useAgents\\(\\)"
    - from: "src/widgets/agent-detail-layout/components/agent-detail-shell.tsx"
      to: "src/features/agents/model/agent-store.ts"
      via: "useAgentStore selector for agent name by ID"
      pattern: "useAgentStore"
---

<objective>
Wire per-agent session row clicks to open SessionSlideOver and make AgentDetailShell display the agent's name from the Zustand store, resolving agent name on direct URL navigation.

Purpose: Closes INT-05 (per-agent sessions table row click does nothing) and INT-07 (agent detail header shows no agent name).
Output: Two modified files enabling session slide-over from agent sessions and agent name display in the detail shell.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-chat-agent-detail-wiring/13-CONTEXT.md
@.planning/phases/13-chat-agent-detail-wiring/13-RESEARCH.md
@src/features/agents/components/agent-sessions-table.tsx
@src/widgets/agent-detail-layout/components/agent-detail-shell.tsx
@src/features/sessions/components/session-slide-over.tsx
@src/features/sessions/components/sessions-table.tsx
@src/entities/session/model/types.ts
@src/entities/agent/model/types.ts
@src/features/agents/model/agent-store.ts
@src/features/agents/api/use-agents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add row click and SessionSlideOver to per-agent sessions table</name>
  <files>src/features/agents/components/agent-sessions-table.tsx</files>
  <action>
Add row-click handling to the per-agent sessions table that opens the existing `SessionSlideOver` component, mirroring the pattern used by the global `SessionsTable` in `src/features/sessions/components/sessions-table.tsx`.

**1. Add imports:**
```typescript
import type { CrossAgentSession } from "@/entities/session";
import { useAgentStore } from "@/features/agents/model/agent-store";
import { SessionSlideOver } from "@/features/sessions/components/session-slide-over";
```

**2. Add mapping function** (outside the component, after helper functions):
```typescript
function toSlideOverSession(
  session: AgentSession,
  agentName: string,
  agentModel: string,
): CrossAgentSession {
  return {
    ...session,
    agentName,
    agentAvatar: undefined,
    model: agentModel,
  };
}
```

**3. Fix CopyableId click propagation** — Add `e.stopPropagation()` to the `handleCopy` function in `CopyableId` to prevent row-click from firing when copying a session ID:
```typescript
const handleCopy = (e: React.MouseEvent) => {
  e.stopPropagation();
  void navigator.clipboard.writeText(id);
  setCopied(true);
  setTimeout(() => setCopied(false), 1500);
};
```

**4. Inside `AgentSessionsTable` component, add state and agent lookup:**
```typescript
const [selectedSession, setSelectedSession] = useState<CrossAgentSession | null>(null);
const agentId = sessions[0]?.agentId ?? "";
const agent = useAgentStore((s) => s.agents.find((a) => a.id === agentId));

const handleRowClick = (session: AgentSession) => {
  setSelectedSession(
    toSlideOverSession(
      session,
      agent?.name ?? agentId,
      agent?.model ?? "unknown",
    )
  );
};
```

**5. Update `TableRow` in the data rows section** to add onClick and cursor styling with selected-row highlight:
```tsx
<TableRow
  key={row.id}
  className={cn(
    "cursor-pointer hover:bg-accent/30 transition-colors",
    selectedSession?.id === row.original.id && "bg-accent/50",
  )}
  onClick={() => handleRowClick(row.original)}
>
```

**6. Render SessionSlideOver** after the pagination `div` (still inside the outermost `<div className="space-y-4">`):
```tsx
<SessionSlideOver
  session={selectedSession}
  open={selectedSession !== null}
  onClose={() => setSelectedSession(null)}
/>
```

Per CONTEXT.md locked decisions:
- Add `onClick` handler + `cursor-pointer` class to each `TableRow`
- Add `selectedSession` state and render `SessionSlideOver` below the table
- Map `AgentSession` to `CrossAgentSession`-compatible shape via lightweight mapping function
- Reuse existing `SessionSlideOver` — no duplication
- Add selected-row visual highlight (subtle background change on active row)
- Do NOT refactor per-agent table to use shared `DataTable` — that's scope creep

Per research Pitfall 4: Add `e.stopPropagation()` to CopyableId handleCopy to prevent slide-over from opening when copying session IDs.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify that CopyableId has stopPropagation. Verify that SessionSlideOver is imported and rendered. Verify the mapping function produces a valid CrossAgentSession shape.</verify>
  <done>Per-agent sessions table rows are clickable with cursor-pointer styling. Clicking a row opens SessionSlideOver with the session data mapped to CrossAgentSession. Selected row shows bg-accent/50 highlight. Copy button does not trigger row click.</done>
</task>

<task type="auto">
  <name>Task 2: Display agent name from Zustand store in AgentDetailShell</name>
  <files>src/widgets/agent-detail-layout/components/agent-detail-shell.tsx</files>
  <action>
Make `AgentDetailShell` read the agent name from the Zustand agent store instead of relying on an unused `agentName` prop, and call `useAgents()` to ensure the store is hydrated on direct navigation.

**1. Add imports:**
```typescript
import { useAgentStore } from "@/features/agents/model/agent-store";
import { useAgents } from "@/features/agents/api/use-agents";
```

**2. Remove `agentName` from the props interface:**
```typescript
interface AgentDetailShellProps {
  agentId: string;
  children: React.ReactNode;
}
```

**3. Update the destructured props** in the function signature to remove `agentName`:
```typescript
export function AgentDetailShell({ agentId, children }: AgentDetailShellProps)
```

**4. Inside the component body, before the `return` statement, add:**
```typescript
// Hydrate agent store (handles direct /agents/[id] navigation)
useAgents();
const agentName = useAgentStore(
  (s) => s.agents.find((a) => a.id === agentId)?.name
);
```

**5. The existing template already handles conditional rendering:**
```tsx
{agentName && (
  <div className="px-4 py-3 border-b border-border">
    <p className="text-sm font-semibold truncate">{agentName}</p>
  </div>
)}
```
This block stays as-is. It works because:
- While agents load: `agentName` is `undefined`, section hidden
- After store populates: `agentName` renders reactively
- Agent not found (deleted, invalid ID): section stays hidden, agentId visible in URL

Per CONTEXT.md locked decisions:
- Remove `agentName` prop from `AgentDetailShell` interface entirely
- Read agent name from Zustand store using `agentId`
- Call `useAgents()` inside `AgentDetailShell` to ensure hydration on direct navigation
- Fallback: show `agentId` as text if agent not found after loading — actually, section just stays hidden (acceptable for edge case)
- No layout changes needed in `app/(dashboard)/agents/[agentId]/layout.tsx` (it never passed agentName)
- Reactive: renaming an agent in the identity editor automatically updates the shell header via store subscription

Per research Pitfall 5: The layout currently passes only `agentId` (not `agentName`), so removing the prop causes zero breakage at call sites.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify that `agentName` prop is removed from the interface. Verify `useAgents()` and `useAgentStore` are called correctly. Verify no call sites pass `agentName` (grep for `agentName` in `app/(dashboard)/agents/` layout).</verify>
  <done>AgentDetailShell reads agent name from Zustand store via useAgentStore selector. useAgents() ensures store hydration on direct navigation. The agentName prop is removed from the interface. The sidebar header shows the agent's name when the store is populated.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. In `agent-sessions-table.tsx`: rows have `cursor-pointer` + `onClick`, `SessionSlideOver` is rendered, `CopyableId` has `stopPropagation`, mapping function bridges `AgentSession` to `CrossAgentSession`
3. In `agent-detail-shell.tsx`: `agentName` prop removed from interface, `useAgents()` called for hydration, `useAgentStore` selector reads agent name by ID
4. No other files in the codebase are modified
</verification>

<success_criteria>
- Per-agent sessions table rows are clickable and open SessionSlideOver with correct data
- Copy button on session ID does not trigger row click
- Selected row has visual highlight
- AgentDetailShell displays agent name from Zustand store
- Direct navigation to /agents/[agentId] hydrates the agent store and shows the name
- TypeScript compilation succeeds
- Both files follow existing codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/13-chat-agent-detail-wiring/13-02-SUMMARY.md`
</output>
