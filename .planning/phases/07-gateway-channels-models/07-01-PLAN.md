---
phase: 07-gateway-channels-models
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/gateway-config/model/types.ts
  - src/entities/gateway-config/model/schemas.ts
  - src/entities/gateway-config/index.ts
  - src/entities/channel/model/types.ts
  - src/entities/channel/model/schemas.ts
  - src/entities/channel/index.ts
  - src/entities/model-provider/model/types.ts
  - src/entities/model-provider/model/schemas.ts
  - src/entities/model-provider/index.ts
  - src/shared/lib/query-keys.ts
  - src/features/gateway/api/use-gateway-health.ts
  - src/features/gateway/api/use-gateway-instances.ts
  - src/features/gateway/components/gateway-health-card.tsx
  - src/features/gateway/components/instance-card.tsx
  - src/features/gateway/components/instance-detail-panel.tsx
  - src/features/gateway/components/health-drill-down.tsx
  - src/views/gateway/gateway-overview-view.tsx
  - src/views/gateway/gateway-instances-view.tsx
  - src/views/gateway/gateway-instance-detail-view.tsx
  - app/(dashboard)/gateway/page.tsx
  - app/(dashboard)/gateway/instances/page.tsx
  - app/(dashboard)/gateway/instances/[instanceId]/page.tsx
  - app/(dashboard)/gateway/config/page.tsx
  - app/(dashboard)/gateway/channels/page.tsx
  - app/(dashboard)/gateway/nodes/page.tsx
  - app/(dashboard)/channels/page.tsx
  - app/(dashboard)/channels/[channel]/page.tsx
  - app/(dashboard)/channels/routing/page.tsx
  - app/(dashboard)/channels/groups/page.tsx
  - app/(dashboard)/channels/pairing/page.tsx
  - app/(dashboard)/models/page.tsx
  - app/(dashboard)/models/[provider]/page.tsx
  - app/(dashboard)/models/catalog/page.tsx
  - app/(dashboard)/models/failover/page.tsx
  - app/(dashboard)/models/usage/page.tsx
  - src/widgets/app-shell/config/navigation.ts
autonomous: true
requirements:
  - GATE-01
  - GATE-06

must_haves:
  truths:
    - "User can view gateway connection status, health, uptime, and version at /gateway"
    - "User can view gateway instances as a card grid at /gateway/instances showing name, status, uptime, connected agents"
    - "User can click an instance card to see instance detail with component-level health drill-down"
    - "All /gateway/*, /channels/*, /models/* routes render without 404"
  artifacts:
    - path: "src/entities/gateway-config/model/types.ts"
      provides: "OpenClawConfig, GatewayInstance, GatewayComponent types"
      min_lines: 60
    - path: "src/entities/channel/model/types.ts"
      provides: "Channel, ChannelPlatform, ChannelRouting types"
      min_lines: 40
    - path: "src/entities/model-provider/model/types.ts"
      provides: "ModelProvider, Model, FailoverChain, ModelUsage types"
      min_lines: 50
    - path: "src/views/gateway/gateway-overview-view.tsx"
      provides: "Gateway health overview page"
      min_lines: 30
    - path: "src/views/gateway/gateway-instances-view.tsx"
      provides: "Instance card grid view"
      min_lines: 30
  key_links:
    - from: "src/views/gateway/gateway-overview-view.tsx"
      to: "src/features/gateway/api/use-gateway-health.ts"
      via: "useGatewayHealth hook"
      pattern: "useGatewayHealth"
    - from: "src/views/gateway/gateway-instances-view.tsx"
      to: "src/features/gateway/api/use-gateway-instances.ts"
      via: "useGatewayInstances hook"
      pattern: "useGatewayInstances"
    - from: "app/(dashboard)/gateway/page.tsx"
      to: "src/views/gateway/gateway-overview-view.tsx"
      via: "view import"
      pattern: "GatewayOverviewView"
---

<objective>
Create the entity types, query key extensions, route scaffolding, and gateway overview/instance management pages for Phase 7.

Purpose: Establish the data model foundation for all three domains (gateway, channels, models), scaffold all app router pages to prevent 404s, and build the gateway health overview and multi-instance management UI.

Output: Entity types for gateway-config, channel, and model-provider. All Phase 7 route pages created (even if placeholder). Gateway overview at /gateway with health display. Instance card grid at /gateway/instances with click-into-detail navigation to instance detail with health drill-down.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gateway-channels-models/07-RESEARCH.md
@src/shared/lib/query-keys.ts
@src/entities/agent/model/types.ts
@src/entities/agent/index.ts
@src/features/agents/api/use-agents.ts
@src/widgets/app-shell/config/navigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Entity types, schemas, query keys, and route scaffolding</name>
  <files>
    src/entities/gateway-config/model/types.ts
    src/entities/gateway-config/model/schemas.ts
    src/entities/gateway-config/index.ts
    src/entities/channel/model/types.ts
    src/entities/channel/model/schemas.ts
    src/entities/channel/index.ts
    src/entities/model-provider/model/types.ts
    src/entities/model-provider/model/schemas.ts
    src/entities/model-provider/index.ts
    src/shared/lib/query-keys.ts
    src/widgets/app-shell/config/navigation.ts
    app/(dashboard)/gateway/page.tsx
    app/(dashboard)/gateway/config/page.tsx
    app/(dashboard)/gateway/channels/page.tsx
    app/(dashboard)/gateway/nodes/page.tsx
    app/(dashboard)/gateway/instances/page.tsx
    app/(dashboard)/gateway/instances/[instanceId]/page.tsx
    app/(dashboard)/channels/page.tsx
    app/(dashboard)/channels/[channel]/page.tsx
    app/(dashboard)/channels/routing/page.tsx
    app/(dashboard)/channels/groups/page.tsx
    app/(dashboard)/channels/pairing/page.tsx
    app/(dashboard)/models/page.tsx
    app/(dashboard)/models/[provider]/page.tsx
    app/(dashboard)/models/catalog/page.tsx
    app/(dashboard)/models/failover/page.tsx
    app/(dashboard)/models/usage/page.tsx
  </files>
  <action>
    **Entity: gateway-config** (`src/entities/gateway-config/`):
    - `model/types.ts`: Define comprehensive types:
      - `GatewayInstance` — id, name, status ('healthy'|'degraded'|'down'), uptime (seconds), version, connectedAgents (number), components: Record<string, GatewayComponent>
      - `GatewayComponent` — name, status ('healthy'|'degraded'|'down'), latency (ms, optional), connections (number, optional), details (string, optional)
      - `GatewayHealth` — status, uptime, version, components: GatewayComponent[]
      - `OpenClawConfig` — Full config type with sections: identity (botName, persona, greeting), sessions (maxDuration, compactionThreshold, maxTokens, branchingEnabled), channels (Record of channel configs), models (providers, defaultModel, maxRetries), compaction (enabled, strategy, threshold), memorySearch (enabled, vectorModel, maxResults, minScore), security (authMode, allowedOrigins, rateLimiting), plugins (enabled string array, configs record), gateway (port, dataDir, logLevel, cors)
      - `ConfigSection` — union literal of section names: 'identity' | 'sessions' | 'channels' | 'models' | 'compaction' | 'memorySearch' | 'security' | 'plugins' | 'gateway'
      - `ConfigDiff` — path, type ('added'|'removed'|'changed'), oldValue?, newValue?
    - `model/schemas.ts`: Zod v4 schemas (import from "zod/v4") for each config section with `.passthrough()` for forward compat. Create `openClawConfigSchema` composing all section schemas. Use `.passthrough()` on the root object too.
    - `index.ts`: Barrel export all types and schemas.

    **Entity: channel** (`src/entities/channel/`):
    - `model/types.ts`: Define:
      - `ChannelPlatform` — 'whatsapp' | 'telegram' | 'discord' | 'slack' | 'web' | 'sms'
      - `Channel` — id, name, platform: ChannelPlatform, status ('connected'|'disconnected'|'pairing'|'error'), agentId (string|null for unrouted), phoneNumber/username (optional platform-specific), connectedAt (Date|null), messageCount (number)
      - `ChannelRouting` — channelId, agentId, rule (string description), priority (number)
      - `ChannelGroupSettings` — allowlist (string[]), mentionPatterns (string[]), broadcastEnabled (boolean)
      - `PairingState` — status ('idle'|'generating'|'waiting'|'scanned'|'connected'|'error'), qrCode (string|null), platform (ChannelPlatform|null), expiresAt (Date|null)
    - `model/schemas.ts`: Zod v4 schemas for channel, routing, group settings, pairing.
    - `index.ts`: Barrel export.

    **Entity: model-provider** (`src/entities/model-provider/`):
    - `model/types.ts`: Define:
      - `ModelProvider` — id, name, slug (e.g. 'anthropic', 'openai', 'google', 'ollama'), status ('connected'|'disconnected'|'error'), authMethod ('api_key'|'oauth'|'none'), baseUrl (string|null), models (Model[])
      - `Model` — id, name, providerId, contextWindow (number), maxOutputTokens (number), inputPricePerMTok (number), outputPricePerMTok (number), capabilities (string[])
      - `FailoverChain` — id, name, models: FailoverModel[]
      - `FailoverModel` — id, providerId, modelId, modelName, providerName, maxRetries (number), timeoutMs (number)
      - `ModelUsage` — period (string), providerId, modelId, agentId (optional), inputTokens, outputTokens, cost, requestCount
    - `model/schemas.ts`: Zod v4 schemas for all types.
    - `index.ts`: Barrel export.

    **Query keys** — Extend `src/shared/lib/query-keys.ts`:
    - Add `gateway.instances`, `gateway.instance(id)`, `gateway.nodes(instanceId)` under existing `gateway` key.
    - Add `channels` domain: `channels.all`, `channels.lists()`, `channels.detail(id)`, `channels.routing()`.
    - Add `models` domain: `models.all`, `models.providers()`, `models.provider(id)`, `models.catalog()`, `models.failover()`, `models.usage(dimension, period)`.

    **Navigation** — Update `src/widgets/app-shell/config/navigation.ts`:
    - Add "Models" nav item to the "Operations" group after "Channels" with url "/models" and icon `Brain` (import from lucide-react). Gateway and Channels are already in nav.

    **Route scaffolding** — Create all page.tsx files listed in `<files>` above. Each is a simple server component that renders a placeholder view or a `<div>Coming soon</div>` for pages that will be built in later plans (07-02 through 07-05). The gateway overview page.tsx and instances pages will render the real views built in Task 2. Use the established pattern: async server component with `generateMetadata`, imports view component, wraps in Suspense with skeleton fallback. For placeholder pages, use PageHeader with the page title and a simple "Coming in plan XX" message. **Note:** `app/(dashboard)/channels/groups/page.tsx` must be scaffolded as a server-side redirect using `redirect('/channels')` from `next/navigation` — group channel settings are managed inline per-channel (per user decision), so this route simply redirects to prevent a 404. Add a comment in the file explaining this.
  </action>
  <verify>
    Run `bunx tsc --noEmit` to verify all types compile. Navigate to each route URL in the running app to confirm no 404s. Confirm the "Models" nav item appears in the sidebar.
  </verify>
  <done>
    All three entity type systems exist with Zod schemas. Query keys extended for gateway instances, channels, and models. All 16 Phase 7 route pages render without 404. Navigation updated with Models link.
  </done>
</task>

<task type="auto">
  <name>Task 2: Gateway overview page, health display, and instance management</name>
  <files>
    src/features/gateway/api/use-gateway-health.ts
    src/features/gateway/api/use-gateway-instances.ts
    src/features/gateway/components/gateway-health-card.tsx
    src/features/gateway/components/instance-card.tsx
    src/features/gateway/components/instance-detail-panel.tsx
    src/features/gateway/components/health-drill-down.tsx
    src/views/gateway/gateway-overview-view.tsx
    src/views/gateway/gateway-instances-view.tsx
    src/views/gateway/gateway-instance-detail-view.tsx
    app/(dashboard)/gateway/page.tsx
    app/(dashboard)/gateway/instances/page.tsx
    app/(dashboard)/gateway/instances/[instanceId]/page.tsx
  </files>
  <action>
    **API hooks** (follow use-agents.ts mock data pattern):
    - `use-gateway-health.ts`: `useGatewayHealth()` — returns mock GatewayHealth with version "1.4.2", uptime 2592000s (30 days), status "healthy", 4 components (database, redis, websocket, queue). Uses queryKeys.gateway.health(), staleTime Infinity.
    - `use-gateway-instances.ts`: `useGatewayInstances()` — returns 2 mock instances (Production + Staging per research). `useGatewayInstance(id)` — returns single instance from list. staleTime Infinity.

    **Components**:
    - `gateway-health-card.tsx`: Card showing gateway status with StatusBadge, version number, formatted uptime (use date-fns formatDistanceStrict), and connected agent count. Use the existing Card, StatusBadge shared components.
    - `health-drill-down.tsx`: Expandable component showing per-component health. Each component as a row with name, StatusBadge, latency if applicable, connection count if applicable. Per user decision: aggregate status badge with expandable drill-down. Use Collapsible from shadcn (already installed).
    - `instance-card.tsx`: Card for each gateway instance showing name, status badge (aggregate healthy/degraded/down per user decision), uptime formatted with formatDistanceStrict, version, connected agents count. Click navigates to `/gateway/instances/${instance.id}`. Use the Card component with cursor-pointer and hover:shadow-md.
    - `instance-detail-panel.tsx`: Full detail view for a single instance. Shows the instance header (name, status, version, uptime) plus the HealthDrillDown for components. Per user decision, gateway nodes are listed within the instance detail page (not a separate page). Add a mock nodes section with a DataTable showing 2-3 mock nodes (name, platform: macOS/iOS/Android, capabilities, status).

    **Views**:
    - `gateway-overview-view.tsx`: Composes PageHeader ("Gateway") + GatewayHealthCard + quick links to sub-pages (Config, Channels, Nodes, Instances) as card grid. Include a "Connected Channels" summary count and "Active Instances" count.
    - `gateway-instances-view.tsx`: PageHeader ("Gateway Instances") + responsive card grid of InstanceCards using `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`. Loading: SkeletonCard preset. Empty: EmptyState with "No gateway instances connected" and CTA.
    - `gateway-instance-detail-view.tsx`: Takes instanceId param. Uses useGatewayInstance(id). Shows InstanceDetailPanel with full health drill-down and nodes table. Loading and not-found states.

    **Update route pages** (created as placeholders in Task 1):
    - `app/(dashboard)/gateway/page.tsx`: Import and render GatewayOverviewView.
    - `app/(dashboard)/gateway/instances/page.tsx`: Import and render GatewayInstancesView.
    - `app/(dashboard)/gateway/instances/[instanceId]/page.tsx`: Extract instanceId from params, render GatewayInstanceDetailView with the id prop.
  </action>
  <verify>
    Run `bunx tsc --noEmit`. Navigate to /gateway — see health card with green "healthy" status, version "1.4.2", "30 days" uptime. Navigate to /gateway/instances — see 2 instance cards (Production: healthy, Staging: degraded). Click "Production Gateway" card — navigate to detail page showing component-level health rows (database, redis, websocket) and nodes table.
  </verify>
  <done>
    Gateway overview shows connection health, uptime, and version. Instance card grid shows all instances with status. Instance detail shows component-level health drill-down and node list. All three gateway pages have real content with mock data.
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes with zero errors
- All 16 Phase 7 routes render (no 404s), including /channels/groups which redirects to /channels
- /gateway shows health status and navigation cards
- /gateway/instances shows 2 instance cards
- /gateway/instances/gw-001 shows component health drill-down and node table
- Navigation sidebar shows "Models" link
- Entity types compile and are importable from barrel exports
</verification>

<success_criteria>
Gateway overview page displays real-time health with status badge, version, and uptime. Multi-instance management works with card grid and click-into-detail navigation showing component-level health drill-down. All Phase 7 route pages exist. Three domain entity types established. Query keys extended.
</success_criteria>

<output>
After completion, create `.planning/phases/07-gateway-channels-models/07-01-SUMMARY.md`
</output>
