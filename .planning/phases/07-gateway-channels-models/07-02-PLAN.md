---
phase: 07-gateway-channels-models
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/features/gateway/api/use-gateway-config.ts
  - src/features/gateway/model/config-draft-store.ts
  - src/features/gateway/lib/config-diff.ts
  - src/features/gateway/schemas/config-schemas.ts
  - src/features/gateway/components/config-section-identity.tsx
  - src/features/gateway/components/config-section-sessions.tsx
  - src/features/gateway/components/config-section-channels.tsx
  - src/features/gateway/components/config-section-models.tsx
  - src/features/gateway/components/config-section-compaction.tsx
  - src/features/gateway/components/config-section-memory.tsx
  - src/features/gateway/components/config-section-security.tsx
  - src/features/gateway/components/config-section-plugins.tsx
  - src/features/gateway/components/config-section-gateway.tsx
  - src/features/gateway/components/config-editor.tsx
  - src/features/gateway/components/config-raw-json.tsx
  - src/features/gateway/components/config-diff-viewer.tsx
  - src/features/gateway/components/config-validation-panel.tsx
  - src/views/gateway/gateway-config-view.tsx
  - app/(dashboard)/gateway/config/page.tsx
autonomous: true
requirements:
  - GATE-02
  - GATE-03

must_haves:
  truths:
    - "User can visually edit openclaw.json configuration with a form-based tabbed editor at /gateway/config"
    - "User can toggle to raw JSON view showing the full openclaw.json file"
    - "User can save changes as a draft, review a diff of changes, and explicitly apply to the gateway"
    - "Validation errors appear both inline per field and in a summary validation panel with jump-to-field links"
    - "Config editor covers all 9 sections: identity, sessions, channels, models, compaction, memory search, security, plugins, gateway"
  artifacts:
    - path: "src/features/gateway/model/config-draft-store.ts"
      provides: "Zustand draft config store with load, update, reset, diff, apply"
      min_lines: 50
    - path: "src/features/gateway/lib/config-diff.ts"
      provides: "Deep comparison utility producing ConfigDiff[]"
      min_lines: 30
    - path: "src/features/gateway/components/config-editor.tsx"
      provides: "Tabbed config editor with form/JSON toggle and apply bar"
      min_lines: 80
    - path: "src/views/gateway/gateway-config-view.tsx"
      provides: "Config editor view page composition"
      min_lines: 30
  key_links:
    - from: "src/features/gateway/components/config-editor.tsx"
      to: "src/features/gateway/model/config-draft-store.ts"
      via: "useConfigDraftStore for draft state"
      pattern: "useConfigDraftStore"
    - from: "src/features/gateway/components/config-editor.tsx"
      to: "src/features/gateway/api/use-gateway-config.ts"
      via: "useGatewayConfig to load original config"
      pattern: "useGatewayConfig"
    - from: "src/features/gateway/components/config-diff-viewer.tsx"
      to: "src/features/gateway/lib/config-diff.ts"
      via: "computeConfigDiff for diff display"
      pattern: "computeConfigDiff"
    - from: "app/(dashboard)/gateway/config/page.tsx"
      to: "src/views/gateway/gateway-config-view.tsx"
      via: "view import"
      pattern: "GatewayConfigView"
---

<objective>
Build the visual gateway configuration editor with tabbed form sections, raw JSON toggle, draft-then-apply workflow, and validation panel at /gateway/config.

Purpose: Allow users to safely edit the openclaw.json gateway configuration through a structured form interface with validation, diff review, and explicit apply -- preventing accidental config corruption.

Output: Tabbed config editor covering all 9 openclaw.json sections with form-based editing, raw JSON toggle, draft-then-apply pattern with diff viewer, and inline + summary validation errors.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gateway-channels-models/07-RESEARCH.md
@.planning/phases/07-gateway-channels-models/07-01-SUMMARY.md
@src/entities/gateway-config/model/types.ts
@src/entities/gateway-config/model/schemas.ts
@src/shared/lib/query-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config draft store, diff utility, schemas, and API hook</name>
  <files>
    src/features/gateway/api/use-gateway-config.ts
    src/features/gateway/model/config-draft-store.ts
    src/features/gateway/lib/config-diff.ts
    src/features/gateway/schemas/config-schemas.ts
  </files>
  <action>
    **API hook** (`use-gateway-config.ts`):
    - Follow the useGatewayHealth mock data pattern. Create `useGatewayConfig()` returning a comprehensive mock `OpenClawConfig` with realistic values for all 9 sections (identity: botName "AXion", persona text; sessions: maxDuration 3600, compactionThreshold 100000, maxTokens 200000; channels: 2 channel configs for whatsapp and telegram; models: 2 providers, defaultModel "claude-sonnet-4"; compaction: enabled true, strategy "smart", threshold 80000; memorySearch: enabled true, vectorModel "text-embedding-3-small"; security: authMode "token", allowedOrigins ["*"], rateLimiting with window and max; plugins: 2 enabled plugins; gateway: port 8080, dataDir "./data", logLevel "info").
    - Use `queryKeys.gateway.config()`, staleTime Infinity, refetchOnWindowFocus false.
    - Export `useApplyConfig` mutation hook that simulates a 1s delay then invalidates the config query.

    **Config schemas** (`config-schemas.ts`):
    - Import from "zod/v4". Create one Zod schema per config section (identityConfigSchema, sessionsConfigSchema, channelsConfigSchema, modelsConfigSchema, compactionConfigSchema, memorySearchConfigSchema, securityConfigSchema, pluginsConfigSchema, gatewayConfigSchema).
    - Each schema validates the fields for its section with meaningful constraints (e.g., botName min 1 max 100, port min 1 max 65535, maxDuration min 60).
    - All schemas use `.passthrough()` for forward compatibility.
    - Export a `CONFIG_SECTIONS` array of objects: `{ id: ConfigSection, label: string, icon: LucideIcon, schema: ZodSchema }` — use icons: User (identity), Clock (sessions), Globe (channels), Brain (models), Minimize2 (compaction), Search (memory), Shield (security), Plug (plugins), Radio (gateway). Import icons from lucide-react.

    **Config diff utility** (`config-diff.ts`):
    - Export `ConfigDiff` type (re-export from entity types or define: path, type 'added'|'removed'|'changed', oldValue?, newValue?).
    - Export `computeConfigDiff(original, draft)` — deep recursive comparison of two objects. Returns `ConfigDiff[]` with dot-path notation (e.g., "identity.botName"). Handle nested objects, arrays (compare by JSON.stringify for simplicity), null/undefined.
    - Export `countDiffsBySection(diffs)` — returns Record<string, number> grouping diff count by top-level section name (first path segment).

    **Draft store** (`config-draft-store.ts`):
    - Zustand store (NOT immer — simple state updates are sufficient):
      - `originalConfig: OpenClawConfig | null` — loaded from gateway, read-only reference
      - `draftConfig: OpenClawConfig | null` — mutable copy being edited
      - `isDirty: boolean` — true when draft differs from original
      - `isApplying: boolean` — true during apply operation
      - `activeSection: ConfigSection` — currently selected tab, default 'identity'
      - `isRawJsonMode: boolean` — toggle between form and JSON editor
      - `validationErrors: Array<{ path: string; message: string; section: ConfigSection }>` — from Zod
    - Actions:
      - `loadConfig(config)` — sets both original and draft (deep clone via structuredClone)
      - `updateSection(section, values)` — merges values into draft[section], sets isDirty true, runs validation
      - `updateFromRawJson(json: string)` — parses JSON, replaces entire draft, runs validation. Returns boolean success.
      - `setActiveSection(section)` — sets active tab
      - `toggleRawJsonMode()` — toggles between form and JSON
      - `resetDraft()` — resets draft to structuredClone of original, clears dirty/errors
      - `getDiffs()` — calls computeConfigDiff(original, draft) and returns the array
      - `validate()` — runs each section schema against corresponding draft section, collects all errors with section+path+message
      - `setIsApplying(v)` — sets applying state
  </action>
  <verify>
    Run `bunx tsc --noEmit` to confirm all types compile. Verify the draft store can load a config, update a field, and compute a diff.
  </verify>
  <done>
    Config API hook returns mock OpenClawConfig. Draft store manages edit lifecycle (load, update, diff, validate, reset). Diff utility computes path-level changes between configs. Section schemas validate all 9 config sections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Config section forms, editor shell, raw JSON, diff viewer, and config view</name>
  <files>
    src/features/gateway/components/config-section-identity.tsx
    src/features/gateway/components/config-section-sessions.tsx
    src/features/gateway/components/config-section-channels.tsx
    src/features/gateway/components/config-section-models.tsx
    src/features/gateway/components/config-section-compaction.tsx
    src/features/gateway/components/config-section-memory.tsx
    src/features/gateway/components/config-section-security.tsx
    src/features/gateway/components/config-section-plugins.tsx
    src/features/gateway/components/config-section-gateway.tsx
    src/features/gateway/components/config-editor.tsx
    src/features/gateway/components/config-raw-json.tsx
    src/features/gateway/components/config-diff-viewer.tsx
    src/features/gateway/components/config-validation-panel.tsx
    src/views/gateway/gateway-config-view.tsx
    app/(dashboard)/gateway/config/page.tsx
  </files>
  <action>
    **9 Config section form components** (each follows the same pattern):
    - "use client" component accepting `values` (section config) and `onUpdate(values)` callback.
    - Uses react-hook-form with zodResolver (as-any cast for Zod v4 compat) and the section's schema from config-schemas.ts.
    - `defaultValues` from props. On form change (watch + useEffect debounced 300ms), calls onUpdate.
    - Uses shared FormField, Input, Textarea, Select, Switch components from @/shared/ui/*.
    - Section-specific fields:
      - **Identity**: botName (Input), persona (Textarea), greeting (Textarea)
      - **Sessions**: maxDuration (Input type="number"), compactionThreshold (Input type="number"), maxTokens (Input type="number"), branchingEnabled (Switch)
      - **Channels**: Read-only table of configured channels with note "Manage channels at /channels". Shows channel names and types.
      - **Models**: defaultModel (Input), maxRetries (Input type="number"). Read-only provider summary with "Configure providers at /models" link.
      - **Compaction**: enabled (Switch), strategy (Select: "smart"|"aggressive"|"conservative"), threshold (Input type="number")
      - **Memory Search**: enabled (Switch), vectorModel (Input), maxResults (Input type="number"), minScore (Input type="number" step="0.01")
      - **Security**: authMode (Select: "token"|"api_key"|"none"), allowedOrigins (Textarea, one per line), rateLimiting.windowMs (Input), rateLimiting.maxRequests (Input)
      - **Plugins**: enabled array (list with add/remove), configs displayed as read-only JSON
      - **Gateway**: port (Input type="number"), dataDir (Input), logLevel (Select: "debug"|"info"|"warn"|"error"), cors (Switch)

    **Config raw JSON editor** (`config-raw-json.tsx`):
    - "use client" component showing the FULL openclaw.json (not just current section, per user decision).
    - Uses a `<textarea>` with monospace font, full height, `font-mono text-sm` styling.
    - Reads from draft store's draftConfig, serialized with `JSON.stringify(draft, null, 2)`.
    - On change, debounced 500ms, calls `updateFromRawJson`. If parse fails, show red border and error message below textarea.
    - "Format JSON" button that pretty-prints the content.

    **Config diff viewer** (`config-diff-viewer.tsx`):
    - Renders ConfigDiff[] from the draft store's getDiffs() method.
    - Each diff row shows path, colored change type (green added, red removed, yellow changed), old and new values.
    - If no diffs, show "No changes detected" message.
    - Summary header: "{N} change(s) across {M} section(s)" using countDiffsBySection.

    **Validation panel** (`config-validation-panel.tsx`):
    - Shows all validationErrors from draft store grouped by section.
    - Each error is a clickable row that calls setActiveSection to jump to the relevant section and switches to form mode.
    - Uses destructive text color and AlertTriangle icon per error.
    - Collapsed when no errors, expandable Collapsible when errors exist.
    - Badge with error count shown in the panel header.

    **Config editor shell** (`config-editor.tsx`):
    - Main composition component. Uses useGatewayConfig to load data and useConfigDraftStore for edit state.
    - On config data load, calls `loadConfig(data)`.
    - Top bar: Tab list for all 9 sections (from CONFIG_SECTIONS) using shadcn Tabs component. Active tab from store's activeSection. Each tab shows section label + icon. If section has validation errors, show a red dot indicator.
    - Toggle button in top-right: "Form" / "JSON" mode switch. Uses isRawJsonMode from store.
    - Content area: In form mode, render the active section's form component with values from draftConfig[activeSection] and onUpdate calling updateSection. In JSON mode, render ConfigRawJson.
    - Bottom sticky bar (only visible when isDirty):
      - Left: "Unsaved changes" text with diff count. Click opens a Sheet/Dialog showing ConfigDiffViewer.
      - Right: "Discard" button (calls resetDraft), "Review & Apply" button (opens Dialog with ConfigDiffViewer + "Apply Changes" confirm button). Apply calls the useApplyConfig mutation, shows sonner toast on success/error.
    - Validation panel shown as a collapsible section below the tabs when errors exist.

    **Config view** (`gateway-config-view.tsx`):
    - "use client" view component. Renders PageHeader ("Gateway Configuration" with description "Edit your openclaw.json gateway settings") and the ConfigEditor component.

    **Route page** — Update `app/(dashboard)/gateway/config/page.tsx` (already scaffolded in 07-01):
    - Replace placeholder with server component importing GatewayConfigView inside Suspense with LoadingSkeleton.
    - Export generateMetadata returning { title: "Gateway Configuration" }.
  </action>
  <verify>
    Run `bunx tsc --noEmit`. Navigate to /gateway/config — see tabbed editor with Identity tab active. Switch tabs to see all 9 section forms. Toggle to JSON mode — see full JSON in textarea. Edit a field (change botName) — see "Unsaved changes" bar appear. Click "Review & Apply" — see diff showing the change. Click "Discard" — changes reset. Check that validation errors appear for invalid values (e.g., empty botName).
  </verify>
  <done>
    Config editor at /gateway/config shows all 9 sections in tabbed form layout. Raw JSON toggle shows full config. Draft-then-apply flow with diff review and apply confirmation works. Validation errors shown inline and in summary panel with jump-to-field links.
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes with zero errors
- /gateway/config renders tabbed config editor with all 9 sections
- Form mode: each section form has correct fields, inline validation errors
- JSON mode: textarea shows full openclaw.json, parse errors shown on invalid JSON
- Draft lifecycle: edit -> unsaved changes bar appears -> review shows diff -> apply shows toast -> discard resets
- Validation panel: appears when errors exist, clicking error jumps to section and switches to form mode
</verification>

<success_criteria>
Gateway config editor at /gateway/config covers all openclaw.json sections with form-based editing and raw JSON toggle. Draft-then-apply pattern works: user edits, reviews diff, and explicitly applies changes. Validation errors shown inline per field and in a summary panel with jump-to-field navigation.
</success_criteria>

<output>
After completion, create `.planning/phases/07-gateway-channels-models/07-02-SUMMARY.md`
</output>
