---
phase: 07-gateway-channels-models
plan: 04
type: execute
wave: 3
depends_on: ["07-01", "07-03"]
files_modified:
  - src/features/channels/model/pairing-store.ts
  - src/features/channels/api/use-channel-pairing.ts
  - src/features/channels/components/pairing-wizard.tsx
  - src/features/channels/components/pairing-step-platform.tsx
  - src/features/channels/components/pairing-step-authenticate.tsx
  - src/features/channels/components/pairing-step-configure.tsx
  - src/features/channels/components/pairing-step-confirm.tsx
  - src/features/channels/components/whatsapp-qr-modal.tsx
  - src/features/gateway/api/use-gateway-nodes.ts
  - src/features/gateway/components/gateway-nodes-table.tsx
  - src/views/channels/channel-pairing-view.tsx
  - src/views/gateway/gateway-nodes-view.tsx
  - app/(dashboard)/channels/pairing/page.tsx
  - app/(dashboard)/gateway/nodes/page.tsx
autonomous: true
requirements:
  - GATE-05
  - CHAN-04

must_haves:
  truths:
    - "User can pair new channels via a step-by-step wizard at /channels/pairing (pick platform, authenticate, configure, confirm)"
    - "WhatsApp pairing shows QR code in a focused centered modal with instructions and refresh timer"
    - "Telegram/Discord pairing collects bot tokens, Slack uses OAuth flow"
    - "User can view and manage connected nodes (macOS/iOS/Android) at /gateway/nodes"
  artifacts:
    - path: "src/features/channels/components/pairing-wizard.tsx"
      provides: "4-step channel pairing wizard shell"
      min_lines: 60
    - path: "src/features/channels/components/whatsapp-qr-modal.tsx"
      provides: "Full-screen centered QR code modal with timer and instructions"
      min_lines: 50
    - path: "src/features/channels/model/pairing-store.ts"
      provides: "Zustand pairing state machine for wizard lifecycle"
      min_lines: 40
    - path: "src/features/gateway/components/gateway-nodes-table.tsx"
      provides: "DataTable listing connected nodes with capabilities"
      min_lines: 40
  key_links:
    - from: "src/features/channels/components/pairing-wizard.tsx"
      to: "src/features/channels/model/pairing-store.ts"
      via: "usePairingStore for wizard state"
      pattern: "usePairingStore"
    - from: "src/features/channels/components/pairing-step-authenticate.tsx"
      to: "src/features/channels/components/whatsapp-qr-modal.tsx"
      via: "WhatsApp QR modal for WhatsApp platform"
      pattern: "WhatsAppQrModal"
    - from: "app/(dashboard)/channels/pairing/page.tsx"
      to: "src/views/channels/channel-pairing-view.tsx"
      via: "view import"
      pattern: "ChannelPairingView"
---

<objective>
Build the channel pairing wizard for connecting new messaging channels (WhatsApp QR code, Telegram/Discord bot tokens, Slack OAuth), and the gateway nodes management page.

Purpose: Enable users to connect new messaging channels through platform-specific authentication flows, and view/manage connected gateway nodes (devices).

Output: Step-by-step pairing wizard at /channels/pairing with platform-specific authentication (QR for WhatsApp, tokens for Telegram/Discord). Gateway nodes page at /gateway/nodes showing connected devices with capabilities.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gateway-channels-models/07-RESEARCH.md
@.planning/phases/07-gateway-channels-models/07-01-SUMMARY.md
@.planning/phases/07-gateway-channels-models/07-03-SUMMARY.md
@src/entities/channel/model/types.ts
@src/features/agents/components/wizard-shell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pairing store, API hook, wizard shell, and all 4 wizard steps</name>
  <files>
    src/features/channels/model/pairing-store.ts
    src/features/channels/api/use-channel-pairing.ts
    src/features/channels/components/pairing-wizard.tsx
    src/features/channels/components/pairing-step-platform.tsx
    src/features/channels/components/pairing-step-authenticate.tsx
    src/features/channels/components/pairing-step-configure.tsx
    src/features/channels/components/pairing-step-confirm.tsx
    src/features/channels/components/whatsapp-qr-modal.tsx
    src/views/channels/channel-pairing-view.tsx
    app/(dashboard)/channels/pairing/page.tsx
  </files>
  <action>
    **Pairing store** (`pairing-store.ts`):
    - Zustand store managing the wizard lifecycle:
      - `currentStep: number` (0-3 for platform, authenticate, configure, confirm)
      - `platform: ChannelPlatform | null` — selected platform
      - `pairingState: PairingState` — from entity types ('idle'|'generating'|'waiting'|'scanned'|'connected'|'error')
      - `qrCode: string | null` — for WhatsApp QR data
      - `qrExpiresAt: Date | null` — QR code expiration
      - `authData: { botToken?: string; oauthCode?: string } | null` — for Telegram/Discord/Slack
      - `channelConfig: { name: string; agentId: string | null } | null` — step 3 config
      - `error: string | null`
    - Actions:
      - `setPlatform(platform)` — sets platform and advances to step 1
      - `setStep(step)` — manual step navigation (only backwards or same)
      - `startPairing()` — simulates initiating pairing (sets state to 'generating', then after 1s to 'waiting')
      - `simulateQrScan()` — for demo: sets state to 'scanned' then after 1s to 'connected'
      - `setAuthData(data)` — sets token/oauth data
      - `setChannelConfig(config)` — sets step 3 config
      - `resetWizard()` — resets all state to initial values (called on unmount/completion)

    **Pairing API hook** (`use-channel-pairing.ts`):
    - `useInitiatePairing()` — mutation that simulates gateway RPC call to start pairing. For WhatsApp: generates a mock QR code string (a base64 placeholder or a simple text QR payload) and sets qrExpiresAt to 60s from now. For others: resolves immediately.
    - `useCompletePairing()` — mutation that simulates completing pairing. 1s delay, invalidates channels queries, shows success toast, returns new channel ID.

    **Pairing wizard shell** (`pairing-wizard.tsx`):
    - "use client" component. Follows the agent wizard pattern from wizard-shell.tsx.
    - 4 steps: "Platform", "Authenticate", "Configure", "Confirm".
    - Step indicator bar at top showing current step with progress (numbered circles, active highlighted).
    - Back button (disabled on step 0), step title and description per step.
    - Renders the active step component based on currentStep.
    - On component unmount (useEffect cleanup), calls resetWizard to clear state.

    **Step 1: Platform selection** (`pairing-step-platform.tsx`):
    - Grid of platform cards (6 platforms: WhatsApp, Telegram, Discord, Slack, Web, SMS).
    - Each card shows: platform icon (from lucide — MessageSquare for WhatsApp, Send for Telegram, Hash for Discord, Slack for Slack, Globe for Web, Smartphone for SMS), platform name, brief description.
    - Clicking a card calls setPlatform and advances to step 1.
    - Cards use hover:border-primary and cursor-pointer styling. Selected state not needed (instant navigation).

    **Step 2: Authenticate** (`pairing-step-authenticate.tsx`):
    - Renders platform-specific auth UI based on store's platform value:
      - **WhatsApp**: "Scan QR Code" heading, button to "Generate QR Code" which calls startPairing and opens WhatsAppQrModal. Status shown below: "Generating...", "Waiting for scan...", "Scanned! Connecting...", "Connected!" with appropriate StatusBadge.
      - **Telegram**: Input field for "Bot Token" with helper text "Get your bot token from @BotFather on Telegram". Save button calls setAuthData.
      - **Discord**: Input field for "Bot Token" with helper text "Get your bot token from the Discord Developer Portal". Save button.
      - **Slack**: "Connect with Slack" OAuth button (simulated: onClick sets authData with mock code after 1s delay, shows "Redirecting to Slack..." then "Connected to Slack workspace").
      - **Web**: No auth needed — shows "No authentication required for web chat" message, auto-advances.
      - **SMS**: Input for "Twilio Account SID" and "Auth Token" with helper text.
    - "Next" button enabled only when authData is set (or platform is 'web').

    **WhatsApp QR Modal** (`whatsapp-qr-modal.tsx`):
    - Full-screen centered Dialog (per user decision: focused full-screen/centered modal).
    - Content: QR code display area (render a placeholder SVG square with "QR Code" text — since this is mock data, use a visually representative placeholder), instructions text "Open WhatsApp > Settings > Linked Devices > Link a Device", countdown timer showing seconds until expiration (reading from qrExpiresAt, updating every 1s via setInterval).
    - "Refresh QR Code" button visible when expired (calls startPairing again).
    - Timer uses useEffect with cleanup to prevent leaks (per research Pitfall 3).
    - Status indicator: current pairing state shown with StatusBadge.
    - Modal closes automatically when pairingState becomes 'connected'.
    - Close button (X) also available to cancel.

    **Step 3: Configure** (`pairing-step-configure.tsx`):
    - Form with channel display name (Input, pre-filled with "{Platform} Channel"), agent assignment (Select dropdown with mock agent options or "Unassigned"), optional description.
    - Uses react-hook-form for validation (name required, min 1 char).
    - "Next" button calls setChannelConfig and advances to step 3.

    **Step 4: Confirm** (`pairing-step-confirm.tsx`):
    - Summary card showing: Platform (badge), Channel Name, Assigned Agent (or "None"), Authentication status (connected/token provided).
    - "Complete Pairing" button calls useCompletePairing mutation. On success, shows success message with confetti-free celebration (checkmark icon + "Channel connected successfully!") and "Go to Channels" link button navigating to /channels.
    - Loading state during completion.

    **Pairing view** (`channel-pairing-view.tsx`):
    - "use client". PageHeader ("Pair New Channel" with description "Connect a messaging platform to your gateway"). Renders PairingWizard component.

    **Route page** — Update `app/(dashboard)/channels/pairing/page.tsx`:
    - Server component rendering ChannelPairingView in Suspense. generateMetadata: { title: "Pair Channel" }.
  </action>
  <verify>
    Run `bunx tsc --noEmit`. Navigate to /channels/pairing — see 6 platform cards. Click WhatsApp — see auth step with "Generate QR Code" button. Click generate — QR modal opens with placeholder, countdown timer, instructions. Close modal and go back, select Telegram — see bot token input. Fill token, click Next — configure step with name and agent. Click Next — confirmation summary. Click "Complete Pairing" — success message with link to /channels.
  </verify>
  <done>
    Channel pairing wizard walks through 4 steps. Platform-specific authentication: WhatsApp QR modal with timer, Telegram/Discord token inputs, Slack OAuth simulation, Web auto-advance. Configuration and confirmation steps complete the flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Gateway nodes management page</name>
  <files>
    src/features/gateway/api/use-gateway-nodes.ts
    src/features/gateway/components/gateway-nodes-table.tsx
    src/views/gateway/gateway-nodes-view.tsx
    app/(dashboard)/gateway/nodes/page.tsx
  </files>
  <action>
    **Nodes API hook** (`use-gateway-nodes.ts`):
    - `useGatewayNodes()` — returns mock node data: 3 nodes representing connected devices:
      1. "Arya's MacBook Pro" — platform: "macOS", status: "connected", capabilities: ["filesystem", "terminal", "browser"], lastSeen: recent date, version: "2.1.0"
      2. "Arya's iPhone 15" — platform: "iOS", status: "connected", capabilities: ["notifications", "camera", "location"], lastSeen: recent date, version: "2.0.5"
      3. "Dev Tablet" — platform: "Android", status: "disconnected", capabilities: ["notifications", "camera"], lastSeen: 2 days ago, version: "1.9.8"
    - Define `GatewayNode` type locally: id, name, platform ('macOS'|'iOS'|'Android'|'Windows'|'Linux'), status ('connected'|'disconnected'), capabilities (string[]), lastSeen (Date), version (string).
    - Uses queryKeys with gateway.all + "nodes" suffix. staleTime Infinity.

    **Nodes table** (`gateway-nodes-table.tsx`):
    - "use client" component using shared DataTable.
    - Columns: Name (with platform icon — Laptop for macOS/Windows/Linux, Smartphone for iOS/Android), Platform (badge), Status (StatusBadge), Capabilities (comma-separated badge list using Badge component), Last Seen (relative time via formatDistanceToNow), Version.
    - Per user decision: nodes are listed within the instance detail page AND at /gateway/nodes. This component is shared between both views.
    - Note: The instance detail page in 07-01 already has a mock nodes section. This task creates the proper reusable component that can replace that mock section.

    **Nodes view** (`gateway-nodes-view.tsx`):
    - "use client". PageHeader ("Gateway Nodes" with description "Connected devices and their capabilities").
    - Renders GatewayNodesTable with data from useGatewayNodes.
    - Loading: SkeletonTable. Empty: EmptyState "No nodes connected" with description about device pairing.
    - Info alert at top: "Nodes are physical devices running the OpenClaw client. They provide filesystem access, terminal, browser, and other capabilities to your agents."

    **Route page** — Update `app/(dashboard)/gateway/nodes/page.tsx`:
    - Server component rendering GatewayNodesView in Suspense. generateMetadata: { title: "Gateway Nodes" }.
  </action>
  <verify>
    Run `bunx tsc --noEmit`. Navigate to /gateway/nodes — see 3 nodes in DataTable with platform icons, capabilities badges, and status. Verify disconnected node shows appropriate status and stale lastSeen time.
  </verify>
  <done>
    Gateway nodes page at /gateway/nodes shows connected devices with platform, capabilities, status, and version. Nodes table is a reusable component usable in both the standalone page and instance detail views.
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes with zero errors
- /channels/pairing shows 6 platform cards and wizard flow works end-to-end
- WhatsApp pairing opens QR modal with timer and instructions
- Telegram/Discord pairing collects bot tokens
- Configuration step allows naming and agent assignment
- Confirmation step shows summary and completes pairing
- /gateway/nodes shows 3 mock nodes with capabilities and status
- Pairing store resets on wizard unmount (no stale state)
</verification>

<success_criteria>
Channel pairing wizard at /channels/pairing walks through platform selection, platform-specific authentication (WhatsApp QR modal, token inputs, OAuth simulation), channel configuration, and completion confirmation. Gateway nodes at /gateway/nodes displays connected devices with capabilities and status.
</success_criteria>

<output>
After completion, create `.planning/phases/07-gateway-channels-models/07-04-SUMMARY.md`
</output>
