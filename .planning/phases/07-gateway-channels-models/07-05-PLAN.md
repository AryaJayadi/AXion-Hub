---
phase: 07-gateway-channels-models
plan: 05
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/features/models/api/use-providers.ts
  - src/features/models/api/use-model-catalog.ts
  - src/features/models/api/use-failover-chains.ts
  - src/features/models/api/use-model-usage.ts
  - src/features/models/schemas/model-schemas.ts
  - src/features/models/components/provider-card.tsx
  - src/features/models/components/provider-config-form.tsx
  - src/features/models/components/model-catalog-browser.tsx
  - src/features/models/components/failover-chain-builder.tsx
  - src/features/models/components/failover-chain-item.tsx
  - src/features/models/components/usage-charts.tsx
  - src/features/models/components/usage-dimension-toggle.tsx
  - src/views/models/models-overview-view.tsx
  - src/views/models/provider-detail-view.tsx
  - src/views/models/model-catalog-view.tsx
  - src/views/models/failover-view.tsx
  - src/views/models/usage-view.tsx
  - app/(dashboard)/models/page.tsx
  - app/(dashboard)/models/[provider]/page.tsx
  - app/(dashboard)/models/catalog/page.tsx
  - app/(dashboard)/models/failover/page.tsx
  - app/(dashboard)/models/usage/page.tsx
autonomous: true
requirements:
  - MODL-01
  - MODL-02
  - MODL-03
  - MODL-04
  - MODL-05

must_haves:
  truths:
    - "User can view connected providers with auth status and model list at /models"
    - "User can configure per-provider settings with API key input and Test Connection button at /models/[provider]"
    - "User can browse all models organized by provider with expandable sections at /models/catalog"
    - "User can configure failover chains with reorderable list at /models/failover"
    - "User can view usage/cost charts with per-provider, per-model, and per-agent toggle at /models/usage"
  artifacts:
    - path: "src/features/models/components/provider-card.tsx"
      provides: "Provider card with status, model count, expandable model list"
      min_lines: 40
    - path: "src/features/models/components/provider-config-form.tsx"
      provides: "Per-provider config form with API key masking and Test Connection"
      min_lines: 60
    - path: "src/features/models/components/failover-chain-builder.tsx"
      provides: "Reorderable failover chain with @dnd-kit/sortable"
      min_lines: 70
    - path: "src/features/models/components/usage-charts.tsx"
      provides: "Multi-dimension usage/cost charts with Recharts"
      min_lines: 80
    - path: "src/views/models/models-overview-view.tsx"
      provides: "Provider overview page composition"
      min_lines: 30
  key_links:
    - from: "src/views/models/models-overview-view.tsx"
      to: "src/features/models/api/use-providers.ts"
      via: "useProviders hook"
      pattern: "useProviders"
    - from: "src/features/models/components/failover-chain-builder.tsx"
      to: "@dnd-kit/sortable"
      via: "SortableContext for reorderable list"
      pattern: "SortableContext"
    - from: "src/features/models/components/usage-charts.tsx"
      to: "recharts"
      via: "AreaChart and BarChart for cost visualization"
      pattern: "AreaChart|BarChart"
    - from: "app/(dashboard)/models/page.tsx"
      to: "src/views/models/models-overview-view.tsx"
      via: "view import"
      pattern: "ModelsOverviewView"
---

<objective>
Build the complete model provider management: provider overview with auth status, per-provider configuration with Test Connection, model catalog browser, failover chain builder with drag-and-drop reordering, and multi-dimension usage/cost tracking charts.

Purpose: Enable users to manage their LLM providers, browse available models, set up resilient failover chains, and track token usage and costs across providers, models, and agents.

Output: Provider overview at /models. Per-provider config at /models/[provider]. Model catalog at /models/catalog organized by provider with expandable sections. Failover chain builder at /models/failover. Usage/cost dashboard at /models/usage with dimension toggle.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gateway-channels-models/07-RESEARCH.md
@.planning/phases/07-gateway-channels-models/07-01-SUMMARY.md
@src/entities/model-provider/model/types.ts
@src/entities/model-provider/model/schemas.ts
@src/shared/lib/query-keys.ts
@src/features/dashboard/components/cost-summary-widget.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Provider overview, per-provider config, and model catalog</name>
  <files>
    src/features/models/api/use-providers.ts
    src/features/models/api/use-model-catalog.ts
    src/features/models/schemas/model-schemas.ts
    src/features/models/components/provider-card.tsx
    src/features/models/components/provider-config-form.tsx
    src/features/models/components/model-catalog-browser.tsx
    src/views/models/models-overview-view.tsx
    src/views/models/provider-detail-view.tsx
    src/views/models/model-catalog-view.tsx
    app/(dashboard)/models/page.tsx
    app/(dashboard)/models/[provider]/page.tsx
    app/(dashboard)/models/catalog/page.tsx
  </files>
  <action>
    **Model schemas** (`model-schemas.ts`):
    - Import from "zod/v4". Create:
      - `providerConfigSchema` — apiKey (string min 1, or empty for none auth), baseUrl (string url optional), enabled (boolean), maxConcurrentRequests (number optional, min 1).
      - `failoverChainSchema` — name (string min 1), models (array of { providerId, modelId, maxRetries min 0 max 10, timeoutMs min 1000 max 120000 }, min 1 item per research Pitfall 4).

    **Provider API hook** (`use-providers.ts`):
    - `useProviders()` — returns 4 mock providers:
      1. Anthropic: slug "anthropic", status "connected", authMethod "api_key", 5 models (Claude Opus 4, Claude Sonnet 4, Claude Haiku 3.5, Claude Sonnet 3.5, Claude 3 Opus) with realistic context windows (200K), pricing (input/output per MTok), and capabilities.
      2. OpenAI: slug "openai", status "connected", authMethod "api_key", 4 models (GPT-4o, GPT-4o mini, GPT-4 Turbo, o1) with specs.
      3. Google: slug "google", status "disconnected", authMethod "api_key", 3 models (Gemini 2.0 Flash, Gemini 1.5 Pro, Gemini 1.5 Flash) with specs.
      4. Ollama: slug "ollama", status "connected", authMethod "none", baseUrl "http://localhost:11434", 2 models (Llama 3.1 70B, Mistral 7B) with local pricing ($0).
    - Uses queryKeys.models.providers(), staleTime Infinity.
    - `useProvider(slug)` — returns single provider from list. queryKeys.models.provider(slug).
    - `useUpdateProvider()` — mutation for saving config, simulates 500ms delay, invalidates, toast.
    - `useTestConnection(slug)` — mutation simulating a 2s "test" delay. Returns { success: boolean, latencyMs: number, error?: string }. For "google" (disconnected) returns { success: false, error: "Invalid API key" }. For others returns { success: true, latencyMs: random 50-200 }.

    **Model catalog hook** (`use-model-catalog.ts`):
    - `useModelCatalog()` — returns all models from all providers flattened, each with providerId and providerName attached. Reuses the provider mock data models. queryKeys.models.catalog(), staleTime Infinity.

    **Provider card** (`provider-card.tsx`):
    - "use client" component displaying a provider as a Card.
    - Header: Provider name (bold), slug in muted text, StatusBadge (connected/disconnected/error).
    - Content: auth method badge, model count, base URL if present.
    - Expandable section (using Collapsible from shadcn): "Models ({count})" header that expands to show model list as compact rows — model name, context window formatted ("200K"), pricing ("{input}/${output} per MTok").
    - Per user decision: model catalog organized by provider with expandable sections.
    - Footer: "Configure" link button to /models/[provider.slug].
    - Click on card itself also navigates to /models/[provider.slug].

    **Provider config form** (`provider-config-form.tsx`):
    - "use client" component taking provider: ModelProvider prop.
    - react-hook-form with zodResolver (as-any Zod v4 cast) and providerConfigSchema.
    - Fields:
      - API Key: Input with type="password" and show/hide toggle button. Pre-filled with masked value ("sk-...XXXX"). If authMethod is "none", field is disabled with "No authentication required" text.
      - Base URL: Input, only shown if provider has a baseUrl or authMethod allows custom endpoints (e.g., Ollama).
      - Max Concurrent Requests: Input type="number".
      - Enabled: Switch toggle.
    - "Test Connection" button (per user decision): calls useTestConnection mutation. Shows loading spinner during test. On success: green checkmark + "Connected (latency: {ms}ms)" toast. On failure: red X + error message toast.
    - "Save Configuration" button calls useUpdateProvider.
    - Both buttons in a flex row at the bottom.

    **Model catalog browser** (`model-catalog-browser.tsx`):
    - "use client" component displaying all models organized by provider with expandable sections (per user decision: organized by provider, not flat list).
    - SearchInput at top for filtering models by name across all providers.
    - For each provider: a Collapsible section with provider name header + model count badge. Initially expanded for connected providers, collapsed for disconnected.
    - Inside each section: card grid or list of models. Each model card shows: name, context window, max output tokens, input/output pricing, capabilities as small badges (e.g., "vision", "function-calling", "json-mode").
    - Empty state if search returns no results.

    **Views**:
    - `models-overview-view.tsx`: "use client". PageHeader ("Model Providers" with description "Manage LLM provider connections and configurations"). Responsive card grid of ProviderCards (grid-cols-1 md:grid-cols-2 gap-4). Sub-nav links below header: "Catalog", "Failover", "Usage" as pill buttons linking to sub-pages. Loading: SkeletonCard. Empty: EmptyState "No providers configured".
    - `provider-detail-view.tsx`: "use client". Takes providerSlug param. Uses useProvider(slug). PageHeader with provider name and status badge. ProviderConfigForm. Below form: model list for this provider (reuse from provider card's expandable section as full table — model name, context, pricing, capabilities). Not-found and loading states.
    - `model-catalog-view.tsx`: "use client". PageHeader ("Model Catalog" with description "Browse all available models across providers"). ModelCatalogBrowser. Loading skeleton.

    **Route pages** — Update placeholders:
    - `app/(dashboard)/models/page.tsx`: Render ModelsOverviewView.
    - `app/(dashboard)/models/[provider]/page.tsx`: Extract provider param, render ProviderDetailView.
    - `app/(dashboard)/models/catalog/page.tsx`: Render ModelCatalogView.
  </action>
  <verify>
    Run `bunx tsc --noEmit`. Navigate to /models — see 4 provider cards with status and expandable model lists. Click "Anthropic" — see config form with masked API key, Test Connection button, and model list. Click Test Connection — loading spinner then success toast with latency. Navigate to /models/catalog — see models organized by provider with search filter. Search "Claude" — only Anthropic models shown.
  </verify>
  <done>
    Provider overview at /models shows 4 providers with status and expandable model lists. Provider detail at /models/[provider] has config form with API key masking and Test Connection. Model catalog at /models/catalog organizes models by provider with search.
  </done>
</task>

<task type="auto">
  <name>Task 2: Failover chain builder and usage/cost tracking charts</name>
  <files>
    src/features/models/api/use-failover-chains.ts
    src/features/models/api/use-model-usage.ts
    src/features/models/components/failover-chain-builder.tsx
    src/features/models/components/failover-chain-item.tsx
    src/features/models/components/usage-charts.tsx
    src/features/models/components/usage-dimension-toggle.tsx
    src/views/models/failover-view.tsx
    src/views/models/usage-view.tsx
    app/(dashboard)/models/failover/page.tsx
    app/(dashboard)/models/usage/page.tsx
  </files>
  <action>
    **Failover chains API hook** (`use-failover-chains.ts`):
    - `useFailoverChains()` — returns 2 mock failover chains:
      1. "Production Chain": Claude Sonnet 4 (Anthropic, 3 retries, 30s timeout) -> GPT-4o (OpenAI, 2 retries, 30s timeout) -> Gemini 2.0 Flash (Google, 1 retry, 60s timeout)
      2. "Fast Chain": Claude Haiku 3.5 (Anthropic, 2 retries, 15s timeout) -> GPT-4o mini (OpenAI, 2 retries, 15s timeout)
    - queryKeys.models.failover(), staleTime Infinity.
    - `useCreateFailoverChain()` — mutation to add a chain. Simulates delay, invalidates, toast.
    - `useUpdateFailoverChain()` — mutation to reorder/modify a chain. Same pattern.
    - `useDeleteFailoverChain()` — mutation to remove a chain.

    **Usage API hook** (`use-model-usage.ts`):
    - `useModelUsage(dimension, period)` — returns mock ModelUsage[] data. Dimension: 'provider'|'model'|'agent'. Period: 'today'|'week'|'month'.
    - Mock data generates 7-30 data points depending on period, grouped by the dimension. Include realistic token counts (hundreds of thousands) and costs ($0.50-$50 range).
    - For 'provider' dimension: Anthropic, OpenAI data series.
    - For 'model' dimension: Claude Sonnet 4, GPT-4o, Claude Haiku data series.
    - For 'agent' dimension: "Research Agent", "Dev Agent", "Writer Agent" data series.
    - queryKeys.models.usage(dimension, period).

    **Failover chain item** (`failover-chain-item.tsx`):
    - "use client" component using useSortable from @dnd-kit/sortable (per research Pattern 5).
    - Renders a single model in the failover chain as a horizontal card.
    - GripVertical drag handle on left (via {...attributes} {...listeners}).
    - Content: priority number (1-based index), model name (bold), provider name (muted), maxRetries and timeoutMs as small badges.
    - Edit button: opens inline editing for maxRetries and timeout (two small Input type="number" fields).
    - Remove button (Trash2 icon) with destructive styling.
    - Apply CSS.Transform for drag animation. Per research code example.

    **Failover chain builder** (`failover-chain-builder.tsx`):
    - "use client" component. Main failover chain management UI.
    - Left sidebar (or top section on mobile): list of existing chains as clickable items. "Create Chain" button that adds a new empty chain with a name input.
    - Main area: selected chain's model list as a vertical reorderable list.
    - Uses DndContext + SortableContext with verticalListSortingStrategy (per research Pattern 5, replicating the kanban pattern from @dnd-kit/sortable).
    - DragOverlay shows a ghost of the FailoverChainItem being dragged.
    - "Add Model" button at bottom of the chain: opens a dropdown/popover showing all available models from all providers (grouped by provider). Selecting a model adds it to the chain with default retries (2) and timeout (30000ms).
    - Chain name editable inline (click to edit pattern).
    - "Save Chain" button calls useUpdateFailoverChain. "Delete Chain" button with confirmation dialog.
    - Validation: chain must have at least 1 model (per research Pitfall 4). Show error if empty.

    **Usage dimension toggle** (`usage-dimension-toggle.tsx`):
    - "use client" component with two toggle groups:
      1. Dimension: "By Provider" | "By Model" | "By Agent" (per user decision: multi-dimension toggle).
      2. Period: "Today" | "This Week" | "This Month".
    - Uses nuqs useQueryState for URL persistence of both dimension and period.
    - Renders as ToggleGroup or segmented button bar from shadcn.

    **Usage charts** (`usage-charts.tsx`):
    - "use client" component taking usage data, dimension, and period props.
    - Extends the existing cost-summary-widget.tsx pattern from Phase 5.
    - Two chart sections:
      1. **Usage Over Time** — Recharts AreaChart showing token usage (input + output stacked) over the period. X-axis: dates. Y-axis: token count. One area per dimension group (e.g., per-provider shows Anthropic area + OpenAI area). Use ChartConfig with CSS variable colors for theme consistency (matching Phase 5 pattern).
      2. **Cost Breakdown** — Recharts BarChart showing cost grouped by dimension. Stacked bars for input vs output costs. Use the existing cost-summary-widget pattern.
    - Below charts: DataTable showing detailed sortable data — columns: Name (provider/model/agent depending on dimension), Input Tokens, Output Tokens, Total Cost, Request Count. With totals row at bottom.
    - Uses @number-flow/react NumberFlow for animated total cost display at the top.

    **Views**:
    - `failover-view.tsx`: "use client". PageHeader ("Failover Chains" with description "Configure model failover priority for resilient AI operations"). FailoverChainBuilder. Loading skeleton.
    - `usage-view.tsx`: "use client". PageHeader ("Model Usage & Costs" with description "Track token usage and costs across providers, models, and agents"). UsageDimensionToggle at top. UsageCharts below with data from useModelUsage(dimension, period). Loading skeleton during data fetch.

    **Route pages** — Update placeholders:
    - `app/(dashboard)/models/failover/page.tsx`: Render FailoverView. generateMetadata: { title: "Failover Chains" }.
    - `app/(dashboard)/models/usage/page.tsx`: Render UsageView. generateMetadata: { title: "Model Usage" }.
  </action>
  <verify>
    Run `bunx tsc --noEmit`. Navigate to /models/failover — see 2 failover chains. Click "Production Chain" — see 3 models in reorderable list. Drag to reorder — items move with animation. Click "Add Model" — popover shows available models. Remove a model — chain updates. Navigate to /models/usage — see dimension toggle (provider/model/agent) and period toggle (today/week/month). See area chart for usage over time and bar chart for cost breakdown. Switch to "By Agent" — charts update. DataTable below shows detailed numbers.
  </verify>
  <done>
    Failover chains at /models/failover: create, reorder (drag-and-drop), add/remove models, edit retries/timeout. Minimum 1 model enforced. Usage at /models/usage: multi-dimension toggle (provider/model/agent), period toggle (today/week/month), area chart for usage, bar chart for costs, detailed DataTable.
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes with zero errors
- /models shows 4 provider cards with expandable model lists
- /models/anthropic shows config form with masked API key and Test Connection
- /models/catalog shows models organized by provider with search
- /models/failover shows reorderable failover chains with drag-and-drop
- /models/usage shows usage/cost charts with dimension and period toggles
- Test Connection button gives success/failure feedback per provider
- Failover chain enforces minimum 1 model validation
- Usage charts switch dimensions and periods via URL-persisted toggles
</verification>

<success_criteria>
Provider overview at /models displays providers with auth status. Per-provider config at /models/[provider] has API key masking and Test Connection. Model catalog at /models/catalog organizes by provider with expandable sections and search. Failover chains at /models/failover use drag-and-drop reordering. Usage tracking at /models/usage provides multi-dimension (provider/model/agent) charts with period toggles.
</success_criteria>

<output>
After completion, create `.planning/phases/07-gateway-channels-models/07-05-SUMMARY.md`
</output>
