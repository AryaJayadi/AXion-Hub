---
phase: 06-mission-board
plan: 04
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/features/missions/components/task-comments.tsx
  - src/features/missions/components/mention-popover.tsx
  - src/features/missions/components/board-sidebar.tsx
  - src/features/missions/components/board-settings.tsx
  - src/features/missions/schemas/board-schemas.ts
  - src/features/missions/api/use-board-mutations.ts
  - src/views/missions/boards-list-view.tsx
  - src/views/missions/board-settings-view.tsx
  - app/(dashboard)/missions/boards/page.tsx
  - app/(dashboard)/missions/boards/[boardId]/settings/page.tsx
  - src/features/missions/components/task-detail-content.tsx
  - src/views/missions/missions-board-view.tsx
autonomous: true
requirements:
  - TASK-07
  - TASK-08
  - TASK-09

must_haves:
  truths:
    - "User can comment on tasks with a text input that supports @agent and @human mentions"
    - "Typing @ in the comment input opens a mention popover with searchable agent/human list"
    - "User can view and manage boards at /missions/boards"
    - "User can configure board settings at /missions/boards/[boardId]/settings including rename, custom columns, and automation rules"
    - "Board sidebar shows list of boards for navigation (Notion-like page tree)"
  artifacts:
    - path: "src/features/missions/components/task-comments.tsx"
      provides: "Comment thread with @mention support and comment input"
    - path: "src/features/missions/components/mention-popover.tsx"
      provides: "Mention autocomplete popover for @agent and @human"
    - path: "src/features/missions/components/board-sidebar.tsx"
      provides: "Board list sidebar for mission board navigation"
    - path: "src/features/missions/components/board-settings.tsx"
      provides: "Board settings form with column management and automation rules"
    - path: "app/(dashboard)/missions/boards/page.tsx"
      provides: "Board list route page"
    - path: "app/(dashboard)/missions/boards/[boardId]/settings/page.tsx"
      provides: "Board settings route page"
  key_links:
    - from: "src/features/missions/components/task-comments.tsx"
      to: "src/features/missions/components/mention-popover.tsx"
      via: "@ trigger in textarea opens MentionPopover for autocomplete"
      pattern: "MentionPopover|@"
    - from: "src/features/missions/components/board-sidebar.tsx"
      to: "src/features/missions/model/board-store.ts"
      via: "Board list from store, active board selection"
      pattern: "useBoardStore|setActiveBoard"
    - from: "src/features/missions/components/board-settings.tsx"
      to: "src/features/missions/api/use-board-mutations.ts"
      via: "Board update mutation for settings changes"
      pattern: "useUpdateBoard"
---

<objective>
Add task comments with @mention support, board organization pages (/missions/boards), board settings with custom column management and automation rules, and a board sidebar for navigation.

Purpose: Comments enable collaboration between humans and agents on tasks. Board organization allows managing multiple project boards. These complete the Phase 6 feature set.
Output: Comment thread component, mention popover, board list page, board settings page, and board sidebar.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mission-board/06-RESEARCH.md
@.planning/phases/06-mission-board/06-CONTEXT.md
@.planning/phases/06-mission-board/06-02-SUMMARY.md
@src/entities/mission/model/types.ts
@src/features/missions/model/board-store.ts
@src/features/missions/model/task-store.ts
@src/features/chat/components/slash-command-popover.tsx
@src/shared/ui/command.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Task comments with @mention popover and wire into task detail</name>
  <files>
    src/features/missions/components/task-comments.tsx
    src/features/missions/components/mention-popover.tsx
    src/features/missions/components/task-detail-content.tsx
  </files>
  <action>
    **1. Create MentionPopover** at `src/features/missions/components/mention-popover.tsx`:
    - "use client" directive
    - Reuse the same pattern as `src/features/chat/components/slash-command-popover.tsx`
    - Props: open (boolean), onSelect ((mention: Mention) => void), onClose (() => void), position ({ top: number; left: number }), searchQuery (string)
    - Uses cmdk Command component for searchable list
    - Two groups in the command list:
      - "Agents" group: list agents from agent store (useAgentStore), each with Bot icon and agent name
      - "Team Members" group: mock list of human users (e.g., "Arya", "Admin") with User icon
    - Filter by searchQuery (cmdk handles this natively)
    - On select: call onSelect with { type: 'agent'|'human', id, name }
    - Position: use absolute positioning relative to the textarea cursor position (pass position prop from parent)
    - Use bottom-full positioning approach (popover appears above the cursor) to avoid edge clipping (Pitfall 8)
    - Keyboard: up/down arrows navigate, Enter selects, Escape closes

    **2. Create TaskComments** at `src/features/missions/components/task-comments.tsx`:
    - "use client" directive
    - Props: taskId (string), comments (TaskComment[])
    - **Comment list:** Render each comment as:
      - Author avatar + name (with 'agent' or 'human' indicator badge)
      - Timestamp (relative)
      - Content with mentions highlighted: parse content for @mentions (pattern: @[name](type:id)) and render as colored inline badges -- blue for agents, purple for humans
      - If authorType='agent', show a subtle Bot icon indicator
    - **Comment input:**
      - Textarea (not contentEditable -- per research anti-pattern)
      - Track cursor position in state
      - On typing '@': detect the @ character, start tracking the search query (characters after @), set mentionPopoverOpen=true
      - Pass current cursor position to MentionPopover for positioning
      - On mention select: insert mention text at cursor position in format `@[name](type:id)`, close popover, refocus textarea
      - "Post" button to submit comment
      - On submit: create mock comment with nanoid, add to local comments state, show toast "Comment added"
      - Clear input after submit
    - **Mock comments:** Add 2-3 mock comments per task (one from user, one from agent with @mention)
    - Empty state: "No comments yet. Start the conversation." with MessageSquare icon

    **3. Wire into TaskDetailContent:**
    - Replace the "Comments" placeholder section with `<TaskComments>` component
    - Add as the last section in the detail view (below deliverables and activity timeline)
    - Pass comments from task store or local mock data
  </action>
  <verify>
    Run `bun run build` -- must pass. Navigate to task detail and verify comments section renders with mock comments. Type @ in the comment input to verify mention popover appears with agent/human list. Select a mention and verify it inserts into the textarea. Post a comment and verify it appears in the thread.
  </verify>
  <done>
    Comment thread renders with author avatars, timestamps, and highlighted @mentions. Typing @ opens mention popover with searchable agent/human list using cmdk. Selected mentions insert as formatted text. Comments post with optimistic update. Wired into TaskDetailContent in both slide-over and full page views. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Board organization pages, board sidebar, and board settings</name>
  <files>
    src/features/missions/components/board-sidebar.tsx
    src/features/missions/components/board-settings.tsx
    src/features/missions/schemas/board-schemas.ts
    src/features/missions/api/use-board-mutations.ts
    src/views/missions/boards-list-view.tsx
    src/views/missions/board-settings-view.tsx
    app/(dashboard)/missions/boards/page.tsx
    app/(dashboard)/missions/boards/[boardId]/settings/page.tsx
    src/views/missions/missions-board-view.tsx
  </files>
  <action>
    **1. Create board form schemas** at `src/features/missions/schemas/board-schemas.ts`:
    - Import from `zod/v4`
    - `createBoardSchema`: name (min 1, max 100)
    - `updateBoardSchema`: name (optional), columns array (optional)
    - `boardColumnFormSchema`: name (min 1), semanticRole (nullable), isHumanOnly (boolean)
    - `automationRuleSchema`: trigger (enum: 'card_enters_column' | 'card_assigned' | 'deliverable_submitted' | 'sign_off_completed'), triggerColumn (optional string), action (enum: 'notify_reviewer' | 'auto_assign' | 'send_webhook' | 'change_status'), actionConfig (Record<string, string>)
    - Export inferred types

    **2. Create board mutation hooks** at `src/features/missions/api/use-board-mutations.ts`:
    - `useCreateBoard()`: mutation to add board to board store, toast success
    - `useUpdateBoard()`: mutation to update board name/columns in store, toast success
    - `useDeleteBoard()`: mutation with confirmation, remove from store, toast success
    - All use mock/optimistic pattern (no real API yet)

    **3. Create BoardSidebar** at `src/features/missions/components/board-sidebar.tsx`:
    - "use client" directive
    - Renders inside the missions board view as an in-content secondary sidebar (per research: like chat conversation sidebar, NOT nested in app sidebar)
    - Layout: w-56 border-r, flex-shrink-0, scrollable
    - Header: "Boards" label with a "+" button to create new board (opens small Dialog with name input)
    - Board list: each board as a clickable item with:
      - Board name
      - Active indicator (background highlight for selected board, using pathname or activeBoardId)
      - Three-dot ActionMenu with: Rename, Settings (link to /missions/boards/[boardId]/settings), Delete (with AlertDialog confirmation)
    - Boards come from board store
    - Mock data: "General" board (auto-created default per CONTEXT.md) + "Research Tasks" board

    **4. Create BoardSettings** at `src/features/missions/components/board-settings.tsx`:
    - "use client" directive
    - Props: boardId (string)
    - react-hook-form with zodResolver
    - Sections:
      - **General:** Board name input with save button
      - **Columns:** Show list of current columns (both core and human-only). Core columns are non-deletable (shown with lock icon and semantic role label). Human-only columns can be added, renamed, reordered, or deleted.
        - "Add Column" button: adds a new human-only column. Input for name + position selector (dropdown showing "After IN PROGRESS", "After IN REVIEW", etc.)
        - Each human-only column row: name input, position indicator, delete button
        - Core columns shown as read-only rows with their semantic role
      - **Automation Rules:** Simple trigger-action model per CONTEXT.md discretion
        - List existing rules with edit/delete
        - "Add Rule" button opens a form:
          - Trigger: dropdown (card enters column, card assigned, deliverable submitted, sign-off completed)
          - Condition: dropdown for trigger-specific config (e.g., which column)
          - Action: dropdown (notify reviewer, auto-assign, send webhook, change status)
          - Action config: depends on action type (e.g., webhook URL input, target column selector)
        - Start simple: rules stored in local state / board store mock
      - **Members:** Placeholder section showing "Board access management coming soon"
    - Save button submits via useUpdateBoard mutation

    **5. Create BoardsListView** at `src/views/missions/boards-list-view.tsx`:
    - "use client" directive
    - PageHeader: "Boards", description "Organize tasks across project boards"
    - Grid of board cards (grid-cols-1 md:grid-cols-2 lg:grid-cols-3):
      - Each card: board name, task count (from board store), created date
      - Click: navigate to /missions with that board active (or set activeBoardId)
      - Settings icon button: navigate to /missions/boards/[boardId]/settings
    - "Create Board" button in PageHeader actions
    - Empty state if no boards (shouldn't happen since "General" always exists)

    **6. Create BoardSettingsView** at `src/views/missions/board-settings-view.tsx`:
    - "use client" directive
    - PageHeader: breadcrumb "Boards > [Board Name] > Settings"
    - Renders BoardSettings component with boardId from params
    - Back link to /missions/boards

    **7. Create route pages:**
    - `app/(dashboard)/missions/boards/page.tsx`: Server component rendering BoardsListView in Suspense. Metadata: "Boards | AXion Hub"
    - `app/(dashboard)/missions/boards/[boardId]/settings/page.tsx`: Server component extracting boardId from params, rendering BoardSettingsView in Suspense. Metadata: "Board Settings | AXion Hub"

    **8. Wire BoardSidebar into MissionsBoardView:**
    - Update missions-board-view.tsx to include BoardSidebar on the left side of the board
    - Layout: flex row with BoardSidebar (w-56, shrink-0) + KanbanBoard (flex-1)
    - BoardSidebar shows on md+ screens, hidden on mobile (responsive)
  </action>
  <verify>
    Run `bun run build` -- must pass. Verify /missions shows board sidebar with "General" and "Research Tasks" boards. Click between boards to verify switching. Navigate to /missions/boards to see board list grid. Navigate to /missions/boards/[boardId]/settings to see settings form. Add a human-only column and verify it appears. Add an automation rule.
  </verify>
  <done>
    Board sidebar renders in missions board view with board list and create/rename/delete actions. /missions/boards shows board grid with task counts. Board settings at /missions/boards/[boardId]/settings allows renaming, adding human-only columns between core columns, and configuring automation rules with trigger-action model. Mock data includes "General" and "Research Tasks" boards. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes with zero TypeScript errors
2. Comment thread renders in task detail with mock comments
3. Typing @ in comment input opens mention popover with agent/human list
4. Mention popover filters as user types and inserts formatted mention on selection
5. Board sidebar shows in /missions view with board list
6. /missions/boards renders board list grid
7. /missions/boards/[boardId]/settings renders settings form
8. Core columns shown as read-only; human-only columns can be added/removed
9. Automation rules can be added with trigger-action model
</verification>

<success_criteria>
- Comment thread with @mention support using cmdk-based popover (matching existing slash-command pattern)
- Board sidebar for navigation between boards (Notion-like page tree)
- Board list page at /missions/boards with grid of board cards
- Board settings at /missions/boards/[boardId]/settings with column management and automation rules
- Human-only columns insertable between core columns; core columns non-deletable
- Simple trigger-action automation rule model as starting point
</success_criteria>

<output>
After completion, create `.planning/phases/06-mission-board/06-04-SUMMARY.md`
</output>
