---
phase: 06-mission-board
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/features/missions/components/task-activity-timeline.tsx
  - src/features/missions/components/task-dispatch-log.tsx
  - src/features/missions/components/task-deliverables.tsx
  - src/features/missions/components/deliverable-preview-card.tsx
  - src/features/missions/components/task-sign-off-modal.tsx
  - src/features/missions/components/task-detail-content.tsx
autonomous: true
requirements:
  - TASK-04
  - TASK-05
  - TASK-06

must_haves:
  truths:
    - "Task detail shows an activity timeline with status changes, comments, deliverable uploads, and assignment changes"
    - "Activity timeline has a toggle to expand agent-level detail (tool calls, reasoning) for any event"
    - "Task detail shows a dispatch log of agent interactions"
    - "Deliverables display as inline preview cards with thumbnails for images, code snippets, and links"
    - "Sign-off gate uses a review modal with approve/reject/request revision buttons"
    - "Rejection and revision request require a comment before submission"
  artifacts:
    - path: "src/features/missions/components/task-activity-timeline.tsx"
      provides: "Layered activity timeline with expandable agent detail"
    - path: "src/features/missions/components/task-deliverables.tsx"
      provides: "Deliverable preview cards with thumbnails"
    - path: "src/features/missions/components/task-sign-off-modal.tsx"
      provides: "Review modal with approve/reject/revision actions"
  key_links:
    - from: "src/features/missions/components/task-activity-timeline.tsx"
      to: "src/features/missions/model/task-store.ts"
      via: "Reading activity entries from task store"
      pattern: "useTaskStore|ActivityEntry"
    - from: "src/features/missions/components/task-sign-off-modal.tsx"
      to: "src/features/missions/api/use-task-mutations.ts"
      via: "useUpdateTask mutation to set signOffStatus"
      pattern: "useUpdateTask|signOffStatus"
    - from: "src/features/missions/components/task-detail-content.tsx"
      to: "src/features/missions/components/task-activity-timeline.tsx"
      via: "TaskDetailContent renders ActivityTimeline replacing placeholder"
      pattern: "TaskActivityTimeline"
---

<objective>
Add the activity timeline, dispatch log, deliverables preview, and sign-off gate modal to the task detail views. These components replace the placeholder sections from plan 06-02 inside TaskDetailContent.

Purpose: Activity tracking and deliverable management are what make the mission board more than a simple Kanban -- they provide full visibility into agent work and governance controls.
Output: Activity timeline with expandable agent detail, dispatch log, deliverable preview cards, and sign-off review modal.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mission-board/06-RESEARCH.md
@.planning/phases/06-mission-board/06-CONTEXT.md
@.planning/phases/06-mission-board/06-02-SUMMARY.md
@src/entities/mission/model/types.ts
@src/features/missions/model/task-store.ts
@src/features/missions/api/use-task-mutations.ts
@src/features/missions/components/task-detail-content.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Activity timeline with expandable agent detail and dispatch log</name>
  <files>
    src/features/missions/components/task-activity-timeline.tsx
    src/features/missions/components/task-dispatch-log.tsx
    src/features/missions/components/task-detail-content.tsx
  </files>
  <action>
    **1. Create TaskActivityTimeline** at `src/features/missions/components/task-activity-timeline.tsx`:
    - "use client" directive
    - Props: taskId (string), entries (ActivityEntry[])
    - Renders a vertical timeline using a left-border line pattern (border-l-2 with relative dots)
    - Each entry shows:
      - Timestamp (relative, using date-fns formatDistanceToNow)
      - Actor (avatar + name, with type indicator for user/agent/system)
      - Summary text
      - Type-specific icon: status_change -> ArrowRight, comment -> MessageSquare, deliverable -> Paperclip, assignment -> UserPlus, agent_detail -> Bot
      - Type-specific color: status_change -> blue, comment -> gray, deliverable -> green, assignment -> purple, agent_detail -> amber
    - **Expandable agent detail:** When an entry has agentDetails array, show a "Show agent detail" toggle button. On click, expand with AnimatePresence (framer-motion) to show nested list of agent activities:
      - tool_call: shows tool name and arguments in a code block
      - reasoning: shows reasoning text in italic
      - output: shows output text
    - Default: collapsed (high-level events only per CONTEXT.md decision)
    - Empty state: "No activity yet" with Clock icon

    **2. Populate mock activity data:**
    - In the task store or useBoardTasks mock data, add 4-6 activity entries per task that has status beyond inbox:
      - A "Created task" system entry
      - A "Changed status to queued" entry
      - A "Assigned to agent" entry (for tasks with assignedAgentIds)
      - An agent_detail entry with 2-3 agentDetails items (tool call + output) for in_progress tasks
      - A "Submitted deliverable" entry for in_review tasks

    **3. Create TaskDispatchLog** at `src/features/missions/components/task-dispatch-log.tsx`:
    - "use client" directive
    - Props: taskId (string)
    - Filters activity entries to show only agent-related events: assignment, status_change by agents, agent_detail
    - Renders as a compact table (DataTable or simple table):
      - Columns: Timestamp, Agent, Action, Details
    - Shows "No dispatches yet" EmptyState if no agent activity

    **4. Wire into TaskDetailContent:**
    - Replace the "Activity Timeline" placeholder section with `<TaskActivityTimeline taskId={taskId} entries={activityEntries} />`
    - Add a Tabs component below the description area with two tabs: "Activity" (TaskActivityTimeline) and "Dispatch Log" (TaskDispatchLog)
    - Activity entries: retrieve from a mock source or from the task store (add an activityEntries Map<taskId, ActivityEntry[]> to task store if needed, or maintain as local state populated from mock data)
  </action>
  <verify>
    Run `bun run build` -- must pass. Navigate to task detail (slide-over or full page) and verify activity timeline renders with entries. Click "Show agent detail" on an entry with agentDetails to verify expandable section works. Switch to "Dispatch Log" tab to verify filtered agent-only entries.
  </verify>
  <done>
    Activity timeline renders in task detail with timestamped entries, actor avatars, type-specific icons and colors. Agent detail sections expand/collapse with framer-motion animation. Dispatch log tab shows agent-only activity in table format. Mock data provides realistic timeline entries. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deliverables preview cards and sign-off gate review modal</name>
  <files>
    src/features/missions/components/task-deliverables.tsx
    src/features/missions/components/deliverable-preview-card.tsx
    src/features/missions/components/task-sign-off-modal.tsx
    src/features/missions/components/task-detail-content.tsx
  </files>
  <action>
    **1. Create DeliverablePreviewCard** at `src/features/missions/components/deliverable-preview-card.tsx`:
    - "use client" directive
    - Props: deliverable (Deliverable)
    - Renders as a Card component with compact layout:
      - For type='file': show file icon, title, mimeType badge, thumbnailUrl as small img if present (with fallback placeholder)
      - For type='code': show code icon (FileCode), title, code snippet preview (first 3 lines in monospace font, truncated), gray background
      - For type='link': show link icon (ExternalLink), title as clickable link, URL displayed below truncated
    - Click: open full view (for files: new tab with url, for code: expand to show full content in Dialog, for links: navigate)
    - Show submittedAt relative time and submittedBy avatar in footer

    **2. Create TaskDeliverables** at `src/features/missions/components/task-deliverables.tsx`:
    - "use client" directive
    - Props: taskId (string), deliverables (Deliverable[]), signOffRequired (boolean), signOffStatus (string | undefined)
    - Renders grid of DeliverablePreviewCard components (grid-cols-1 md:grid-cols-2 gap-3)
    - If signOffRequired is true AND deliverables exist:
      - Show sign-off status banner:
        - pending: yellow banner "Awaiting human sign-off" with "Review" button
        - approved: green banner "Approved" with checkmark
        - rejected: red banner "Rejected" with reason
        - revision_requested: orange banner "Revision requested" with details
      - "Review" button opens TaskSignOffModal
    - If signOffRequired is false: no banner, just show deliverables
    - Empty state: "No deliverables submitted yet" with Package icon

    **3. Add mock deliverables to tasks:**
    - For tasks in IN REVIEW or DONE columns, add 2-3 deliverables each:
      - One file deliverable (e.g., "analysis-report.pdf", type='file')
      - One code deliverable (e.g., "data-processor.ts", type='code', with snippet)
      - One link deliverable (e.g., "API Documentation", type='link', url to example)
    - For tasks with signOffRequired=true, set signOffStatus to 'pending' for IN REVIEW tasks

    **4. Create TaskSignOffModal** at `src/features/missions/components/task-sign-off-modal.tsx`:
    - "use client" directive
    - Uses Dialog (not AlertDialog -- needs more complex layout)
    - Props: taskId (string), deliverables (Deliverable[]), open (boolean), onClose (() => void)
    - Layout: deliberate review experience (per CONTEXT.md "should feel deliberate -- not accidental approvals")
      - Dialog title: "Review Deliverables"
      - Left section: scrollable list of DeliverablePreviewCards
      - Right section (or below on mobile): action buttons
    - Three action buttons:
      - **Approve** (green): Button with CheckCircle icon. On click, calls useUpdateTask to set signOffStatus='approved'. Show success toast.
      - **Reject** (red): Button with XCircle icon. On click, expand Textarea for required rejection comment. Comment must be non-empty to submit. Calls useUpdateTask to set signOffStatus='rejected'.
      - **Request Revision** (orange): Button with RotateCcw icon. On click, expand Textarea for required revision notes. Must be non-empty. Calls useUpdateTask to set signOffStatus='revision_requested'.
    - After any action: close dialog, show sonner toast with result
    - Cancel button to close without action

    **5. Wire into TaskDetailContent:**
    - Replace the "Deliverables" placeholder section with `<TaskDeliverables>` component
    - Add as a section between the subtasks and the activity timeline
    - Pass deliverables from task data, signOffRequired and signOffStatus
  </action>
  <verify>
    Run `bun run build` -- must pass. Navigate to a task in IN REVIEW column to see deliverable preview cards. Verify file, code, and link types render with appropriate icons and previews. Click "Review" to open sign-off modal. Verify reject/revision require comment before submission. Approve and verify status updates.
  </verify>
  <done>
    Deliverables section shows inline preview cards with type-specific rendering (file with thumbnail, code with snippet, link with URL). Sign-off gate shows status banner when required. Review modal displays deliverables with approve/reject/request revision actions. Reject and revision require comment. All wired into TaskDetailContent replacing placeholders. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes with zero TypeScript errors
2. Activity timeline renders in task detail with timestamped entries and type-specific icons
3. Agent detail sections expand/collapse with animation
4. Dispatch log tab shows filtered agent-only activity
5. Deliverables render as preview cards with type-specific thumbnails
6. Sign-off gate banner appears for tasks with signOffRequired=true
7. Review modal opens with deliverable display and three action buttons
8. Reject and revision request require non-empty comment
9. Approve/reject/revision update signOffStatus optimistically
</verification>

<success_criteria>
- Activity timeline with layered detail: high-level by default, expandable agent detail per CONTEXT.md decision
- Dispatch log provides agent-focused view of task activity
- Deliverable preview cards handle file, code, and link types with appropriate rendering
- Sign-off gate review modal feels deliberate with required comments for rejection/revision
- All sections wired into TaskDetailContent, visible in both slide-over and full page views
</success_criteria>

<output>
After completion, create `.planning/phases/06-mission-board/06-03-SUMMARY.md`
</output>
