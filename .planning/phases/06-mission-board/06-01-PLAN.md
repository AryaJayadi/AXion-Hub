---
phase: 06-mission-board
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/entities/mission/model/types.ts
  - src/entities/mission/model/schemas.ts
  - src/entities/mission/lib/priority-utils.ts
  - src/entities/mission/lib/column-utils.ts
  - src/entities/mission/index.ts
  - src/features/missions/model/board-store.ts
  - src/features/missions/model/task-store.ts
  - src/features/missions/model/hooks.ts
  - src/features/missions/api/use-boards.ts
  - src/features/missions/api/use-board-tasks.ts
  - src/features/missions/lib/mission-subscriptions.ts
  - src/features/missions/lib/drag-utils.ts
  - src/features/missions/components/kanban-board.tsx
  - src/features/missions/components/kanban-column.tsx
  - src/features/missions/components/kanban-card.tsx
  - src/features/missions/components/kanban-overlay.tsx
  - src/features/missions/index.ts
  - src/views/missions/missions-board-view.tsx
  - app/(dashboard)/missions/page.tsx
  - src/shared/lib/query-keys.ts
  - src/features/gateway-connection/lib/event-bus.ts
autonomous: true
requirements:
  - TASK-01

must_haves:
  truths:
    - "User can see tasks organized in 6 Kanban columns (INBOX, QUEUED, IN PROGRESS, IN REVIEW, DONE, ARCHIVED) at /missions"
    - "User can drag a card from one column to another and the UI updates optimistically"
    - "User can reorder cards within a column by dragging"
    - "Cards show priority border stripe, title, assigned agent avatars, due date, and tag chips"
    - "Cards with an actively-working agent show a pulsing glow (box-shadow based)"
  artifacts:
    - path: "src/entities/mission/model/types.ts"
      provides: "Task, Board, BoardColumn, Deliverable, TaskComment, ActivityEntry type definitions"
    - path: "src/features/missions/model/board-store.ts"
      provides: "Zustand board store with moveCard, reorderInColumn, autoTransition actions using immer"
    - path: "src/features/missions/components/kanban-board.tsx"
      provides: "DndContext + multi-SortableContext Kanban board with DragOverlay"
    - path: "src/features/missions/components/kanban-card.tsx"
      provides: "Draggable task card with priority stripe, agent avatars, glow effect"
    - path: "app/(dashboard)/missions/page.tsx"
      provides: "Next.js route page for /missions"
  key_links:
    - from: "src/features/missions/components/kanban-board.tsx"
      to: "src/features/missions/model/board-store.ts"
      via: "useBoardStore selectors and getState() in drag handlers"
      pattern: "useBoardStore"
    - from: "src/features/missions/lib/mission-subscriptions.ts"
      to: "src/features/missions/model/board-store.ts"
      via: "EventBus subscriptions calling autoTransition on task events"
      pattern: "eventBus\\.on.*autoTransition"
    - from: "src/features/missions/components/kanban-card.tsx"
      to: "src/entities/mission/lib/priority-utils.ts"
      via: "PRIORITY_BORDER color mapping for left border stripe"
      pattern: "PRIORITY_BORDER"
---

<objective>
Install dnd-kit dependencies and build the core Kanban board at /missions with drag-and-drop card movement across 6 semantic columns. Establish the mission entity types, Zustand stores with immer middleware, EventBus subscriptions for real-time agent updates, and the full drag-and-drop board UI.

Purpose: This plan creates the foundational data layer and interactive board that all subsequent mission plans build upon. The Kanban board is the centerpiece of Phase 6.
Output: Working drag-and-drop Kanban board at /missions with mock task data, mission entity types, board/task Zustand stores, and EventBus subscription wiring.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mission-board/06-RESEARCH.md
@.planning/phases/06-mission-board/06-CONTEXT.md
@src/entities/agent/model/types.ts
@src/entities/agent/lib/agent-utils.ts
@src/features/agents/model/agent-store.ts
@src/features/gateway-connection/lib/event-bus.ts
@src/shared/lib/query-keys.ts
@src/shared/ui/avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit + immer, create mission entity types, Zustand stores, EventBus subscriptions, and query keys</name>
  <files>
    package.json
    src/entities/mission/model/types.ts
    src/entities/mission/model/schemas.ts
    src/entities/mission/lib/priority-utils.ts
    src/entities/mission/lib/column-utils.ts
    src/entities/mission/index.ts
    src/features/missions/model/board-store.ts
    src/features/missions/model/task-store.ts
    src/features/missions/model/hooks.ts
    src/features/missions/api/use-boards.ts
    src/features/missions/api/use-board-tasks.ts
    src/features/missions/lib/mission-subscriptions.ts
    src/features/missions/lib/drag-utils.ts
    src/features/missions/index.ts
    src/shared/lib/query-keys.ts
    src/features/gateway-connection/lib/event-bus.ts
  </files>
  <action>
    **1. Install dependencies:**
    ```bash
    bun add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities @dnd-kit/modifiers immer
    ```

    **2. Create mission entity types** at `src/entities/mission/model/types.ts`:
    - `TaskPriority = 'critical' | 'high' | 'medium' | 'low'`
    - `TaskStatus = 'inbox' | 'queued' | 'in_progress' | 'in_review' | 'done' | 'archived'`
    - `Task` interface with: id, boardId, title, description (markdown), priority, status, assignedAgentIds (string[]), reviewerId (string | undefined), tags (string[]), subtasks (Subtask[]), deliverables (Deliverable[]), signOffRequired (boolean), signOffStatus ('pending' | 'approved' | 'rejected' | 'revision_requested' | undefined), parentTaskId (string | undefined), dueDate (Date | undefined), createdAt, updatedAt, columnOrder (number)
    - `Subtask` interface: id, title, completed
    - `Deliverable` interface: id, type ('file' | 'code' | 'link'), title, url, thumbnailUrl (string | undefined), mimeType (string | undefined), submittedAt, submittedBy
    - `TaskComment` interface: id, taskId, authorId, authorType ('user' | 'agent'), content, mentions (Mention[]), createdAt
    - `Mention` interface: type ('agent' | 'human'), id, name
    - `Board` interface: id, name, orgId, columns (BoardColumn[]), createdAt
    - `BoardColumn` interface: id, name, semanticRole (TaskStatus | null), order (number), isHumanOnly (boolean)
    - `ActivityEntry` interface: id, taskId, type ('status_change' | 'comment' | 'deliverable' | 'assignment' | 'agent_detail'), summary, timestamp, actorId, actorType ('user' | 'agent' | 'system'), details (unknown | undefined), agentDetails (AgentActivityDetail[] | undefined)
    - `AgentActivityDetail` interface: type ('tool_call' | 'reasoning' | 'output'), content, timestamp
    - Use `| undefined` for all optional props (exactOptionalPropertyTypes pattern)

    **3. Create Zod v4 schemas** at `src/entities/mission/model/schemas.ts`:
    - Import from `zod/v4`
    - `taskPrioritySchema`, `taskStatusSchema` as z.enum
    - `createTaskSchema` with title (min 1, max 200), description (default ''), priority (default 'medium'), assignedAgentIds (array, default []), reviewerId (optional), tags (array, default []), signOffRequired (default false), dueDate (optional), boardId (min 1)
    - `updateTaskSchema` extending createTaskSchema partial
    - `createBoardSchema` with name (min 1, max 100), orgId
    - `boardColumnSchema` with name, semanticRole (nullable), isHumanOnly (default false)
    - Export `CreateTaskValues`, `UpdateTaskValues`, `CreateBoardValues` inferred types

    **4. Create priority utils** at `src/entities/mission/lib/priority-utils.ts`:
    - `PRIORITY_BORDER: Record<TaskPriority, string>` mapping: critical -> 'border-l-4 border-l-red-500', high -> 'border-l-4 border-l-orange-500', medium -> 'border-l-4 border-l-blue-500', low -> 'border-l-4 border-l-gray-400'
    - `PRIORITY_BADGE: Record<TaskPriority, string>` mapping priority to badge label/color strings
    - `prioritySortOrder: Record<TaskPriority, number>` = { critical: 0, high: 1, medium: 2, low: 3 }
    - `sortByPriority(a: Task, b: Task): number` comparator function
    - `getTaskGlowClasses(isAgentWorking: boolean): string` returning '' or 'shadow-[0_0_8px_-1px] shadow-blue-500/50 border-blue-500/30 animate-pulse' (matches Phase 3 box-shadow glow pattern)

    **5. Create column utils** at `src/entities/mission/lib/column-utils.ts`:
    - `CORE_COLUMNS: BoardColumn[]` defining the 6 default columns with semanticRole mapping: INBOX=inbox, QUEUED=queued, IN PROGRESS=in_progress, IN REVIEW=in_review, DONE=done, ARCHIVED=archived
    - `getColumnBySemanticRole(columns: BoardColumn[], role: TaskStatus): BoardColumn | undefined`
    - `isHumanOnlyColumn(column: BoardColumn): boolean`
    - `COLUMN_DISPLAY: Record<TaskStatus, { label: string; icon: string }>` with display names and lucide icon names

    **6. Create barrel export** at `src/entities/mission/index.ts`

    **7. Create board store** at `src/features/missions/model/board-store.ts`:
    - Use `zustand` with `immer` middleware: `create<BoardStore>()(immer((set, get) => ({...})))`
    - State: boards (Board[]), activeBoardId (string | null), columns (BoardColumn[]), tasksByColumn (Record<string, string[]> mapping columnId -> taskId[]), isDragging (boolean), activeTaskId (string | null), pendingTransitions (Array<{ taskId: string; targetColumn: string }>)
    - Actions:
      - `setBoards(boards: Board[])` -- set boards array, default activate first
      - `setActiveBoard(boardId: string)` -- switch active board, load its columns
      - `setColumns(columns: BoardColumn[])` -- set columns for active board
      - `setTaskOrder(columnId: string, taskIds: string[])` -- set task ordering for a column
      - `moveCard(taskId: string, fromColumnId: string, toColumnId: string, newIndex: number)` -- remove from source, insert at position in target
      - `reorderInColumn(columnId: string, oldIndex: number, newIndex: number)` -- reorder within single column using arrayMove logic
      - `setDragging(isDragging: boolean, activeTaskId: string | null)` -- track drag state
      - `autoTransition(taskId: string, targetColumnSemanticRole: TaskStatus)` -- if isDragging and activeTaskId matches, queue to pendingTransitions; otherwise find column by semantic role and move task to top
      - `flushPendingTransitions()` -- apply all pending transitions (called after drag ends)
    - **Important:** Read from `get()` (not closed-over state) in moveCard/reorderInColumn to avoid stale closures during rapid drag events

    **8. Create task store** at `src/features/missions/model/task-store.ts`:
    - Zustand store with immer
    - State: tasks (Map<string, Task>), selectedTaskId (string | null)
    - Actions:
      - `setTasks(tasks: Task[])` -- populate Map from array
      - `addTask(task: Task)` -- add single task
      - `updateTask(taskId: string, updates: Partial<Task>)` -- merge updates
      - `removeTask(taskId: string)` -- delete from Map
      - `setSelectedTask(taskId: string | null)` -- for slide-over/detail
      - `addDeliverable(taskId: string, deliverable: Deliverable)` -- push to task's deliverables array
      - `addActivityEntry(taskId: string, entry: ActivityEntry)` -- for timeline (stored per-task as needed)

    **9. Create hooks** at `src/features/missions/model/hooks.ts`:
    - `useActiveBoard()` -- selector for active board from board store
    - `useColumns()` -- selector for columns
    - `useTasksForColumn(columnId: string)` -- returns Task[] from task store for given column's taskIds
    - `useTask(taskId: string)` -- single task selector from task store
    - `useSelectedTask()` -- selected task for slide-over

    **10. Create TanStack Query hooks** at `src/features/missions/api/use-boards.ts` and `use-board-tasks.ts`:
    - `useBoards()` -- fetches board list with mock data (one "General" board), syncs to board store. staleTime: Infinity (matching project pattern)
    - `useBoardTasks(boardId: string)` -- fetches tasks for active board with mock data (8-10 tasks across columns with varied priorities, some with assigned agents), syncs to task store and board store tasksByColumn. staleTime: Infinity

    Mock data for useBoardTasks: create 8-10 realistic tasks distributed across columns:
    - 2 in INBOX (new tasks)
    - 1 in QUEUED
    - 2 in IN PROGRESS (one with agent working)
    - 1 in IN REVIEW
    - 2 in DONE
    - 1 in ARCHIVED
    Include varied priorities (1 critical, 2 high, 3 medium, 2 low), some with assignedAgentIds, some with tags, some with subtasks. Use nanoid for IDs.

    **11. Create EventBus subscriptions** at `src/features/missions/lib/mission-subscriptions.ts`:
    - `initMissionStoreSubscriptions(eventBus: EventBus): () => void`
    - Subscribe to 'task.agent.started' -> autoTransition to 'in_progress'
    - Subscribe to 'task.deliverable.submitted' -> addDeliverable + autoTransition to 'in_review'
    - Subscribe to 'task.status.updated' -> addActivityEntry
    - Subscribe to 'task.comment.added' -> (placeholder for future comment handling)
    - Return cleanup function that calls all unsubs

    **12. Add mission events to KnownEvents** in `src/features/gateway-connection/lib/event-bus.ts`:
    - Add these typed events:
      - `'task.agent.started': { taskId: string; agentId: string }`
      - `'task.agent.progress': { taskId: string; agentId: string; summary: string }`
      - `'task.deliverable.submitted': { taskId: string; agentId: string; deliverable: { id: string; type: string; title: string; url: string } }`
      - `'task.status.updated': { taskId: string; agentId: string; status: string }`
      - `'task.comment.added': { taskId: string; authorId: string; authorType: 'agent' | 'user'; content: string }`

    **13. Extend query keys** in `src/shared/lib/query-keys.ts`:
    - Add `boards` domain: all, lists(), detail(id), settings(id)
    - Add `tasks` domain: all, byBoard(boardId), detail(taskId), comments(taskId), activity(taskId)

    **14. Create drag-utils** at `src/features/missions/lib/drag-utils.ts`:
    - `findColumnOfTask(tasksByColumn: Record<string, string[]>, taskId: string): string | null`
    - `getTaskIndex(tasksByColumn: Record<string, string[]>, columnId: string, taskId: string): number`

    **15. Create barrel export** at `src/features/missions/index.ts` -- export stores, hooks, types, subscriptions
  </action>
  <verify>
    Run `bun run build` -- must pass with zero errors. Verify @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities, @dnd-kit/modifiers, and immer appear in package.json dependencies. Verify entity and feature barrel exports resolve correctly.
  </verify>
  <done>
    Mission entity types fully defined with 11 interfaces. Board store with immer supports moveCard, reorderInColumn, autoTransition with pending transition queue. Task store holds Map of tasks. EventBus extended with 5 task event types. Query keys extended with boards and tasks domains. Mock data provides realistic board state. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Kanban board UI with drag-and-drop, card components, and /missions route page</name>
  <files>
    src/features/missions/components/kanban-board.tsx
    src/features/missions/components/kanban-column.tsx
    src/features/missions/components/kanban-card.tsx
    src/features/missions/components/kanban-overlay.tsx
    src/views/missions/missions-board-view.tsx
    app/(dashboard)/missions/page.tsx
  </files>
  <action>
    **1. Create KanbanCard** at `src/features/missions/components/kanban-card.tsx`:
    - "use client" directive
    - Uses `useSortable` from @dnd-kit/sortable and `CSS` from @dnd-kit/utilities for transform styles
    - Props: task (Task), isOverlay (boolean, default false -- for DragOverlay clone)
    - Renders shadcn Card with:
      - Priority left border stripe via `PRIORITY_BORDER[task.priority]` (border-l-4)
      - Pulsing glow via `getTaskGlowClasses(isAgentWorking)` where isAgentWorking is derived from agent store (check if any assignedAgentIds has status 'working')
      - `cursor-grab active:cursor-grabbing` classes
      - Title text (truncated, font-medium)
      - Priority badge using Badge component with variant outline
      - Assigned agents as stacked AvatarGroup (up to 3, then AvatarGroupCount) using existing Avatar components
      - Due date display (formatted with date-fns formatDistanceToNow or format) if present
      - Tags as small Badge components (max 3 shown, then +N)
      - Subtask progress indicator if subtasks exist (e.g., "2/5" with small progress bar)
    - Wrap with React.memo for performance (Pitfall 6)
    - When not isOverlay, apply useSortable: ref, attributes, listeners, transform, transition, isDragging (reduce opacity when dragging)

    **2. Create KanbanColumn** at `src/features/missions/components/kanban-column.tsx`:
    - "use client" directive
    - Uses `useDroppable` from @dnd-kit/core for empty column drop target (Pitfall 3)
    - Uses `SortableContext` with `verticalListSortingStrategy`
    - Props: column (BoardColumn), taskIds (string[])
    - Layout: flex flex-col, fixed width (w-72 or w-80), max-h with overflow-y-auto for scrolling
    - Column header: column name, task count badge
    - If taskIds empty, show droppable placeholder zone: "No tasks" text with dashed border, min-h-24, using useDroppable with column.id as droppable ID
    - Render KanbanCard for each taskId (get task from task store via useTask hook)
    - Gap between cards: gap-2 or space-y-2

    **3. Create KanbanOverlay** at `src/features/missions/components/kanban-overlay.tsx`:
    - "use client" directive
    - Renders inside DragOverlay portal
    - Props: taskId (string | null)
    - If taskId, get task from useTaskStore.getState() and render KanbanCard with isOverlay=true
    - Slight rotation and scale for visual feedback: className with rotate-2 scale-105 shadow-lg

    **4. Create KanbanBoard** at `src/features/missions/components/kanban-board.tsx`:
    - "use client" directive
    - The main board component using DndContext from @dnd-kit/core
    - Sensors: PointerSensor with `activationConstraint: { distance: 5 }` (prevent accidental drags on click), KeyboardSensor
    - Collision detection: closestCorners
    - State: activeId (string | null) for tracking dragged card
    - **onDragStart:** set activeId, call boardStore.setDragging(true, activeId)
    - **onDragOver:** When active item enters a different container (column), use `useBoardStore.getState()` (not hook selector -- Pitfall 2) to move card between columns via moveCard. Find source column via findColumnOfTask(), determine target column from over.id (could be a column ID or a task ID within a column). Handle both cases.
    - **onDragEnd:** Finalize position. Call boardStore.setDragging(false, null). Call boardStore.flushPendingTransitions(). If target column has semantic role (not null), check for semantic drag actions:
      - If moved to 'in_progress' column -> log "dispatching task to agent" (console.log placeholder for gateway RPC)
      - If moved to 'archived' column -> log "archiving task" (cleanup placeholder)
    - **onDragCancel:** Reset activeId, setDragging(false, null)
    - Layout: flex flex-row with gap-4, overflow-x-auto for horizontal scrolling, p-4
    - Render KanbanColumn for each column from boardStore
    - Render DragOverlay with KanbanOverlay
    - Use `restrictToWindowEdges` modifier from @dnd-kit/modifiers

    **5. Create MissionsBoardView** at `src/views/missions/missions-board-view.tsx`:
    - "use client" directive
    - Uses PageHeader with title "Missions", description "Manage and track agent tasks"
    - Renders useBoards() and useBoardTasks() hooks to load data
    - Renders KanbanBoard component
    - Shows SkeletonCard loading state while data loads
    - Actions in PageHeader: "New Task" button (placeholder, will connect in 06-02)

    **6. Create route page** at `app/(dashboard)/missions/page.tsx`:
    - Server component that imports MissionsBoardView
    - Wraps in Suspense boundary (matching project pattern from agents/page.tsx)
    - Metadata: title "Missions | AXion Hub"
  </action>
  <verify>
    Run `bun run build` -- must pass with zero errors. Verify /missions route is registered. Navigate to /missions in browser to see 6 columns with mock task cards rendered, drag a card between columns (optimistic update), and verify card styling (priority stripe, avatars, badges).
  </verify>
  <done>
    Kanban board at /missions renders 6 columns with mock task cards. Cards display priority border stripe, title, assigned agent avatars, due date, tag chips, and subtask progress. Dragging cards between columns works with optimistic UI update. Empty columns accept drops. DragOverlay shows a rotated/scaled card preview. Active agent working glow pulses on relevant cards. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes with zero TypeScript errors
2. /missions route renders 6 Kanban columns with mock task cards
3. Dragging a card between columns updates the UI optimistically
4. Cards show priority left border stripe (red/orange/blue/gray)
5. Cards with working agents show pulsing glow (box-shadow based)
6. Empty columns display droppable placeholder
7. DragOverlay shows card preview during drag
8. Entity types, stores, and barrel exports are importable
</verification>

<success_criteria>
- Working drag-and-drop Kanban board at /missions with 6 semantic columns
- 8-10 mock tasks distributed across columns with varied priorities and assignments
- Cards styled per CONTEXT.md decisions: priority stripe, stacked avatars, tag chips, glow
- Board store handles moveCard, reorderInColumn, and autoTransition with pending queue
- EventBus extended with task events and subscription initializer ready
- All types, stores, and hooks exported and importable for subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/06-mission-board/06-01-SUMMARY.md`
</output>
