---
phase: 05-dashboard-monitoring
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/features/dashboard/components/gateway-status-widget.tsx
  - src/features/dashboard/components/agent-count-widget.tsx
  - src/features/dashboard/components/task-summary-widget.tsx
  - src/features/dashboard/components/context-usage-widget.tsx
  - src/features/dashboard/components/cost-summary-widget.tsx
  - src/features/dashboard/components/degraded-mode-banner.tsx
  - src/features/dashboard/api/use-dashboard-stats.ts
  - src/features/dashboard/api/use-cost-summary.ts
  - src/views/dashboard/dashboard-view.tsx
  - app/(dashboard)/page.tsx
autonomous: true
requirements: [DASH-01, DASH-02, DASH-03, DASH-04, DASH-05]

must_haves:
  truths:
    - "User sees gateway connection status (connected/disconnected/degraded) on the dashboard"
    - "User sees active agent count with health badges grouped by status"
    - "User sees tasks in flight grouped by status"
    - "User sees context window usage as color-shifting horizontal bars per agent"
    - "User sees token cost summary with time toggle, per-agent stacked bar chart, AND a compact sortable table"
    - "Agent status badges pulse briefly when their count changes"
    - "Gateway disconnect shows persistent degraded-mode banner with stale data indicators"
  artifacts:
    - path: "src/features/dashboard/components/gateway-status-widget.tsx"
      provides: "Gateway connection status indicator widget"
    - path: "src/features/dashboard/components/agent-count-widget.tsx"
      provides: "Agent count by status with animated numbers and health badges"
    - path: "src/features/dashboard/components/task-summary-widget.tsx"
      provides: "Task count by status with animated numbers"
    - path: "src/features/dashboard/components/context-usage-widget.tsx"
      provides: "Per-agent context window progress bars"
    - path: "src/features/dashboard/components/cost-summary-widget.tsx"
      provides: "Cost summary with time toggle, stacked bar chart, and sortable table"
    - path: "src/features/dashboard/components/degraded-mode-banner.tsx"
      provides: "Persistent disconnected banner"
    - path: "src/views/dashboard/dashboard-view.tsx"
      provides: "Dashboard page composition with bento grid"
    - path: "app/(dashboard)/page.tsx"
      provides: "Next.js route rendering DashboardView"
  key_links:
    - from: "src/features/dashboard/components/agent-count-widget.tsx"
      to: "src/features/dashboard/model/dashboard-store.ts"
      via: "useDashboardStore selector"
      pattern: "useDashboardStore"
    - from: "src/features/dashboard/components/cost-summary-widget.tsx"
      to: "src/features/dashboard/model/dashboard-store.ts"
      via: "useDashboardStore selector for costByPeriod and perAgentCosts"
      pattern: "useDashboardStore"
    - from: "src/features/dashboard/components/cost-summary-widget.tsx"
      to: "src/shared/ui/data-table.tsx"
      via: "DataTable with sortable TanStack Table columns for per-agent costs"
      pattern: "DataTable"
    - from: "src/views/dashboard/dashboard-view.tsx"
      to: "src/widgets/dashboard-grid/components/bento-grid.tsx"
      via: "BentoGrid layout composition"
      pattern: "BentoGrid"
---

<objective>
Build all dashboard stat widgets (gateway status, agent counts, task summary, context usage, cost summary) with animated number transitions, a degraded-mode banner, and compose them into the bento grid dashboard page at /dashboard.

Purpose: Deliver the visual command center (DASH-01 through DASH-05) where users see at-a-glance health of their agent ecosystem with real-time animated counters and cost tracking.

Output: Six widget components, two TanStack Query hooks, DashboardView composition, and updated /dashboard route page.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-monitoring/05-RESEARCH.md
@.planning/phases/05-dashboard-monitoring/05-01-SUMMARY.md
@src/features/gateway-connection/index.ts
@src/entities/agent/model/types.ts
@src/shared/ui/chart.tsx
@src/shared/ui/progress.tsx
@src/shared/ui/status-badge.tsx
@src/shared/ui/card.tsx
@src/shared/ui/tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build stat widgets with animated numbers, cost charts, and degraded-mode banner</name>
  <files>
    src/features/dashboard/components/gateway-status-widget.tsx
    src/features/dashboard/components/agent-count-widget.tsx
    src/features/dashboard/components/task-summary-widget.tsx
    src/features/dashboard/components/context-usage-widget.tsx
    src/features/dashboard/components/cost-summary-widget.tsx
    src/features/dashboard/components/degraded-mode-banner.tsx
    src/features/dashboard/api/use-dashboard-stats.ts
    src/features/dashboard/api/use-cost-summary.ts
  </files>
  <action>
    All widget components are "use client" components.

    1. Create `gateway-status-widget.tsx`:
       - Import `useIsConnected`, `useConnectionState`, `useConnectionError` from `@/features/gateway-connection`
       - Import `StatusBadge` from `@/shared/ui/status-badge`
       - Display current connection state as a StatusBadge (connected/disconnected/degraded)
       - Show connection mode (local/remote) and latency if available
       - Small card widget (1x1 in bento grid)
       - Use Wifi/WifiOff lucide icons

    2. Create `agent-count-widget.tsx`:
       - Import `useDashboardStore` from the dashboard feature
       - Import `NumberFlow` from `@number-flow/react` for animated transitions
       - Per locked decision: "Dashboard stat widgets use subtle number transitions -- counters smoothly animate between values, status badges pulse briefly on change"
       - Show total agent count as large animated NumberFlow
       - Below: breakdown by status (online, idle, working, error, offline) with StatusBadge for each and animated NumberFlow count
       - Per locked decision: "status badges pulse briefly on change" — implement a brief CSS pulse animation on StatusBadge wrappers when their count changes:
         - Use a `useRef` to track previous `agentCounts` values
         - In a `useEffect`, compare current counts to previous; for any status whose count changed, add a `animate-pulse` class to that StatusBadge's wrapper `<div>`
         - Remove the animation after 600ms via `setTimeout` (toggle a `pulsingStatuses` state Set)
         - Wrapper pattern: `<div className={cn("transition-all", pulsingStatuses.has(status) && "animate-pulse")}>`
       - Read agent counts from `useDashboardStore(s => s.agentCounts)` and `useDashboardStore(s => s.totalAgents)`
       - Read isStale from `useDashboardStore(s => s.isStale)` and pass to BentoGridItem

    3. Create `task-summary-widget.tsx`:
       - Import `useDashboardStore` from dashboard feature
       - Import `NumberFlow` from `@number-flow/react`
       - Show task counts grouped by status: inbox, assigned, in-progress, review, done
       - Use animated NumberFlow for each count
       - Read from `useDashboardStore(s => s.taskSummary)`
       - Show a note or subtle indicator that this is mock data until Phase 6 (use a small "Preview" badge)

    4. Create `context-usage-widget.tsx`:
       - Per locked decision: "Context window usage displayed as horizontal progress bars per agent -- color shifts green -> yellow -> red as context fills"
       - Import `Progress` from `@/shared/ui/progress`
       - Read agents from `useAgentStore(s => s.agents)` -- filter to active agents only (not offline)
       - For each agent, render a row: agent name (truncated) | Progress bar | percentage text
       - Dynamic color class based on usage threshold: green < 60%, yellow 60-80%, red > 80%
       - Use `[&_[data-slot=progress-indicator]]:bg-green-500` pattern for Radix Progress color override
       - Sort by contextUsage descending (most full at top)

    5. Create `cost-summary-widget.tsx`:
       - Per locked decision: "Token costs shown as both aggregate summary (with time toggle: session/today/week) and per-agent breakdown"
       - Per locked decision: "Cost format shows tokens and estimated dollar cost with equal visual weight (side by side)"
       - Per locked decision: "Per-agent cost breakdown shows both a stacked bar chart (input vs output tokens) and a compact sortable table"
       - Import `Tabs`, `TabsList`, `TabsTrigger`, `TabsContent` from `@/shared/ui/tabs`
       - Import `NumberFlow` from `@number-flow/react`
       - Import Recharts: `BarChart, Bar, XAxis, YAxis, Legend` + `ChartContainer, ChartTooltip, ChartTooltipContent` from `@/shared/ui/chart`
       - Time toggle via Tabs: session | today | week
       - Top section: two large numbers side-by-side -- total tokens (formatted with formatTokenCount) and total cost (formatDollarCost), both using NumberFlow
       - Middle section: stacked BarChart (input vs output tokens per agent) using ChartContainer with `min-h-[200px]`
       - Bottom section: compact sortable table for per-agent cost breakdown:
         - Import `DataTable` from `@/shared/ui/data-table` (existing TanStack Table wrapper)
         - Define TanStack Table columns: agent (string), model (string), inputTokens (number, formatted with formatTokenCount), outputTokens (number, formatted with formatTokenCount), cost (number, formatted with formatDollarCost)
         - All columns sortable via column header click (DataTable supports this out of the box with getSortedRowModel)
         - Data source: `useDashboardStore(s => s.perAgentCosts)` (AgentCostData[])
         - Compact sizing: use `className="text-xs"` on table rows, no pagination needed (agent count is small)
         - Per locked decision: "Per-agent cost breakdown: stacked bar chart AND compact sortable table"
       - Use mock data for costs (similar pattern to agent mock data) until gateway wires up
       - Import cost formatter functions from `@/features/dashboard`

    6. Create `degraded-mode-banner.tsx`:
       - Per locked decision: "Gateway disconnect triggers a persistent degraded-mode banner ('Gateway disconnected — showing last known state') with stale data indicators on affected widgets, not an overlay"
       - Import `useIsConnected`, `useConnectionError` from `@/features/gateway-connection`
       - If not connected, render a full-width banner with AlertTriangle icon, yellow/amber styling
       - Text: "Gateway disconnected — showing last known state"
       - If error message available, show in muted text
       - If connected, return null (render nothing)

    7. Create `use-dashboard-stats.ts`:
       - TanStack Query hook for initial dashboard data load
       - Uses `queryKeys.dashboard.stats()` key
       - Mock fetch function returning agent counts and task summary (derive from mock agents in use-agents.ts pattern)
       - staleTime: Infinity (consistent with project pattern)
       - On success, sync data into `useDashboardStore` via useEffect

    8. Create `use-cost-summary.ts`:
       - TanStack Query hook accepting a `period: TimePeriod` parameter
       - Uses `queryKeys.dashboard.costs(period)` key
       - Mock fetch function returning CostSummary + AgentCostData[] for the period
       - staleTime: Infinity
       - On success, sync into `useDashboardStore.getState().updateCosts()`
  </action>
  <verify>
    Run `bun run build` -- zero TypeScript errors. Verify all 8 files exist. Verify NumberFlow import resolves. Verify Recharts chart renders (ChartContainer used with min-h).
  </verify>
  <done>
    Six stat widgets render with animated NumberFlow counters, Recharts cost charts, color-shifting context gauges, and degraded-mode banner. Two TanStack Query hooks provide initial data loading with Zustand sync. All widgets read from Zustand stores with granular selectors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compose DashboardView with bento grid and wire /dashboard route</name>
  <files>
    src/views/dashboard/dashboard-view.tsx
    app/(dashboard)/page.tsx
  </files>
  <action>
    1. Create `src/views/dashboard/dashboard-view.tsx`:
       - "use client" component
       - Import `BentoGrid`, `BentoGridItem` from `@/widgets/dashboard-grid/components/bento-grid`
       - Import all 6 widget components from `@/features/dashboard/components/`
       - Import `DegradedModeBanner` from the same
       - Import `useDashboardStats` and `useCostSummary` hooks
       - Import `useDashboardStore` for isStale
       - Import `PageHeader` from `@/shared/ui/page-header`

       Layout composition in the BentoGrid:
       - Gateway status widget: `col-span-1` (small card, top-left)
       - Agent count widget: `col-span-1 md:col-span-1` (small card)
       - Task summary widget: `col-span-1 md:col-span-2` (medium card)
       - Context usage widget: `col-span-1 md:col-span-2 lg:col-span-2 row-span-2` (tall card for progress bars)
       - Cost summary widget: `col-span-1 md:col-span-2 lg:col-span-2 row-span-2` (tall card for charts)
       - Leave a `col-span-1 md:col-span-2 lg:col-span-2 row-span-3` slot for the activity feed (Plan 05-03)
       - Quick actions slot placeholder (Plan 05-03)

       Note: The activity feed and quick actions are NOT implemented here -- they come in Plan 05-03. Use a placeholder BentoGridItem with EmptyState or a subtle "Coming soon" message for the activity feed slot so the grid layout is correct.

       Above the grid: render `<DegradedModeBanner />` (renders nothing when connected)
       Above the banner: `<PageHeader title="Dashboard" description="Command center overview" />`

       Call `useDashboardStats()` and `useCostSummary('session')` at the top to trigger initial data loading.

    2. Replace `app/(dashboard)/page.tsx`:
       - Remove the placeholder welcome screen
       - Import and render `DashboardView` from `@/views/dashboard/dashboard-view`
       - Wrap in Suspense with a loading skeleton fallback
       - Update metadata: title "Dashboard | AXion Hub"
  </action>
  <verify>
    Run `bun run build` -- zero errors. Visit /dashboard (or verify build output includes the route). Confirm DashboardView imports all widgets. Confirm the placeholder activity feed slot exists in the grid.
  </verify>
  <done>
    /dashboard renders a bento grid with gateway status, agent counts, task summary, context usage gauges, and cost summary widgets. Degraded-mode banner appears above the grid when gateway is disconnected. Activity feed slot is reserved for Plan 05-03. The command center is visible and functional with mock data.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes with zero errors
2. /dashboard route renders DashboardView with bento grid
3. All 6 stat widgets exist and render data from Zustand stores
4. NumberFlow animated counters work (import resolves)
5. Cost widget has Recharts stacked bar chart with ChartContainer
6. Context usage shows color-shifting progress bars
7. DegradedModeBanner renders when gateway is disconnected
8. Activity feed slot is reserved with a placeholder in the grid
</verification>

<success_criteria>
- Gateway status widget shows connection state with StatusBadge
- Agent count widget shows animated counters by status
- Task summary widget shows mock task counts by status
- Context usage widget shows per-agent horizontal bars with green/yellow/red color shifting
- Cost summary widget has time toggle (session/today/week), side-by-side token+dollar display, stacked bar chart
- Degraded-mode banner renders "Gateway disconnected — showing last known state" when disconnected
- Dashboard bento grid is responsive: 4 cols on lg, 2 on md, 1 on mobile
- `bun run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-monitoring/05-02-SUMMARY.md`
</output>
