---
phase: 05-dashboard-monitoring
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/features/dashboard/components/activity-split-view.tsx
  - src/features/dashboard/components/activity-event-detail.tsx
  - src/features/dashboard/api/use-activity-history.ts
  - src/views/dashboard/activity-view.tsx
  - src/views/dashboard/activity-history-view.tsx
  - src/features/dashboard/components/dependency-map.tsx
  - src/features/dashboard/components/dependency-node.tsx
  - src/features/dashboard/components/node-detail-panel.tsx
  - src/features/dashboard/lib/dagre-layout.ts
  - src/features/dashboard/api/use-service-health.ts
  - src/views/dashboard/monitor-view.tsx
  - app/(dashboard)/activity/page.tsx
  - app/(dashboard)/activity/history/page.tsx
  - app/(dashboard)/monitor/page.tsx
autonomous: true
requirements: [MNTR-01, MNTR-02, MNTR-03]

must_haves:
  truths:
    - "User can view a real-time event stream at /activity in a split view"
    - "User can search and filter activity history at /activity/history"
    - "User can view a system health dependency map at /monitor with color-coded nodes"
    - "Clicking a node in the dependency map shows detail metrics and recent events"
  artifacts:
    - path: "src/features/dashboard/components/activity-split-view.tsx"
      provides: "Split view with filterable event list and detail panel"
    - path: "src/views/dashboard/activity-view.tsx"
      provides: "/activity page composition"
    - path: "src/views/dashboard/activity-history-view.tsx"
      provides: "/activity/history page composition"
    - path: "src/features/dashboard/components/dependency-map.tsx"
      provides: "React Flow dependency map with custom health nodes"
    - path: "src/features/dashboard/components/dependency-node.tsx"
      provides: "Custom React Flow node component"
    - path: "src/views/dashboard/monitor-view.tsx"
      provides: "/monitor page composition"
    - path: "app/(dashboard)/activity/page.tsx"
      provides: "Next.js route for /activity"
    - path: "app/(dashboard)/activity/history/page.tsx"
      provides: "Next.js route for /activity/history"
    - path: "app/(dashboard)/monitor/page.tsx"
      provides: "Next.js route for /monitor"
  key_links:
    - from: "src/features/dashboard/components/activity-split-view.tsx"
      to: "src/features/dashboard/model/activity-store.ts"
      via: "useActivityStore for real-time events"
      pattern: "useActivityStore"
    - from: "src/features/dashboard/components/dependency-map.tsx"
      to: "@xyflow/react"
      via: "ReactFlow component rendering"
      pattern: "ReactFlow"
    - from: "src/features/dashboard/lib/dagre-layout.ts"
      to: "@dagrejs/dagre"
      via: "Dagre graph layout algorithm"
      pattern: "dagre"
---

<objective>
Build the /activity page (real-time split view), /activity/history page (searchable history), and /monitor page (interactive dependency map with health visualization).

Purpose: Deliver MNTR-01 (real-time event stream), MNTR-02 (activity history search/filter), and MNTR-03 (system health dependency map). These three pages give users deep visibility into what's happening across their agent ecosystem.

Output: Activity split view, activity history with data table, dependency map with custom nodes, three route pages.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-monitoring/05-RESEARCH.md
@.planning/phases/05-dashboard-monitoring/05-01-SUMMARY.md
@src/features/dashboard/model/activity-store.ts
@src/features/dashboard/components/activity-event-card.tsx
@src/entities/dashboard-event/model/types.ts
@src/shared/ui/data-table.tsx
@src/shared/ui/search-input.tsx
@src/shared/ui/filter-bar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build /activity split view and /activity/history pages</name>
  <files>
    src/features/dashboard/components/activity-split-view.tsx
    src/features/dashboard/components/activity-event-detail.tsx
    src/features/dashboard/api/use-activity-history.ts
    src/views/dashboard/activity-view.tsx
    src/views/dashboard/activity-history-view.tsx
    app/(dashboard)/activity/page.tsx
    app/(dashboard)/activity/history/page.tsx
  </files>
  <action>
    1. Create `src/features/dashboard/components/activity-event-detail.tsx`:
       - "use client" component
       - Props: `event: DashboardEvent | null`
       - When event is null, show an EmptyState "Select an event to view details"
       - When event is provided, show: event type, full timestamp (date-fns format), source, agentId (if present), severity badge, summary, and details (rendered as JSON in a code block using `<pre>` with monospace font)
       - Use Card with CardHeader + CardContent layout

    2. Create `src/features/dashboard/components/activity-split-view.tsx`:
       - Per locked decision: "/activity page uses a split view: left panel = filterable event list, right panel = event detail on selection (like a log viewer)"
       - "use client" component
       - Import `useActivityStore` from `@/features/dashboard` for real-time events (use `fullEvents` -- larger buffer)
       - Import `ActivityEventCard` from `./activity-event-card`
       - Import `ActivityEventDetail` from `./activity-event-detail`
       - Import `SearchInput` from `@/shared/ui/search-input`
       - Import `FilterBar` from `@/shared/ui/filter-bar`
       - Import `ScrollArea` from `@/shared/ui/scroll-area`

       Left panel (60% width):
       - Top: SearchInput for text search + FilterBar with filters: event type (multi-select), severity (multi-select), source (multi-select)
       - Use nuqs `useQueryState` for filter URL persistence (same pattern as Phase 3 agent search)
       - Below: ScrollArea with event list, each item is an ActivityEventCard
       - Clicking an event sets it as the selected event
       - Selected event gets a highlighted bg (bg-accent)
       - Use the `useAutoScroll` hook from plan 05-03 for the event list scroll area

       Right panel (40% width):
       - Render `<ActivityEventDetail event={selectedEvent} />`
       - Use a CSS Grid or flex layout to split left/right (not a ResizablePanel -- keep it simple)
       - On mobile (< md), stack vertically: event list on top, detail below (or hide detail panel and show as a sheet/dialog)

    3. Create `src/features/dashboard/api/use-activity-history.ts`:
       - TanStack Query hook accepting `filters: EventFilter` parameter
       - Uses `queryKeys.activity.list(filters)` key
       - Mock fetch function returning an array of DashboardEvent objects (generate 50 mock events with varied types, timestamps over past 7 days)
       - Returns paginated data: `{ events: DashboardEvent[], total: number, page: number, pageSize: number }`
       - staleTime: 5 minutes (historical data can refetch, unlike real-time data)

    4. Create `src/views/dashboard/activity-view.tsx`:
       - "use client" component
       - Import `PageHeader` from `@/shared/ui/page-header`
       - Import `ActivitySplitView` from `@/features/dashboard/components/activity-split-view`
       - Render PageHeader with title "Activity" and description "Real-time event stream across all agents and channels"
       - Render ActivitySplitView below
       - Add breadcrumb action link to "/activity/history" for "View History"

    5. Create `src/views/dashboard/activity-history-view.tsx`:
       - "use client" component
       - Import `PageHeader`, `DataTable`, `SearchInput`, `FilterBar` from shared UI
       - Import `useActivityHistory` hook
       - Import nuqs for filter URL state
       - Render a DataTable with columns: timestamp, type, source, agent, summary, severity
       - Add SearchInput above the table for full-text search
       - Add FilterBar with filters: event type, severity, date range
       - DataTable uses the existing `DataTable` component from `@/shared/ui/data-table`
       - Column definitions: use TanStack Table column helpers with sortable headers for timestamp and type

    6. Create `app/(dashboard)/activity/page.tsx`:
       - Import and render `ActivityView`
       - Export metadata: `{ title: "Activity | AXion Hub" }`

    7. Create `app/(dashboard)/activity/history/page.tsx`:
       - Import and render `ActivityHistoryView`
       - Export metadata: `{ title: "Activity History | AXion Hub" }`
  </action>
  <verify>
    Run `bun run build` -- zero errors. Verify routes: /activity and /activity/history exist in build output. Verify ActivitySplitView imports from activity store and renders two panels.
  </verify>
  <done>
    /activity page renders a split view with filterable event list (left) and event detail (right). /activity/history renders a DataTable with search, filters, and sortable columns. Both pages have proper metadata and route structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build /monitor page with interactive React Flow dependency map</name>
  <files>
    src/features/dashboard/components/dependency-map.tsx
    src/features/dashboard/components/dependency-node.tsx
    src/features/dashboard/components/node-detail-panel.tsx
    src/features/dashboard/lib/dagre-layout.ts
    src/features/dashboard/api/use-service-health.ts
    src/views/dashboard/monitor-view.tsx
    app/(dashboard)/monitor/page.tsx
  </files>
  <action>
    1. Create `src/features/dashboard/lib/dagre-layout.ts`:
       - Import dagre from `@dagrejs/dagre`
       - `computeDagreLayout(services: ServiceHealth[]): { nodes: Node[], edges: Edge[] }` function:
         - Creates a dagre graph with `rankdir: 'TB'` (top-to-bottom)
         - Sets node dimensions: width 220, height 100
         - Adds nodes from services array
         - Adds edges from service.connectedTo arrays
         - Runs dagre.layout(graph)
         - Returns React Flow Node[] and Edge[] with positions from dagre
       - Type Node and Edge from `@xyflow/react`
       - Edge styling: animated=true, stroke color based on connected node health

    2. Create `src/features/dashboard/components/dependency-node.tsx`:
       - Per locked decision: "Dependency map is interactive: click a node to drill in, showing metrics, recent events, and connected services"
       - Per locked decision: "/monitor page features a dependency map -- visual diagram showing how services connect (gateway, providers, channels, nodes) with color-coded health (green/yellow/red)"
       - Custom React Flow node component
       - Import `Handle, Position` from `@xyflow/react`
       - Props via `data`: { label: string, type: 'gateway' | 'provider' | 'channel' | 'node', health: 'healthy' | 'degraded' | 'down', metrics?: { uptime: number, latency: number, errorRate: number } }
       - Render a rounded card with:
         - Color-coded border: green-500 for healthy, yellow-500 for degraded, red-500 for down (border-2)
         - Icon per service type (lucide): Server for gateway, Cpu for provider, MessageSquare for channel, HardDrive for node
         - Service name as bold text
         - Health status as StatusBadge
         - Small metric summary (latency in ms) if metrics provided
       - Source and target Handles for edges

    3. Create `src/features/dashboard/components/node-detail-panel.tsx`:
       - "use client" component
       - Props: `service: ServiceHealth | null, onClose: () => void`
       - When service is null, return null
       - When service is provided, render a side panel (absolutely positioned or a Sheet from shadcn):
         - Service name, type, health badge
         - Metrics: uptime (formatted), latency (ms), error rate (%)
         - Recent events: list last 5 events from activity store filtered by this service
         - Connected services: list of other services it connects to
       - Close button to dismiss the panel

    4. Create `src/features/dashboard/components/dependency-map.tsx`:
       - "use client" component
       - Per locked decision: "Dependency map is interactive: click a node to drill in"
       - Import `ReactFlow, useNodesState, useEdgesState, Controls, Background, MiniMap` from `@xyflow/react`
       - Import `@xyflow/react/dist/style.css`
       - Import `DependencyNode` and register as nodeTypes: `{ health: DependencyNode }`
       - Import `NodeDetailPanel` for drill-in
       - Import `computeDagreLayout` from `../lib/dagre-layout`
       - Props: `services: ServiceHealth[]`
       - Use `useMemo` to compute layout from services
       - Initialize `useNodesState` and `useEdgesState` with computed layout
       - On node click (`onNodeClick`): set selectedService state, show NodeDetailPanel
       - Set `nodesDraggable={false}` (per research Pitfall 4 -- reduce event listeners)
       - Set `fitView` to auto-fit all nodes on initial render
       - Container: `div className="h-[600px] w-full rounded-lg border bg-card"`
       - Include `<Controls showInteractive={false} />`, `<Background />`, `<MiniMap />`
       - Set `proOptions={{ hideAttribution: true }}`

    5. Create `src/features/dashboard/api/use-service-health.ts`:
       - TanStack Query hook
       - Uses `queryKeys.dashboard.stats()` or a new `queryKeys.gateway.health()` key
       - Mock fetch function returning ServiceHealth[] with ~8 services:
         - 1 gateway (healthy)
         - 2 providers (1 healthy, 1 degraded)
         - 3 channels (2 healthy, 1 down)
         - 2 nodes (both healthy)
       - Each with connectedTo arrays creating a realistic dependency graph
       - staleTime: Infinity (real-time updates via EventBus)

    6. Create `src/views/dashboard/monitor-view.tsx`:
       - "use client" component
       - Import `PageHeader` from `@/shared/ui/page-header`
       - Import `DependencyMap` from `@/features/dashboard/components/dependency-map`
       - Import `useServiceHealth` hook
       - Import `Link` from `next/link` for breadcrumb action to /monitor/alerts
       - Render PageHeader with title "System Health" and description "Service dependency map with real-time health status"
       - Add a link/button to /monitor/alerts: "Configure Alerts"
       - When loading, show a skeleton (min-h-[600px] with Skeleton)
       - When data loaded, render `<DependencyMap services={data} />`

    7. Create `app/(dashboard)/monitor/page.tsx`:
       - Import and render `MonitorView`
       - Export metadata: `{ title: "System Health | AXion Hub" }`
  </action>
  <verify>
    Run `bun run build` -- zero errors. Verify /monitor route exists. Verify @xyflow/react import resolves. Verify DependencyMap uses ReactFlow with custom node types. Verify dagre layout function is called with mock services.
  </verify>
  <done>
    /monitor page renders an interactive React Flow dependency map with custom health-coded nodes. Clicking a node shows a detail panel with metrics, recent events, and connected services. Dagre auto-positions nodes in a clean top-to-bottom layout. The map is non-draggable for performance with pan/zoom/minimap controls.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes with zero errors
2. /activity renders split view with filterable event list and detail panel
3. /activity/history renders DataTable with search, filter, and sortable columns
4. /monitor renders React Flow dependency map with color-coded health nodes
5. Clicking a dependency map node shows detail panel with metrics
6. All three routes have proper Next.js metadata
7. nuqs URL state persistence works on /activity filters
</verification>

<success_criteria>
- /activity split view: left panel shows real-time event list with search/filter, right panel shows event detail on selection
- /activity/history: DataTable with 50 mock events, searchable, filterable by type/severity, sortable by timestamp
- /monitor: Interactive React Flow dependency map with 8 mock services, color-coded borders (green/yellow/red), click-to-drill-in detail panel
- Dagre layout automatically positions nodes in a clean graph
- Mobile responsive: split view stacks vertically, dependency map scrolls
- `bun run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-monitoring/05-04-SUMMARY.md`
</output>
