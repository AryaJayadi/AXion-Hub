---
phase: 08-sessions-memory-files-governance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/session/model/types.ts
  - src/entities/session/index.ts
  - src/features/sessions/api/use-sessions.ts
  - src/features/sessions/api/use-session-detail.ts
  - src/features/sessions/api/use-session-transcript.ts
  - src/features/sessions/components/sessions-table.tsx
  - src/features/sessions/components/session-summary-header.tsx
  - src/features/sessions/components/transcript-thread.tsx
  - src/features/sessions/components/transcript-tree.tsx
  - src/features/sessions/components/transcript-tool-block.tsx
  - src/views/sessions/sessions-list-view.tsx
  - src/views/sessions/session-detail-view.tsx
  - src/views/sessions/session-transcript-view.tsx
  - app/(dashboard)/sessions/page.tsx
  - app/(dashboard)/sessions/[sessionId]/page.tsx
  - app/(dashboard)/sessions/[sessionId]/transcript/page.tsx
  - src/shared/lib/query-keys.ts
autonomous: true
requirements:
  - SESS-01
  - SESS-02
  - SESS-03

must_haves:
  truths:
    - "User can browse all sessions across agents at /sessions in a chronological DataTable"
    - "User can toggle 'Group by agent' to see sessions organized by agent with collapsible sections"
    - "User can view session detail at /sessions/[sessionId] with token usage summary (total tokens, cost, duration)"
    - "User can view JSONL transcript at /sessions/[sessionId]/transcript as flat chronological thread"
    - "User can toggle to tree view to see branching/retry message structure"
    - "Tool calls in transcript appear as collapsed blocks showing tool name + status, expandable for args/output"
    - "Per-message token count is visible on hover/click in the transcript"
  artifacts:
    - path: "src/entities/session/model/types.ts"
      provides: "CrossAgentSession, SessionDetail, TranscriptMessage, TranscriptToolCall types"
      contains: "CrossAgentSession"
    - path: "src/features/sessions/components/sessions-table.tsx"
      provides: "Cross-agent session DataTable with group toggle"
      contains: "SessionsTable"
    - path: "src/features/sessions/components/transcript-thread.tsx"
      provides: "Flat chronological message thread"
      contains: "TranscriptThread"
    - path: "src/features/sessions/components/transcript-tree.tsx"
      provides: "Tree view for branching/retry messages"
      contains: "TranscriptTree"
    - path: "src/views/sessions/sessions-list-view.tsx"
      provides: "Sessions list page composition"
      contains: "SessionsListView"
  key_links:
    - from: "app/(dashboard)/sessions/page.tsx"
      to: "src/views/sessions/sessions-list-view.tsx"
      via: "Next.js route -> view component"
      pattern: "SessionsListView"
    - from: "src/views/sessions/session-detail-view.tsx"
      to: "src/features/sessions/api/use-session-detail.ts"
      via: "TanStack Query hook"
      pattern: "useSessionDetail"
    - from: "src/views/sessions/session-transcript-view.tsx"
      to: "src/features/sessions/components/transcript-thread.tsx"
      via: "Default view rendering"
      pattern: "TranscriptThread"
---

<objective>
Build the complete session browsing and transcript replay experience: a cross-agent session list with grouping, session detail pages with token/cost summaries, and a JSONL transcript viewer with flat/tree toggle and collapsed tool call blocks.

Purpose: Users need visibility into what their agents have been doing across all sessions -- browsing chronologically or by agent, drilling into token usage and costs, and replaying full conversation transcripts including tool calls.

Output: Session entity types, 3 TanStack Query hooks with mock data, 5 feature components, 3 view compositions, 3 route pages, extended query keys.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/entities/agent/model/types.ts (AgentSession type to extend)
@src/features/agents/components/agent-sessions-table.tsx (existing per-agent sessions DataTable pattern)
@src/features/chat/components/tool-call-group.tsx (tool call collapsed block pattern to adapt)
@src/shared/ui/data-table.tsx (DataTable component)
@src/shared/lib/query-keys.ts (query key factory to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Session entity types, query hooks, session list page with group toggle, and session detail page</name>
  <files>
    src/entities/session/model/types.ts
    src/entities/session/index.ts
    src/shared/lib/query-keys.ts
    src/features/sessions/api/use-sessions.ts
    src/features/sessions/api/use-session-detail.ts
    src/features/sessions/components/sessions-table.tsx
    src/features/sessions/components/session-summary-header.tsx
    src/views/sessions/sessions-list-view.tsx
    src/views/sessions/session-detail-view.tsx
    app/(dashboard)/sessions/page.tsx
    app/(dashboard)/sessions/[sessionId]/page.tsx
  </files>
  <action>
    **Entity types** (src/entities/session/model/types.ts):
    - Import AgentSession from @/entities/agent
    - Define CrossAgentSession extending AgentSession with: agentName (string), agentAvatar (string | undefined), model (string)
    - Define SessionDetail: { session: CrossAgentSession, summary: { totalTokens, inputTokens, outputTokens, estimatedCost (number), duration (number ms), messageCount, toolCallCount } }
    - Define TranscriptMessage: { id, role ("user"|"assistant"|"system"), content (string), timestamp (Date), tokenCount (number), toolCalls (TranscriptToolCall[]), parentMessageId (string | undefined), isRetry (boolean), metadata ({ model, temperature, stopReason } | undefined) }
    - Define TranscriptToolCall: { id, name, arguments (Record<string, unknown>), output (string | undefined), error (string | undefined), durationMs (number), status ("completed"|"error") }
    - Use `| undefined` for all optional props (exactOptionalPropertyTypes)
    - Barrel export from src/entities/session/index.ts

    **Query keys** (src/shared/lib/query-keys.ts):
    - Add `transcript` to existing `sessions` key object: `transcript: (id: string) => [...queryKeys.sessions.details(), id, "transcript"] as const`
    - Add `memory`, `workspace`, `deliverables`, `approvals`, `governance` domains (per research query keys section). This extends the file for all Phase 8 plans to avoid conflicts.

    **use-sessions.ts**: TanStack Query hook returning CrossAgentSession[]. Generate 15-20 mock sessions across 4 agents (Research Agent, Code Agent, Data Agent, Writer Agent) with varied statuses and durations. staleTime: Infinity. Use queryKeys.sessions.list(filters).

    **use-session-detail.ts**: TanStack Query hook taking sessionId, returning SessionDetail with summary data. Mock: derive from a lookup by sessionId with realistic token counts (2000-15000 total, 60% input / 40% output), cost ($0.01-$0.50), duration (30s-600s). Use queryKeys.sessions.detail(sessionId).

    **sessions-table.tsx**: SessionsTable component.
    - nuqs useQueryState for `group` param (default "none").
    - Columns: agent name (with small avatar), session status (StatusBadge), model, started time (date-fns formatDistanceToNow), duration, message count.
    - When group="none": flat DataTable with agent column, chronological (newest first).
    - When group="agent": group sessions by agentId, render Collapsible per agent with agent name as trigger and count badge, each containing a DataTable of that agent's sessions.
    - Toggle button in PageHeader actions area: "Group by agent" / "Chronological" using shadcn Button with variant toggle.
    - Row click navigates to /sessions/[sessionId].
    - Loading skeleton via SkeletonTable pattern.

    **session-summary-header.tsx**: SessionSummaryHeader component.
    - Takes SessionDetail.summary as prop.
    - 4 compact stat cards in a responsive grid (2x2 on mobile, 4 cols on lg):
      1. Total Tokens (formatted with K suffix, e.g., "12.3K")
      2. Cost (formatted as $X.XX)
      3. Duration (date-fns formatDistanceStrict)
      4. Messages / Tool Calls (e.g., "42 messages, 8 tool calls")
    - Use Card from shadcn with muted background, small icon per card (Coins, Clock, MessageSquare, Wrench from lucide-react).

    **sessions-list-view.tsx**: SessionsListView composing PageHeader ("Sessions", "Browse all agent sessions") + SessionsTable. Pass down the useSessions data.

    **session-detail-view.tsx**: SessionDetailView taking sessionId prop.
    - Uses useSessionDetail(sessionId) for data.
    - Renders: PageHeader with breadcrumb (Sessions > {agentName} > Session), SessionSummaryHeader with summary data, then a "View Transcript" link/button navigating to /sessions/[sessionId]/transcript.
    - Loading state: SkeletonDetail.
    - Not found state: EmptyState with "Session not found" message.

    **Route pages**: Standard async server component pattern -- await params, pass sessionId to view, Suspense wrapper. generateMetadata for session detail page.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no type errors)
    - All entity types export correctly from barrel
    - Sessions route at /sessions renders DataTable
    - Session detail at /sessions/[sessionId] renders summary cards
    - Group toggle switches between flat and grouped views
  </verify>
  <done>
    - /sessions shows a chronological DataTable of 15-20 mock sessions across agents
    - "Group by agent" toggle groups sessions under collapsible agent sections
    - Clicking a session row navigates to /sessions/[sessionId]
    - /sessions/[sessionId] shows 4 token/cost/duration stat cards and a "View Transcript" button
  </done>
</task>

<task type="auto">
  <name>Task 2: Transcript viewer with flat thread, tree toggle, and tool call blocks</name>
  <files>
    src/features/sessions/api/use-session-transcript.ts
    src/features/sessions/components/transcript-thread.tsx
    src/features/sessions/components/transcript-tree.tsx
    src/features/sessions/components/transcript-tool-block.tsx
    src/views/sessions/session-transcript-view.tsx
    app/(dashboard)/sessions/[sessionId]/transcript/page.tsx
  </files>
  <action>
    **use-session-transcript.ts**: TanStack Query hook taking sessionId, returning TranscriptMessage[]. Generate 20-40 mock messages with realistic conversation flow: user asks question -> assistant responds with tool calls -> tool results -> assistant final answer. Include 2-3 branching/retry examples (messages with parentMessageId pointing to a prior message, isRetry: true). Include 3-5 tool calls across messages (file_read, web_search, code_execute types). Token counts per message: user 50-200, assistant 200-2000, system 50-100. Use queryKeys.sessions.transcript(sessionId).

    **transcript-tool-block.tsx**: TranscriptToolBlock component.
    - Takes TranscriptToolCall as prop.
    - Default: collapsed block showing tool name + status badge (StatusBadge with "completed"/"error") + duration (e.g., "1.2s").
    - Uses shadcn Collapsible. Expand reveals:
      - Arguments section: JSON.stringify(args, null, 2) in a `<pre>` block with bg-muted rounded, font-mono text-xs.
      - Output section (if present): truncated to first 500 chars with "Show all" toggle.
      - Error section (if error): red text with error message.
    - Styling: border-l-2 with status color (green for completed, red for error), padding-left for indent.
    - Adapt the pattern from src/features/chat/components/tool-call-group.tsx but make it read-only (no real-time execution state, no pipeline animation). Keep it simpler -- just collapsed/expanded.

    **transcript-thread.tsx**: TranscriptThread component.
    - Takes TranscriptMessage[] as prop.
    - Renders messages in chronological order as a flat list.
    - Per message: role icon (User/Bot/Settings from lucide-react), role label, timestamp (date-fns format "HH:mm:ss"), content as rendered markdown (use a simple prose wrapper, no Streamdown needed since this is static read-only).
    - Token count shown on hover via shadcn Tooltip: "Input: X / Output: Y tokens" or just "X tokens" for the message.
    - After each assistant message's content, render any toolCalls using TranscriptToolBlock components.
    - Visual styling: alternating background for user vs assistant (muted bg for assistant), small gap between messages.
    - Use virtual scrolling if message count > 50 (reuse @tanstack/react-virtual pattern from agent logs).

    **transcript-tree.tsx**: TranscriptTree component.
    - Takes same TranscriptMessage[] prop.
    - Build tree structure from parentMessageId links: messages without parentMessageId are roots, messages with parentMessageId are children of that message.
    - Render tree using CSS margin-left (depth * 24px) for indentation.
    - Branch indicator: a vertical line on the left side connecting parent to children, with a small dot at branch points.
    - Retry messages shown with a "Retry" badge next to the timestamp.
    - Reuse same message rendering as TranscriptThread (role icon, content, tool calls) but with depth-based indentation.
    - For most sessions (no branching), this looks nearly identical to the flat view.

    **session-transcript-view.tsx**: SessionTranscriptView component.
    - Takes sessionId prop.
    - Uses useSessionTranscript(sessionId) for data.
    - nuqs useQueryState for `view` param (default "thread", options "thread" | "tree").
    - Toggle in PageHeader actions: "Flat" / "Tree" buttons using shadcn ToggleGroup or two Buttons with active state.
    - When view="thread": render TranscriptThread.
    - When view="tree": render TranscriptTree.
    - PageHeader with breadcrumb: Sessions > {sessionId} > Transcript.
    - Loading skeleton: SkeletonList.

    **Route page**: Standard async server component pattern with await params, Suspense wrapper.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /sessions/[sessionId]/transcript renders flat message thread by default
    - Toggle switches to tree view with indented branching messages
    - Tool calls appear as collapsed blocks, expand to show args and output
    - Token count appears on message hover
  </verify>
  <done>
    - /sessions/[sessionId]/transcript shows flat chronological message thread
    - Tree toggle renders branching/retry structure with indentation
    - Tool calls shown as collapsed blocks (tool name + status), expandable for args/output
    - Per-message token details visible on hover via Tooltip
    - Virtual scrolling handles long transcripts (50+ messages)
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- All 3 session routes resolve without 404
- Sessions list shows DataTable with agent sessions and group toggle
- Session detail shows token usage summary
- Transcript viewer shows flat thread with tree toggle
- Tool calls render as collapsed/expandable blocks
</verification>

<success_criteria>
- SESS-01: /sessions shows chronological DataTable with "Group by agent" toggle
- SESS-02: /sessions/[sessionId] shows session detail with token/cost/duration summary header
- SESS-03: /sessions/[sessionId]/transcript shows JSONL transcript with flat/tree toggle and collapsed tool call blocks
</success_criteria>

<output>
After completion, create `.planning/phases/08-sessions-memory-files-governance/08-01-SUMMARY.md`
</output>
