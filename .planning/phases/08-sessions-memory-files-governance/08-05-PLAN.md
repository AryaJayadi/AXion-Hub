---
phase: 08-sessions-memory-files-governance
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/approval/model/types.ts
  - src/entities/approval/index.ts
  - src/features/approvals/api/use-approvals.ts
  - src/features/approvals/api/use-approval-actions.ts
  - src/features/approvals/components/approval-inbox.tsx
  - src/features/approvals/components/approval-review.tsx
  - src/features/approvals/components/approval-action-panel.tsx
  - src/views/approvals/approvals-list-view.tsx
  - src/views/approvals/approval-detail-view.tsx
  - app/(dashboard)/approvals/page.tsx
  - app/(dashboard)/approvals/[taskId]/page.tsx
autonomous: true
requirements:
  - GOVR-01
  - GOVR-02

must_haves:
  truths:
    - "User can view tasks awaiting sign-off at /approvals in an inbox-style list"
    - "Approval list shows newest first with task title, agent, priority, and submission date"
    - "User can click into an approval to review agent output at /approvals/[taskId]"
    - "User can approve, reject, or request revision with required comment for reject/revision"
    - "Approval status updates optimistically after action"
  artifacts:
    - path: "src/entities/approval/model/types.ts"
      provides: "ApprovalItem, ApprovalAction types"
      contains: "ApprovalItem"
    - path: "src/features/approvals/components/approval-inbox.tsx"
      provides: "Inbox-style approval list"
      contains: "ApprovalInbox"
    - path: "src/features/approvals/components/approval-action-panel.tsx"
      provides: "Approve/reject/revision action panel"
      contains: "ApprovalActionPanel"
    - path: "src/views/approvals/approvals-list-view.tsx"
      provides: "Approvals list page composition"
      contains: "ApprovalsListView"
  key_links:
    - from: "app/(dashboard)/approvals/page.tsx"
      to: "src/views/approvals/approvals-list-view.tsx"
      via: "Next.js route -> view component"
      pattern: "ApprovalsListView"
    - from: "src/features/approvals/components/approval-action-panel.tsx"
      to: "src/features/approvals/api/use-approval-actions.ts"
      via: "TanStack Query mutation"
      pattern: "useApprovalActions"
    - from: "src/views/approvals/approval-detail-view.tsx"
      to: "src/features/approvals/components/approval-review.tsx"
      via: "Review panel rendering"
      pattern: "ApprovalReview"
---

<objective>
Build the approval queue and approval detail experience: an inbox-style list of tasks awaiting human sign-off and a review page where users can inspect agent output and approve, reject, or request revision with required comments.

Purpose: Users need governance control over agent work -- seeing what awaits their approval, reviewing deliverables, and making approval decisions that flow back to the mission board.

Output: Approval entity types, 2 TanStack Query hooks with mock data, 3 feature components, 2 view compositions, 2 route pages.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/features/missions/components/task-sign-off-modal.tsx (sign-off pattern: approve/reject/revision with required comments)
@src/features/missions/components/task-deliverables.tsx (deliverable preview cards)
@src/entities/mission/model/types.ts (Task, Deliverable, TaskPriority types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Approval entity types, query hooks, and inbox-style approval queue at /approvals</name>
  <files>
    src/entities/approval/model/types.ts
    src/entities/approval/index.ts
    src/features/approvals/api/use-approvals.ts
    src/features/approvals/components/approval-inbox.tsx
    src/views/approvals/approvals-list-view.tsx
    app/(dashboard)/approvals/page.tsx
  </files>
  <action>
    **Entity types** (src/entities/approval/model/types.ts):
    - Define ApprovalItem: { taskId (string), taskTitle (string), taskDescription (string), agentId (string), agentName (string), priority ("critical"|"high"|"medium"|"low"), deliverableCount (number), submittedAt (Date), signOffStatus ("pending") }
    - Define ApprovalAction: { type ("approve"|"reject"|"revision"), comment (string, required for reject/revision, optional for approve), reviewedAt (Date) }
    - Define ApprovalDetail extending ApprovalItem with: deliverables (array of { id, name, type ("file"|"code"|"link"), content (string | undefined), url (string | undefined), size (number | undefined) }), taskActivity (array of { timestamp (Date), action (string), actor (string) })
    - All optional props use `| undefined`
    - Barrel export from index.ts

    **use-approvals.ts**: TanStack Query hook returning ApprovalItem[].
    - Generate 5-7 mock pending approvals:
      - "Security audit report" by Research Agent (high priority, 3 deliverables)
      - "API endpoint implementation" by Code Agent (medium, 2 deliverables)
      - "Data migration script" by Data Agent (critical, 1 deliverable)
      - "User documentation" by Writer Agent (low, 2 deliverables)
      - "Performance optimization" by Code Agent (high, 4 deliverables)
    - Sort by submittedAt descending (newest first).
    - staleTime: 30000 (30s, approvals should refresh more often). Use queryKeys.approvals.list().

    **approval-inbox.tsx**: ApprovalInbox component.
    - Takes ApprovalItem[] as prop.
    - Render as DataTable with columns:
      1. Priority: colored dot or badge (critical=red, high=orange, medium=blue, low=gray)
      2. Task: taskTitle as primary text, agentName as secondary text below
      3. Deliverables: count with Package icon
      4. Submitted: date-fns formatDistanceToNow (e.g., "2 hours ago")
    - Row click navigates to /approvals/[taskId].
    - Row hover shows subtle highlight.
    - Inbox feel: compact rows, no excessive spacing, clean lines.
    - Empty state: EmptyState with CheckCircle icon and "All caught up! No approvals pending."

    **approvals-list-view.tsx**: ApprovalsListView composition.
    - Uses useApprovals() for data.
    - PageHeader: "Approvals" with description "Tasks awaiting your review" and count badge showing number of pending items.
    - ApprovalInbox with the data.
    - Loading skeleton: SkeletonTable.

    **Route page**: Standard async server component, Suspense wrapper.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /approvals renders inbox-style DataTable
    - Items sorted newest first with priority indicators
    - Clicking a row navigates to /approvals/[taskId]
    - Empty state shows "All caught up" message
  </verify>
  <done>
    - /approvals shows inbox-style list of pending approval items
    - Items display priority, task title, agent name, deliverable count, and submission time
    - Newest items appear first
    - Row click navigates to approval detail
  </done>
</task>

<task type="auto">
  <name>Task 2: Approval detail with deliverable review and approve/reject/revision actions at /approvals/[taskId]</name>
  <files>
    src/features/approvals/api/use-approval-actions.ts
    src/features/approvals/components/approval-review.tsx
    src/features/approvals/components/approval-action-panel.tsx
    src/views/approvals/approval-detail-view.tsx
    app/(dashboard)/approvals/[taskId]/page.tsx
  </files>
  <action>
    **use-approval-actions.ts**: TanStack Query mutation hook.
    - Accepts: { taskId: string, action: ApprovalAction }.
    - Optimistic update: immediately remove the item from the approvals list cache (queryKeys.approvals.list()) and show toast.
    - Mock: 300ms delay, then success.
    - On approve: toast "Task approved" with CheckCircle icon.
    - On reject: toast "Task rejected" with XCircle icon.
    - On revision: toast "Revision requested" with RotateCcw icon.
    - Invalidate queryKeys.approvals.list() and queryKeys.tasks.detail(taskId) on settled.

    **approval-review.tsx**: ApprovalReview component.
    - Takes ApprovalDetail as prop.
    - Two-column layout (responsive: stacked on mobile, side-by-side on lg):
      - Left/Top (60%): Deliverables section.
        - Section header "Deliverables ({count})".
        - Grid of deliverable cards. For each deliverable: name, type badge, size (if file), content preview (if code: first 5 lines in a pre block with bg-muted; if file: icon + file info; if link: clickable URL).
        - Clicking a deliverable could open a full preview dialog (Sheet or Dialog showing full content). Use shadcn Dialog.
      - Right/Bottom (40%): Task info.
        - Task title, description, agent name + avatar, priority badge, submitted date.
        - Task activity timeline (simplified): list of { timestamp, action, actor } entries with small timeline dots. Shows recent activity like "Submitted for review", "Agent completed task", etc.

    **approval-action-panel.tsx**: ApprovalActionPanel component.
    - Takes taskId (string) and onComplete callback.
    - Three action buttons:
      1. "Approve" (green, CheckCircle icon) -- enabled always.
      2. "Reject" (red, XCircle icon) -- shows comment textarea when clicked.
      3. "Request Revision" (orange, RotateCcw icon) -- shows comment textarea when clicked.
    - Comment textarea: appears below reject/revision buttons when that action is selected. Required field (cannot submit with empty comment). Placeholder: "Explain what needs to change..." for revision, "Reason for rejection..." for reject.
    - Approve can optionally have a comment (textarea toggleable via "Add comment" link, not required).
    - Submit button: "Confirm {Action}" (e.g., "Confirm Rejection"). Shows loading spinner during mutation.
    - Uses useApprovalActions mutation.
    - After successful action, call onComplete (which navigates back to /approvals).
    - Consistent with Phase 6 TaskSignOffModal pattern: required comment for reject/revision, optional for approve.

    **approval-detail-view.tsx**: ApprovalDetailView composition.
    - Takes taskId prop.
    - Uses a local hook or inline mock to generate ApprovalDetail from the taskId (extend the mock approvals data with deliverables and activity).
    - Layout: PageHeader with breadcrumb (Approvals > {taskTitle}), then ApprovalReview, then ApprovalActionPanel below the review (sticky bottom bar on mobile, or fixed at bottom of right column on desktop).
    - Loading: SkeletonDetail. Not found: EmptyState.
    - onComplete: router.push("/approvals").

    **Route page**: Standard async server component with await params, Suspense wrapper, generateMetadata.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /approvals/[taskId] renders deliverable review with action panel
    - Approve action works immediately (optimistic removal from list)
    - Reject requires non-empty comment before submission
    - Request revision requires non-empty comment
    - After action, navigates back to /approvals
    - Toast confirms the action taken
  </verify>
  <done>
    - /approvals/[taskId] shows two-column review layout with deliverables and task info
    - Approve, reject, and request revision actions all work
    - Reject and revision require non-empty comment (consistent with Phase 6 pattern)
    - Optimistic status update removes item from approval queue
    - Success toast and redirect back to /approvals
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Both /approvals and /approvals/[taskId] routes resolve
- Inbox shows pending items sorted newest first
- Approval actions work with required comments for reject/revision
- Optimistic updates remove approved/rejected items from the list
</verification>

<success_criteria>
- GOVR-01: /approvals shows inbox-style list of tasks awaiting sign-off with priority, agent, and submission date
- GOVR-02: /approvals/[taskId] allows reviewing deliverables and taking approve/reject/revision actions with required comments
</success_criteria>

<output>
After completion, create `.planning/phases/08-sessions-memory-files-governance/08-05-SUMMARY.md`
</output>
