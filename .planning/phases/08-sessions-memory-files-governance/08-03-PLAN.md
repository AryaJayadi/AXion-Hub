---
phase: 08-sessions-memory-files-governance
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/workspace/model/types.ts
  - src/entities/workspace/index.ts
  - src/features/workspace/api/use-workspace-tree.ts
  - src/features/workspace/api/use-workspace-file.ts
  - src/features/workspace/components/file-tree.tsx
  - src/features/workspace/components/file-tree-node.tsx
  - src/features/workspace/components/code-editor.tsx
  - src/features/workspace/components/file-viewer.tsx
  - src/views/workspace/workspace-browser-view.tsx
  - src/views/workspace/workspace-file-view.tsx
  - app/(dashboard)/workspace/page.tsx
  - app/(dashboard)/workspace/[agentId]/[...path]/page.tsx
autonomous: true
requirements:
  - FILE-01
  - FILE-02

must_haves:
  truths:
    - "User can browse agent workspace files at /workspace with a tree sidebar"
    - "File tree shows shared workspace area and per-agent directories"
    - "User can view/edit workspace files at /workspace/[agentId]/[...path]"
    - "Code files have syntax highlighting, line numbers, and find/replace via CodeMirror"
    - "Markdown files use @uiw/react-md-editor for split-pane preview"
    - "File editor auto-saves with debounce"
  artifacts:
    - path: "src/entities/workspace/model/types.ts"
      provides: "FileTreeNode, WorkspaceFile, UploadTarget types"
      contains: "FileTreeNode"
    - path: "src/features/workspace/components/file-tree.tsx"
      provides: "Recursive file tree sidebar"
      contains: "FileTree"
    - path: "src/features/workspace/components/code-editor.tsx"
      provides: "CodeMirror wrapper with language detection"
      contains: "CodeEditor"
    - path: "src/features/workspace/components/file-viewer.tsx"
      provides: "Routes to CodeMirror or MDEditor by extension"
      contains: "FileViewer"
    - path: "src/views/workspace/workspace-browser-view.tsx"
      provides: "Workspace browser page composition"
      contains: "WorkspaceBrowserView"
  key_links:
    - from: "src/features/workspace/components/file-viewer.tsx"
      to: "src/features/workspace/components/code-editor.tsx"
      via: "Extension-based routing"
      pattern: "CodeEditor|MDEditor"
    - from: "src/views/workspace/workspace-browser-view.tsx"
      to: "src/features/workspace/components/file-tree.tsx"
      via: "Tree sidebar + content area"
      pattern: "FileTree"
    - from: "src/views/workspace/workspace-file-view.tsx"
      to: "src/features/workspace/api/use-workspace-file.ts"
      via: "TanStack Query hook"
      pattern: "useWorkspaceFile"
---

<objective>
Build the workspace file browser and code editor: a VS Code-style tree sidebar with content area using react-resizable-panels, a CodeMirror-based code editor with syntax highlighting and auto-save, and markdown editing via @uiw/react-md-editor.

Purpose: Users need to browse, view, and edit files in their agents' workspace directories -- navigating file trees, editing code with proper syntax highlighting, and editing markdown with split-pane preview.

Output: Workspace entity types, CodeMirror + language packages installed, 2 TanStack Query hooks, 4 feature components, 2 view compositions, 2 route pages.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-sessions-memory-files-governance/08-RESEARCH.md (CodeMirror setup, language extensions, anti-patterns)

@src/features/agents/components/agent-memory-browser.tsx (tree sidebar + content pattern)
@src/features/agents/components/agent-identity-editor.tsx (MDEditor with auto-save, dark mode sync)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Workspace entity types, CodeMirror install, file tree component, and workspace browser at /workspace</name>
  <files>
    src/entities/workspace/model/types.ts
    src/entities/workspace/index.ts
    src/features/workspace/api/use-workspace-tree.ts
    src/features/workspace/components/file-tree.tsx
    src/features/workspace/components/file-tree-node.tsx
    src/views/workspace/workspace-browser-view.tsx
    app/(dashboard)/workspace/page.tsx
  </files>
  <action>
    **Install CodeMirror packages** (run first):
    ```bash
    bun add @uiw/react-codemirror @codemirror/lang-javascript @codemirror/lang-json @codemirror/lang-markdown @codemirror/lang-python @codemirror/lang-yaml
    ```

    **Entity types** (src/entities/workspace/model/types.ts):
    - Define FileTreeNode: { name (string), path (string, relative from workspace root), type ("file"|"directory"), children (FileTreeNode[] | undefined), size (number | undefined), lastModified (Date | undefined), mimeType (string | undefined) }
    - Define WorkspaceFile: { path (string), agentId (string | null, null = shared), content (string), language (string, detected from extension), size (number), lastModified (Date), isReadOnly (boolean) }
    - Define UploadTarget: discriminated union with type "shared" | { type: "agent", agentId: string } | { type: "task", taskId: string }
    - All optional props use `| undefined`
    - Barrel export from index.ts

    **use-workspace-tree.ts**: TanStack Query hook returning FileTreeNode (root node). Generate mock workspace tree:
    - Root has 2 top-level directories: "shared" and per-agent dirs ("research-agent", "code-agent", "data-agent")
    - shared/ contains: README.md, config.yaml, data/ (with 2-3 .json files)
    - Each agent dir contains: workspace/ (with .ts, .py, .md files), output/ (with result files), logs/ (with .log files)
    - Total ~20-30 files across the tree
    - staleTime: Infinity. Use queryKeys.workspace.tree().

    **file-tree-node.tsx**: FileTreeNode component (recursive, React.memo).
    - Takes: node (FileTreeNode), depth (number), activePath (string), onSelect ((path: string) => void)
    - If file: render button with file icon (use lucide-react: FileText for .md, FileCode for .ts/.js/.py, FileJson for .json, FileType for .yaml/.yml, File for default), name truncated, paddingLeft = (depth * 12 + 12)px.
    - Active file: bg-accent text-accent-foreground. Inactive: text-muted-foreground hover:bg-accent/50.
    - If directory: render Collapsible (defaultOpen for depth < 2).
      - Trigger: ChevronRight icon (rotate-90 when open), FolderOpen/Folder icon, folder name.
      - Content: recursively render children.
    - Memoize with path-based comparison to prevent tree-wide re-renders.

    **file-tree.tsx**: FileTree component.
    - Takes: tree (FileTreeNode), activePath (string), onSelect ((path: string) => void)
    - Keep expanded state in a Set<string> for folder paths.
    - Wrap in ScrollArea for overflow.
    - Render root's children via FileTreeNode.

    **workspace-browser-view.tsx**: WorkspaceBrowserView composition.
    - Uses useWorkspaceTree() for tree data.
    - Uses react-resizable-panels: PanelGroup (orientation="horizontal") with Panel (defaultSize={25} minSize={15}) for tree sidebar and Panel (defaultSize={75}) for content area.
    - PanelResizeHandle between panels (thin border with hover highlight).
    - React state for activePath (string, defaults to empty).
    - Left panel: FileTree. Right panel: when activePath is set, show a placeholder "File viewer coming soon" card showing the file path and a link to /workspace/{agentId}/{path}. When no file selected: show EmptyState "Select a file to view".
    - Actually, for the full experience: when a file is clicked in the tree, navigate to /workspace/[agentId]/[...path] so the file viewer page handles it. BUT to maintain the sidebar context, we need inline viewing. Use a simpler approach: keep both tree and file content in the same page. When a file is selected, load and display it inline using FileViewer (from Task 2). For now (Task 1), just show file metadata (path, size, last modified) as a placeholder -- Task 2 adds the actual editor.
    - PageHeader: "Workspace" with description "Browse agent workspace files" and "Upload" button (placeholder, navigates to /workspace/upload).
    - Loading skeleton: SkeletonList for tree, SkeletonDetail for content area.

    **Route page**: Standard async server component, Suspense wrapper.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - CodeMirror packages installed in package.json
    - /workspace renders tree sidebar with resizable panels
    - File tree shows shared + per-agent directories
    - Clicking files shows selection state
    - Collapsible directories expand/collapse correctly
  </verify>
  <done>
    - CodeMirror and language extension packages installed
    - /workspace shows tree sidebar + content area with react-resizable-panels
    - File tree renders shared workspace and per-agent directories
    - Directory expand/collapse works, file selection highlights active file
  </done>
</task>

<task type="auto">
  <name>Task 2: CodeMirror code editor, file viewer routing, and workspace file editing at /workspace/[agentId]/[...path]</name>
  <files>
    src/features/workspace/api/use-workspace-file.ts
    src/features/workspace/components/code-editor.tsx
    src/features/workspace/components/file-viewer.tsx
    src/views/workspace/workspace-file-view.tsx
    src/views/workspace/workspace-browser-view.tsx
    app/(dashboard)/workspace/[agentId]/[...path]/page.tsx
  </files>
  <action>
    **use-workspace-file.ts**: TanStack Query hook taking (agentId: string, filePath: string), returning WorkspaceFile.
    - Mock: generate file content based on extension:
      - .ts/.tsx: sample TypeScript code (30-50 lines with imports, interface, function)
      - .py: sample Python code (20-30 lines)
      - .json: sample JSON config object
      - .md: sample markdown documentation
      - .yaml/.yml: sample YAML config
      - .log: sample log entries
    - Detect language from extension: ts->typescript, py->python, json->json, md->markdown, yaml->yaml, etc.
    - isReadOnly: true for .log files, false for others.
    - Use queryKeys.workspace.file(agentId, filePath).

    **code-editor.tsx**: CodeEditor component.
    - Dynamic import @uiw/react-codemirror via next/dynamic with ssr: false, loading: Skeleton placeholder. (Prevents SSR crash per research Pitfall 1.)
    - Props: value (string), filePath (string), onChange ((value: string) => void | undefined), onSave ((content: string) => Promise<void> | undefined), readOnly (boolean | undefined).
    - Lazy language extension loading (research Pitfall 2):
      - getLanguageExtension(ext) async function with switch: ts/tsx -> @codemirror/lang-javascript with typescript:true, jsx for tsx; js/jsx -> lang-javascript; json -> lang-json; md/mdx -> lang-markdown; py -> lang-python; yaml/yml -> lang-yaml; default -> null.
      - useEffect to load language extension on ext change, store in state.
      - useMemo to build extensions array.
    - Dark mode: use `useTheme()` from next-themes. Pass `theme={resolvedTheme === "light" ? "light" : "dark"}`.
    - Auto-save: useDebouncedCallback from use-debounce with 500ms delay. Call onSave on change. Follow exact pattern from AgentIdentityEditor (flush pending saves, cancel on unmount).
    - basicSetup: lineNumbers: true, foldGutter: true, bracketMatching: true, highlightActiveLine: true, tabSize: 2. Search/replace is built into CodeMirror (Ctrl+F).
    - Wrapper div: data-color-mode attribute for theme, h-full.

    **file-viewer.tsx**: FileViewer component.
    - Takes: WorkspaceFile as prop, onSave callback.
    - Routes by file extension:
      - .md/.mdx files: use @uiw/react-md-editor (dynamic import, ssr: false) in edit mode with preview. Same pattern as AgentIdentityEditor with data-color-mode dark mode sync.
      - All other files: use CodeEditor component.
    - Header bar above editor: file path (font-mono text-sm), language badge, file size, save status indicator (Saving.../Saved pattern from identity editor).
    - readOnly files: pass readOnly=true to editor, show "Read-only" badge.

    **Update workspace-browser-view.tsx**: When a file is selected in the tree, inline-load the file content using useWorkspaceFile and render FileViewer in the right panel. Derive agentId from the file path (first segment after root, or "shared" for shared files). Show save status. This replaces the placeholder from Task 1.

    **workspace-file-view.tsx**: WorkspaceFileView for the standalone route.
    - Takes agentId and path (string[]) from route params.
    - Uses useWorkspaceFile(agentId, path.join("/")) for data.
    - Renders: PageHeader with breadcrumb (Workspace > {agentId} > {fileName}), FileViewer with the file data.
    - Loading: SkeletonDetail. Not found: EmptyState.
    - onSave: mock mutation that shows success toast via sonner.

    **Route page**: Standard async server component. Params include agentId (string) and path (string[] from catch-all). Join path segments. Suspense wrapper.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - /workspace shows inline file editing when file selected in tree
    - /workspace/[agentId]/[...path] shows standalone file editor
    - TypeScript files get syntax highlighting
    - Markdown files use MDEditor with preview
    - Auto-save triggers on edit (visible save status indicator)
    - CodeMirror Ctrl+F find/replace works
    - No SSR errors (dynamic imports working)
  </verify>
  <done>
    - CodeMirror renders with syntax highlighting for .ts, .js, .json, .py, .yaml files
    - Markdown files use @uiw/react-md-editor with split-pane preview
    - Language extensions lazy-loaded based on file extension (no bundle bloat)
    - Auto-save with 500ms debounce and save status indicator
    - Read-only mode for log files
    - Both inline (workspace browser) and standalone (/workspace/[agentId]/[...path]) views work
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Both /workspace and /workspace/[agentId]/[...path] routes resolve
- File tree navigation works with expand/collapse
- Code editor has syntax highlighting for multiple languages
- Auto-save functions with debounce and status indicator
- No SSR errors from CodeMirror or MDEditor
</verification>

<success_criteria>
- FILE-01: /workspace shows tree sidebar + content layout with shared and per-agent directories
- FILE-02: /workspace/[agentId]/[...path] shows code editor with syntax highlighting, line numbers, find/replace, and auto-save
</success_criteria>

<output>
After completion, create `.planning/phases/08-sessions-memory-files-governance/08-03-SUMMARY.md`
</output>
