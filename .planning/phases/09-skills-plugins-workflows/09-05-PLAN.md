---
phase: 09-skills-plugins-workflows
plan: 05
type: execute
wave: 2
depends_on:
  - "09-03"
files_modified:
  - src/features/workflows/api/use-cron-schedules.ts
  - src/features/workflows/api/use-webhooks.ts
  - src/features/workflows/components/cron-builder.tsx
  - src/features/workflows/components/cron-schedules-table.tsx
  - src/features/workflows/components/webhook-table.tsx
  - src/features/workflows/components/webhook-create-dialog.tsx
  - src/views/workflows/cron-schedules-view.tsx
  - src/views/workflows/webhooks-view.tsx
  - app/(dashboard)/workflows/cron/page.tsx
  - app/(dashboard)/workflows/webhooks/page.tsx
autonomous: true
requirements:
  - WORK-04
  - WORK-05

must_haves:
  truths:
    - "User can view and manage cron schedules at /workflows/cron"
    - "User can create cron schedules with a visual builder showing human-readable preview and next run dates"
    - "User can view and manage webhook endpoints at /workflows/webhooks"
    - "User can create webhook endpoints via a dialog that generates URL and secret"
    - "Run history shown as inline expandable rows in both cron and webhook tables"
  artifacts:
    - path: "src/features/workflows/components/cron-builder.tsx"
      provides: "Hybrid visual builder with raw expression toggle and human-readable preview"
      min_lines: 80
    - path: "src/features/workflows/components/cron-schedules-table.tsx"
      provides: "DataTable for cron schedules with inline run history"
      min_lines: 50
    - path: "src/features/workflows/components/webhook-table.tsx"
      provides: "DataTable for webhook endpoints with inline run history"
      min_lines: 50
    - path: "src/features/workflows/components/webhook-create-dialog.tsx"
      provides: "Dialog for creating webhook with URL generation and secret"
      min_lines: 40
  key_links:
    - from: "src/features/workflows/components/cron-builder.tsx"
      to: "cronstrue"
      via: "human-readable cron description"
      pattern: "cronstrue"
    - from: "src/features/workflows/components/cron-builder.tsx"
      to: "croner"
      via: "next run date calculation"
      pattern: "Cron.*nextRuns|croner"
    - from: "src/views/workflows/webhooks-view.tsx"
      to: "src/features/workflows/components/webhook-create-dialog.tsx"
      via: "dialog opens on Create Webhook button"
      pattern: "WebhookCreateDialog"
---

<objective>
Build cron job scheduling and webhook endpoint management: visual cron builder with human-readable preview at /workflows/cron and webhook DataTable with create dialog at /workflows/webhooks.

Purpose: Users need to schedule recurring workflow executions via cron and create inbound webhook endpoints that trigger workflows.
Output: 2 fully functional pages for cron scheduling and webhook management, with the visual cron builder being the highlight component.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-skills-plugins-workflows/09-RESEARCH.md
@.planning/phases/09-skills-plugins-workflows/09-03-SUMMARY.md

Key patterns to follow:
- DataTable: src/shared/ui/data-table.tsx
- Dialog: shadcn/ui Dialog component
- Action menu: src/shared/ui/action-menu.tsx
- Expandable rows: Phase 8 audit log (expandable detail pattern)
- cronstrue: cronstrue.toString(expression) for human-readable
- croner: new Cron(expression).nextRuns(5) for next run dates
- Install: npm install cronstrue croner (run at start of execution)

NOTE: cronstrue and croner must be installed first: `bun add cronstrue croner`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, cron API hooks, cron builder component, and cron schedules page</name>
  <files>
    src/features/workflows/api/use-cron-schedules.ts
    src/features/workflows/components/cron-builder.tsx
    src/features/workflows/components/cron-schedules-table.tsx
    src/views/workflows/cron-schedules-view.tsx
    app/(dashboard)/workflows/cron/page.tsx
  </files>
  <action>
    First, install new dependencies:
    ```bash
    bun add cronstrue croner
    ```

    **use-cron-schedules.ts**: TanStack Query hooks:
    - Define `CronSchedule` type: id, name, workflowId, workflowName, expression (cron string), enabled (boolean), lastRunAt (Date | null), lastRunStatus ("success" | "error" | null), nextRunAt (Date), createdAt (Date), runs (array of { id, status, duration, startedAt, triggeredBy })
    - `useCronSchedules()`: returns 4-6 mock schedules with varied expressions ("0 0 * * *" daily, "0 */6 * * *" every 6 hours, "0 9 * * 1" Monday 9am, etc.), some enabled, some disabled, with 2-3 mock runs each. Use `queryKeys.workflows.cron()`.
    - `useCreateCronSchedule()`: mutation accepting { name, workflowId, expression }. Mock delay 300ms. Invalidates cron query. Toast "Schedule created".
    - `useUpdateCronSchedule()`: mutation for enable/disable toggle and expression update. Optimistic update.
    - `useDeleteCronSchedule()`: mutation with optimistic removal.
    - `useRetryCronRun()`: mutation to retry a failed run. Accepts `{ scheduleId, runId, overridePayload?: string }` -- the optional overridePayload allows editing input before re-queuing per locked decision.

    **cron-builder.tsx**: "use client" component -- the hybrid visual+raw cron builder per user decision:
    - Props: value (string - current cron expression), onChange (newExpression: string) => void, onSave?: () => void
    - State: isRawMode (boolean), builderState with: frequency ("minute" | "hourly" | "daily" | "weekly" | "monthly" | "custom"), minute (0-59), hour (0-23), dayOfWeek (number[] of 0-6), dayOfMonth (1-31)
    - Visual builder mode (default):
      - Frequency select dropdown: Every Minute, Hourly, Daily, Weekly, Monthly, Custom
      - Conditional fields based on frequency:
        - Minute: just shows "every minute" (no extra fields)
        - Hourly: "at minute" number input (0-59)
        - Daily: "at" hour select (0-23) + minute select (0-59)
        - Weekly: day checkboxes (Mon-Sun) + time selects
        - Monthly: day of month select (1-31) + time selects
        - Custom: switches to raw mode automatically
      - Visual builder state syncs to cron expression via conversion function
    - Raw expression mode (toggle via Switch "Raw expression"):
      - Text input for raw cron expression (5-field standard)
      - Validation: try-catch around cronstrue.toString() -- if throws, show error
    - Always visible preview section:
      - Human-readable description: `cronstrue.toString(expression)` in bold text
      - Next 5 runs: `new Cron(expression).nextRuns(5)` displayed as formatted dates (use date-fns format)
      - If expression invalid: show red error text instead of preview
    - Mode toggle: shadcn Switch at top-right labeled "Raw expression"

    **cron-schedules-table.tsx**: DataTable component:
    - Columns: Name, Workflow (link to /workflows/[id]), Schedule (human-readable via cronstrue), Status (enabled/disabled Switch toggle), Next Run (formatted date), Last Run (status badge + relative time), Actions (ActionMenu: Edit, Disable/Enable, Delete)
    - Inline expandable rows: click chevron to expand and show last 3-5 runs (RunHistoryRow-style: run status badge, duration, timestamp). For failed runs: "Retry" button that opens an inline `<Textarea>` pre-populated with the original run's input payload (JSON.stringify pretty-printed). User can edit the payload before confirming retry. Confirm calls `useRetryCronRun` with optional `overridePayload` parameter. Cancel closes the editor. Per locked decision: "Failed runs support retry with options: retry button plus ability to edit input payload before re-queuing."
    - Props: schedules data, isLoading
    - Enable/disable toggle calls useUpdateCronSchedule mutation

    **cron-schedules-view.tsx**: PageHeader ("Cron Schedules") with description "Schedule recurring workflow executions". Action: "New Schedule" button opens a Dialog containing:
    - Name input
    - Workflow select (dropdown with mock workflow names from useWorkflows)
    - CronBuilder component for expression
    - Save button calling useCreateCronSchedule
    Renders CronSchedulesTable below with useCronSchedules() data.

    **app/(dashboard)/workflows/cron/page.tsx**: Thin wrapper rendering CronSchedulesView.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Run `bun add cronstrue croner` if not already done. Navigate to /workflows/cron -- DataTable renders with mock schedules, human-readable cron descriptions display correctly, expandable rows show run history. Open "New Schedule" dialog -- cron builder shows visual mode with frequency dropdown, preview section shows human-readable description and next 5 run dates, toggle to raw mode allows typing raw expressions.</verify>
  <done>Cron schedule management page at /workflows/cron with DataTable, inline run history, and new schedule dialog with hybrid visual/raw cron builder showing human-readable previews and next run dates.</done>
</task>

<task type="auto">
  <name>Task 2: Webhook API hooks, webhook table, create dialog, and webhooks page</name>
  <files>
    src/features/workflows/api/use-webhooks.ts
    src/features/workflows/components/webhook-table.tsx
    src/features/workflows/components/webhook-create-dialog.tsx
    src/views/workflows/webhooks-view.tsx
    app/(dashboard)/workflows/webhooks/page.tsx
  </files>
  <action>
    Build the webhook endpoint management:

    **use-webhooks.ts**: TanStack Query hooks:
    - Define `WebhookEndpoint` type: id, name, url (string - the full webhook URL), secret (string - the HMAC secret), workflowId, workflowName, status ("active" | "disabled"), lastTriggeredAt (Date | null), createdAt (Date), runs (array of { id, status, duration, startedAt, sourceIp, payload (string - truncated JSON) })
    - `useWebhooks()`: returns 3-5 mock webhook endpoints with varied statuses. Mock URLs like `https://axion.hub/api/webhooks/wh_abc123`. Each with 2-3 mock runs. Use `queryKeys.workflows.webhooks()`.
    - `useCreateWebhook()`: mutation accepting { name, workflowId }. Generates webhook URL using nanoid for the token portion and a random secret. Mock delay 300ms. Returns created webhook with URL and secret. Invalidates webhook query. Toast "Webhook created".
    - `useUpdateWebhook()`: mutation for enable/disable toggle.
    - `useDeleteWebhook()`: mutation with optimistic removal.
    - `useRetryWebhookRun()`: mutation to retry a failed webhook run. Accepts `{ webhookId, runId, overridePayload?: string }` -- the optional overridePayload allows editing input before re-queuing per locked decision.
    - `useRegenerateWebhookSecret()`: mutation that generates a new secret for a webhook.

    **webhook-table.tsx**: DataTable component:
    - Columns:
      - Name (bold)
      - URL (monospace, truncated with copy button - use navigator.clipboard.writeText with toast "Copied!")
      - Linked Workflow (link to /workflows/[id])
      - Status (StatusBadge active/disabled)
      - Last Triggered (relative time or "Never")
      - Actions (ActionMenu: Copy URL, Copy Secret, Disable/Enable, Regenerate Secret, Delete with destructive variant)
    - Inline expandable rows: click to expand and show last 3-5 triggers with: source IP, status, duration, truncated payload preview. For failed runs: "Retry" button that opens an inline `<Textarea>` pre-populated with the original trigger's payload (JSON.stringify pretty-printed). User can edit the payload before confirming retry. Confirm calls a retry mutation with optional `overridePayload` parameter. Cancel closes the editor. Per locked decision: "Failed runs support retry with options: retry button plus ability to edit input payload before re-queuing."
    - Props: webhooks data, isLoading

    **webhook-create-dialog.tsx**: shadcn Dialog component:
    - Trigger: passed as children or controlled via open/onOpenChange props
    - Form fields:
      - Name input (required)
      - Workflow select dropdown (required, populated from useWorkflows mock data)
    - On submit: call useCreateWebhook mutation
    - Success state: show the generated webhook URL and secret in a prominent display:
      - URL in a copy-able code block with copy button
      - Secret in a copy-able code block with copy button and warning icon: "Save this secret -- it won't be shown again"
      - "Done" button to close dialog
    - Use react-hook-form with Zod v4 schema for validation (name required, workflowId required)

    **webhooks-view.tsx**: PageHeader ("Webhook Endpoints") with description "Create inbound webhook URLs that trigger workflow executions". Action: "Create Webhook" button (opens WebhookCreateDialog). Renders WebhookTable with useWebhooks() data. Loading skeleton while fetching.

    **app/(dashboard)/workflows/webhooks/page.tsx**: Thin wrapper rendering WebhooksView.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Navigate to /workflows/webhooks -- DataTable renders with mock webhook endpoints, URL column shows monospace truncated URLs. Click "Create Webhook" -- dialog opens with name + workflow fields, on submit shows generated URL and secret. Expandable rows show last triggers with source IP and payload preview.</verify>
  <done>Webhook management page at /workflows/webhooks with DataTable showing endpoints, create dialog generating URL + secret, inline expandable run history, and copy-to-clipboard functionality.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `cronstrue` and `croner` packages installed and importable
3. /workflows/cron renders DataTable with 4-6 mock cron schedules
4. Cron builder visual mode: frequency dropdown changes visible fields, human-readable preview updates live
5. Cron builder raw mode: typing cron expression shows preview or validation error
6. Next 5 runs calculated correctly by croner
7. /workflows/webhooks renders DataTable with 3-5 mock webhook endpoints
8. Create Webhook dialog generates URL and secret, displays prominently for copying
9. Copy buttons work (clipboard + toast)
10. Expandable rows show run history in both tables
11. Enable/disable toggles work with optimistic updates
</verification>

<success_criteria>
User can manage cron schedules at /workflows/cron with a hybrid visual/raw cron builder showing human-readable descriptions and next run dates, and manage webhook endpoints at /workflows/webhooks with URL generation, secret management, and inline run history.
</success_criteria>

<output>
After completion, create `.planning/phases/09-skills-plugins-workflows/09-05-SUMMARY.md`
</output>
