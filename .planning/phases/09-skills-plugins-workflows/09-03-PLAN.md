---
phase: 09-skills-plugins-workflows
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/workflow/model/types.ts
  - src/entities/workflow/model/schemas.ts
  - src/entities/workflow/lib/node-registry.ts
  - src/entities/workflow/index.ts
  - src/features/workflows/api/use-workflows.ts
  - src/features/workflows/model/workflow-canvas-store.ts
  - src/features/workflows/components/canvas/workflow-canvas.tsx
  - src/features/workflows/components/canvas/node-palette.tsx
  - src/features/workflows/components/canvas/node-config-panel.tsx
  - src/features/workflows/components/nodes/base-workflow-node.tsx
  - src/features/workflows/components/nodes/trigger-node.tsx
  - src/features/workflows/components/nodes/agent-action-node.tsx
  - src/features/workflows/components/nodes/condition-node.tsx
  - src/features/workflows/components/nodes/delay-node.tsx
  - src/features/workflows/components/nodes/transform-node.tsx
  - src/features/workflows/components/nodes/output-node.tsx
  - src/features/workflows/components/nodes/loop-node.tsx
  - src/features/workflows/components/nodes/parallel-node.tsx
  - src/features/workflows/components/nodes/http-request-node.tsx
  - src/features/workflows/components/nodes/code-node.tsx
  - src/features/workflows/components/nodes/approval-gate-node.tsx
  - src/features/workflows/components/nodes/sub-workflow-node.tsx
  - src/features/workflows/components/workflow-card.tsx
  - src/views/workflows/workflows-list-view.tsx
  - src/views/workflows/workflow-editor-view.tsx
  - app/(dashboard)/workflows/page.tsx
  - app/(dashboard)/workflows/new/page.tsx
  - src/shared/lib/query-keys.ts
autonomous: true
requirements:
  - WORK-01
  - WORK-02

must_haves:
  truths:
    - "User can view saved workflows in a card grid at /workflows"
    - "User can build workflows by dragging nodes from a sidebar palette onto a canvas at /workflows/new"
    - "User can connect nodes by dragging between handles"
    - "User can select a node and configure it via a right sidebar panel"
    - "All 12 node types render with category-specific colors and handles"
  artifacts:
    - path: "src/entities/workflow/lib/node-registry.ts"
      provides: "Node type definitions with palette metadata, default data, icons, handle config"
      min_lines: 80
    - path: "src/features/workflows/model/workflow-canvas-store.ts"
      provides: "Zustand store for workflow graph state, node selection, undo/redo"
      min_lines: 80
    - path: "src/features/workflows/components/canvas/workflow-canvas.tsx"
      provides: "ReactFlow interactive canvas with drag-drop and connect handlers"
      min_lines: 60
    - path: "src/features/workflows/components/canvas/node-palette.tsx"
      provides: "Left sidebar with draggable node type items"
      min_lines: 40
    - path: "src/features/workflows/components/canvas/node-config-panel.tsx"
      provides: "Right sidebar Figma-style properties panel for selected node"
      min_lines: 60
  key_links:
    - from: "src/features/workflows/components/canvas/workflow-canvas.tsx"
      to: "src/features/workflows/model/workflow-canvas-store.ts"
      via: "Zustand store for nodes/edges state"
      pattern: "useWorkflowCanvasStore"
    - from: "src/features/workflows/components/canvas/workflow-canvas.tsx"
      to: "src/entities/workflow/lib/node-registry.ts"
      via: "nodeTypes registration and default data lookup"
      pattern: "nodeTypes|getDefaultNodeData"
    - from: "src/views/workflows/workflow-editor-view.tsx"
      to: "src/features/workflows/components/canvas/workflow-canvas.tsx"
      via: "ReactFlowProvider wrapping canvas"
      pattern: "ReactFlowProvider"
---

<objective>
Build the workflow list page and the visual workflow builder with an interactive @xyflow/react canvas, 12 custom node types, drag-from-sidebar palette, and right sidebar config panel.

Purpose: The workflow canvas is the architectural centerpiece of Phase 9 -- users build multi-step automation sequences by dragging nodes onto a canvas and connecting them.
Output: Workflow list page at /workflows and fully interactive visual workflow editor at /workflows/new.
</objective>

<execution_context>
@/home/arya/.claude/get-shit-done/workflows/execute-plan.md
@/home/arya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-skills-plugins-workflows/09-RESEARCH.md

Key patterns to follow:
- Existing React Flow (read-only): src/features/dashboard/components/dependency-map.tsx (nodeTypes outside component, dagre layout, Controls, Background, MiniMap)
- Existing React Flow (read-only): src/features/channels/components/routing-graph.tsx (custom nodes with Handle)
- Zustand stores: src/features/gateway/model/config-draft-store.ts (state + actions)
- Query keys: src/shared/lib/query-keys.ts

CRITICAL React Flow patterns from research:
- nodeTypes MUST be defined OUTSIDE the component (module-level const) to prevent re-renders
- ReactFlowProvider MUST wrap parent component (not same component as ReactFlow)
- Import "@xyflow/react/dist/style.css" for proper rendering
- Use screenToFlowPosition for drag-from-sidebar coordinates
- "use client" directive required (DOM APIs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Workflow entity types, node registry, canvas store, query hooks, and workflow list page</name>
  <files>
    src/entities/workflow/model/types.ts
    src/entities/workflow/model/schemas.ts
    src/entities/workflow/lib/node-registry.ts
    src/entities/workflow/index.ts
    src/features/workflows/api/use-workflows.ts
    src/features/workflows/model/workflow-canvas-store.ts
    src/features/workflows/components/workflow-card.tsx
    src/views/workflows/workflows-list-view.tsx
    app/(dashboard)/workflows/page.tsx
    src/shared/lib/query-keys.ts
  </files>
  <action>
    Build the workflow data layer, canvas store, and list page:

    **types.ts**: Define types:
    - `WorkflowStatus`: "draft" | "active" | "paused" | "error"
    - `WorkflowTriggerType`: "manual" | "cron" | "webhook" | "event"
    - `WorkflowNodeType`: "trigger" | "agentAction" | "condition" | "delay" | "transform" | "output" | "loop" | "parallel" | "httpRequest" | "code" | "approvalGate" | "subWorkflow"
    - `WorkflowNodeData`: Record<string, unknown> & { label: string } -- base data all nodes carry
    - `WorkflowDefinition`: id, name, description, status, triggerType, nodes (serialized node positions/types/data), edges (serialized connections), nodeCount, lastEditedAt, lastRunAt (Date | null), lastRunStatus ("success" | "error" | "running" | null)
    - `ExecutionNodeStatus`: "pending" | "running" | "success" | "error" | "skipped"
    - `NodeExecutionState`: status (ExecutionNodeStatus), startedAt (Date | null), completedAt (Date | null), input (unknown), output (unknown), error (string | null)

    **schemas.ts**: Zod v4 schemas for WorkflowDefinition using z.object().

    **node-registry.ts**: Central registry defining all 12 node types. Export:
    - `NODE_CATEGORIES`: Record mapping category names to colors:
      - "trigger": { border: "border-blue-500", bg: "bg-blue-500/10", text: "text-blue-500" }
      - "action": { border: "border-purple-500", bg: "bg-purple-500/10", text: "text-purple-500" }
      - "control": { border: "border-amber-500", bg: "bg-amber-500/10", text: "text-amber-500" }
      - "io": { border: "border-slate-500", bg: "bg-slate-500/10", text: "text-slate-500" }
      - "special": { border: "border-indigo-500", bg: "bg-indigo-500/10", text: "text-indigo-500" }
      - "code": { border: "border-emerald-500", bg: "bg-emerald-500/10", text: "text-emerald-500" }
    - `NODE_REGISTRY`: Array of node definitions, each with: type (WorkflowNodeType), label, description, category (key of NODE_CATEGORIES), icon (lucide icon name string), defaultData (default WorkflowNodeData), handles (array describing source/target handles with ids and positions).
      Node list: Trigger (trigger), Agent Action (action), Condition (control, has "true" and "false" source handles), Delay (control), Transform (io), Output (io), Loop (control), Parallel (control, has "fan-out" and "fan-in" handles), HTTP Request (io), Code (code), Approval Gate (special, has "approved" and "rejected" source handles), Sub-workflow (special)
    - `getDefaultNodeData(type)`: returns default data for a node type from registry
    - `getNodeCategory(type)`: returns category colors for a node type

    **index.ts**: Barrel export types, schemas, node-registry.

    **workflow-canvas-store.ts**: Zustand store (NO immer -- use functional updates):
    - State: nodes (Node[]), edges (Edge[]), selectedNodeId (string | null), workflowId (string | null), workflowName (string), isDirty (boolean), past (Array<{nodes, edges}>), future (Array<{nodes, edges}>)
    - Actions:
      - setNodes(nodes | updater): update nodes, mark dirty
      - setEdges(edges | updater): update edges, mark dirty
      - onNodesChange(changes): apply node changes via applyNodeChanges from @xyflow/react
      - onEdgesChange(changes): apply edge changes via applyEdgeChanges from @xyflow/react
      - addNode(node): append node, take snapshot for undo
      - selectNode(id | null): set selectedNodeId
      - updateNodeData(nodeId, data): merge data into node's data, mark dirty
      - deleteSelectedNodes(): remove nodes with selected=true and connected edges
      - loadWorkflow(id, name, nodes, edges): load a saved workflow, reset dirty/undo
      - clearCanvas(): reset to empty state
      - takeSnapshot(): push current {nodes, edges} to past, clear future
      - undo(): restore from past, push current to future
      - redo(): restore from future, push current to past

    **use-workflows.ts**: `useWorkflows()` returning 5-6 mock WorkflowDefinition objects with varied statuses, trigger types, and node counts. Include `useCreateWorkflow` and `useDeleteWorkflow` mutations. Add `workflows` domain to query-keys.ts:
    ```
    workflows: {
      all: ["workflows"],
      lists: () => [...queryKeys.workflows.all, "list"],
      list: (filters?) => [...queryKeys.workflows.lists(), filters],
      details: () => [...queryKeys.workflows.all, "detail"],
      detail: (id: string) => [...queryKeys.workflows.details(), id],
      runs: (id: string) => [...queryKeys.workflows.all, "runs", id],
      cron: () => [...queryKeys.workflows.all, "cron"],
      webhooks: () => [...queryKeys.workflows.all, "webhooks"],
    },
    ```

    **workflow-card.tsx**: Card for workflow list. Shows: workflow name, description (truncated), trigger type badge (color-coded by type), status badge (StatusBadge), node count, last edited (relative time), last run status indicator (colored dot). On click navigates to /workflows/[id]. Layout: `border bg-card rounded-lg p-4 hover:bg-muted/50 cursor-pointer transition-colors`.

    **workflows-list-view.tsx**: PageHeader ("Workflows") with action button linking to /workflows/new ("New Workflow"). Card grid with `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4`. Uses useWorkflows() data. Loading skeleton. Empty state with CTA to create first workflow.

    **app/(dashboard)/workflows/page.tsx**: Thin wrapper rendering WorkflowsListView.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Navigate to /workflows in browser -- card grid renders with 5-6 mock workflows showing trigger badges and status.</verify>
  <done>Workflow entity layer complete with 12-node registry, canvas Zustand store with undo/redo, TanStack Query hooks with mock data, and workflow list page rendering card grid at /workflows.</done>
</task>

<task type="auto">
  <name>Task 2: Interactive workflow canvas with 12 custom nodes, palette, config panel, and editor view</name>
  <files>
    src/features/workflows/components/nodes/base-workflow-node.tsx
    src/features/workflows/components/nodes/trigger-node.tsx
    src/features/workflows/components/nodes/agent-action-node.tsx
    src/features/workflows/components/nodes/condition-node.tsx
    src/features/workflows/components/nodes/delay-node.tsx
    src/features/workflows/components/nodes/transform-node.tsx
    src/features/workflows/components/nodes/output-node.tsx
    src/features/workflows/components/nodes/loop-node.tsx
    src/features/workflows/components/nodes/parallel-node.tsx
    src/features/workflows/components/nodes/http-request-node.tsx
    src/features/workflows/components/nodes/code-node.tsx
    src/features/workflows/components/nodes/approval-gate-node.tsx
    src/features/workflows/components/nodes/sub-workflow-node.tsx
    src/features/workflows/components/canvas/workflow-canvas.tsx
    src/features/workflows/components/canvas/node-palette.tsx
    src/features/workflows/components/canvas/node-config-panel.tsx
    src/views/workflows/workflow-editor-view.tsx
    app/(dashboard)/workflows/new/page.tsx
  </files>
  <action>
    Build the interactive workflow canvas -- this is the most complex component in Phase 9:

    **base-workflow-node.tsx**: Shared base node component. Props: id, data, selected, nodeType (WorkflowNodeType), children (slot for node-specific content). Renders:
    - Target Handle at Position.Top (unless trigger type -- triggers have no input)
    - Card wrapper: `w-[200px] rounded-lg border-2 bg-card p-3 shadow-sm` with category-specific border color from getNodeCategory(nodeType). If selected: `ring-2 ring-primary/20`.
    - Header: icon (from NODE_REGISTRY) + label in a flex row
    - Children slot for node-specific content
    - Default source Handle at Position.Bottom (overridden by nodes with multiple outputs)
    - Wrap in React.memo for performance.

    **12 custom nodes** (each file): Each wraps BaseWorkflowNode with type-specific content:
    - **trigger-node**: Shows trigger sub-type (manual/cron/webhook/event) from data. NO target handle (entry point). One source handle bottom.
    - **agent-action-node**: Shows agent name from data, action description truncated. Standard handles.
    - **condition-node**: Shows expression from data (mono font). TWO source handles at bottom: "true" (left, green) and "false" (right, red), per research example. Use `style={{ left: "30%" }}` and `style={{ left: "70%" }}`.
    - **delay-node**: Shows duration from data (e.g., "5 minutes"). Standard handles.
    - **transform-node**: Shows mapping description. Standard handles.
    - **output-node**: Shows output type (notify/log). Standard handles. No source handle (terminal).
    - **loop-node**: Shows iteration config. TWO source handles: "body" (loop iteration) and "done" (exit).
    - **parallel-node**: Shows branch count. TWO source handles: "fan-out" and "fan-in".
    - **http-request-node**: Shows method + URL from data (truncated). Standard handles.
    - **code-node**: Shows language (JS/Python) badge. Standard handles.
    - **approval-gate-node**: Shows approver from data. TWO source handles: "approved" (green) and "rejected" (red).
    - **sub-workflow-node**: Shows referenced workflow name. Standard handles.

    All nodes MUST be wrapped in `memo()` and exported as named constants.

    **workflow-canvas.tsx**: "use client" component. The interactive canvas:
    - Import `@xyflow/react/dist/style.css`
    - Define `const nodeTypes = { trigger: TriggerNode, agentAction: AgentActionNode, ... }` as MODULE-LEVEL constant OUTSIDE the component (critical for performance per research Pitfall 1)
    - Read nodes/edges from workflow-canvas-store via selectors
    - Wire onNodesChange, onEdgesChange to store actions
    - onConnect: use addEdge from @xyflow/react to create edge, call store.setEdges
    - onDragOver: `event.preventDefault(); event.dataTransfer.dropEffect = "move"`
    - onDrop: read type from `event.dataTransfer.getData("application/reactflow")`, convert to flow position via `screenToFlowPosition({ x: event.clientX, y: event.clientY })`, create new node with `nanoid()` id and `getDefaultNodeData(type)`, add via store.addNode()
    - onNodeClick: call store.selectNode(nodeId)
    - onPaneClick: call store.selectNode(null)
    - Keyboard: listen for Backspace/Delete to delete selected nodes (via onKeyDown on wrapper div with tabIndex={0})
    - Render: `<ReactFlow>` with `<Controls />`, `<Background />`, `<MiniMap className="!bg-muted/50" />`, `fitView`, `proOptions={{ hideAttribution: true }}`

    **node-palette.tsx**: "use client" component. Left sidebar (w-64, border-r, overflow-y-auto, h-full, bg-background, p-4):
    - Group NODE_REGISTRY items by category
    - Each category: heading with colored dot, then list of draggable items
    - Each item: `<div draggable onDragStart={(e) => { e.dataTransfer.setData("application/reactflow", type); e.dataTransfer.effectAllowed = "move"; }}>` with icon, label, small description. Styled: `flex items-center gap-2 rounded-md border p-2 cursor-grab active:cursor-grabbing hover:bg-muted/50 transition-colors`
    - Top: small text "Drag nodes onto canvas"

    **node-config-panel.tsx**: "use client" component. Right sidebar panel (w-80, border-l, bg-background, h-full, overflow-y-auto):
    - Shows when a node is selected (read selectedNodeId from store)
    - If no node selected: show placeholder "Select a node to configure"
    - If node selected: find node from store, display:
      - Header with node type icon, label, and close button (deselects)
      - Node type badge with category color
      - Config form fields based on node type:
        - Trigger: sub-type select (manual/cron/webhook/event)
        - Agent Action: agent select dropdown, action description textarea
        - Condition: expression input
        - Delay: duration number + unit select (seconds/minutes/hours)
        - Transform: mapping description textarea
        - Output: type select (notify/log), target input
        - Loop: count input, collection reference
        - Parallel: branch count
        - HTTP Request: method select (GET/POST/PUT/DELETE), URL input, body textarea
        - Code: language select (javascript/python), code textarea (placeholder for CodeMirror)
        - Approval Gate: approver input, timeout input
        - Sub-workflow: workflow ID input
      - Each field change calls store.updateNodeData(nodeId, updatedData)
    - Animate open/close with framer-motion AnimatePresence

    **workflow-editor-view.tsx**: "use client" composition view:
    - Full height: `h-[calc(100vh-64px)]` (subtracting header bar)
    - Top bar: workflow name input, Save button, Undo/Redo buttons reading from store
    - Three-column flex layout: NodePalette (left) | WorkflowCanvas (flex-1 center) | NodeConfigPanel (right, conditional)
    - Wrapped in `<ReactFlowProvider>` (MUST be ancestor of canvas component, per research Pitfall 2)

    **app/(dashboard)/workflows/new/page.tsx**: Thin wrapper rendering WorkflowEditorView.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Navigate to /workflows/new in browser: canvas renders with controls/minimap/background, palette shows all 12 node types grouped by category, dragging a node from palette to canvas creates it, connecting two nodes creates an edge, clicking a node opens config panel, Backspace deletes selected node, undo/redo work.</verify>
  <done>Visual workflow builder at /workflows/new renders interactive React Flow canvas with 12 custom node types, drag-from-sidebar palette, node-to-node connections, right sidebar config panel, and undo/redo.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. /workflows renders card grid with 5-6 mock workflows
3. /workflows/new renders full editor with three-column layout (palette | canvas | config panel)
4. Dragging node from palette to canvas creates a node at the drop position
5. Connecting two nodes via handle drag creates an edge
6. Clicking a node opens right sidebar config panel with type-specific fields
7. All 12 node types render with correct category border colors
8. Condition and Approval Gate nodes show dual source handles (true/false, approved/rejected)
9. Undo/Redo buttons work for node additions and deletions
10. Keyboard Delete removes selected nodes
</verification>

<success_criteria>
User can view saved workflows at /workflows in a card grid and build new workflows at /workflows/new by dragging 12 node types from a sidebar palette onto an interactive canvas, connecting nodes via handles, and configuring each node via a right sidebar panel.
</success_criteria>

<output>
After completion, create `.planning/phases/09-skills-plugins-workflows/09-03-SUMMARY.md`
</output>
